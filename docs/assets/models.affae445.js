import{ad as e,L as n,ae as t,E as i,q as r,S as o,O as a,h as s,a as l,x as c,ac as f,i as u,f as d,s as h,a0 as p,V as m,af as _,F as v,M as A,ag as g,ah as E,B as T,a6 as y,ai as R,Q as C,y as b,z as S,a7 as I,l as O,m as M,n as x,aj as L,j as P,ak as N,aa as D,t as F,e as U,o as B,C as w,w as G,a3 as V,al as k,J as H,k as X,u as W,v as z,c as Y,am as Q,an as j,ao as K,ap as q,a2 as Z,d as J,aq as $,K as ee,g as ne,U as te,ab as ie,ar as re,as as oe,X as ae,N as se,at as le,au as ce,Y as fe,a8 as ue,av as de,aw as he,a9 as pe,ax as me,ay as _e,az as ve,_ as Ae}from"./vendor.c0117933.js";import{T as ge,M as Ee,E as Te,S as ye,a as Re,C as Ce,H as be,b as Se,P as Ie,c as Oe,B as Me,D as xe,d as Le,e as Pe,R as Ne}from"./app.58a5b43b.js";import"./index.6f2edf29.js";var De,Fe;(Fe=De||(De={}))[Fe.Clean=0]="Clean",Fe[Fe.Stop=1]="Stop",Fe[Fe.Sync=2]="Sync",Fe[Fe.NoSync=3]="NoSync";var Ue=function(){function l(){}return Object.defineProperty(l,"ForceFullSceneLoadingForIncremental",{get:function(){return e.ForceFullSceneLoadingForIncremental},set:function(n){e.ForceFullSceneLoadingForIncremental=n},enumerable:!1,configurable:!0}),Object.defineProperty(l,"ShowLoadingScreen",{get:function(){return e.ShowLoadingScreen},set:function(n){e.ShowLoadingScreen=n},enumerable:!1,configurable:!0}),Object.defineProperty(l,"loggingLevel",{get:function(){return e.loggingLevel},set:function(n){e.loggingLevel=n},enumerable:!1,configurable:!0}),Object.defineProperty(l,"CleanBoneMatrixWeights",{get:function(){return e.CleanBoneMatrixWeights},set:function(n){e.CleanBoneMatrixWeights=n},enumerable:!1,configurable:!0}),l.GetDefaultPlugin=function(){return l._registeredPlugins[".babylon"]},l._GetPluginForExtension=function(e){var t=l._registeredPlugins[e];return t||(n.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/how_to/load_from_any_file_type"),l.GetDefaultPlugin())},l._GetPluginForDirectLoad=function(e){for(var n in l._registeredPlugins){var t=l._registeredPlugins[n].plugin;if(t.canDirectLoad&&t.canDirectLoad(e))return l._registeredPlugins[n]}return l.GetDefaultPlugin()},l._GetPluginForFilename=function(e){var n=e.indexOf("?");-1!==n&&(e=e.substring(0,n));var t=e.lastIndexOf("."),i=e.substring(t,e.length).toLowerCase();return l._GetPluginForExtension(i)},l._GetDirectLoad=function(e){return"data:"===e.substr(0,5)?e.substr(5):null},l._LoadData=function(e,n,r,o,a,s,c){var f,u=l._GetDirectLoad(e.name),d=c?l._GetPluginForExtension(c):u?l._GetPluginForDirectLoad(e.name):l._GetPluginForFilename(e.name);if(!(f=void 0!==d.plugin.createPlugin?d.plugin.createPlugin():d.plugin))throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(l.OnPluginActivatedObservable.notifyObservers(f),u){if(f.directLoad){var h=f.directLoad(n,u);h.then?h.then((function(e){r(f,e)})).catch((function(e){a("Error in directLoad of _loadData: "+e,e)})):r(f,h)}else r(f,u);return f}var p=d.isBinary,m=function(e,t){n.isDisposed?a("Scene has been disposed"):r(f,e,t)},_=null,v=!1,A=f.onDisposeObservable;A&&A.add((function(){v=!0,_&&(_.abort(),_=null),s()}));var g=function(){if(!v){var t=function(e,n){m(e,n?n.responseURL:void 0)},i=function(e){a(e.message,e)};_=f.requestFile?f.requestFile(n,e.url,t,o,p,i):n._requestFile(e.url,t,o,!0,p,i)}},E=e.file||t.FilesToLoad[e.name.toLowerCase()];if(-1===e.rootUrl.indexOf("file:")||-1!==e.rootUrl.indexOf("file:")&&!E){var T=n.getEngine(),y=T.enableOfflineSupport;if(y){for(var R=!1,C=0,b=n.disableOfflineSupportExceptionRules;C<b.length;C++){if(b[C].test(e.url)){R=!0;break}}y=!R}y&&i.OfflineProviderFactory?n.offlineProvider=i.OfflineProviderFactory(e.url,g,T.disableManifestCheck):g()}else if(E){var S=function(e){a(e.message,e)};_=f.readFile?f.readFile(n,E,m,o,p,S):n._readFile(E,m,o,p,S)}else a("Unable to find file named "+e.name);return f},l._GetFileInfo=function(e,n){var t,i,o=null;if(n)if(n.name){var a=n;t=e+a.name,i=a.name,o=a}else{var s=n;if("/"===s.substr(0,1))return r.Error("Wrong sceneFilename parameter"),null;t=e+s,i=s}else t=e,i=r.GetFilename(e),e=r.GetFolderPath(e);return{url:t,rootUrl:e,name:i,file:o}},l.GetPluginForExtension=function(e){return l._GetPluginForExtension(e).plugin},l.IsPluginForExtensionAvailable=function(e){return!!l._registeredPlugins[e]},l.RegisterPlugin=function(e){if("string"==typeof e.extensions){var n=e.extensions;l._registeredPlugins[n.toLowerCase()]={plugin:e,isBinary:!1}}else{var t=e.extensions;Object.keys(t).forEach((function(n){l._registeredPlugins[n.toLowerCase()]={plugin:e,isBinary:t[n].isBinary}}))}},l.ImportMesh=function(e,t,i,r,o,a,c,f){if(void 0===i&&(i=""),void 0===r&&(r=s.LastCreatedScene),void 0===o&&(o=null),void 0===a&&(a=null),void 0===c&&(c=null),void 0===f&&(f=null),!r)return n.Error("No scene available to import mesh to"),null;var u=l._GetFileInfo(t,i);if(!u)return null;var d={};r._addPendingData(d);var h=function(){r._removePendingData(d)},p=function(e,t){var i="Unable to import meshes from "+u.url+": "+e;c?c(r,i,t):n.Error(i),h()},m=a?function(e){try{a(e)}catch(n){p("Error in onProgress callback: "+n,n)}}:void 0,_=function(e,n,t,i,a,s,l){if(r.importedMeshesFiles.push(u.url),o)try{o(e,n,t,i,a,s,l)}catch(c){p("Error in onSuccess callback: "+c,c)}r._removePendingData(d)};return l._LoadData(u,r,(function(n,t,i){if(n.rewriteRootURL&&(u.rootUrl=n.rewriteRootURL(u.rootUrl,i)),n.importMesh){var o=n,a=new Array,s=new Array,l=new Array;if(!o.importMesh(e,r,t,u.rootUrl,a,s,l,p))return;r.loadingPluginName=n.name,_(a,s,l,[],[],[],[])}else{n.importMeshAsync(e,r,t,u.rootUrl,m,u.name).then((function(e){r.loadingPluginName=n.name,_(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights)})).catch((function(e){p(e.message,e)}))}}),m,p,h,f)},l.ImportMeshAsync=function(e,n,t,i,r,o){return void 0===t&&(t=""),void 0===i&&(i=s.LastCreatedScene),void 0===r&&(r=null),void 0===o&&(o=null),new Promise((function(a,s){l.ImportMesh(e,n,t,i,(function(e,n,t,i,r,o,s){a({meshes:e,particleSystems:n,skeletons:t,animationGroups:i,transformNodes:r,geometries:o,lights:s})}),r,(function(e,n,t){s(t||new Error(n))}),o)}))},l.Load=function(e,n,t,i,a,c,f){return void 0===n&&(n=""),void 0===t&&(t=s.LastCreatedEngine),void 0===i&&(i=null),void 0===a&&(a=null),void 0===c&&(c=null),void 0===f&&(f=null),t?l.Append(e,n,new o(t),i,a,c,f):(r.Error("No engine available"),null)},l.LoadAsync=function(e,n,t,i,r){return void 0===n&&(n=""),void 0===t&&(t=s.LastCreatedEngine),void 0===i&&(i=null),void 0===r&&(r=null),new Promise((function(o,a){l.Load(e,n,t,(function(e){o(e)}),i,(function(e,n,t){a(t||new Error(n))}),r)}))},l.Append=function(e,t,i,r,o,a,c){var f=this;if(void 0===t&&(t=""),void 0===i&&(i=s.LastCreatedScene),void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===c&&(c=null),!i)return n.Error("No scene available to append to"),null;var u=l._GetFileInfo(e,t);if(!u)return null;l.ShowLoadingScreen&&!this._showingLoadingScreen&&(this._showingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady((function(){i.getEngine().hideLoadingUI(),f._showingLoadingScreen=!1})));var d={};i._addPendingData(d);var h=function(){i._removePendingData(d)},p=function(e,t){var r="Unable to load from "+u.url+(e?": "+e:"");a?a(i,r,t):n.Error(r),h()},m=o?function(e){try{o(e)}catch(n){p("Error in onProgress callback",n)}}:void 0,_=function(){if(r)try{r(i)}catch(e){p("Error in onSuccess callback",e)}i._removePendingData(d)};return l._LoadData(u,i,(function(e,n){if(e.load){if(!e.load(i,n,u.rootUrl,p))return;i.loadingPluginName=e.name,_()}else{e.loadAsync(i,n,u.rootUrl,m,u.name).then((function(){i.loadingPluginName=e.name,_()})).catch((function(e){p(e.message,e)}))}}),m,p,h,c)},l.AppendAsync=function(e,n,t,i,r){return void 0===n&&(n=""),void 0===t&&(t=s.LastCreatedScene),void 0===i&&(i=null),void 0===r&&(r=null),new Promise((function(o,a){l.Append(e,n,t,(function(e){o(e)}),i,(function(e,n,t){a(t||new Error(n))}),r)}))},l.LoadAssetContainer=function(e,t,i,r,o,a,c){if(void 0===t&&(t=""),void 0===i&&(i=s.LastCreatedScene),void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===c&&(c=null),!i)return n.Error("No scene available to load asset container to"),null;var f=l._GetFileInfo(e,t);if(!f)return null;var u={};i._addPendingData(u);var d=function(){i._removePendingData(u)},h=function(e,t){var r="Unable to load assets from "+f.url+(e?": "+e:"");t&&t.message&&(r+=" ("+t.message+")"),a?a(i,r,t):n.Error(r),d()},p=o?function(e){try{o(e)}catch(n){h("Error in onProgress callback",n)}}:void 0,m=function(e){if(r)try{r(e)}catch(n){h("Error in onSuccess callback",n)}i._removePendingData(u)};return l._LoadData(f,i,(function(e,n){if(e.loadAssetContainer){var t=e.loadAssetContainer(i,n,f.rootUrl,h);if(!t)return;i.loadingPluginName=e.name,m(t)}else if(e.loadAssetContainerAsync){e.loadAssetContainerAsync(i,n,f.rootUrl,p,f.name).then((function(n){i.loadingPluginName=e.name,m(n)})).catch((function(e){h(e.message,e)}))}else h("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")}),p,h,d,c)},l.LoadAssetContainerAsync=function(e,n,t,i,r){return void 0===n&&(n=""),void 0===t&&(t=s.LastCreatedScene),void 0===i&&(i=null),void 0===r&&(r=null),new Promise((function(o,a){l.LoadAssetContainer(e,n,t,(function(e){o(e)}),i,(function(e,n,t){a(t||new Error(n))}),r)}))},l.ImportAnimations=function(e,t,i,r,o,a,l,c,f,u){if(void 0===t&&(t=""),void 0===i&&(i=s.LastCreatedScene),void 0===r&&(r=!0),void 0===o&&(o=De.Clean),void 0===a&&(a=null),void 0===l&&(l=null),void 0===c&&(c=null),void 0===f&&(f=null),void 0===u&&(u=null),i){if(r){for(var d=0,h=i.animatables;d<h.length;d++){h[d].reset()}i.stopAllAnimations(),i.animationGroups.slice().forEach((function(e){e.dispose()})),i.getNodes().forEach((function(e){e.animations&&(e.animations=[])}))}else switch(o){case De.Clean:i.animationGroups.slice().forEach((function(e){e.dispose()}));break;case De.Stop:i.animationGroups.forEach((function(e){e.stop()}));break;case De.Sync:i.animationGroups.forEach((function(e){e.reset(),e.restart()}));break;case De.NoSync:break;default:return void n.Error("Unknown animation group loading mode value '"+o+"'")}var p=i.animatables.length;this.LoadAssetContainer(e,t,i,(function(e){e.mergeAnimationsTo(i,i.animatables.slice(p),a),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),l&&l(i)}),c,f,u)}else n.Error("No scene available to load animations to")},l.ImportAnimationsAsync=function(e,n,t,i,r,o,a,c,f,u){return void 0===n&&(n=""),void 0===t&&(t=s.LastCreatedScene),void 0===i&&(i=!0),void 0===r&&(r=De.Clean),void 0===o&&(o=null),void 0===c&&(c=null),void 0===u&&(u=null),new Promise((function(a,s){l.ImportAnimations(e,n,t,i,r,o,(function(e){a(e)}),c,(function(e,n,t){s(t||new Error(n))}),u)}))},l.NO_LOGGING=0,l.MINIMAL_LOGGING=1,l.SUMMARY_LOGGING=2,l.DETAILED_LOGGING=3,l.OnPluginActivatedObservable=new a,l._registeredPlugins={},l._showingLoadingScreen=!1,l}(),Be=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return l(n,e),n}(f),we=function(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]},Ge=function(e){function t(n){var t=e.call(this)||this;return t._wasAddedToScene=!1,t.scene=n,t.sounds=[],t.effectLayers=[],t.layers=[],t.lensFlareSystems=[],t.proceduralTextures=[],t.reflectionProbes=[],n.onDisposeObservable.add((function(){t._wasAddedToScene||t.dispose()})),t}return l(t,e),t.prototype.instantiateModelsToScene=function(e,n){var t=this;void 0===n&&(n=!1);var i={},r={},o=new we,a=[],s=[],l={doNotInstantiate:!0},f=function(n,t){if(i[n.uniqueId]=t.uniqueId,r[t.uniqueId]=t,e&&(t.name=e(n.name)),t instanceof c){var o=t;if(o.morphTargetManager){var a=n.morphTargetManager;o.morphTargetManager=a.clone();for(var s=0;s<a.numTargets;s++){var l=a.getTarget(s),f=o.morphTargetManager.getTarget(s);i[l.uniqueId]=f.uniqueId,r[f.uniqueId]=f}}}};return this.transformNodes.forEach((function(e){if(!e.parent){var n=e.instantiateHierarchy(null,l,(function(e,n){f(e,n)}));n&&o.rootNodes.push(n)}})),this.meshes.forEach((function(a){if(!a.parent){var c=a.instantiateHierarchy(null,l,(function(o,a){if(f(o,a),a.material){var l=a;if(l.material)if(n){var c=o.material;if(-1===s.indexOf(c)){var u=c.clone(e?e(c.name):"Clone of "+c.name);if(s.push(c),i[c.uniqueId]=u.uniqueId,r[u.uniqueId]=u,"MultiMaterial"===c.getClassName()){for(var d=c,h=0,p=d.subMaterials;h<p.length;h++){var m=p[h];m&&(u=m.clone(e?e(m.name):"Clone of "+m.name),s.push(m),i[m.uniqueId]=u.uniqueId,r[u.uniqueId]=u)}d.subMaterials=d.subMaterials.map((function(e){return e&&r[i[e.uniqueId]]}))}}l.material=r[i[c.uniqueId]]}else"MultiMaterial"===l.material.getClassName()?-1===t.scene.multiMaterials.indexOf(l.material)&&t.scene.addMultiMaterial(l.material):-1===t.scene.materials.indexOf(l.material)&&t.scene.addMaterial(l.material)}}));c&&o.rootNodes.push(c)}})),this.skeletons.forEach((function(n){var s=n.clone(e?e(n.name):"Clone of "+n.name);n.overrideMesh&&(s.overrideMesh=r[i[n.overrideMesh.uniqueId]]);for(var l=0,c=t.meshes;l<c.length;l++){var f=c[l];if(f.skeleton===n&&!f.isAnInstance){if(r[i[f.uniqueId]].skeleton=s,-1!==a.indexOf(s))continue;a.push(s);for(var u=0,d=s.bones;u<d.length;u++){var h=d[u];h._linkedTransformNode&&(h._linkedTransformNode=r[i[h._linkedTransformNode.uniqueId]])}}}o.skeletons.push(s)})),this.animationGroups.forEach((function(e){var n=e.clone(e.name,(function(e){return r[i[e.uniqueId]]||e}));o.animationGroups.push(n)})),o},t.prototype.addAllToScene=function(){var e=this;this._wasAddedToScene=!0,this.cameras.forEach((function(n){e.scene.addCamera(n)})),this.lights.forEach((function(n){e.scene.addLight(n)})),this.meshes.forEach((function(n){e.scene.addMesh(n)})),this.skeletons.forEach((function(n){e.scene.addSkeleton(n)})),this.animations.forEach((function(n){e.scene.addAnimation(n)})),this.animationGroups.forEach((function(n){e.scene.addAnimationGroup(n)})),this.multiMaterials.forEach((function(n){e.scene.addMultiMaterial(n)})),this.materials.forEach((function(n){e.scene.addMaterial(n)})),this.morphTargetManagers.forEach((function(n){e.scene.addMorphTargetManager(n)})),this.geometries.forEach((function(n){e.scene.addGeometry(n)})),this.transformNodes.forEach((function(n){e.scene.addTransformNode(n)})),this.actionManagers.forEach((function(n){e.scene.addActionManager(n)})),this.textures.forEach((function(n){e.scene.addTexture(n)})),this.reflectionProbes.forEach((function(n){e.scene.addReflectionProbe(n)})),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(var n=0,t=this.scene._serializableComponents;n<t.length;n++){t[n].addFromContainer(this)}},t.prototype.removeAllFromScene=function(){var e=this;this._wasAddedToScene=!1,this.cameras.forEach((function(n){e.scene.removeCamera(n)})),this.lights.forEach((function(n){e.scene.removeLight(n)})),this.meshes.forEach((function(n){e.scene.removeMesh(n)})),this.skeletons.forEach((function(n){e.scene.removeSkeleton(n)})),this.animations.forEach((function(n){e.scene.removeAnimation(n)})),this.animationGroups.forEach((function(n){e.scene.removeAnimationGroup(n)})),this.multiMaterials.forEach((function(n){e.scene.removeMultiMaterial(n)})),this.materials.forEach((function(n){e.scene.removeMaterial(n)})),this.morphTargetManagers.forEach((function(n){e.scene.removeMorphTargetManager(n)})),this.geometries.forEach((function(n){e.scene.removeGeometry(n)})),this.transformNodes.forEach((function(n){e.scene.removeTransformNode(n)})),this.actionManagers.forEach((function(n){e.scene.removeActionManager(n)})),this.textures.forEach((function(n){e.scene.removeTexture(n)})),this.reflectionProbes.forEach((function(n){e.scene.removeReflectionProbe(n)})),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(var n=0,t=this.scene._serializableComponents;n<t.length;n++){t[n].removeFromContainer(this)}},t.prototype.dispose=function(){this.cameras.forEach((function(e){e.dispose()})),this.cameras=[],this.lights.forEach((function(e){e.dispose()})),this.lights=[],this.meshes.forEach((function(e){e.dispose()})),this.meshes=[],this.skeletons.forEach((function(e){e.dispose()})),this.skeletons=[],this.animationGroups.forEach((function(e){e.dispose()})),this.animationGroups=[],this.multiMaterials.forEach((function(e){e.dispose()})),this.multiMaterials=[],this.materials.forEach((function(e){e.dispose()})),this.materials=[],this.geometries.forEach((function(e){e.dispose()})),this.geometries=[],this.transformNodes.forEach((function(e){e.dispose()})),this.transformNodes=[],this.actionManagers.forEach((function(e){e.dispose()})),this.actionManagers=[],this.textures.forEach((function(e){e.dispose()})),this.textures=[],this.reflectionProbes.forEach((function(e){e.dispose()})),this.reflectionProbes=[],this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(var e=0,n=this.scene._serializableComponents;e<n.length;e++){n[e].removeFromContainer(this,!0)}},t.prototype._moveAssets=function(e,n,t){if(e)for(var i=0,r=e;i<r.length;i++){var o=r[i],a=!0;if(t)for(var s=0,l=t;s<l.length;s++){if(o===l[s]){a=!1;break}}a&&n.push(o)}},t.prototype.moveAllFromScene=function(e){for(var n in this._wasAddedToScene=!1,void 0===e&&(e=new Be),this)this.hasOwnProperty(n)&&(this[n]=this[n]||("environmentTexture"===n?null:[]),this._moveAssets(this.scene[n],this[n],e[n]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()},t.prototype.createRootMesh=function(){var e=new c("assetContainerRootMesh",this.scene);return this.meshes.forEach((function(n){n.parent||e.addChild(n)})),this.meshes.unshift(e),e},t.prototype.mergeAnimationsTo=function(e,t,i){if(void 0===e&&(e=s.LastCreatedScene),void 0===i&&(i=null),!e)return n.Error("No scene available to merge animations to"),[];var r=i||function(n){var t=null,i=n.animations.length?n.animations[0].targetProperty:"",r=n.name.split(".").join("").split("_primitive")[0];switch(i){case"position":case"rotationQuaternion":t=e.getTransformNodeByName(n.name)||e.getTransformNodeByName(r);break;case"influence":t=e.getMorphTargetByName(n.name)||e.getMorphTargetByName(r);break;default:t=e.getNodeByName(n.name)||e.getNodeByName(r)}return t};this.getNodes().forEach((function(e){var n=r(e);if(null!==n){for(var t=function(e){for(var t=0,i=n.animations.filter((function(n){return n.targetProperty===e.targetProperty}));t<i.length;t++){var r=i[t],o=n.animations.indexOf(r,0);o>-1&&n.animations.splice(o,1)}},i=0,o=e.animations;i<o.length;i++){t(o[i])}n.animations=n.animations.concat(e.animations)}}));var o=new Array;return this.animationGroups.slice().forEach((function(e){o.push(e.clone(e.name,r)),e.animatables.forEach((function(e){e.stop()}))})),t.forEach((function(n){var t=r(n.target);t&&(e.beginAnimation(t,n.fromFrame,n.toFrame,n.loopAnimation,n.speedRatio,n.onAnimationEnd?n.onAnimationEnd:void 0,void 0,!0,void 0,n.onAnimationLoop?n.onAnimationLoop:void 0),e.stopAnimation(n.target))})),o},t}(f),Ve=function(){function e(e){this.byteOffset=0,this.buffer=e}return e.prototype.loadAsync=function(e){var n=this;return this.buffer.readAsync(this.byteOffset,e).then((function(e){n._dataView=new DataView(e.buffer,e.byteOffset,e.byteLength),n._dataByteOffset=0}))},e.prototype.readUint32=function(){var e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e},e.prototype.readUint8Array=function(e){var n=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,n},e.prototype.readString=function(e){return u.Decode(this.readUint8Array(e))},e.prototype.skipBytes=function(e){this._dataByteOffset+=e,this.byteOffset+=e},e}();function ke(e,n,t,i){var r={externalResourceFunction:function(e){return i(e).then((function(e){return new Uint8Array(e)}))}};return t&&(r.uri="file:"===n?t:n+t),e instanceof ArrayBuffer?GLTFValidator.validateBytes(new Uint8Array(e),r):GLTFValidator.validateString(e,r)}function He(){var e=[];onmessage=function(n){var t=n.data;switch(t.id){case"init":importScripts(t.url);break;case"validate":ke(t.data,t.rootUrl,t.fileName,(function(n){return new Promise((function(t,i){var r=e.length;e.push({resolve:t,reject:i}),postMessage({id:"getExternalResource",index:r,uri:n})}))})).then((function(e){postMessage({id:"validate.resolve",value:e})}),(function(e){postMessage({id:"validate.reject",reason:e})}));break;case"getExternalResource.resolve":e[t.index].resolve(t.value);break;case"getExternalResource.reject":e[t.index].reject(t.reason)}}}var Xe,We,ze,Ye,Qe,je,Ke=function(){function e(){}return e.ValidateAsync=function(e,n,t,i){var o=this;return"function"==typeof Worker?new Promise((function(a,s){var l=ke+"("+He+")()",c=URL.createObjectURL(new Blob([l],{type:"application/javascript"})),f=new Worker(c),u=function(e){f.removeEventListener("error",u),f.removeEventListener("message",d),s(e)},d=function(e){var n=e.data;switch(n.id){case"getExternalResource":i(n.uri).then((function(e){f.postMessage({id:"getExternalResource.resolve",index:n.index,value:e},[e])}),(function(e){f.postMessage({id:"getExternalResource.reject",index:n.index,reason:e})}));break;case"validate.resolve":f.removeEventListener("error",u),f.removeEventListener("message",d),a(n.value);break;case"validate.reject":f.removeEventListener("error",u),f.removeEventListener("message",d),s(n.reason)}};f.addEventListener("error",u),f.addEventListener("message",d),f.postMessage({id:"init",url:r.GetAbsoluteUrl(o.Configuration.url)}),f.postMessage({id:"validate",data:e,rootUrl:n,fileName:t})})):(this._LoadScriptPromise||(this._LoadScriptPromise=r.LoadScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then((function(){return ke(e,n,t,i)})))},e.Configuration={url:"https://preview.babylonjs.com/gltf_validator.js"},e}();(We=Xe||(Xe={}))[We.AUTO=0]="AUTO",We[We.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",(Ye=ze||(ze={}))[Ye.NONE=0]="NONE",Ye[Ye.FIRST=1]="FIRST",Ye[Ye.ALL=2]="ALL",(je=Qe||(Qe={}))[je.LOADING=0]="LOADING",je[je.READY=1]="READY",je[je.COMPLETE=2]="COMPLETE";var qe,Ze,Je,$e,en,nn,tn,rn,on,an,sn,ln,cn,fn,un,dn,hn=function(){function e(){this.onParsedObservable=new a,this.coordinateSystemMode=Xe.AUTO,this.animationStartMode=ze.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable=new a,this.onTextureLoadedObservable=new a,this.onMaterialLoadedObservable=new a,this.onCameraLoadedObservable=new a,this.onCompleteObservable=new a,this.onErrorObservable=new a,this.onDisposeObservable=new a,this.onExtensionLoadedObservable=new a,this.validate=!1,this.onValidatedObservable=new a,this._loader=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}return Object.defineProperty(e.prototype,"onParsed",{set:function(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onMeshLoaded",{set:function(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onTextureLoaded",{set:function(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onMaterialLoaded",{set:function(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onCameraLoaded",{set:function(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onComplete",{set:function(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onError",{set:function(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onDispose",{set:function(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onExtensionLoaded",{set:function(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loggingEnabled",{get:function(){return this._loggingEnabled},set:function(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"capturePerformanceCounters",{get:function(){return this._capturePerformanceCounters},set:function(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onValidated",{set:function(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this._loader&&(this._loader.dispose(),this._loader=null);for(var e=0,n=this._requests;e<n.length;e++){n[e].abort()}this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=function(e){return Promise.resolve(e)},this.onMeshLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()},e.prototype.requestFile=function(e,t,i,o,s,l){var c=this;if(this._progressCallback=o,s){if(this.useRangeRequests){this.validate&&n.Warn("glTF validation is not supported when range requests are enabled");var f={abort:function(){},onCompleteObservable:new a},u={readAsync:function(n,i){return new Promise((function(r,o){c._requestFile(t,e,(function(e){r(new Uint8Array(e))}),!0,(function(e){o(e)}),(function(e){e.setRequestHeader("Range","bytes="+n+"-"+(n+i-1))}))}))},byteLength:0};return this._unpackBinaryAsync(new Ve(u)).then((function(e){f.onCompleteObservable.notifyObservers(f),i(e)}),l),f}return this._requestFile(t,e,(function(e,n){var t=e;c._unpackBinaryAsync(new Ve({readAsync:function(e,n){return Promise.resolve(new Uint8Array(t,e,n))},byteLength:t.byteLength})).then((function(e){i(e,n)}),l)}),!0,l)}return this._requestFile(t,e,(function(n,o){c._validate(e,n,r.GetFolderPath(t),r.GetFilename(t)),i({json:c._parseJson(n)},o)}),s,l)},e.prototype.readFile=function(e,n,t,i,r,o){var a=this;return e._readFile(n,(function(i){if(a._validate(e,i,"file:",n.name),r){var s=i;a._unpackBinaryAsync(new Ve({readAsync:function(e,n){return Promise.resolve(new Uint8Array(s,e,n))},byteLength:s.byteLength})).then(t,o)}else t({json:a._parseJson(i)})}),i,r,o)},e.prototype.importMeshAsync=function(e,n,t,i,r,o){var a=this;return Promise.resolve().then((function(){return a.onParsedObservable.notifyObservers(t),a.onParsedObservable.clear(),a._log("Loading "+(o||"")),a._loader=a._getLoader(t),a._loader.importMeshAsync(e,n,!1,t,i,r,o)}))},e.prototype.loadAsync=function(e,n,t,i,r){var o=this;return Promise.resolve().then((function(){return o.onParsedObservable.notifyObservers(n),o.onParsedObservable.clear(),o._log("Loading "+(r||"")),o._loader=o._getLoader(n),o._loader.loadAsync(e,n,t,i,r)}))},e.prototype.loadAssetContainerAsync=function(e,n,t,i,r){var o=this;return Promise.resolve().then((function(){o.onParsedObservable.notifyObservers(n),o.onParsedObservable.clear(),o._log("Loading "+(r||"")),o._loader=o._getLoader(n);var a=new Ge(e),s=[];o.onMaterialLoadedObservable.add((function(e){s.push(e),e.onDisposeObservable.addOnce((function(){var n=a.materials.indexOf(e);n>-1&&a.materials.splice(n,1),(n=s.indexOf(e))>-1&&s.splice(n,1)}))}));var l=[];o.onTextureLoadedObservable.add((function(e){l.push(e),e.onDisposeObservable.addOnce((function(){var n=a.textures.indexOf(e);n>-1&&a.textures.splice(n,1),(n=l.indexOf(e))>-1&&l.splice(n,1)}))}));var c=[];return o.onCameraLoadedObservable.add((function(e){c.push(e)})),o._loader.importMeshAsync(null,e,!0,n,t,i,r).then((function(e){return Array.prototype.push.apply(a.geometries,e.geometries),Array.prototype.push.apply(a.meshes,e.meshes),Array.prototype.push.apply(a.particleSystems,e.particleSystems),Array.prototype.push.apply(a.skeletons,e.skeletons),Array.prototype.push.apply(a.animationGroups,e.animationGroups),Array.prototype.push.apply(a.materials,s),Array.prototype.push.apply(a.textures,l),Array.prototype.push.apply(a.lights,e.lights),Array.prototype.push.apply(a.transformNodes,e.transformNodes),Array.prototype.push.apply(a.cameras,c),a}))}))},e.prototype.canDirectLoad=function(n){return-1!==n.indexOf("asset")&&-1!==n.indexOf("version")||u.StartsWith(n,"data:base64,"+e.magicBase64Encoded)||u.StartsWith(n,"data:application/octet-stream;base64,"+e.magicBase64Encoded)||u.StartsWith(n,"data:model/gltf-binary;base64,"+e.magicBase64Encoded)},e.prototype.directLoad=function(n,t){if(u.StartsWith(t,"base64,"+e.magicBase64Encoded)||u.StartsWith(t,"application/octet-stream;base64,"+e.magicBase64Encoded)||u.StartsWith(t,"model/gltf-binary;base64,"+e.magicBase64Encoded)){var i=r.DecodeBase64(t);return this._validate(n,i),this._unpackBinaryAsync(new Ve({readAsync:function(e,n){return Promise.resolve(new Uint8Array(i,e,n))},byteLength:i.byteLength}))}return this._validate(n,t),Promise.resolve({json:this._parseJson(t)})},e.prototype.createPlugin=function(){return new e},Object.defineProperty(e.prototype,"loaderState",{get:function(){return this._loader?this._loader.state:null},enumerable:!1,configurable:!0}),e.prototype.whenCompleteAsync=function(){var e=this;return new Promise((function(n,t){e.onCompleteObservable.addOnce((function(){n()})),e.onErrorObservable.addOnce((function(e){t(e)}))}))},e.prototype._loadFile=function(e,n,t,i,r){var o=this,a=n._loadFile(e,t,(function(e){o._onProgress(e,a)}),void 0,i,r);return a.onCompleteObservable.add((function(e){o._requests.splice(o._requests.indexOf(e),1)})),this._requests.push(a),a},e.prototype._requestFile=function(e,n,t,i,r,o){var a=this,s=n._requestFile(e,t,(function(e){a._onProgress(e,s)}),void 0,i,r,o);return s.onCompleteObservable.add((function(e){a._requests.splice(a._requests.indexOf(e),1)})),this._requests.push(s),s},e.prototype._onProgress=function(e,n){if(this._progressCallback){n._lengthComputable=e.lengthComputable,n._loaded=e.loaded,n._total=e.total;for(var t=!0,i=0,r=0,o=0,a=this._requests;o<a.length;o++){var s=a[o];if(void 0===s._lengthComputable||void 0===s._loaded||void 0===s._total)return;t=t&&s._lengthComputable,i+=s._loaded,r+=s._total}this._progressCallback({lengthComputable:t,loaded:i,total:t?r:0})}},e.prototype._validate=function(e,n,t,i){var o=this;void 0===t&&(t=""),void 0===i&&(i=""),this.validate&&(this._startPerformanceCounter("Validate JSON"),Ke.ValidateAsync(n,t,i,(function(n){return o.preprocessUrlAsync(t+n).then((function(n){return e._loadFileAsync(n,void 0,!0,!0)}))})).then((function(e){o._endPerformanceCounter("Validate JSON"),o.onValidatedObservable.notifyObservers(e),o.onValidatedObservable.clear()}),(function(e){o._endPerformanceCounter("Validate JSON"),r.Warn("Failed to validate: "+e.message),o.onValidatedObservable.clear()})))},e.prototype._getLoader=function(n){var t=n.json.asset||{};this._log("Asset version: "+t.version),t.minVersion&&this._log("Asset minimum version: "+t.minVersion),t.generator&&this._log("Asset generator: "+t.generator);var i=e._parseVersion(t.version);if(!i)throw new Error("Invalid version: "+t.version);if(void 0!==t.minVersion){var r=e._parseVersion(t.minVersion);if(!r)throw new Error("Invalid minimum version: "+t.minVersion);if(e._compareVersion(r,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}var o={1:e._CreateGLTF1Loader,2:e._CreateGLTF2Loader}[i.major];if(!o)throw new Error("Unsupported version: "+t.version);return o(this)},e.prototype._parseJson=function(e){this._startPerformanceCounter("Parse JSON"),this._log("JSON length: "+e.length);var n=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),n},e.prototype._unpackBinaryAsync=function(e){var n=this;return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then((function(){var t=e.readUint32();if(1179937895!==t)throw new Error("Unexpected magic: "+t);var i=e.readUint32();n.loggingEnabled&&n._log("Binary version: "+i);var r,o=e.readUint32();if(0!==e.buffer.byteLength&&o!==e.buffer.byteLength)throw new Error("Length in header does not match actual data length: "+o+" != "+e.buffer.byteLength);switch(i){case 1:r=n._unpackBinaryV1Async(e,o);break;case 2:r=n._unpackBinaryV2Async(e,o);break;default:throw new Error("Unsupported version: "+i)}return n._endPerformanceCounter("Unpack Binary"),r}))},e.prototype._unpackBinaryV1Async=function(e,n){var t=e.readUint32(),i=e.readUint32();if(0!==i)throw new Error("Unexpected content format: "+i);var r=n-e.byteOffset,o={json:this._parseJson(e.readString(t)),bin:null};if(0!==r){var a=e.byteOffset;o.bin={readAsync:function(n,t){return e.buffer.readAsync(a+n,t)},byteLength:r}}return Promise.resolve(o)},e.prototype._unpackBinaryV2Async=function(e,n){var t=this,i=1313821514,r=5130562,o=e.readUint32();if(e.readUint32()!==i)throw new Error("First chunk format is not JSON");return e.byteOffset+o===n?e.loadAsync(o).then((function(){return{json:t._parseJson(e.readString(o)),bin:null}})):e.loadAsync(o+8).then((function(){var a={json:t._parseJson(e.readString(o)),bin:null},s=function(){var t=e.readUint32();switch(e.readUint32()){case i:throw new Error("Unexpected JSON chunk");case r:var o=e.byteOffset;a.bin={readAsync:function(n,t){return e.buffer.readAsync(o+n,t)},byteLength:t},e.skipBytes(t);break;default:e.skipBytes(t)}return e.byteOffset!==n?e.loadAsync(8).then(s):Promise.resolve(a)};return s()}))},e._parseVersion=function(e){if("1.0"===e||"1.0.1"===e)return{major:1,minor:0};var n=(e+"").match(/^(\d+)\.(\d+)/);return n?{major:parseInt(n[1]),minor:parseInt(n[2])}:null},e._compareVersion=function(e,n){return e.major>n.major?1:e.major<n.major?-1:e.minor>n.minor?1:e.minor<n.minor?-1:0},e.prototype._logOpen=function(e){this._log(e),this._logIndentLevel++},e.prototype._logClose=function(){--this._logIndentLevel},e.prototype._logEnabled=function(t){var i=e._logSpaces.substr(0,2*this._logIndentLevel);n.Log(""+i+t)},e.prototype._logDisabled=function(e){},e.prototype._startPerformanceCounterEnabled=function(e){r.StartPerformanceCounter(e)},e.prototype._startPerformanceCounterDisabled=function(e){},e.prototype._endPerformanceCounterEnabled=function(e){r.EndPerformanceCounter(e)},e.prototype._endPerformanceCounterDisabled=function(e){},e.IncrementalLoading=!0,e.HomogeneousCoordinates=!1,e.magicBase64Encoded="Z2xURg",e._logSpaces="                                ",e}();Ue&&Ue.RegisterPlugin(new hn),(Ze=qe||(qe={}))[Ze.BYTE=5120]="BYTE",Ze[Ze.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",Ze[Ze.SHORT=5122]="SHORT",Ze[Ze.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",Ze[Ze.FLOAT=5126]="FLOAT",($e=Je||(Je={}))[$e.FRAGMENT=35632]="FRAGMENT",$e[$e.VERTEX=35633]="VERTEX",(nn=en||(en={}))[nn.BYTE=5120]="BYTE",nn[nn.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",nn[nn.SHORT=5122]="SHORT",nn[nn.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",nn[nn.INT=5124]="INT",nn[nn.UNSIGNED_INT=5125]="UNSIGNED_INT",nn[nn.FLOAT=5126]="FLOAT",nn[nn.FLOAT_VEC2=35664]="FLOAT_VEC2",nn[nn.FLOAT_VEC3=35665]="FLOAT_VEC3",nn[nn.FLOAT_VEC4=35666]="FLOAT_VEC4",nn[nn.INT_VEC2=35667]="INT_VEC2",nn[nn.INT_VEC3=35668]="INT_VEC3",nn[nn.INT_VEC4=35669]="INT_VEC4",nn[nn.BOOL=35670]="BOOL",nn[nn.BOOL_VEC2=35671]="BOOL_VEC2",nn[nn.BOOL_VEC3=35672]="BOOL_VEC3",nn[nn.BOOL_VEC4=35673]="BOOL_VEC4",nn[nn.FLOAT_MAT2=35674]="FLOAT_MAT2",nn[nn.FLOAT_MAT3=35675]="FLOAT_MAT3",nn[nn.FLOAT_MAT4=35676]="FLOAT_MAT4",nn[nn.SAMPLER_2D=35678]="SAMPLER_2D",(rn=tn||(tn={}))[rn.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",rn[rn.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",rn[rn.REPEAT=10497]="REPEAT",(an=on||(on={}))[an.NEAREST=9728]="NEAREST",an[an.LINEAR=9728]="LINEAR",an[an.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",an[an.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",an[an.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",an[an.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",(ln=sn||(sn={}))[ln.ALPHA=6406]="ALPHA",ln[ln.RGB=6407]="RGB",ln[ln.RGBA=6408]="RGBA",ln[ln.LUMINANCE=6409]="LUMINANCE",ln[ln.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",(fn=cn||(cn={}))[fn.FRONT=1028]="FRONT",fn[fn.BACK=1029]="BACK",fn[fn.FRONT_AND_BACK=1032]="FRONT_AND_BACK",(dn=un||(un={}))[dn.ZERO=0]="ZERO",dn[dn.ONE=1]="ONE",dn[dn.SRC_COLOR=768]="SRC_COLOR",dn[dn.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",dn[dn.DST_COLOR=774]="DST_COLOR",dn[dn.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",dn[dn.SRC_ALPHA=770]="SRC_ALPHA",dn[dn.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",dn[dn.DST_ALPHA=772]="DST_ALPHA",dn[dn.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",dn[dn.CONSTANT_COLOR=32769]="CONSTANT_COLOR",dn[dn.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",dn[dn.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",dn[dn.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",dn[dn.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE";var pn=function(){function e(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this._keys=new Array}return e.prototype.attachControl=function(e){var n=this;e=r.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add((function(){n._keys=[]})),this._onKeyboardObserver=this._scene.onKeyboardObservable.add((function(t){var i,r=t.event;r.metaKey||(t.type===p.KEYDOWN?-1===n.keysUp.indexOf(r.keyCode)&&-1===n.keysDown.indexOf(r.keyCode)&&-1===n.keysLeft.indexOf(r.keyCode)&&-1===n.keysRight.indexOf(r.keyCode)&&-1===n.keysUpward.indexOf(r.keyCode)&&-1===n.keysDownward.indexOf(r.keyCode)||(-1===(i=n._keys.indexOf(r.keyCode))&&n._keys.push(r.keyCode),e||r.preventDefault()):-1===n.keysUp.indexOf(r.keyCode)&&-1===n.keysDown.indexOf(r.keyCode)&&-1===n.keysLeft.indexOf(r.keyCode)&&-1===n.keysRight.indexOf(r.keyCode)&&-1===n.keysUpward.indexOf(r.keyCode)&&-1===n.keysDownward.indexOf(r.keyCode)||((i=n._keys.indexOf(r.keyCode))>=0&&n._keys.splice(i,1),e||r.preventDefault()))})))},e.prototype.detachControl=function(e){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys=[]},e.prototype.checkInputs=function(){if(this._onKeyboardObserver)for(var e=this.camera,n=0;n<this._keys.length;n++){var t=this._keys[n],i=e._computeLocalCameraSpeed();-1!==this.keysLeft.indexOf(t)?e._localDirection.copyFromFloats(-i,0,0):-1!==this.keysUp.indexOf(t)?e._localDirection.copyFromFloats(0,0,i):-1!==this.keysRight.indexOf(t)?e._localDirection.copyFromFloats(i,0,0):-1!==this.keysDown.indexOf(t)?e._localDirection.copyFromFloats(0,0,-i):-1!==this.keysUpward.indexOf(t)?e._localDirection.copyFromFloats(0,i,0):-1!==this.keysDownward.indexOf(t)&&e._localDirection.copyFromFloats(0,-i,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),m.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}},e.prototype.getClassName=function(){return"FreeCameraKeyboardMoveInput"},e.prototype._onLostFocus=function(){this._keys=[]},e.prototype.getSimpleName=function(){return"keyboard"},d([h()],e.prototype,"keysUp",void 0),d([h()],e.prototype,"keysUpward",void 0),d([h()],e.prototype,"keysDown",void 0),d([h()],e.prototype,"keysDownward",void 0),d([h()],e.prototype,"keysLeft",void 0),d([h()],e.prototype,"keysRight",void 0),e}();_.FreeCameraKeyboardMoveInput=pn;var mn=function(){function e(e){void 0===e&&(e=!0),this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this.previousPosition=null,this.onPointerMovedObservable=new a,this._allowCameraRotation=!0}return e.prototype.attachControl=function(e){var n=this;e=r.BackCompatCameraNoPreventDefault(arguments);var t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=function(r){var o=r.event;if(!t.isInVRExclusivePointerMode&&(n.touchEnabled||"touch"!==o.pointerType)&&(r.type===v.POINTERMOVE||-1!==n.buttons.indexOf(o.button))){var a=o.srcElement||o.target;if(r.type===v.POINTERDOWN&&a){try{a.setPointerCapture(o.pointerId)}catch(c){}n.previousPosition={x:o.clientX,y:o.clientY},e||(o.preventDefault(),i&&i.focus()),t.isPointerLock&&n._onMouseMove&&n._onMouseMove(r.event)}else if(r.type===v.POINTERUP&&a){try{a.releasePointerCapture(o.pointerId)}catch(c){}n.previousPosition=null,e||o.preventDefault()}else if(r.type===v.POINTERMOVE){if(!n.previousPosition)return void(t.isPointerLock&&n._onMouseMove&&n._onMouseMove(r.event));var s=o.clientX-n.previousPosition.x,l=o.clientY-n.previousPosition.y;n.camera.getScene().useRightHandedSystem&&(s*=-1),n.camera.parent&&n.camera.parent._getWorldMatrixDeterminant()<0&&(s*=-1),n._allowCameraRotation&&(n.camera.cameraRotation.y+=s/n.angularSensibility,n.camera.cameraRotation.x+=l/n.angularSensibility),n.onPointerMovedObservable.notifyObservers({offsetX:s,offsetY:l}),n.previousPosition={x:o.clientX,y:o.clientY},e||o.preventDefault()}}}),this._onMouseMove=function(i){if(t.isPointerLock&&!t.isInVRExclusivePointerMode){var r=i.movementX||i.mozMovementX||i.webkitMovementX||i.msMovementX||0;n.camera.getScene().useRightHandedSystem&&(r*=-1),n.camera.parent&&n.camera.parent._getWorldMatrixDeterminant()<0&&(r*=-1),n.camera.cameraRotation.y+=r/n.angularSensibility;var o=i.movementY||i.mozMovementY||i.webkitMovementY||i.msMovementY||0;n.camera.cameraRotation.x+=o/n.angularSensibility,n.previousPosition=null,e||i.preventDefault()}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,v.POINTERDOWN|v.POINTERUP|v.POINTERMOVE),i&&i.addEventListener("contextmenu",this.onContextMenu.bind(this),!1)},e.prototype.onContextMenu=function(e){e.preventDefault()},e.prototype.detachControl=function(e){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this.onContextMenu){var n=this.camera.getEngine().getInputElement();n&&n.removeEventListener("contextmenu",this.onContextMenu)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this.previousPosition=null}},e.prototype.getClassName=function(){return"FreeCameraMouseInput"},e.prototype.getSimpleName=function(){return"mouse"},d([h()],e.prototype,"buttons",void 0),d([h()],e.prototype,"angularSensibility",void 0),e}();_.FreeCameraMouseInput=mn;var _n,vn,An=function(){function e(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new a,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}return e.prototype.attachControl=function(e){var n=this;e=r.BackCompatCameraNoPreventDefault(arguments),this._wheel=function(t){if(t.type===v.POINTERWHEEL){var i=t.event,r=i.deltaMode===WheelEvent.DOM_DELTA_LINE?n._ffMultiplier:1;void 0!==i.deltaY?(n._wheelDeltaX+=n.wheelPrecisionX*r*i.deltaX/n._normalize,n._wheelDeltaY-=n.wheelPrecisionY*r*i.deltaY/n._normalize,n._wheelDeltaZ+=n.wheelPrecisionZ*r*i.deltaZ/n._normalize):void 0!==i.wheelDeltaY?(n._wheelDeltaX+=n.wheelPrecisionX*r*i.wheelDeltaX/n._normalize,n._wheelDeltaY-=n.wheelPrecisionY*r*i.wheelDeltaY/n._normalize,n._wheelDeltaZ+=n.wheelPrecisionZ*r*i.wheelDeltaZ/n._normalize):i.wheelDelta&&(n._wheelDeltaY-=n.wheelPrecisionY*i.wheelDelta/n._normalize),i.preventDefault&&(e||i.preventDefault())}},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,v.POINTERWHEEL)},e.prototype.detachControl=function(e){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()},e.prototype.checkInputs=function(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0},e.prototype.getClassName=function(){return"BaseCameraMouseWheelInput"},e.prototype.getSimpleName=function(){return"mousewheel"},d([h()],e.prototype,"wheelPrecisionX",void 0),d([h()],e.prototype,"wheelPrecisionY",void 0),d([h()],e.prototype,"wheelPrecisionZ",void 0),e}();(vn=_n||(_n={}))[vn.MoveRelative=0]="MoveRelative",vn[vn.RotateRelative=1]="RotateRelative",vn[vn.MoveScene=2]="MoveScene";var gn=function(e){function n(){var n=null!==e&&e.apply(this,arguments)||this;return n._moveRelative=m.Zero(),n._rotateRelative=m.Zero(),n._moveScene=m.Zero(),n._wheelXAction=_n.MoveRelative,n._wheelXActionCoordinate=g.X,n._wheelYAction=_n.MoveRelative,n._wheelYActionCoordinate=g.Z,n._wheelZAction=null,n._wheelZActionCoordinate=null,n}return l(n,e),n.prototype.getClassName=function(){return"FreeCameraMouseWheelInput"},Object.defineProperty(n.prototype,"wheelXMoveRelative",{get:function(){return this._wheelXAction!==_n.MoveRelative?null:this._wheelXActionCoordinate},set:function(e){null===e&&this._wheelXAction!==_n.MoveRelative||(this._wheelXAction=_n.MoveRelative,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYMoveRelative",{get:function(){return this._wheelYAction!==_n.MoveRelative?null:this._wheelYActionCoordinate},set:function(e){null===e&&this._wheelYAction!==_n.MoveRelative||(this._wheelYAction=_n.MoveRelative,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZMoveRelative",{get:function(){return this._wheelZAction!==_n.MoveRelative?null:this._wheelZActionCoordinate},set:function(e){null===e&&this._wheelZAction!==_n.MoveRelative||(this._wheelZAction=_n.MoveRelative,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelXRotateRelative",{get:function(){return this._wheelXAction!==_n.RotateRelative?null:this._wheelXActionCoordinate},set:function(e){null===e&&this._wheelXAction!==_n.RotateRelative||(this._wheelXAction=_n.RotateRelative,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYRotateRelative",{get:function(){return this._wheelYAction!==_n.RotateRelative?null:this._wheelYActionCoordinate},set:function(e){null===e&&this._wheelYAction!==_n.RotateRelative||(this._wheelYAction=_n.RotateRelative,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZRotateRelative",{get:function(){return this._wheelZAction!==_n.RotateRelative?null:this._wheelZActionCoordinate},set:function(e){null===e&&this._wheelZAction!==_n.RotateRelative||(this._wheelZAction=_n.RotateRelative,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelXMoveScene",{get:function(){return this._wheelXAction!==_n.MoveScene?null:this._wheelXActionCoordinate},set:function(e){null===e&&this._wheelXAction!==_n.MoveScene||(this._wheelXAction=_n.MoveScene,this._wheelXActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelYMoveScene",{get:function(){return this._wheelYAction!==_n.MoveScene?null:this._wheelYActionCoordinate},set:function(e){null===e&&this._wheelYAction!==_n.MoveScene||(this._wheelYAction=_n.MoveScene,this._wheelYActionCoordinate=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"wheelZMoveScene",{get:function(){return this._wheelZAction!==_n.MoveScene?null:this._wheelZActionCoordinate},set:function(e){null===e&&this._wheelZAction!==_n.MoveScene||(this._wheelZAction=_n.MoveScene,this._wheelZActionCoordinate=e)},enumerable:!1,configurable:!0}),n.prototype.checkInputs=function(){if(0!==this._wheelDeltaX||0!==this._wheelDeltaY||0!=this._wheelDeltaZ){this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);var n=A.Zero();this.camera.getViewMatrix().invertToRef(n);var t=m.Zero();m.TransformNormalToRef(this._moveRelative,n,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),e.prototype.checkInputs.call(this)}},n.prototype._updateCamera=function(){var e=this._moveRelative,n=this._rotateRelative,t=this._moveScene,i=function(i,r,o){if(0!==i&&null!==r&&null!==o){var a=null;switch(r){case _n.MoveRelative:a=e;break;case _n.RotateRelative:a=n;break;case _n.MoveScene:a=t}switch(o){case g.X:a.set(i,0,0);break;case g.Y:a.set(0,i,0);break;case g.Z:a.set(0,0,i)}}};i(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),i(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),i(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)},d([h()],n.prototype,"wheelXMoveRelative",null),d([h()],n.prototype,"wheelYMoveRelative",null),d([h()],n.prototype,"wheelZMoveRelative",null),d([h()],n.prototype,"wheelXRotateRelative",null),d([h()],n.prototype,"wheelYRotateRelative",null),d([h()],n.prototype,"wheelZRotateRelative",null),d([h()],n.prototype,"wheelXMoveScene",null),d([h()],n.prototype,"wheelYMoveScene",null),d([h()],n.prototype,"wheelZMoveScene",null),n}(An);_.FreeCameraMouseWheelInput=gn;var En=function(){function e(e){void 0===e&&(e=!1),this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array}return e.prototype.attachControl=function(e){var n=this;e=r.BackCompatCameraNoPreventDefault(arguments);var t=null;if(void 0===this._pointerInput&&(this._onLostFocus=function(){n._offsetX=null,n._offsetY=null},this._pointerInput=function(i){var r=i.event,o=!n.camera.getEngine().hostInformation.isMobile&&r instanceof MouseEvent;if(n.allowMouse||"mouse"!==r.pointerType&&!o)if(i.type===v.POINTERDOWN){if(e||r.preventDefault(),n._pointerPressed.push(r.pointerId),1!==n._pointerPressed.length)return;t={x:r.clientX,y:r.clientY}}else if(i.type===v.POINTERUP){if(e||r.preventDefault(),-1===(a=n._pointerPressed.indexOf(r.pointerId)))return;if(n._pointerPressed.splice(a,1),0!=a)return;t=null,n._offsetX=null,n._offsetY=null}else if(i.type===v.POINTERMOVE){if(e||r.preventDefault(),!t)return;var a;if(0!=(a=n._pointerPressed.indexOf(r.pointerId)))return;n._offsetX=r.clientX-t.x,n._offsetY=-(r.clientY-t.y)}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,v.POINTERDOWN|v.POINTERUP|v.POINTERMOVE),this._onLostFocus){var i=this.camera.getEngine(),o=i.getInputElement();o&&o.addEventListener("blur",this._onLostFocus)}},e.prototype.detachControl=function(e){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){var n=this.camera.getEngine().getInputElement();n&&n.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed=[],this._offsetX=null,this._offsetY=null}},e.prototype.checkInputs=function(){if(null!==this._offsetX&&null!==this._offsetY&&(0!==this._offsetX||0!==this._offsetY)){var e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{var n=e._computeLocalCameraSpeed(),t=new m(0,0,n*this._offsetY/this.touchMoveSensibility);A.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(m.TransformCoordinates(t,e._cameraRotationMatrix))}}},e.prototype.getClassName=function(){return"FreeCameraTouchInput"},e.prototype.getSimpleName=function(){return"touch"},d([h()],e.prototype,"touchAngularSensibility",void 0),d([h()],e.prototype,"touchMoveSensibility",void 0),e}();_.FreeCameraTouchInput=En;var Tn=function(e){function n(n){var t=e.call(this,n)||this;return t._mouseInput=null,t._mouseWheelInput=null,t}return l(n,e),n.prototype.addKeyboard=function(){return this.add(new pn),this},n.prototype.addMouse=function(e){return void 0===e&&(e=!0),this._mouseInput||(this._mouseInput=new mn(e),this.add(this._mouseInput)),this},n.prototype.removeMouse=function(){return this._mouseInput&&this.remove(this._mouseInput),this},n.prototype.addMouseWheel=function(){return this._mouseWheelInput||(this._mouseWheelInput=new gn,this.add(this._mouseWheelInput)),this},n.prototype.removeMouseWheel=function(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this},n.prototype.addTouch=function(){return this.add(new En),this},n.prototype.clear=function(){e.prototype.clear.call(this),this._mouseInput=null},n}(E),yn=function(e){function n(n,t,r,o){void 0===o&&(o=!0);var a=e.call(this,n,t,r,o)||this;return a.ellipsoid=new m(.5,1,.5),a.ellipsoidOffset=new m(0,0,0),a.checkCollisions=!1,a.applyGravity=!1,a._needMoveForGravity=!1,a._oldPosition=m.Zero(),a._diffPosition=m.Zero(),a._newPosition=m.Zero(),a._collisionMask=-1,a._onCollisionPositionChange=function(e,n,t){void 0===t&&(t=null);var r;r=n,a._newPosition.copyFrom(r),a._newPosition.subtractToRef(a._oldPosition,a._diffPosition),a._diffPosition.length()>i.CollisionsEpsilon&&(a.position.addInPlace(a._diffPosition),a.onCollide&&t&&a.onCollide(t))},a.inputs=new Tn(a),a.inputs.addKeyboard().addMouse(),a}return l(n,e),Object.defineProperty(n.prototype,"angularSensibility",{get:function(){var e=this.inputs.attached.mouse;return e?e.angularSensibility:0},set:function(e){var n=this.inputs.attached.mouse;n&&(n.angularSensibility=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysUp",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUp:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysUp=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysUpward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysUpward:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysUpward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysDown",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDown:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysDown=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysDownward",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysDownward:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysDownward=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysLeft",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysLeft:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysLeft=e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"keysRight",{get:function(){var e=this.inputs.attached.keyboard;return e?e.keysRight:[]},set:function(e){var n=this.inputs.attached.keyboard;n&&(n.keysRight=e)},enumerable:!1,configurable:!0}),n.prototype.attachControl=function(e,n){n=r.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(n)},n.prototype.detachControl=function(e){this.inputs.detachElement(),this.cameraDirection=new m(0,0,0),this.cameraRotation=new T(0,0)},Object.defineProperty(n.prototype,"collisionMask",{get:function(){return this._collisionMask},set:function(e){this._collisionMask=isNaN(e)?-1:e},enumerable:!1,configurable:!0}),n.prototype._collideWithWorld=function(e){(this.parent?m.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position).subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);var n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;var t=e;this.applyGravity&&(t=e.add(this.getScene().gravity)),n.getNewPosition(this._oldPosition,t,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)},n.prototype._checkInputs=function(){this._localDirection||(this._localDirection=m.Zero(),this._transformedDirection=m.Zero()),this.inputs.checkInputs(),e.prototype._checkInputs.call(this)},n.prototype._decideIfNeedsToMove=function(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0},n.prototype._updatePosition=function(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):e.prototype._updatePosition.call(this)},n.prototype.dispose=function(){this.inputs.clear(),e.prototype.dispose.call(this)},n.prototype.getClassName=function(){return"FreeCamera"},d([y()],n.prototype,"ellipsoid",void 0),d([y()],n.prototype,"ellipsoidOffset",void 0),d([h()],n.prototype,"checkCollisions",void 0),d([h()],n.prototype,"applyGravity",void 0),n}(R),Rn=function(e){function n(n,t,i,r,o,a,s){void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),void 0===s&&(s=null);var l=e.call(this,n,t.getScene())||this;return l.name=n,l.children=new Array,l.animations=new Array,l._index=null,l._absoluteTransform=new A,l._invertedAbsoluteTransform=new A,l._scalingDeterminant=1,l._worldTransform=new A,l._needToDecompose=!0,l._needToCompose=!1,l._linkedTransformNode=null,l._waitingTransformNodeId=null,l._skeleton=t,l._localMatrix=r?r.clone():A.Identity(),l._restPose=o||l._localMatrix.clone(),l._bindPose=l._localMatrix.clone(),l._baseMatrix=a||l._localMatrix.clone(),l._index=s,t.bones.push(l),l.setParent(i,!1),(a||r)&&l._updateDifferenceMatrix(),l}return l(n,e),Object.defineProperty(n.prototype,"_matrix",{get:function(){return this._compose(),this._localMatrix},set:function(e){this._localMatrix.copyFrom(e),this._needToDecompose=!0},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"Bone"},n.prototype.getSkeleton=function(){return this._skeleton},n.prototype.getParent=function(){return this._parent},n.prototype.getChildren=function(){return this.children},n.prototype.getIndex=function(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index},n.prototype.setParent=function(e,n){if(void 0===n&&(n=!0),this._parent!==e){if(this._parent){var t=this._parent.children.indexOf(this);-1!==t&&this._parent.children.splice(t,1)}this._parent=e,this._parent&&this._parent.children.push(this),n&&this._updateDifferenceMatrix(),this.markAsDirty()}},n.prototype.getLocalMatrix=function(){return this._compose(),this._localMatrix},n.prototype.getBaseMatrix=function(){return this._baseMatrix},n.prototype.getRestPose=function(){return this._restPose},n.prototype.setRestPose=function(e){this._restPose.copyFrom(e)},n.prototype.getBindPose=function(){return this._bindPose},n.prototype.setBindPose=function(e){this._bindPose.copyFrom(e)},n.prototype.getWorldMatrix=function(){return this._worldTransform},n.prototype.returnToRest=function(){this._skeleton._numBonesWithLinkedTransformNode>0?this.updateMatrix(this._restPose,!1,!1):this.updateMatrix(this._restPose,!1,!0)},n.prototype.getInvertedAbsoluteTransform=function(){return this._invertedAbsoluteTransform},n.prototype.getAbsoluteTransform=function(){return this._absoluteTransform},n.prototype.linkTransformNode=function(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},n.prototype.getTransformNode=function(){return this._linkedTransformNode},Object.defineProperty(n.prototype,"position",{get:function(){return this._decompose(),this._localPosition},set:function(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotation",{get:function(){return this.getRotation()},set:function(e){this.setRotation(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotationQuaternion",{get:function(){return this._decompose(),this._localRotation},set:function(e){this.setRotationQuaternion(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"scaling",{get:function(){return this.getScale()},set:function(e){this.setScale(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"animationPropertiesOverride",{get:function(){return this._skeleton.animationPropertiesOverride},enumerable:!1,configurable:!0}),n.prototype._decompose=function(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=m.Zero(),this._localRotation=C.Zero(),this._localPosition=m.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))},n.prototype._compose=function(){this._needToCompose&&(this._localScaling?(this._needToCompose=!1,A.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)):this._needToCompose=!1)},n.prototype.updateMatrix=function(e,n,t){void 0===n&&(n=!0),void 0===t&&(t=!0),this._baseMatrix.copyFrom(e),n&&this._updateDifferenceMatrix(),t?(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose()):this.markAsDirty()},n.prototype._updateDifferenceMatrix=function(e,n){if(void 0===n&&(n=!0),e||(e=this._baseMatrix),this._parent?e.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),n)for(var t=0;t<this.children.length;t++)this.children[t]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1},n.prototype.markAsDirty=function(){this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty()},n.prototype._markAsDirtyAndCompose=function(){this.markAsDirty(),this._needToCompose=!0},n.prototype._markAsDirtyAndDecompose=function(){this.markAsDirty(),this._needToDecompose=!0},n.prototype.translate=function(e,t,i){void 0===t&&(t=b.LOCAL);var r=this.getLocalMatrix();if(t==b.LOCAL)r.addAtIndex(12,e.x),r.addAtIndex(13,e.y),r.addAtIndex(14,e.z);else{var o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var a=n._tmpMats[0],s=n._tmpVecs[0];this._parent?i&&o?(a.copyFrom(this._parent.getAbsoluteTransform()),a.multiplyToRef(o,a)):a.copyFrom(this._parent.getAbsoluteTransform()):A.IdentityToRef(a),a.setTranslationFromFloats(0,0,0),a.invert(),m.TransformCoordinatesToRef(e,a,s),r.addAtIndex(12,s.x),r.addAtIndex(13,s.y),r.addAtIndex(14,s.z)}this._markAsDirtyAndDecompose()},n.prototype.setPosition=function(e,t,i){void 0===t&&(t=b.LOCAL);var r=this.getLocalMatrix();if(t==b.LOCAL)r.setTranslationFromFloats(e.x,e.y,e.z);else{var o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var a=n._tmpMats[0],s=n._tmpVecs[0];this._parent?(i&&o?(a.copyFrom(this._parent.getAbsoluteTransform()),a.multiplyToRef(o,a)):a.copyFrom(this._parent.getAbsoluteTransform()),a.invert()):A.IdentityToRef(a),m.TransformCoordinatesToRef(e,a,s),r.setTranslationFromFloats(s.x,s.y,s.z)}this._markAsDirtyAndDecompose()},n.prototype.setAbsolutePosition=function(e,n){this.setPosition(e,b.WORLD,n)},n.prototype.scale=function(e,t,i,r){void 0===r&&(r=!1);var o=this.getLocalMatrix(),a=n._tmpMats[0];A.ScalingToRef(e,t,i,a),a.multiplyToRef(o,o),a.invert();for(var s=0,l=this.children;s<l.length;s++){var c=(d=l[s]).getLocalMatrix();c.multiplyToRef(a,c),c.multiplyAtIndex(12,e),c.multiplyAtIndex(13,t),c.multiplyAtIndex(14,i),d._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(var f=0,u=this.children;f<u.length;f++){var d;(d=u[f]).scale(e,t,i,r)}},n.prototype.setScale=function(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()},n.prototype.getScale=function(){return this._decompose(),this._localScaling},n.prototype.getScaleToRef=function(e){this._decompose(),e.copyFrom(this._localScaling)},n.prototype.setYawPitchRoll=function(e,t,i,r,o){if(void 0===r&&(r=b.LOCAL),r===b.LOCAL){var a=n._tmpQuat;return C.RotationYawPitchRollToRef(e,t,i,a),void this.setRotationQuaternion(a,r,o)}var s=n._tmpMats[0];if(this._getNegativeRotationToRef(s,o)){var l=n._tmpMats[1];A.RotationYawPitchRollToRef(e,t,i,l),s.multiplyToRef(l,l),this._rotateWithMatrix(l,r,o)}},n.prototype.rotate=function(e,t,i,r){void 0===i&&(i=b.LOCAL);var o=n._tmpMats[0];o.setTranslationFromFloats(0,0,0),A.RotationAxisToRef(e,t,o),this._rotateWithMatrix(o,i,r)},n.prototype.setAxisAngle=function(e,t,i,r){if(void 0===i&&(i=b.LOCAL),i===b.LOCAL){var o=n._tmpQuat;return C.RotationAxisToRef(e,t,o),void this.setRotationQuaternion(o,i,r)}var a=n._tmpMats[0];if(this._getNegativeRotationToRef(a,r)){var s=n._tmpMats[1];A.RotationAxisToRef(e,t,s),a.multiplyToRef(s,s),this._rotateWithMatrix(s,i,r)}},n.prototype.setRotation=function(e,n,t){void 0===n&&(n=b.LOCAL),this.setYawPitchRoll(e.y,e.x,e.z,n,t)},n.prototype.setRotationQuaternion=function(e,t,i){if(void 0===t&&(t=b.LOCAL),t===b.LOCAL)return this._decompose(),this._localRotation.copyFrom(e),void this._markAsDirtyAndCompose();var r=n._tmpMats[0];if(this._getNegativeRotationToRef(r,i)){var o=n._tmpMats[1];A.FromQuaternionToRef(e,o),r.multiplyToRef(o,o),this._rotateWithMatrix(o,t,i)}},n.prototype.setRotationMatrix=function(e,t,i){if(void 0===t&&(t=b.LOCAL),t===b.LOCAL){var r=n._tmpQuat;return C.FromRotationMatrixToRef(e,r),void this.setRotationQuaternion(r,t,i)}var o=n._tmpMats[0];if(this._getNegativeRotationToRef(o,i)){var a=n._tmpMats[1];a.copyFrom(e),o.multiplyToRef(e,a),this._rotateWithMatrix(a,t,i)}},n.prototype._rotateWithMatrix=function(e,t,i){void 0===t&&(t=b.LOCAL);var r=this.getLocalMatrix(),o=r.m[12],a=r.m[13],s=r.m[14],l=this.getParent(),c=n._tmpMats[3],f=n._tmpMats[4];l&&t==b.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteTransform()),f.copyFrom(c),f.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(f,r)):t==b.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),f.copyFrom(c),f.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(f,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(o,a,s),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()},n.prototype._getNegativeRotationToRef=function(e,t){var i=n._tmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t&&(e.multiplyToRef(t.getWorldMatrix(),e),A.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)},n.prototype.getPosition=function(e,n){void 0===e&&(e=b.LOCAL),void 0===n&&(n=null);var t=m.Zero();return this.getPositionToRef(e,n,t),t},n.prototype.getPositionToRef=function(e,t,i){if(void 0===e&&(e=b.LOCAL),e==b.LOCAL){var r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{var o=null;t&&(o=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var a=n._tmpMats[0];t&&o?(a.copyFrom(this.getAbsoluteTransform()),a.multiplyToRef(o,a)):a=this.getAbsoluteTransform(),i.x=a.m[12],i.y=a.m[13],i.z=a.m[14]}},n.prototype.getAbsolutePosition=function(e){void 0===e&&(e=null);var n=m.Zero();return this.getPositionToRef(b.WORLD,e,n),n},n.prototype.getAbsolutePositionToRef=function(e,n){this.getPositionToRef(b.WORLD,e,n)},n.prototype.computeAbsoluteTransforms=function(){if(this._compose(),this._parent)this._localMatrix.multiplyToRef(this._parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);var e=this._skeleton.getPoseMatrix();e&&this._absoluteTransform.multiplyToRef(e,this._absoluteTransform)}for(var n=this.children,t=n.length,i=0;i<t;i++)n[i].computeAbsoluteTransforms()},n.prototype.getDirection=function(e,n){void 0===n&&(n=null);var t=m.Zero();return this.getDirectionToRef(e,n,t),t},n.prototype.getDirectionToRef=function(e,t,i){void 0===t&&(t=null);var r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=n._tmpMats[0];o.copyFrom(this.getAbsoluteTransform()),t&&r&&o.multiplyToRef(r,o),m.TransformNormalToRef(e,o,i),i.normalize()},n.prototype.getRotation=function(e,n){void 0===e&&(e=b.LOCAL),void 0===n&&(n=null);var t=m.Zero();return this.getRotationToRef(e,n,t),t},n.prototype.getRotationToRef=function(e,t,i){void 0===e&&(e=b.LOCAL),void 0===t&&(t=null);var r=n._tmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)},n.prototype.getRotationQuaternion=function(e,n){void 0===e&&(e=b.LOCAL),void 0===n&&(n=null);var t=C.Identity();return this.getRotationQuaternionToRef(e,n,t),t},n.prototype.getRotationQuaternionToRef=function(e,t,i){if(void 0===e&&(e=b.LOCAL),void 0===t&&(t=null),e==b.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{var r=n._tmpMats[0],o=this.getAbsoluteTransform();t?o.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(o),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}},n.prototype.getRotationMatrix=function(e,n){void 0===e&&(e=b.LOCAL);var t=A.Identity();return this.getRotationMatrixToRef(e,n,t),t},n.prototype.getRotationMatrixToRef=function(e,t,i){if(void 0===e&&(e=b.LOCAL),e==b.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{var r=n._tmpMats[0],o=this.getAbsoluteTransform();t?o.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(o),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}},n.prototype.getAbsolutePositionFromLocal=function(e,n){void 0===n&&(n=null);var t=m.Zero();return this.getAbsolutePositionFromLocalToRef(e,n,t),t},n.prototype.getAbsolutePositionFromLocalToRef=function(e,t,i){void 0===t&&(t=null);var r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=n._tmpMats[0];t&&r?(o.copyFrom(this.getAbsoluteTransform()),o.multiplyToRef(r,o)):o=this.getAbsoluteTransform(),m.TransformCoordinatesToRef(e,o,i)},n.prototype.getLocalPositionFromAbsolute=function(e,n){void 0===n&&(n=null);var t=m.Zero();return this.getLocalPositionFromAbsoluteToRef(e,n,t),t},n.prototype.getLocalPositionFromAbsoluteToRef=function(e,t,i){void 0===t&&(t=null);var r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();var o=n._tmpMats[0];o.copyFrom(this.getAbsoluteTransform()),t&&r&&o.multiplyToRef(r,o),o.invert(),m.TransformCoordinatesToRef(e,o,i)},n.prototype.setCurrentPoseAsRest=function(){this.setRestPose(this.getLocalMatrix())},n._tmpVecs=S.BuildArray(2,m.Zero),n._tmpQuat=C.Identity(),n._tmpMats=S.BuildArray(5,A.Identity),n}(I);function Cn(e,n,t,i){var r;r=1===i?new Float32Array(n*t*4):new Uint32Array(n*t*4);for(var o=0;o<n;o++)for(var a=0;a<t;a++){var s=3*(a*n+o),l=4*(a*n+o);r[l+0]=e[s+0],r[l+1]=e[s+1],r[l+2]=e[s+2],r[l+3]=1}return r}function bn(e){return function(n,t,i,r,o,a,s,l,c,f){void 0===c&&(c=null),void 0===f&&(f=0);var u=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=e?x.Raw3D:x.Raw2DArray,h=new M(this,d);h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=o,h.type=f,h.generateMipMaps=a,h.samplingMode=l,e?h.is3D=!0:h.is2DArray=!0,this._doNotHandleContextLost||(h._bufferView=n),e?this.updateRawTexture3D(h,n,o,s,c,f):this.updateRawTexture2DArray(h,n,o,s,c,f),this._bindTextureDirectly(u,h,!0);var p=this._getSamplingParameters(l,a);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,p.min),a&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(h),h}}function Sn(e){return function(n,t,i,r,o,a){void 0===o&&(o=null),void 0===a&&(a=0);var s=e?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(a),c=this._getInternalFormat(i),f=this._getRGBABufferInternalSizedFormat(a,i);this._bindTextureDirectly(s,n,!0),this._unpackFlipY(void 0===r||!!r),this._doNotHandleContextLost||(n._bufferView=t,n.format=i,n.invertY=r,n._compression=o),n.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),o&&t?this._gl.compressedTexImage3D(s,0,this.getCaps().s3tc[o],n.width,n.height,n.depth,0,t):this._gl.texImage3D(s,0,f,n.width,n.height,n.depth,0,c,l,t),n.generateMipMaps&&this._gl.generateMipmap(s),this._bindTextureDirectly(s,null),n.isReady=!0}}O.prototype.updateRawTexture=function(e,n,t,i,r,o){if(void 0===r&&(r=null),void 0===o&&(o=0),e){var a=this._getRGBABufferInternalSizedFormat(o,t),s=this._getInternalFormat(t),l=this._getWebGLTextureType(o);this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._unpackFlipY(void 0===i||!!i),this._doNotHandleContextLost||(e._bufferView=n,e.format=t,e.type=o,e.invertY=i,e._compression=r),e.width%4!=0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&n?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],e.width,e.height,0,n):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,e.width,e.height,0,s,l,n),e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}},O.prototype.createRawTexture=function(e,n,t,i,r,o,a,s,l){void 0===s&&(s=null),void 0===l&&(l=0);var c=new M(this,x.Raw);c.baseWidth=n,c.baseHeight=t,c.width=n,c.height=t,c.format=i,c.generateMipMaps=r,c.samplingMode=a,c.invertY=o,c._compression=s,c.type=l,this._doNotHandleContextLost||(c._bufferView=e),this.updateRawTexture(c,e,i,o,s,l),this._bindTextureDirectly(this._gl.TEXTURE_2D,c,!0);var f=this._getSamplingParameters(a,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,f.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,f.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(c),c},O.prototype.createRawCubeTexture=function(e,t,i,o,a,s,l,c){void 0===c&&(c=null);var f=this._gl,u=new M(this,x.CubeRaw);u.isCube=!0,u.format=i,u.type=o,this._doNotHandleContextLost||(u._bufferViewArray=e);var d=this._getWebGLTextureType(o),h=this._getInternalFormat(i);h===f.RGB&&(h=f.RGBA),d!==f.FLOAT||this._caps.textureFloatLinearFiltering?d!==this._gl.HALF_FLOAT_OES||this._caps.textureHalfFloatLinearFiltering?d!==f.FLOAT||this._caps.textureFloatRender?d!==f.HALF_FLOAT||this._caps.colorBufferFloat||(a=!1,n.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(a=!1,n.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(a=!1,l=1,n.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(a=!1,l=1,n.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively."));var p=t,m=p;u.width=p,u.height=m,!this.needPOTTextures||r.IsExponentOfTwo(u.width)&&r.IsExponentOfTwo(u.height)||(a=!1),e&&this.updateRawCubeTexture(u,e,i,o,s,c),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,u,!0),e&&a&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);var _=this._getSamplingParameters(l,a);return f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,_.mag),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,_.min),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null),u.generateMipMaps=a,u},O.prototype.updateRawCubeTexture=function(e,n,t,i,o,a,s){void 0===a&&(a=null),void 0===s&&(s=0),e._bufferViewArray=n,e.format=t,e.type=i,e.invertY=o,e._compression=a;var l=this._gl,c=this._getWebGLTextureType(i),f=this._getInternalFormat(t),u=this._getRGBABufferInternalSizedFormat(i),d=!1;f===l.RGB&&(f=l.RGBA,d=!0),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,e,!0),this._unpackFlipY(void 0===o||!!o),e.width%4!=0&&l.pixelStorei(l.UNPACK_ALIGNMENT,1);for(var h=0;h<6;h++){var p=n[h];a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+h,s,this.getCaps().s3tc[a],e.width,e.height,0,p):(d&&(p=Cn(p,e.width,e.height,i)),l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+h,s,u,e.width,e.height,0,f,c,p))}(!this.needPOTTextures||r.IsExponentOfTwo(e.width)&&r.IsExponentOfTwo(e.height))&&e.generateMipMaps&&0===s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),e.isReady=!0},O.prototype.createRawCubeTextureFromUrl=function(e,n,t,i,r,o,a,s,l,c,f,u){var d=this;void 0===l&&(l=null),void 0===c&&(c=null),void 0===f&&(f=3),void 0===u&&(u=!1);var h=this._gl,p=this.createRawCubeTexture(null,t,i,r,!o,u,f,null);null==n||n._addPendingData(p),p.url=e,this._internalTexturesCache.push(p);return this._loadFile(e,(function(e){!function(e){var t=p.width,o=a(e);if(o){if(s){var c=d._getWebGLTextureType(r),f=d._getInternalFormat(i),m=d._getRGBABufferInternalSizedFormat(r),_=!1;f===h.RGB&&(f=h.RGBA,_=!0),d._bindTextureDirectly(h.TEXTURE_CUBE_MAP,p,!0),d._unpackFlipY(!1);for(var v=s(o),A=0;A<v.length;A++)for(var g=t>>A,E=0;E<6;E++){var T=v[A][E];_&&(T=Cn(T,g,g,r)),h.texImage2D(E,A,m,g,g,0,f,c,T)}d._bindTextureDirectly(h.TEXTURE_CUBE_MAP,null)}else d.updateRawCubeTexture(p,o,i,r,u);p.isReady=!0,null==n||n._removePendingData(p),l&&l()}}(e)}),void 0,null==n?void 0:n.offlineProvider,!0,(function(e,t){null==n||n._removePendingData(p),c&&e&&c(e.status+" "+e.statusText,t)})),p},O.prototype.createRawTexture2DArray=bn(!1),O.prototype.createRawTexture3D=bn(!0),O.prototype.updateRawTexture2DArray=Sn(!1),O.prototype.updateRawTexture3D=Sn(!0);var In=function(e){function n(n,t,i,r,o,a,s,l,c){void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===l&&(l=3),void 0===c&&(c=0);var f=e.call(this,null,o,!a,s)||this;return f.format=r,f._engine?(f._texture=f._engine.createRawTexture(n,t,i,r,a,s,l,null,c),f.wrapU=ge.CLAMP_ADDRESSMODE,f.wrapV=ge.CLAMP_ADDRESSMODE,f):f}return l(n,e),n.prototype.update=function(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)},n.CreateLuminanceTexture=function(e,t,i,r,o,a,s){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=3),new n(e,t,i,1,r,o,a,s)},n.CreateLuminanceAlphaTexture=function(e,t,i,r,o,a,s){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=3),new n(e,t,i,2,r,o,a,s)},n.CreateAlphaTexture=function(e,t,i,r,o,a,s){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=3),new n(e,t,i,0,r,o,a,s)},n.CreateRGBTexture=function(e,t,i,r,o,a,s,l){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=3),void 0===l&&(l=0),new n(e,t,i,4,r,o,a,s,l)},n.CreateRGBATexture=function(e,t,i,r,o,a,s,l){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=3),void 0===l&&(l=0),new n(e,t,i,5,r,o,a,s,l)},n.CreateRTexture=function(e,t,i,r,o,a,s,l){return void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=ge.TRILINEAR_SAMPLINGMODE),void 0===l&&(l=1),new n(e,t,i,6,r,o,a,s,l)},n}(ge),On=function(){function e(e,n,t){this.name=e,this.id=n,this.bones=new Array,this.needInitialSkinMatrix=!1,this.overrideMesh=null,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=A.Identity(),this._ranges={},this._lastAbsoluteTransformsUpdateId=-1,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._waitingOverrideMeshId=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new a,this.bones=[],this._scene=t||s.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;var i=this._scene.getEngine().getCaps();this._canUseTextureForBones=i.textureFloat&&i.maxVertexTextureImageUnits>0}return Object.defineProperty(e.prototype,"useTextureToStoreBoneMatrices",{get:function(){return this._useTextureToStoreBoneMatrices},set:function(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animationPropertiesOverride",{get:function(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isUsingTextureForMatrices",{get:function(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),e.prototype.getClassName=function(){return"Skeleton"},e.prototype.getChildren=function(){return this.bones.filter((function(e){return!e.getParent()}))},e.prototype.getTransformMatrices=function(e){return this.needInitialSkinMatrix&&e._bonesTransformMatrices?e._bonesTransformMatrices:(this._transformMatrices||this.prepare(),this._transformMatrices)},e.prototype.getTransformMatrixTexture=function(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture},e.prototype.getScene=function(){return this._scene},e.prototype.toString=function(e){var n="Name: "+this.name+", nBones: "+this.bones.length;if(n+=", nAnimationRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){n+=", Ranges: {";var t=!0;for(var i in this._ranges)t&&(n+=", ",t=!1),n+=i;n+="}"}return n},e.prototype.getBoneIndexByName=function(e){for(var n=0,t=this.bones.length;n<t;n++)if(this.bones[n].name===e)return n;return-1},e.prototype.createAnimationRange=function(e,n,t){if(!this._ranges[e]){this._ranges[e]=new L(e,n,t);for(var i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].createRange(e,n,t)}},e.prototype.deleteAnimationRange=function(e,n){void 0===n&&(n=!0);for(var t=0,i=this.bones.length;t<i;t++)this.bones[t].animations[0]&&this.bones[t].animations[0].deleteRange(e,n);this._ranges[e]=null},e.prototype.getAnimationRange=function(e){return this._ranges[e]||null},e.prototype.getAnimationRanges=function(){var e,n=[];for(e in this._ranges)n.push(this._ranges[e]);return n},e.prototype.copyAnimationRange=function(e,t,i){if(void 0===i&&(i=!1),this._ranges[t]||!e.getAnimationRange(t))return!1;var r,o,a=!0,s=this._getHighestAnimationFrame()+1,l={},c=e.bones;for(o=0,r=c.length;o<r;o++)l[c[o].name]=c[o];this.bones.length!==c.length&&(n.Warn("copyAnimationRange: this rig has "+this.bones.length+" bones, while source as "+c.length),a=!1);var f=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(o=0,r=this.bones.length;o<r;o++){var u=this.bones[o].name,d=l[u];d?a=a&&this.bones[o].copyAnimationRange(d,t,s,i,f):(n.Warn("copyAnimationRange: not same rig, missing source bone "+u),a=!1)}var h=e.getAnimationRange(t);return h&&(this._ranges[t]=new L(t,h.from+s,h.to+s)),a},e.prototype.returnToRest=function(){for(var e=P.Vector3[0],n=P.Quaternion[0],t=P.Vector3[1],i=0;i<this.bones.length;i++){var r=this.bones[i];-1!==r._index&&(r.returnToRest(),r._linkedTransformNode&&(r.getRestPose().decompose(e,n,t),r._linkedTransformNode.position=t.clone(),r._linkedTransformNode.rotationQuaternion=n.clone(),r._linkedTransformNode.scaling=e.clone()))}},e.prototype._getHighestAnimationFrame=function(){for(var e=0,n=0,t=this.bones.length;n<t;n++)if(this.bones[n].animations[0]){var i=this.bones[n].animations[0].getHighestFrame();e<i&&(e=i)}return e},e.prototype.beginAnimation=function(e,n,t,i){var r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,n,t,i):null},e.MakeAnimationAdditive=function(e,n,t){void 0===n&&(n=0);var i=e.getAnimationRange(t);if(!i)return null;for(var r=e._scene.getAllAnimatablesByTarget(e),o=null,a=0;a<r.length;a++){var s=r[a];if(s.fromFrame===(null==i?void 0:i.from)&&s.toFrame===(null==i?void 0:i.to)){o=s;break}}var l=e.getAnimatables();for(a=0;a<l.length;a++){var c=l[a].animations;if(c)for(var f=0;f<c.length;f++)N.MakeAnimationAdditive(c[f],n,t)}return o&&(o.isAdditive=!0),e},e.prototype._markAsDirty=function(){this._isDirty=!0},e.prototype._registerMeshWithPoseMatrix=function(e){this._meshesWithPoseMatrix.push(e)},e.prototype._unregisterMeshWithPoseMatrix=function(e){var n=this._meshesWithPoseMatrix.indexOf(e);n>-1&&this._meshesWithPoseMatrix.splice(n,1)},e.prototype._computeTransformMatrices=function(e,n){this.onBeforeComputeObservable.notifyObservers(this);for(var t=0;t<this.bones.length;t++){var i=this.bones[t];i._childUpdateId++;var r=i.getParent();if(r?i.getLocalMatrix().multiplyToRef(r.getWorldMatrix(),i.getWorldMatrix()):n?i.getLocalMatrix().multiplyToRef(n,i.getWorldMatrix()):i.getWorldMatrix().copyFrom(i.getLocalMatrix()),-1!==i._index){var o=null===i._index?t:i._index;i.getInvertedAbsoluteTransform().multiplyToArray(i.getWorldMatrix(),e,16*o)}}this._identity.copyToArray(e,16*this.bones.length)},e.prototype.prepare=function(){if(this._numBonesWithLinkedTransformNode>0)for(var e=0,n=this.bones;e<n.length;e++){var t=n[e];t._linkedTransformNode&&(t._linkedTransformNode.computeWorldMatrix(),t._matrix=t._linkedTransformNode._localMatrix,t.markAsDirty())}if(this._isDirty){if(this.needInitialSkinMatrix)for(var i=0;i<this._meshesWithPoseMatrix.length;i++){var r=this._meshesWithPoseMatrix[i],o=r.getPoseMatrix();if(r._bonesTransformMatrices&&r._bonesTransformMatrices.length===16*(this.bones.length+1)||(r._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1))),this._synchronizedWithMesh!==r){this._synchronizedWithMesh=r;for(var a=0;a<this.bones.length;a++){var s=this.bones[a];if(!s.getParent())s.getBaseMatrix().multiplyToRef(o,P.Matrix[1]),s._updateDifferenceMatrix(P.Matrix[1])}if(this.isUsingTextureForMatrices){var l=4*(this.bones.length+1);r._transformMatrixTexture&&r._transformMatrixTexture.getSize().width===l||(r._transformMatrixTexture&&r._transformMatrixTexture.dispose(),r._transformMatrixTexture=In.CreateRGBATexture(r._bonesTransformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(r._bonesTransformMatrices,o),this.isUsingTextureForMatrices&&r._transformMatrixTexture&&r._transformMatrixTexture.update(r._bonesTransformMatrices)}else this._transformMatrices&&this._transformMatrices.length===16*(this.bones.length+1)||(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=In.CreateRGBATexture(this._transformMatrices,4*(this.bones.length+1),1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices);this._isDirty=!1,this._scene._activeBones.addCount(this.bones.length,!1)}},e.prototype.getAnimatables=function(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(var e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables},e.prototype.clone=function(n,t){var i=new e(n,t||n,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix,i.overrideMesh=this.overrideMesh;for(var r=0;r<this.bones.length;r++){var o=this.bones[r],a=null,s=o.getParent();if(s){var l=this.bones.indexOf(s);a=i.bones[l]}var c=new Rn(o.name,i,a,o.getBaseMatrix().clone(),o.getRestPose().clone());c._index=o._index,o._linkedTransformNode&&c.linkTransformNode(o._linkedTransformNode),D.DeepCopy(o.animations,c.animations)}if(this._ranges)for(var f in i._ranges={},this._ranges){var u=this._ranges[f];u&&(i._ranges[f]=u.clone())}return this._isDirty=!0,i},e.prototype.enableBlending=function(e){void 0===e&&(e=.01),this.bones.forEach((function(n){n.animations.forEach((function(n){n.enableBlending=!0,n.blendingSpeed=e}))}))},e.prototype.dispose=function(){this._meshesWithPoseMatrix=[],this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)},e.prototype.serialize=function(){var e,n,t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix,t.overrideMeshId=null===(e=this.overrideMesh)||void 0===e?void 0:e.id;for(var i=0;i<this.bones.length;i++){var r=this.bones[i],o=r.getParent(),a={parentBoneIndex:o?this.bones.indexOf(o):-1,index:r.getIndex(),name:r.name,matrix:r.getBaseMatrix().toArray(),rest:r.getRestPose().toArray(),linkedTransformNodeId:null===(n=r.getTransformNode())||void 0===n?void 0:n.id};for(var s in t.bones.push(a),r.length&&(a.length=r.length),r.metadata&&(a.metadata=r.metadata),r.animations&&r.animations.length>0&&(a.animation=r.animations[0].serialize()),t.ranges=[],this._ranges){var l=this._ranges[s];if(l){var c={};c.name=s,c.from=l.from,c.to=l.to,t.ranges.push(c)}}}return t},e.Parse=function(n,t){var i,r=new e(n.name,n.id,t);for(n.dimensionsAtRest&&(r.dimensionsAtRest=m.FromArray(n.dimensionsAtRest)),r.needInitialSkinMatrix=n.needInitialSkinMatrix,n.overrideMeshId&&(r._hasWaitingData=!0,r._waitingOverrideMeshId=n.overrideMeshId),i=0;i<n.bones.length;i++){var o=n.bones[i],a=n.bones[i].index,s=null;o.parentBoneIndex>-1&&(s=r.bones[o.parentBoneIndex]);var l=o.rest?A.FromArray(o.rest):null,c=new Rn(o.name,r,s,A.FromArray(o.matrix),l,null,a);void 0!==o.id&&null!==o.id&&(c.id=o.id),o.length&&(c.length=o.length),o.metadata&&(c.metadata=o.metadata),o.animation&&c.animations.push(N.Parse(o.animation)),void 0!==o.linkedTransformNodeId&&null!==o.linkedTransformNodeId&&(r._hasWaitingData=!0,c._waitingTransformNodeId=o.linkedTransformNodeId)}if(n.ranges)for(i=0;i<n.ranges.length;i++){var f=n.ranges[i];r.createAnimationRange(f.name,f.from,f.to)}return r},e.prototype.computeAbsoluteTransforms=function(e){void 0===e&&(e=!1);var n=this._scene.getRenderId();(this._lastAbsoluteTransformsUpdateId!=n||e)&&(this.bones[0].computeAbsoluteTransforms(),this._lastAbsoluteTransformsUpdateId=n)},e.prototype.getPoseMatrix=function(){var e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e},e.prototype.sortBones=function(){for(var e=new Array,n=new Array(this.bones.length),t=0;t<this.bones.length;t++)this._sortBones(t,e,n);this.bones=e},e.prototype._sortBones=function(e,n,t){if(!t[e]){t[e]=!0;var i=this.bones[e];void 0===i._index&&(i._index=e);var r=i.getParent();r&&this._sortBones(this.bones.indexOf(r),n,t),n.push(i)}},e.prototype.setCurrentPoseAsRest=function(){this.bones.forEach((function(e){e.setCurrentPoseAsRest()}))},e}(),Mn={effect:null,subMesh:null},xn=function(e){function n(n,t,i,r){void 0===r&&(r={});var o=e.call(this,n,t)||this;return o._textures={},o._textureArrays={},o._floats={},o._ints={},o._floatsArrays={},o._colors3={},o._colors3Arrays={},o._colors4={},o._colors4Arrays={},o._vectors2={},o._vectors3={},o._vectors4={},o._matrices={},o._matrixArrays={},o._matrices3x3={},o._matrices2x2={},o._vectors2Arrays={},o._vectors3Arrays={},o._vectors4Arrays={},o._cachedWorldViewMatrix=new A,o._cachedWorldViewProjectionMatrix=new A,o._multiview=!1,o._shaderPath=i,o._options=B({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],defines:[]},r),o}return l(n,e),Object.defineProperty(n.prototype,"shaderPath",{get:function(){return this._shaderPath},set:function(e){this._shaderPath=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"ShaderMaterial"},n.prototype.needAlphaBlending=function(){return this.alpha<1||this._options.needAlphaBlending},n.prototype.needAlphaTesting=function(){return this._options.needAlphaTesting},n.prototype._checkUniform=function(e){-1===this._options.uniforms.indexOf(e)&&this._options.uniforms.push(e)},n.prototype.setTexture=function(e,n){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._textures[e]=n,this},n.prototype.setTextureArray=function(e,n){return-1===this._options.samplers.indexOf(e)&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=n,this},n.prototype.setFloat=function(e,n){return this._checkUniform(e),this._floats[e]=n,this},n.prototype.setInt=function(e,n){return this._checkUniform(e),this._ints[e]=n,this},n.prototype.setFloats=function(e,n){return this._checkUniform(e),this._floatsArrays[e]=n,this},n.prototype.setColor3=function(e,n){return this._checkUniform(e),this._colors3[e]=n,this},n.prototype.setColor3Array=function(e,n){return this._checkUniform(e),this._colors3Arrays[e]=n.reduce((function(e,n){return n.toArray(e,e.length),e}),[]),this},n.prototype.setColor4=function(e,n){return this._checkUniform(e),this._colors4[e]=n,this},n.prototype.setColor4Array=function(e,n){return this._checkUniform(e),this._colors4Arrays[e]=n.reduce((function(e,n){return n.toArray(e,e.length),e}),[]),this},n.prototype.setVector2=function(e,n){return this._checkUniform(e),this._vectors2[e]=n,this},n.prototype.setVector3=function(e,n){return this._checkUniform(e),this._vectors3[e]=n,this},n.prototype.setVector4=function(e,n){return this._checkUniform(e),this._vectors4[e]=n,this},n.prototype.setMatrix=function(e,n){return this._checkUniform(e),this._matrices[e]=n,this},n.prototype.setMatrices=function(e,n){this._checkUniform(e);for(var t=new Float32Array(16*n.length),i=0;i<n.length;i++){n[i].copyToArray(t,16*i)}return this._matrixArrays[e]=t,this},n.prototype.setMatrix3x3=function(e,n){return this._checkUniform(e),this._matrices3x3[e]=n,this},n.prototype.setMatrix2x2=function(e,n){return this._checkUniform(e),this._matrices2x2[e]=n,this},n.prototype.setArray2=function(e,n){return this._checkUniform(e),this._vectors2Arrays[e]=n,this},n.prototype.setArray3=function(e,n){return this._checkUniform(e),this._vectors3Arrays[e]=n,this},n.prototype.setArray4=function(e,n){return this._checkUniform(e),this._vectors4Arrays[e]=n,this},n.prototype._checkCache=function(e,n){return!e||(!this._effect||-1!==this._effect.defines.indexOf("#define INSTANCES")===n)},n.prototype.isReadyForSubMesh=function(e,n,t){return this.isReady(e,t)},n.prototype.isReady=function(e,n){var t,i;if(this._effect&&this.isFrozen&&this._effect._wasPreviouslyReady)return!0;var r=this.getScene(),o=r.getEngine();if(!this.checkReadyOnEveryCall&&this._renderId===r.getRenderId()&&this._checkCache(e,n))return!0;var a=[],s=[],l=new Te;o.getCaps().multiview&&r.activeCamera&&r.activeCamera.outputRenderTarget&&r.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,a.push("#define MULTIVIEW"),-1!==this._options.uniforms.indexOf("viewProjection")&&-1===this._options.uniforms.push("viewProjectionR")&&this._options.uniforms.push("viewProjectionR"));for(var c=0;c<this._options.defines.length;c++)a.push(this._options.defines[c]);for(c=0;c<this._options.attributes.length;c++)s.push(this._options.attributes[c]);e&&e.isVerticesDataPresent(F.ColorKind)&&(s.push(F.ColorKind),a.push("#define VERTEXCOLOR")),n&&(a.push("#define INSTANCES"),Ee.PushAttributesForInstances(s),(null==e?void 0:e.hasThinInstances)&&a.push("#define THIN_INSTANCES"));var f=0;if(e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){s.push(F.MatricesIndicesKind),s.push(F.MatricesWeightsKind),e.numBoneInfluencers>4&&(s.push(F.MatricesIndicesExtraKind),s.push(F.MatricesWeightsExtraKind));var u=e.skeleton;f=e.numBoneInfluencers,a.push("#define NUM_BONE_INFLUENCERS "+f),l.addCPUSkinningFallback(0,e),u.isUsingTextureForMatrices?(a.push("#define BONETEXTURE"),-1===this._options.uniforms.indexOf("boneTextureWidth")&&this._options.uniforms.push("boneTextureWidth"),-1===this._options.samplers.indexOf("boneSampler")&&this._options.samplers.push("boneSampler")):(a.push("#define BonesPerMesh "+(u.bones.length+1)),-1===this._options.uniforms.indexOf("mBones")&&this._options.uniforms.push("mBones"))}else a.push("#define NUM_BONE_INFLUENCERS 0");for(var d in this._textures)if(!this._textures[d].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&a.push("#define ALPHATEST");var h=this._shaderPath,p=this._options.uniforms,m=this._options.uniformBuffers,_=this._options.samplers;this.customShaderNameResolve&&(p=p.slice(),m=m.slice(),_=_.slice(),h=this.customShaderNameResolve(h,p,m,_,a,s));var v=this._effect,A=a.join("\n");return this._cachedDefines!==A&&(this._cachedDefines=A,this._effect=o.createEffect(h,{attributes:s,uniformsNames:p,uniformBuffersNames:m,samplers:_,defines:A,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:f}},o),this._onEffectCreatedObservable&&(Mn.effect=this._effect,this._onEffectCreatedObservable.notifyObservers(Mn))),null!==(i=!(null===(t=this._effect)||void 0===t?void 0:t.isReady()))&&void 0!==i&&!i&&(v!==this._effect&&r.resetCachedMaterial(),this._renderId=r.getRenderId(),this._effect._wasPreviouslyReady=!0,!0)},n.prototype.bindOnlyWorldMatrix=function(e,n){var t=this.getScene(),i=null!=n?n:this._effect;i&&(-1!==this._options.uniforms.indexOf("world")&&i.setMatrix("world",e),-1!==this._options.uniforms.indexOf("worldView")&&(e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.setMatrix("worldView",this._cachedWorldViewMatrix)),-1!==this._options.uniforms.indexOf("worldViewProjection")&&(e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),i.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))},n.prototype.bindForSubMesh=function(e,n,t){this.bind(e,n,t._effectOverride)},n.prototype.bind=function(e,n,t){this.bindOnlyWorldMatrix(e,t);var i=null!=t?t:this._effect;if(i&&this.getScene().getCachedMaterial()!==this){var r;for(r in-1!==this._options.uniforms.indexOf("view")&&i.setMatrix("view",this.getScene().getViewMatrix()),-1!==this._options.uniforms.indexOf("projection")&&i.setMatrix("projection",this.getScene().getProjectionMatrix()),-1!==this._options.uniforms.indexOf("viewProjection")&&(i.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&i.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&-1!==this._options.uniforms.indexOf("cameraPosition")&&i.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),Ee.BindBonesParameters(n,i),this._textures)i.setTexture(r,this._textures[r]);for(r in this._textureArrays)i.setTextureArray(r,this._textureArrays[r]);for(r in this._ints)i.setInt(r,this._ints[r]);for(r in this._floats)i.setFloat(r,this._floats[r]);for(r in this._floatsArrays)i.setArray(r,this._floatsArrays[r]);for(r in this._colors3)i.setColor3(r,this._colors3[r]);for(r in this._colors3Arrays)i.setArray3(r,this._colors3Arrays[r]);for(r in this._colors4){var o=this._colors4[r];i.setFloat4(r,o.r,o.g,o.b,o.a)}for(r in this._colors4Arrays)i.setArray4(r,this._colors4Arrays[r]);for(r in this._vectors2)i.setVector2(r,this._vectors2[r]);for(r in this._vectors3)i.setVector3(r,this._vectors3[r]);for(r in this._vectors4)i.setVector4(r,this._vectors4[r]);for(r in this._matrices)i.setMatrix(r,this._matrices[r]);for(r in this._matrixArrays)i.setMatrices(r,this._matrixArrays[r]);for(r in this._matrices3x3)i.setMatrix3x3(r,this._matrices3x3[r]);for(r in this._matrices2x2)i.setMatrix2x2(r,this._matrices2x2[r]);for(r in this._vectors2Arrays)i.setArray2(r,this._vectors2Arrays[r]);for(r in this._vectors3Arrays)i.setArray3(r,this._vectors3Arrays[r]);for(r in this._vectors4Arrays)i.setArray4(r,this._vectors4Arrays[r])}var a=this._effect;this._effect=i,this._afterBind(n),this._effect=a},n.prototype._afterBind=function(n){e.prototype._afterBind.call(this,n),this.getScene()._cachedEffect=this._effect},n.prototype.getActiveTextures=function(){var n=e.prototype.getActiveTextures.call(this);for(var t in this._textures)n.push(this._textures[t]);for(var t in this._textureArrays)for(var i=this._textureArrays[t],r=0;r<i.length;r++)n.push(i[r]);return n},n.prototype.hasTexture=function(n){if(e.prototype.hasTexture.call(this,n))return!0;for(var t in this._textures)if(this._textures[t]===n)return!0;for(var t in this._textureArrays)for(var i=this._textureArrays[t],r=0;r<i.length;r++)if(i[r]===n)return!0;return!1},n.prototype.clone=function(e){var t=this,i=U.Clone((function(){return new n(e,t.getScene(),t._shaderPath,t._options)}),this);for(var r in i.name=e,i.id=e,"object"==typeof i._shaderPath&&(i._shaderPath=B({},i._shaderPath)),this._options=B({},this._options),Object.keys(this._options).forEach((function(e){var n=t._options[e];Array.isArray(n)&&(t._options[e]=n.slice(0))})),this._textures)i.setTexture(r,this._textures[r]);for(var r in this._floats)i.setFloat(r,this._floats[r]);for(var r in this._floatsArrays)i.setFloats(r,this._floatsArrays[r]);for(var r in this._colors3)i.setColor3(r,this._colors3[r]);for(var r in this._colors4)i.setColor4(r,this._colors4[r]);for(var r in this._vectors2)i.setVector2(r,this._vectors2[r]);for(var r in this._vectors3)i.setVector3(r,this._vectors3[r]);for(var r in this._vectors4)i.setVector4(r,this._vectors4[r]);for(var r in this._matrices)i.setMatrix(r,this._matrices[r]);for(var r in this._matrices3x3)i.setMatrix3x3(r,this._matrices3x3[r]);for(var r in this._matrices2x2)i.setMatrix2x2(r,this._matrices2x2[r]);return i},n.prototype.dispose=function(n,t,i){if(t){var r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays)for(var o=this._textureArrays[r],a=0;a<o.length;a++)o[a].dispose()}this._textures={},e.prototype.dispose.call(this,n,t,i)},n.prototype.serialize=function(){var e,n=U.Serialize(this);for(e in n.customType="BABYLON.ShaderMaterial",n.options=this._options,n.shaderPath=this._shaderPath,n.textures={},this._textures)n.textures[e]=this._textures[e].serialize();for(e in n.textureArrays={},this._textureArrays){n.textureArrays[e]=[];for(var t=this._textureArrays[e],i=0;i<t.length;i++)n.textureArrays[e].push(t[i].serialize())}for(e in n.floats={},this._floats)n.floats[e]=this._floats[e];for(e in n.FloatArrays={},this._floatsArrays)n.FloatArrays[e]=this._floatsArrays[e];for(e in n.colors3={},this._colors3)n.colors3[e]=this._colors3[e].asArray();for(e in n.colors3Arrays={},this._colors3Arrays)n.colors3Arrays[e]=this._colors3Arrays[e];for(e in n.colors4={},this._colors4)n.colors4[e]=this._colors4[e].asArray();for(e in n.colors4Arrays={},this._colors4Arrays)n.colors4Arrays[e]=this._colors4Arrays[e];for(e in n.vectors2={},this._vectors2)n.vectors2[e]=this._vectors2[e].asArray();for(e in n.vectors3={},this._vectors3)n.vectors3[e]=this._vectors3[e].asArray();for(e in n.vectors4={},this._vectors4)n.vectors4[e]=this._vectors4[e].asArray();for(e in n.matrices={},this._matrices)n.matrices[e]=this._matrices[e].asArray();for(e in n.matrixArray={},this._matrixArrays)n.matrixArray[e]=this._matrixArrays[e];for(e in n.matrices3x3={},this._matrices3x3)n.matrices3x3[e]=this._matrices3x3[e];for(e in n.matrices2x2={},this._matrices2x2)n.matrices2x2[e]=this._matrices2x2[e];for(e in n.vectors2Arrays={},this._vectors2Arrays)n.vectors2Arrays[e]=this._vectors2Arrays[e];for(e in n.vectors3Arrays={},this._vectors3Arrays)n.vectors3Arrays[e]=this._vectors3Arrays[e];for(e in n.vectors4Arrays={},this._vectors4Arrays)n.vectors4Arrays[e]=this._vectors4Arrays[e];return n},n.Parse=function(e,t,i){var r,o=U.Parse((function(){return new n(e.name,t,e.shaderPath,e.options)}),e,t,i);for(r in e.textures)o.setTexture(r,ge.Parse(e.textures[r],t,i));for(r in e.textureArrays){for(var a=e.textureArrays[r],s=new Array,l=0;l<a.length;l++)s.push(ge.Parse(a[l],t,i));o.setTextureArray(r,s)}for(r in e.floats)o.setFloat(r,e.floats[r]);for(r in e.floatsArrays)o.setFloats(r,e.floatsArrays[r]);for(r in e.colors3)o.setColor3(r,w.FromArray(e.colors3[r]));for(r in e.colors3Arrays){var c=e.colors3Arrays[r].reduce((function(e,n,t){return t%3==0?e.push([n]):e[e.length-1].push(n),e}),[]).map((function(e){return w.FromArray(e)}));o.setColor3Array(r,c)}for(r in e.colors4)o.setColor4(r,G.FromArray(e.colors4[r]));for(r in e.colors4Arrays){c=e.colors4Arrays[r].reduce((function(e,n,t){return t%4==0?e.push([n]):e[e.length-1].push(n),e}),[]).map((function(e){return G.FromArray(e)}));o.setColor4Array(r,c)}for(r in e.vectors2)o.setVector2(r,T.FromArray(e.vectors2[r]));for(r in e.vectors3)o.setVector3(r,m.FromArray(e.vectors3[r]));for(r in e.vectors4)o.setVector4(r,V.FromArray(e.vectors4[r]));for(r in e.matrices)o.setMatrix(r,A.FromArray(e.matrices[r]));for(r in e.matrixArray)o._matrixArrays[r]=new Float32Array(e.matrixArray[r]);for(r in e.matrices3x3)o.setMatrix3x3(r,e.matrices3x3[r]);for(r in e.matrices2x2)o.setMatrix2x2(r,e.matrices2x2[r]);for(r in e.vectors2Arrays)o.setArray2(r,e.vectors2Arrays[r]);for(r in e.vectors3Arrays)o.setArray3(r,e.vectors3Arrays[r]);for(r in e.vectors4Arrays)o.setArray4(r,e.vectors4Arrays[r]);return o},n.ParseFromFileAsync=function(e,n,t,r){var o=this;return void 0===r&&(r=""),new Promise((function(a,s){var l=new k;l.addEventListener("readystatechange",(function(){if(4==l.readyState)if(200==l.status){var n=JSON.parse(l.responseText),c=o.Parse(n,t||i.LastCreatedScene,r);e&&(c.name=e),a(c)}else s("Unable to load the ShaderMaterial")})),l.open("GET",n),l.send()}))},n.CreateFromSnippetAsync=function(e,n,t){var r=this;return void 0===t&&(t=""),new Promise((function(o,a){var s=new k;s.addEventListener("readystatechange",(function(){if(4==s.readyState)if(200==s.status){var l=JSON.parse(JSON.parse(s.responseText).jsonPayload),c=JSON.parse(l.shaderMaterial),f=r.Parse(c,n||i.LastCreatedScene,t);f.snippetId=e,o(f)}else a("Unable to load the snippet "+e)})),s.open("GET",r.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()}))},n.SnippetUrl="https://snippet.babylonjs.com",n}(H);X.RegisteredTypes["BABYLON.ShaderMaterial"]=xn,I.AddNodeConstructor("Light_Type_1",(function(e,n){return function(){return new Ln(e,m.Zero(),n)}}));var Ln=function(e){function n(n,t,i){var r=e.call(this,n,i)||this;return r._shadowFrustumSize=0,r._shadowOrthoScale=.1,r.autoUpdateExtends=!0,r.autoCalcShadowZBounds=!1,r._orthoLeft=Number.MAX_VALUE,r._orthoRight=Number.MIN_VALUE,r._orthoTop=Number.MIN_VALUE,r._orthoBottom=Number.MAX_VALUE,r.position=t.scale(-1),r.direction=t,r}return l(n,e),Object.defineProperty(n.prototype,"shadowFrustumSize",{get:function(){return this._shadowFrustumSize},set:function(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"shadowOrthoScale",{get:function(){return this._shadowOrthoScale},set:function(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"DirectionalLight"},n.prototype.getTypeID=function(){return W.LIGHTTYPEID_DIRECTIONALLIGHT},n.prototype._setDefaultShadowProjectionMatrix=function(e,n,t){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,n,t)},n.prototype._setDefaultFixedFrustumShadowProjectionMatrix=function(e){var n=this.getScene().activeCamera;n&&A.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:n.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:n.maxZ,e)},n.prototype._setDefaultAutoExtendShadowProjectionMatrix=function(e,n,t){var i=this.getScene().activeCamera;if(i){if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){var r=m.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;for(var o=Number.MAX_VALUE,a=Number.MIN_VALUE,s=0;s<t.length;s++){var l=t[s];if(l)for(var c=l.getBoundingInfo().boundingBox,f=0;f<c.vectorsWorld.length;f++)m.TransformCoordinatesToRef(c.vectorsWorld[f],n,r),r.x<this._orthoLeft&&(this._orthoLeft=r.x),r.y<this._orthoBottom&&(this._orthoBottom=r.y),r.x>this._orthoRight&&(this._orthoRight=r.x),r.y>this._orthoTop&&(this._orthoTop=r.y),this.autoCalcShadowZBounds&&(r.z<o&&(o=r.z),r.z>a&&(a=r.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=o,this._shadowMaxZ=a)}var u=this._orthoRight-this._orthoLeft,d=this._orthoTop-this._orthoBottom;A.OrthoOffCenterLHToRef(this._orthoLeft-u*this.shadowOrthoScale,this._orthoRight+u*this.shadowOrthoScale,this._orthoBottom-d*this.shadowOrthoScale,this._orthoTop+d*this.shadowOrthoScale,void 0!==this.shadowMinZ?this.shadowMinZ:i.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:i.maxZ,e)}},n.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},n.prototype.transferToEffect=function(e,n){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,n),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,n),this)},n.prototype.transferToNodeMaterialEffect=function(e,n){return this.computeTransformedInformation()?(e.setFloat3(n,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(n,this.direction.x,this.direction.y,this.direction.z),this)},n.prototype.getDepthMinZ=function(e){return 1},n.prototype.getDepthMaxZ=function(e){return 1},n.prototype.prepareLightSpecificDefines=function(e,n){e["DIRLIGHT"+n]=!0},d([h()],n.prototype,"shadowFrustumSize",null),d([h()],n.prototype,"shadowOrthoScale",null),d([h()],n.prototype,"autoUpdateExtends",void 0),d([h()],n.prototype,"autoCalcShadowZBounds",void 0),n}(ye);I.AddNodeConstructor("Light_Type_0",(function(e,n){return function(){return new Dn(e,m.Zero(),n)}}));var Pn,Nn,Dn=function(e){function n(n,t,i){var r=e.call(this,n,i)||this;return r._shadowAngle=Math.PI/2,r.position=t,r}return l(n,e),Object.defineProperty(n.prototype,"shadowAngle",{get:function(){return this._shadowAngle},set:function(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"direction",{get:function(){return this._direction},set:function(e){var n=this.needCube();this._direction=e,this.needCube()!==n&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"PointLight"},n.prototype.getTypeID=function(){return W.LIGHTTYPEID_POINTLIGHT},n.prototype.needCube=function(){return!this.direction},n.prototype.getShadowDirection=function(n){if(this.direction)return e.prototype.getShadowDirection.call(this,n);switch(n){case 0:return new m(1,0,0);case 1:return new m(-1,0,0);case 2:return new m(0,-1,0);case 3:return new m(0,1,0);case 4:return new m(0,0,1);case 5:return new m(0,0,-1)}return m.Zero()},n.prototype._setDefaultShadowProjectionMatrix=function(e,n,t){var i=this.getScene().activeCamera;i&&A.PerspectiveFovLHToRef(this.shadowAngle,1,this.getDepthMinZ(i),this.getDepthMaxZ(i),e)},n.prototype._buildUniformLayout=function(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()},n.prototype.transferToEffect=function(e,n){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,n):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,n),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,n),this},n.prototype.transferToNodeMaterialEffect=function(e,n){return this.computeTransformedInformation()?e.setFloat3(n,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(n,this.position.x,this.position.y,this.position.z),this},n.prototype.prepareLightSpecificDefines=function(e,n){e["POINTLIGHT"+n]=!0},d([h()],n.prototype,"shadowAngle",null),n}(ye),Fn=function(){function e(){}return e.SetMatrix=function(e,n,t,i,r){var o=null;if("MODEL"===t.semantic?o=n.getWorldMatrix():"PROJECTION"===t.semantic?o=e.getProjectionMatrix():"VIEW"===t.semantic?o=e.getViewMatrix():"MODELVIEWINVERSETRANSPOSE"===t.semantic?o=A.Transpose(n.getWorldMatrix().multiply(e.getViewMatrix()).invert()):"MODELVIEW"===t.semantic?o=n.getWorldMatrix().multiply(e.getViewMatrix()):"MODELVIEWPROJECTION"===t.semantic?o=n.getWorldMatrix().multiply(e.getTransformMatrix()):"MODELINVERSE"===t.semantic?o=n.getWorldMatrix().invert():"VIEWINVERSE"===t.semantic?o=e.getViewMatrix().invert():"PROJECTIONINVERSE"===t.semantic?o=e.getProjectionMatrix().invert():"MODELVIEWINVERSE"===t.semantic?o=n.getWorldMatrix().multiply(e.getViewMatrix()).invert():"MODELVIEWPROJECTIONINVERSE"===t.semantic?o=n.getWorldMatrix().multiply(e.getTransformMatrix()).invert():"MODELINVERSETRANSPOSE"===t.semantic&&(o=A.Transpose(n.getWorldMatrix().invert())),o)switch(t.type){case en.FLOAT_MAT2:r.setMatrix2x2(i,A.GetAsMatrix2x2(o));break;case en.FLOAT_MAT3:r.setMatrix3x3(i,A.GetAsMatrix3x3(o));break;case en.FLOAT_MAT4:r.setMatrix(i,o)}},e.SetUniform=function(e,n,t,i){switch(i){case en.FLOAT:return e.setFloat(n,t),!0;case en.FLOAT_VEC2:return e.setVector2(n,T.FromArray(t)),!0;case en.FLOAT_VEC3:return e.setVector3(n,m.FromArray(t)),!0;case en.FLOAT_VEC4:return e.setVector4(n,V.FromArray(t)),!0;default:return!1}},e.GetWrapMode=function(e){switch(e){case tn.CLAMP_TO_EDGE:return ge.CLAMP_ADDRESSMODE;case tn.MIRRORED_REPEAT:return ge.MIRROR_ADDRESSMODE;case tn.REPEAT:default:return ge.WRAP_ADDRESSMODE}},e.GetByteStrideFromType=function(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}},e.GetTextureFilterMode=function(e){switch(e){case on.LINEAR:case on.LINEAR_MIPMAP_NEAREST:case on.LINEAR_MIPMAP_LINEAR:return ge.TRILINEAR_SAMPLINGMODE;case on.NEAREST:case on.NEAREST_MIPMAP_NEAREST:return ge.NEAREST_SAMPLINGMODE;default:return ge.BILINEAR_SAMPLINGMODE}},e.GetBufferFromBufferView=function(e,n,t,i,r){t=n.byteOffset+t;var o=e.loadedBufferViews[n.buffer];if(t+i>o.byteLength)throw new Error("Buffer access is out of range");var a=o.buffer;switch(t+=o.byteOffset,r){case qe.BYTE:return new Int8Array(a,t,i);case qe.UNSIGNED_BYTE:return new Uint8Array(a,t,i);case qe.SHORT:return new Int16Array(a,t,i);case qe.UNSIGNED_SHORT:return new Uint16Array(a,t,i);default:return new Float32Array(a,t,i)}},e.GetBufferFromAccessor=function(n,t){var i=n.bufferViews[t.bufferView],r=t.count*e.GetByteStrideFromType(t);return e.GetBufferFromBufferView(n,i,t.byteOffset,r,t.componentType)},e.DecodeBufferToText=function(e){for(var n="",t=e.byteLength,i=0;i<t;++i)n+=String.fromCharCode(e[i]);return n},e.GetDefaultMaterial=function(n){if(!e._DefaultMaterial){z.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),z.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join("\n");var t={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};e._DefaultMaterial=new xn("GLTFDefaultMaterial",n,{vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},t),e._DefaultMaterial.setColor4("u_emission",new G(.5,.5,.5,1))}return e._DefaultMaterial},e._DefaultMaterial=null,e}();(Nn=Pn||(Pn={}))[Nn.IDENTIFIER=1]="IDENTIFIER",Nn[Nn.UNKNOWN=2]="UNKNOWN",Nn[Nn.END_OF_INPUT=3]="END_OF_INPUT";var Un=function(){function e(e){this._pos=0,this.currentToken=Pn.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}return e.prototype.getNextToken=function(){if(this.isEnd())return Pn.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=Pn.UNKNOWN,"_"===this.currentString||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=Pn.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||"_"===this.currentString);)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken},e.prototype.peek=function(){return this._toParse[this._pos]},e.prototype.read=function(){return this._toParse[this._pos++]},e.prototype.forward=function(){this._pos++},e.prototype.isEnd=function(){return this._pos>=this._maxPos},e}(),Bn=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],wn=["world","view","projection","worldView","worldViewProjection","mBones"],Gn=["translation","rotation","scale"],Vn=["position","rotationQuaternion","scaling"],kn=function(e,n,t){for(var i in e){var r=e[i];t[n][i]=r}},Hn=function(e){if(e)for(var n=0;n<e.length/2;n++)e[2*n+1]=1-e[2*n+1]},Xn=function(e){if("NORMAL"===e.semantic)return"normal";if("POSITION"===e.semantic)return"position";if("JOINT"===e.semantic)return"matricesIndices";if("WEIGHT"===e.semantic)return"matricesWeights";if("COLOR"===e.semantic)return"color";if(e.semantic&&-1!==e.semantic.indexOf("TEXCOORD_")){var n=Number(e.semantic.split("_")[1]);return"uv"+(0===n?"":n+1)}return null},Wn=function(e){var n=null;if(e.translation||e.rotation||e.scale){var t=m.FromArray(e.scale||[1,1,1]),i=C.FromArray(e.rotation||[0,0,0,1]),r=m.FromArray(e.translation||[0,0,0]);n=A.Compose(t,i,r)}else n=A.FromArray(e.matrix);return n},zn=function(e,n,t,i){for(var r=0;r<i.bones.length;r++)if(i.bones[r].name===t)return i.bones[r];var o=e.nodes;for(var a in o){var s=o[a];if(s.jointName){var l=s.children;for(r=0;r<l.length;r++){var c=e.nodes[l[r]];if(c.jointName&&c.jointName===t){var f=Wn(s),u=new Rn(s.name||"",i,zn(e,n,s.jointName,i),f);return u.id=a,u}}}}return null},Yn=function(e,n){for(var t=0;t<e.length;t++)for(var i=e[t],r=0;r<i.node.children.length;r++){if(i.node.children[r]===n)return i.bone}return null},Qn=function(e,n){var t=e.nodes,i=t[n];if(i)return{node:i,id:n};for(var r in t)if((i=t[r]).jointName===n)return{node:i,id:r};return null},jn=function(e,n){for(var t=0;t<e.jointNames.length;t++)if(e.jointNames[t]===n)return!0;return!1},Kn=function(e,n,t,i,o){if(i||(i=new On(n.name||"","",e.scene)),!n.babylonSkeleton)return i;var a=[],s=[];!function(e,n,t,i){for(var r in e.nodes){var o=e.nodes[r],a=r;if(o.jointName&&!jn(t,o.jointName)){var s=Wn(o),l=new Rn(o.name||"",n,null,s);l.id=a,i.push({bone:l,node:o,id:a})}}for(var c=0;c<i.length;c++)for(var f=i[c],u=f.node.children,d=0;d<u.length;d++){for(var h=null,p=0;p<i.length;p++)if(i[p].id===u[d]){h=i[p];break}h&&(h.bone._parent=f.bone,f.bone.children.push(h.bone))}}(e,i,n,a),i.bones=[];for(var l=0;l<n.jointNames.length;l++){if(E=Qn(e,n.jointNames[l])){var c=E.node;if(c){o=E.id;var f=e.scene.getBoneByID(o);if(f)i.bones.push(f);else{for(var u=!1,d=null,h=0;h<l;h++){var p=Qn(e,n.jointNames[h]);if(p){var m=p.node;if(m){var _=m.children;if(_){u=!1;for(var v=0;v<_.length;v++)if(_[v]===o){d=zn(e,n,n.jointNames[h],i),u=!0;break}if(u)break}}else r.Warn("Joint named "+n.jointNames[h]+" does not exist when looking for parent")}}var A=Wn(c);!d&&a.length>0&&(d=Yn(a,o))&&-1===s.indexOf(d)&&s.push(d),new Rn(c.jointName||"",i,d,A).id=o}}else r.Warn("Joint named "+n.jointNames[l]+" does not exist")}}var g=i.bones;i.bones=[];for(l=0;l<n.jointNames.length;l++){var E;if(E=Qn(e,n.jointNames[l]))for(h=0;h<g.length;h++)if(g[h].id===E.id){i.bones.push(g[h]);break}}i.prepare();for(l=0;l<s.length;l++)i.bones.push(s[l]);return i},qn=function(e,n,t,i,r){if(r||(e.scene._blockEntityCollection=e.forAssetContainer,r=new c(n.name||"",e.scene),e.scene._blockEntityCollection=!1,r.id=i),!n.babylonNode)return r;for(var o,a=[],s=null,l=new Array,f=new Array,u=new Array,d=new Array,h=0;h<t.length;h++){var p=t[h];if(M=e.meshes[p])for(var m=0;m<M.primitives.length;m++){var _=new Z,v=M.primitives[m];v.mode;var A=v.attributes,g=null,E=null;for(var T in A)if(g=e.accessors[A[T]],E=Fn.GetBufferFromAccessor(e,g),"NORMAL"===T)_.normals=new Float32Array(E.length),_.normals.set(E);else if("POSITION"===T){if(hn.HomogeneousCoordinates){_.positions=new Float32Array(E.length-E.length/4);for(var y=0;y<E.length;y+=4)_.positions[y]=E[y],_.positions[y+1]=E[y+1],_.positions[y+2]=E[y+2]}else _.positions=new Float32Array(E.length),_.positions.set(E);f.push(_.positions.length)}else if(-1!==T.indexOf("TEXCOORD_")){var R=Number(T.split("_")[1]),C=F.UVKind+(0===R?"":R+1),b=new Float32Array(E.length);b.set(E),Hn(b),_.set(b,C)}else"JOINT"===T?(_.matricesIndices=new Float32Array(E.length),_.matricesIndices.set(E)):"WEIGHT"===T?(_.matricesWeights=new Float32Array(E.length),_.matricesWeights.set(E)):"COLOR"===T&&(_.colors=new Float32Array(E.length),_.colors.set(E));if(g=e.accessors[v.indices])E=Fn.GetBufferFromAccessor(e,g),_.indices=new Int32Array(E.length),_.indices.set(E),d.push(_.indices.length);else{var S=[];for(y=0;y<_.positions.length/3;y++)S.push(y);_.indices=new Int32Array(S),d.push(_.indices.length)}s?s.merge(_):s=_;var I=e.scene.getMaterialByID(v.material);a.push(null===I?Fn.GetDefaultMaterial(e.scene):I),l.push(0===l.length?0:l[l.length-1]+f[f.length-2]),u.push(0===u.length?0:u[u.length-1]+d[d.length-2])}}e.scene._blockEntityCollection=e.forAssetContainer,a.length>1?(o=new j("multimat"+i,e.scene)).subMaterials=a:o=new Re("multimat"+i,e.scene),1===a.length&&(o=a[0]),r.material||(r.material=o),new K(i,e.scene,s,!1,r),r.computeWorldMatrix(!0),e.scene._blockEntityCollection=!1,r.subMeshes=[];var O=0;for(h=0;h<t.length;h++){var M;p=t[h];if(M=e.meshes[p])for(m=0;m<M.primitives.length;m++)M.primitives[m].mode,q.AddToMesh(O,l[O],f[O],u[O],d[O],r,r,!0),O++}return r},Zn=function(e,n,t,i){e.position&&(e.position=n),(e.rotationQuaternion||e.rotation)&&(e.rotationQuaternion=t),e.scaling&&(e.scaling=i)},Jn=function(e,n,t,i){var r=null;if(e.importOnlyMeshes&&(n.skin||n.meshes)&&e.importMeshesNames&&e.importMeshesNames.length>0&&-1===e.importMeshesNames.indexOf(n.name||""))return null;if(n.skin){if(n.meshes){var o=e.skins[n.skin];(a=qn(e,n,n.meshes,t,n.babylonNode)).skeleton=e.scene.getLastSkeletonByID(n.skin),null===a.skeleton&&(a.skeleton=Kn(e,o,0,o.babylonSkeleton,n.skin),o.babylonSkeleton||(o.babylonSkeleton=a.skeleton)),r=a}}else if(n.meshes){var a;r=a=qn(e,n,n.mesh?[n.mesh]:n.meshes,t,n.babylonNode)}else if(!n.light||n.babylonNode||e.importOnlyMeshes){if(n.camera&&!n.babylonNode&&!e.importOnlyMeshes){var s=e.cameras[n.camera];if(s){if(e.scene._blockEntityCollection=e.forAssetContainer,"orthographic"===s.type){var l=new yn(n.camera,m.Zero(),e.scene,!1);l.name=n.name||"",l.mode=Q.ORTHOGRAPHIC_CAMERA,l.attachControl(),r=l}else if("perspective"===s.type){var f=s[s.type],u=new yn(n.camera,m.Zero(),e.scene,!1);u.name=n.name||"",u.attachControl(),f.aspectRatio||(f.aspectRatio=e.scene.getEngine().getRenderWidth()/e.scene.getEngine().getRenderHeight()),f.znear&&f.zfar&&(u.maxZ=f.zfar,u.minZ=f.znear),r=u}e.scene._blockEntityCollection=!1}}}else{var d=e.lights[n.light];if(d)if("ambient"===d.type){var h=d[d.type],p=new be(n.light,m.Zero(),e.scene);p.name=n.name||"",h.color&&(p.diffuse=w.FromArray(h.color)),r=p}else if("directional"===d.type){var _=d[d.type],v=new Ln(n.light,m.Zero(),e.scene);v.name=n.name||"",_.color&&(v.diffuse=w.FromArray(_.color)),r=v}else if("point"===d.type){var g=d[d.type],E=new Dn(n.light,m.Zero(),e.scene);E.name=n.name||"",g.color&&(E.diffuse=w.FromArray(g.color)),r=E}else if("spot"===d.type){var T=d[d.type],y=new Se(n.light,m.Zero(),m.Zero(),0,0,e.scene);y.name=n.name||"",T.color&&(y.diffuse=w.FromArray(T.color)),T.fallOfAngle&&(y.angle=T.fallOfAngle),T.fallOffExponent&&(y.exponent=T.fallOffExponent),r=y}}if(!n.jointName){if(n.babylonNode)return n.babylonNode;if(null===r){e.scene._blockEntityCollection=e.forAssetContainer;var R=new c(n.name||"",e.scene);e.scene._blockEntityCollection=!1,n.babylonNode=R,r=R}}if(null!==r){if(n.matrix&&r instanceof c)!function(e,n,t){if(n.matrix){var i=new m(0,0,0),r=new C,o=new m(0,0,0);A.FromArray(n.matrix).decompose(o,r,i),Zn(e,i,r,o)}else n.translation&&n.rotation&&n.scale&&Zn(e,m.FromArray(n.translation),C.FromArray(n.rotation),m.FromArray(n.scale));e.computeWorldMatrix(!0)}(r,n);else{var b=n.translation||[0,0,0],S=n.rotation||[0,0,0,1],I=n.scale||[1,1,1];Zn(r,m.FromArray(b),C.FromArray(S),m.FromArray(I))}r.updateCache(!0),n.babylonNode=r}return r},$n=function(e,n,t,i){void 0===i&&(i=!1);var r=e.nodes[n],o=null;if(i=!(e.importOnlyMeshes&&!i&&e.importMeshesNames)||(-1!==e.importMeshesNames.indexOf(r.name||"")||0===e.importMeshesNames.length),!r.jointName&&i&&null!==(o=Jn(e,r,n))&&(o.id=n,o.parent=t),r.children)for(var a=0;a<r.children.length;a++)$n(e,r.children[a],o,i)},et=function(e){var n=e.currentScene;if(n)for(var t=0;t<n.nodes.length;t++)$n(e,n.nodes[t],null);else for(var i in e.scenes){n=e.scenes[i];for(t=0;t<n.nodes.length;t++)$n(e,n.nodes[t],null)}!function(e){for(var n in e.animations){var t=e.animations[n];if(t.channels&&t.samplers)for(var i=null,o=0;o<t.channels.length;o++){var a=t.channels[o],s=t.samplers[a.sampler];if(s){var l=null,c=null;t.parameters?(l=t.parameters[s.input],c=t.parameters[s.output]):(l=s.input,c=s.output);var f=Fn.GetBufferFromAccessor(e,e.accessors[l]),u=Fn.GetBufferFromAccessor(e,e.accessors[c]),d=a.target.id,h=e.scene.getNodeByID(d);if(null===h&&(h=e.scene.getNodeByName(d)),null!==h){var p=h instanceof Rn,_=a.target.path,v=Gn.indexOf(_);-1!==v&&(_=Vn[v]);var g=N.ANIMATIONTYPE_MATRIX;p||("rotationQuaternion"===_?(g=N.ANIMATIONTYPE_QUATERNION,h.rotationQuaternion=new C):g=N.ANIMATIONTYPE_VECTOR3);var E=null,T=[],y=0,R=!1;p&&i&&i.getKeys().length===f.length&&(E=i,R=!0),R||(e.scene._blockEntityCollection=e.forAssetContainer,E=new N(n,p?"_matrix":_,1,g,N.ANIMATIONLOOPMODE_CYCLE),e.scene._blockEntityCollection=!1);for(var b=0;b<f.length;b++){var S=null;if("rotationQuaternion"===_?(S=C.FromArray([u[y],u[y+1],u[y+2],u[y+3]]),y+=4):(S=m.FromArray([u[y],u[y+1],u[y+2]]),y+=3),p){var I=h,O=m.Zero(),M=new C,x=m.Zero(),L=I.getBaseMatrix();R&&i&&(L=i.getKeys()[b].value),L.decompose(x,M,O),"position"===_?O=S:"rotationQuaternion"===_?M=S:x=S,S=A.Compose(x,M,O)}R?i&&(i.getKeys()[b].value=S):T.push({frame:f[b],value:S})}!R&&E&&(E.setKeys(T),h.animations.push(E)),i=E,e.scene.stopAnimation(h),e.scene.beginAnimation(h,0,f[f.length-1],!0,1)}else r.Warn("Creating animation named "+n+". But cannot find node named "+d+" to attach to")}}}}(e);for(t=0;t<e.scene.skeletons.length;t++){var o=e.scene.skeletons[t];e.scene.beginAnimation(o,0,Number.MAX_VALUE,!0,1)}},nt=function(e,n,t,i,r,o){return function(a){!function(e,n,t,i,r){var o=i.values||t.parameters,a=t.uniforms;for(var s in r){var l=r[s],c=l.type,f=o[a[s]];if(void 0===f&&(f=l.value),f){var u=function(e){return function(t){l.value&&e&&(n.setTexture(e,t),delete r[e])}};c===en.SAMPLER_2D?at.LoadTextureAsync(e,i.values?f:l.value,u(s),(function(){return u(null)})):l.value&&Fn.SetUniform(n,s,i.values?f:l.value,c)&&delete r[s]}}}(e,n,t,i,r),n.onBind=function(a){!function(e,n,t,i,r,o,a){var s=o.values||r.parameters;for(var l in t){var c=t[l],f=c.type;if(f===en.FLOAT_MAT2||f===en.FLOAT_MAT3||f===en.FLOAT_MAT4)if(!c.semantic||c.source||c.node){if(c.semantic&&(c.source||c.node)){var u=n.scene.getNodeByName(c.source||c.node||"");if(null===u&&(u=n.scene.getNodeByID(c.source||c.node||"")),null===u)continue;Fn.SetMatrix(n.scene,u,c,l,i.getEffect())}}else Fn.SetMatrix(n.scene,e,c,l,i.getEffect());else{var d=s[r.uniforms[l]];if(!d)continue;if(f===en.SAMPLER_2D){var h=n.textures[o.values?d:c.value].babylonTexture;if(null==h)continue;i.getEffect().setTexture(l,h)}else Fn.SetUniform(i.getEffect(),l,d,f)}}a(i)}(a,e,r,n,t,i,o)}}},tt=function(e,n,t){for(var i in n.uniforms){var r=n.uniforms[i],o=n.parameters[r];if(e.currentIdentifier===i&&o.semantic&&!o.source&&!o.node){var a=Bn.indexOf(o.semantic);if(-1!==a)return delete t[i],wn[a]}}return e.currentIdentifier},it=function(e){for(var n in e.materials)at.LoadMaterialAsync(e,n,(function(e){}),(function(){}))},rt=function(){function e(){}return e.CreateRuntime=function(e,n,t){var i={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:n,rootUrl:t,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],forAssetContainer:!1};return e.extensions&&kn(e.extensions,"extensions",i),e.extensionsUsed&&kn(e.extensionsUsed,"extensionsUsed",i),e.buffers&&function(e,n){for(var t in e){var i=e[t];n.buffers[t]=i,n.buffersCount++}}(e.buffers,i),e.bufferViews&&kn(e.bufferViews,"bufferViews",i),e.accessors&&kn(e.accessors,"accessors",i),e.meshes&&kn(e.meshes,"meshes",i),e.lights&&kn(e.lights,"lights",i),e.cameras&&kn(e.cameras,"cameras",i),e.nodes&&kn(e.nodes,"nodes",i),e.images&&kn(e.images,"images",i),e.textures&&kn(e.textures,"textures",i),e.shaders&&function(e,n){for(var t in e){var i=e[t];n.shaders[t]=i,n.shaderscount++}}(e.shaders,i),e.programs&&kn(e.programs,"programs",i),e.samplers&&kn(e.samplers,"samplers",i),e.techniques&&kn(e.techniques,"techniques",i),e.materials&&kn(e.materials,"materials",i),e.animations&&kn(e.animations,"animations",i),e.skins&&kn(e.skins,"skins",i),e.scenes&&(i.scenes=e.scenes),e.scene&&e.scenes&&(i.currentScene=e.scenes[e.scene]),i},e.LoadBufferAsync=function(e,n,t,i,o){var a=e.buffers[n];r.IsBase64(a.uri)?setTimeout((function(){return t(new Uint8Array(r.DecodeBase64(a.uri)))})):r.LoadFile(e.rootUrl+a.uri,(function(e){return t(new Uint8Array(e))}),o,void 0,!0,(function(e){e&&i(e.status+" "+e.statusText)}))},e.LoadTextureBufferAsync=function(e,n,t,i){var o=e.textures[n];if(o&&o.source)if(o.babylonTexture)t(null);else{var a=e.images[o.source];r.IsBase64(a.uri)?setTimeout((function(){return t(new Uint8Array(r.DecodeBase64(a.uri)))})):r.LoadFile(e.rootUrl+a.uri,(function(e){return t(new Uint8Array(e))}),void 0,void 0,!0,(function(e){e&&i(e.status+" "+e.statusText)}))}else i("")},e.CreateTextureAsync=function(e,n,t,i,r){var o=e.textures[n];if(o.babylonTexture)i(o.babylonTexture);else{var a=e.samplers[o.sampler],s=a.minFilter===on.NEAREST_MIPMAP_NEAREST||a.minFilter===on.NEAREST_MIPMAP_LINEAR||a.minFilter===on.LINEAR_MIPMAP_NEAREST||a.minFilter===on.LINEAR_MIPMAP_LINEAR,l=ge.BILINEAR_SAMPLINGMODE,c=null==t?new Blob:new Blob([t]),f=URL.createObjectURL(c),u=function(){return URL.revokeObjectURL(f)},d=new ge(f,e.scene,!s,!0,l,u,u);void 0!==a.wrapS&&(d.wrapU=Fn.GetWrapMode(a.wrapS)),void 0!==a.wrapT&&(d.wrapV=Fn.GetWrapMode(a.wrapT)),d.name=n,o.babylonTexture=d,i(d)}},e.LoadShaderStringAsync=function(e,n,t,i){var o=e.shaders[n];if(r.IsBase64(o.uri)){var a=atob(o.uri.split(",")[1]);t&&t(a)}else r.LoadFile(e.rootUrl+o.uri,t,void 0,void 0,!1,(function(e){e&&i&&i(e.status+" "+e.statusText)}))},e.LoadMaterialAsync=function(e,n,t,i){var r=e.materials[n];if(r.technique){var o=e.techniques[r.technique];if(!o){e.scene._blockEntityCollection=e.forAssetContainer;var a=new Re(n,e.scene);return e.scene._blockEntityCollection=!1,a.diffuseColor=new w(.5,.5,.5),a.sideOrientation=H.CounterClockWiseSideOrientation,void t(a)}var s=e.programs[o.program],l=o.states,c=z.ShadersStore[s.vertexShader+"VertexShader"],f=z.ShadersStore[s.fragmentShader+"PixelShader"],u="",d="",h=new Un(c),p=new Un(f),m={},_=[],v=[],A=[];for(var g in o.uniforms){var E=o.uniforms[g],T=o.parameters[E];if(m[g]=T,!T.semantic||T.node||T.source)T.type===en.SAMPLER_2D?A.push(g):_.push(g);else{var y=Bn.indexOf(T.semantic);-1!==y?(_.push(wn[y]),delete m[g]):_.push(g)}}for(var R in o.attributes){var C=o.attributes[R];if((I=o.parameters[C]).semantic){var b=Xn(I);b&&v.push(b)}}for(;!h.isEnd()&&h.getNextToken();){if(h.currentToken===Pn.IDENTIFIER){var S=!1;for(var R in o.attributes){C=o.attributes[R];var I=o.parameters[C];if(h.currentIdentifier===R&&I.semantic){u+=Xn(I),S=!0;break}}S||(u+=tt(h,o,m))}else u+=h.currentString}for(;!p.isEnd()&&p.getNextToken();){p.currentToken===Pn.IDENTIFIER?d+=tt(p,o,m):d+=p.currentString}var O={vertex:s.vertexShader+n,fragment:s.fragmentShader+n},M={attributes:v,uniforms:_,samplers:A,needAlphaBlending:l&&l.enable&&-1!==l.enable.indexOf(3042)};z.ShadersStore[s.vertexShader+n+"VertexShader"]=u,z.ShadersStore[s.fragmentShader+n+"PixelShader"]=d;var x=new xn(n,e.scene,O,M);if(x.onError=function(e,n,t){return function(i,r){n.dispose(!0),t("Cannot compile program named "+e.name+". Error: "+r+". Default material will be applied")}}(s,x,i),x.onCompiled=nt(e,x,o,r,m,t),x.sideOrientation=H.CounterClockWiseSideOrientation,l&&l.functions){var L=l.functions;L.cullFace&&L.cullFace[0]!==cn.BACK&&(x.backFaceCulling=!1);var P=L.blendFuncSeparate;P&&(P[0]===un.SRC_ALPHA&&P[1]===un.ONE_MINUS_SRC_ALPHA&&P[2]===un.ONE&&P[3]===un.ONE?x.alphaMode=Ce.ALPHA_COMBINE:P[0]===un.ONE&&P[1]===un.ONE&&P[2]===un.ZERO&&P[3]===un.ONE?x.alphaMode=Ce.ALPHA_ONEONE:P[0]===un.SRC_ALPHA&&P[1]===un.ONE&&P[2]===un.ZERO&&P[3]===un.ONE?x.alphaMode=Ce.ALPHA_ADD:P[0]===un.ZERO&&P[1]===un.ONE_MINUS_SRC_COLOR&&P[2]===un.ONE&&P[3]===un.ONE?x.alphaMode=Ce.ALPHA_SUBTRACT:P[0]===un.DST_COLOR&&P[1]===un.ZERO&&P[2]===un.ONE&&P[3]===un.ONE?x.alphaMode=Ce.ALPHA_MULTIPLY:P[0]===un.SRC_ALPHA&&P[1]===un.ONE_MINUS_SRC_COLOR&&P[2]===un.ONE&&P[3]===un.ONE&&(x.alphaMode=Ce.ALPHA_MAXIMIZED))}}else i&&i("No technique found.")},e}(),ot=function(){function e(){this.state=null}return e.RegisterExtension=function(n){e.Extensions[n.name]?r.Error('Tool with the same name "'+n.name+'" already exists'):e.Extensions[n.name]=n},e.prototype.dispose=function(){},e.prototype._importMeshAsync=function(e,n,t,i,o,a,s,l){var c=this;return n.useRightHandedSystem=!0,at.LoadRuntimeAsync(n,t,i,(function(n){n.forAssetContainer=o,n.importOnlyMeshes=!0,""===e?n.importMeshesNames=[]:"string"==typeof e?n.importMeshesNames=[e]:!e||e instanceof Array?(n.importMeshesNames=[],r.Warn("Argument meshesNames must be of type string or string[]")):n.importMeshesNames=[e],c._createNodes(n);var t=new Array,i=new Array;for(var l in n.nodes){var f=n.nodes[l];f.babylonNode instanceof Y&&t.push(f.babylonNode)}for(var u in n.skins){var d=n.skins[u];d.babylonSkeleton instanceof On&&i.push(d.babylonSkeleton)}c._loadBuffersAsync(n,(function(){c._loadShadersAsync(n,(function(){it(n),et(n),!hn.IncrementalLoading&&a&&a(t,i)}))}),s),hn.IncrementalLoading&&a&&a(t,i)}),l),!0},e.prototype.importMeshAsync=function(e,n,t,i,r,o){var a=this;return new Promise((function(s,l){a._importMeshAsync(e,n,i,r,t,(function(e,n){s({meshes:e,particleSystems:[],skeletons:n,animationGroups:[],lights:[],transformNodes:[],geometries:[]})}),o,(function(e){l(new Error(e))}))}))},e.prototype._loadAsync=function(e,n,t,i,r,o,a){var s=this;e.useRightHandedSystem=!0,at.LoadRuntimeAsync(e,n,t,(function(e){at.LoadRuntimeExtensionsAsync(e,(function(){s._createNodes(e),s._loadBuffersAsync(e,(function(){s._loadShadersAsync(e,(function(){it(e),et(e),hn.IncrementalLoading||r()}))})),hn.IncrementalLoading&&r()}),a)}),a)},e.prototype.loadAsync=function(e,n,t,i){var r=this;return new Promise((function(o,a){r._loadAsync(e,n,t,!1,(function(){o()}),i,(function(e){a(new Error(e))}))}))},e.prototype._loadShadersAsync=function(e,n){var t=!1,i=function(t,i){at.LoadShaderStringAsync(e,t,(function(r){r instanceof ArrayBuffer||(e.loadedShaderCount++,r&&(z.ShadersStore[t+(i.type===Je.VERTEX?"VertexShader":"PixelShader")]=r),e.loadedShaderCount===e.shaderscount&&n())}),(function(){r.Error("Error when loading shader program named "+t+" located at "+i.uri)}))};for(var o in e.shaders){t=!0;var a=e.shaders[o];a?i.bind(this,o,a)():r.Error("No shader named: "+o)}t||n()},e.prototype._loadBuffersAsync=function(e,n,t){var i=!1,o=function(t,i){at.LoadBufferAsync(e,t,(function(o){e.loadedBufferCount++,o&&(o.byteLength!=e.buffers[t].byteLength&&r.Error("Buffer named "+t+" is length "+o.byteLength+". Expected: "+i.byteLength),e.loadedBufferViews[t]=o),e.loadedBufferCount===e.buffersCount&&n()}),(function(){r.Error("Error when loading buffer named "+t+" located at "+i.uri)}))};for(var a in e.buffers){i=!0;var s=e.buffers[a];s?o.bind(this,a,s)():r.Error("No buffer named: "+a)}i||n()},e.prototype._createNodes=function(e){var n=e.currentScene;if(n)for(var t=0;t<n.nodes.length;t++)$n(e,n.nodes[t],null);else for(var i in e.scenes){n=e.scenes[i];for(t=0;t<n.nodes.length;t++)$n(e,n.nodes[t],null)}},e.Extensions={},e}(),at=function(){function e(e){this._name=e}return Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),e.prototype.loadRuntimeAsync=function(e,n,t,i,r){return!1},e.prototype.loadRuntimeExtensionsAsync=function(e,n,t){return!1},e.prototype.loadBufferAsync=function(e,n,t,i,r){return!1},e.prototype.loadTextureBufferAsync=function(e,n,t,i){return!1},e.prototype.createTextureAsync=function(e,n,t,i,r){return!1},e.prototype.loadShaderStringAsync=function(e,n,t,i){return!1},e.prototype.loadMaterialAsync=function(e,n,t,i){return!1},e.LoadRuntimeAsync=function(n,t,i,r,o){e.ApplyExtensions((function(e){return e.loadRuntimeAsync(n,t,i,r,o)}),(function(){setTimeout((function(){r&&r(rt.CreateRuntime(t.json,n,i))}))}))},e.LoadRuntimeExtensionsAsync=function(n,t,i){e.ApplyExtensions((function(e){return e.loadRuntimeExtensionsAsync(n,t,i)}),(function(){setTimeout((function(){t()}))}))},e.LoadBufferAsync=function(n,t,i,r,o){e.ApplyExtensions((function(e){return e.loadBufferAsync(n,t,i,r,o)}),(function(){rt.LoadBufferAsync(n,t,i,r,o)}))},e.LoadTextureAsync=function(n,t,i,r){e.LoadTextureBufferAsync(n,t,(function(o){o&&e.CreateTextureAsync(n,t,o,i,r)}),r)},e.LoadShaderStringAsync=function(n,t,i,r){e.ApplyExtensions((function(e){return e.loadShaderStringAsync(n,t,i,r)}),(function(){rt.LoadShaderStringAsync(n,t,i,r)}))},e.LoadMaterialAsync=function(n,t,i,r){e.ApplyExtensions((function(e){return e.loadMaterialAsync(n,t,i,r)}),(function(){rt.LoadMaterialAsync(n,t,i,r)}))},e.LoadTextureBufferAsync=function(n,t,i,r){e.ApplyExtensions((function(e){return e.loadTextureBufferAsync(n,t,i,r)}),(function(){rt.LoadTextureBufferAsync(n,t,i,r)}))},e.CreateTextureAsync=function(n,t,i,r,o){e.ApplyExtensions((function(e){return e.createTextureAsync(n,t,i,r,o)}),(function(){rt.CreateTextureAsync(n,t,i,r,o)}))},e.ApplyExtensions=function(e,n){for(var t in ot.Extensions){if(e(ot.Extensions[t]))return}n()},e}();hn._CreateGLTF1Loader=function(){return new ot};var st=function(e){function n(){return e.call(this,"KHR_binary_glTF")||this}return l(n,e),n.prototype.loadRuntimeAsync=function(e,n,t,i,r){var o=n.json.extensionsUsed;return!(!o||-1===o.indexOf(this.name)||!n.bin)&&(this._bin=n.bin,i(rt.CreateRuntime(n.json,e,t)),!0)},n.prototype.loadBufferAsync=function(e,n,t,i){return-1!==e.extensionsUsed.indexOf(this.name)&&("binary_glTF"===n&&(this._bin.readAsync(0,this._bin.byteLength).then(t,(function(e){return i(e.message)})),!0))},n.prototype.loadTextureBufferAsync=function(e,n,t,i){var r=e.textures[n],o=e.images[r.source];if(!o.extensions||!(this.name in o.extensions))return!1;var a=o.extensions[this.name],s=e.bufferViews[a.bufferView];return t(Fn.GetBufferFromBufferView(e,s,0,s.byteLength,qe.UNSIGNED_BYTE)),!0},n.prototype.loadShaderStringAsync=function(e,n,t,i){var r=e.shaders[n];if(!r.extensions||!(this.name in r.extensions))return!1;var o=r.extensions[this.name],a=e.bufferViews[o.bufferView],s=Fn.GetBufferFromBufferView(e,a,0,a.byteLength,qe.UNSIGNED_BYTE);return setTimeout((function(){var e=Fn.DecodeBufferToText(s);t(e)})),!0},n}(at);ot.RegisterExtension(new st);var lt=function(e){function n(){return e.call(this,"KHR_materials_common")||this}return l(n,e),n.prototype.loadRuntimeExtensionsAsync=function(e,n,t){if(!e.extensions)return!1;var i=e.extensions[this.name];if(!i)return!1;var o=i.lights;if(o)for(var a in o){var s=o[a];switch(s.type){case"ambient":var l=new be(s.name,new m(0,1,0),e.scene),c=s.ambient;c&&(l.diffuse=w.FromArray(c.color||[1,1,1]));break;case"point":var f=new Dn(s.name,new m(10,10,10),e.scene),u=s.point;u&&(f.diffuse=w.FromArray(u.color||[1,1,1]));break;case"directional":var d=new Ln(s.name,new m(0,-1,0),e.scene),h=s.directional;h&&(d.diffuse=w.FromArray(h.color||[1,1,1]));break;case"spot":var p=s.spot;if(p)new Se(s.name,new m(0,10,0),new m(0,-1,0),p.fallOffAngle||Math.PI,p.fallOffExponent||0,e.scene).diffuse=w.FromArray(p.color||[1,1,1]);break;default:r.Warn('GLTF Material Common extension: light type "'+s.type+"” not supported")}}return!1},n.prototype.loadMaterialAsync=function(e,n,t,i){var r=e.materials[n];if(!r||!r.extensions)return!1;var o=r.extensions[this.name];if(!o)return!1;var a=new Re(n,e.scene);return a.sideOrientation=H.CounterClockWiseSideOrientation,"CONSTANT"===o.technique&&(a.disableLighting=!0),a.backFaceCulling=void 0!==o.doubleSided&&!o.doubleSided,a.alpha=void 0===o.values.transparency?1:o.values.transparency,a.specularPower=void 0===o.values.shininess?0:o.values.shininess,"string"==typeof o.values.ambient?this._loadTexture(e,o.values.ambient,a,"ambientTexture",i):a.ambientColor=w.FromArray(o.values.ambient||[0,0,0]),"string"==typeof o.values.diffuse?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",i):a.diffuseColor=w.FromArray(o.values.diffuse||[0,0,0]),"string"==typeof o.values.emission?this._loadTexture(e,o.values.emission,a,"emissiveTexture",i):a.emissiveColor=w.FromArray(o.values.emission||[0,0,0]),"string"==typeof o.values.specular?this._loadTexture(e,o.values.specular,a,"specularTexture",i):a.specularColor=w.FromArray(o.values.specular||[0,0,0]),!0},n.prototype._loadTexture=function(e,n,t,i,r){rt.LoadTextureBufferAsync(e,n,(function(o){rt.CreateTextureAsync(e,n,o,(function(e){return t[i]=e}),r)}),r)},n}(at);ot.RegisterExtension(new lt);var ct=function(){function e(){var e=this;this.promise=new Promise((function(n,t){e._resolve=n,e._reject=t}))}return Object.defineProperty(e.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),e}(),ft=Object.freeze(new C(0,0,0,0)),ut=Object.freeze(m.Zero()),dt=Object.freeze(T.Zero()),ht=Object.freeze(J.Zero()),pt=Object.freeze(w.Black()),mt=function(){function e(e,n,t,i){var r=this;if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=n,this._target=e,this._scene=t,this._host=i,this._activeTargets=[],n._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===N.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=A.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){var o={frame:0,value:this._minValue};this._keys.splice(0,0,o)}if(this._target instanceof Array){for(var a=0,s=0,l=this._target;s<l.length;s++){var c=l[s];this._preparePath(c,a),this._getOriginalValues(a),a++}this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];var f=n.getEvents();f&&f.length>0&&f.forEach((function(e){r._events.push(e._clone())})),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}return Object.defineProperty(e.prototype,"currentFrame",{get:function(){return this._currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"weight",{get:function(){return this._weight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"currentValue",{get:function(){return this._currentValue},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"targetPath",{get:function(){return this._targetPath},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"target",{get:function(){return this._currentActiveTarget},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isAdditive",{get:function(){return this._host&&this._host.isAdditive},enumerable:!1,configurable:!0}),e.prototype._preparePath=function(e,n){void 0===n&&(n=0);var t=this._animation.targetPropertyPath;if(t.length>1){for(var i=e[t[0]],r=1;r<t.length-1;r++)i=i[t[r]];this._targetPath=t[t.length-1],this._activeTargets[n]=i}else this._targetPath=t[0],this._activeTargets[n]=e},Object.defineProperty(e.prototype,"animation",{get:function(){return this._animation},enumerable:!1,configurable:!0}),e.prototype.reset=function(e){if(void 0===e&&(e=!1),e)if(this._target instanceof Array)for(var n=0,t=0,i=this._target;t<i.length;t++){var r=i[t];void 0!==this._originalValue[n]&&this._setValue(r,this._activeTargets[n],this._originalValue[n],-1,n),n++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(n=0;n<this._events.length;n++)this._events[n].isDone=!1},e.prototype.isStopped=function(){return this._stopped},e.prototype.dispose=function(){var e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)},e.prototype.setValue=function(e,n){if(this._targetIsArray)for(var t=0;t<this._target.length;t++){var i=this._target[t];this._setValue(i,this._activeTargets[t],e,n,t)}else this._setValue(this._target,this._directTarget,e,n,0)},e.prototype._getOriginalValues=function(e){var n;void 0===e&&(e=0);var t=this._activeTargets[e];(n=t.getRestPose&&"_matrix"===this._targetPath?t.getRestPose():t[this._targetPath])&&n.clone?this._originalValue[e]=n.clone():this._originalValue[e]=n},e.prototype._setValue=function(e,n,t,i,r){if(this._currentActiveTarget=n,this._weight=i,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){var o=n[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?N.AllowMatrixDecomposeForInterpolation?this._currentValue?A.DecomposeLerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=A.DecomposeLerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue?A.LerpToRef(this._originalBlendValue,t,this._blendingFactor,this._currentValue):this._currentValue=A.Lerp(this._originalBlendValue,t,this._blendingFactor):this._currentValue=N._UniversalLerp(this._originalBlendValue,t,this._blendingFactor);var a=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=a}else this._currentValue=t;-1!==i?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]):n[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)},e.prototype._getCorrectLoopMode=function(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode},e.prototype.goToFrame=function(e){var n=this._animation.getKeys();e<n[0].frame?e=n[0].frame:e>n[n.length-1].frame&&(e=n[n.length-1].frame);var t=this._events;if(t.length)for(var i=0;i<t.length;i++)t[i].onlyOnce||(t[i].isDone=t[i].frame<e);this._currentFrame=e;var r=this._animation._interpolate(e,this._animationState);this.setValue(r,-1)},e.prototype._prepareForSpeedRatioChange=function(e){var n=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-n},e.prototype.animate=function(e,n,t,i,r,o){void 0===o&&(o=-1);var a=this._animation,s=a.targetPropertyPath;if(!s||s.length<1)return this._stopped=!0,!1;var l=!0;(n<this._minFrame||n>this._maxFrame)&&(n=this._minFrame),(t<this._minFrame||t>this._maxFrame)&&(t=this._maxFrame);var c,f,u=t-n,d=e*(a.framePerSecond*r)/1e3+this._ratioOffset,h=0;if(this._previousDelay=e,this._previousRatio=d,!i&&t>=n&&d>=u)l=!1,h=a._getKeyValue(this._maxValue);else if(!i&&n>=t&&d<=u)l=!1,h=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==N.ANIMATIONLOOPMODE_CYCLE){var p=t.toString()+n.toString();if(!this._offsetsCache[p]){this._animationState.repeatCount=0,this._animationState.loopMode=N.ANIMATIONLOOPMODE_CYCLE;var m=a._interpolate(n,this._animationState),_=a._interpolate(t,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case N.ANIMATIONTYPE_FLOAT:this._offsetsCache[p]=_-m;break;case N.ANIMATIONTYPE_QUATERNION:this._offsetsCache[p]=_.subtract(m);break;case N.ANIMATIONTYPE_VECTOR3:this._offsetsCache[p]=_.subtract(m);case N.ANIMATIONTYPE_VECTOR2:this._offsetsCache[p]=_.subtract(m);case N.ANIMATIONTYPE_SIZE:this._offsetsCache[p]=_.subtract(m);case N.ANIMATIONTYPE_COLOR3:this._offsetsCache[p]=_.subtract(m)}this._highLimitsCache[p]=_}h=this._highLimitsCache[p],c=this._offsetsCache[p]}if(void 0===c)switch(a.dataType){case N.ANIMATIONTYPE_FLOAT:c=0;break;case N.ANIMATIONTYPE_QUATERNION:c=ft;break;case N.ANIMATIONTYPE_VECTOR3:c=ut;break;case N.ANIMATIONTYPE_VECTOR2:c=dt;break;case N.ANIMATIONTYPE_SIZE:c=ht;break;case N.ANIMATIONTYPE_COLOR3:c=pt}if(this._host&&this._host.syncRoot){var v=this._host.syncRoot;f=n+(t-n)*((v.masterFrame-v.fromFrame)/(v.toFrame-v.fromFrame))}else f=l&&0!==u?n+d%u:t;var A=this._events;if((u>0&&this.currentFrame>f||u<0&&this.currentFrame<f)&&(this._onLoop(),A.length))for(var g=0;g<A.length;g++)A[g].onlyOnce||(A[g].isDone=!1);this._currentFrame=f,this._animationState.repeatCount=0===u?0:d/u>>0,this._animationState.highLimitValue=h,this._animationState.offsetValue=c;var E=a._interpolate(f,this._animationState);if(this.setValue(E,o),A.length)for(g=0;g<A.length;g++)if(u>0&&f>=A[g].frame&&A[g].frame>=n||u<0&&f<=A[g].frame&&A[g].frame<=n){var T=A[g];T.isDone||(T.onlyOnce&&(A.splice(g,1),g--),T.isDone=!0,T.action(f))}return l||(this._stopped=!0),l},e}(),_t=function(){function e(e,n,t,i,r,o,s,l,c,f){void 0===t&&(t=0),void 0===i&&(i=100),void 0===r&&(r=!1),void 0===o&&(o=1),void 0===f&&(f=!1),this.target=n,this.fromFrame=t,this.toFrame=i,this.loopAnimation=r,this.onAnimationEnd=s,this.onAnimationLoop=c,this.isAdditive=f,this._localDelayOffset=null,this._pausedDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new a,this.onAnimationLoopObservable=new a,this._scene=e,l&&this.appendAnimations(n,l),this._speedRatio=o,e._activeAnimatables.push(this)}return Object.defineProperty(e.prototype,"syncRoot",{get:function(){return this._syncRoot},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"masterFrame",{get:function(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"weight",{get:function(){return this._weight},set:function(e){this._weight=-1!==e?Math.min(Math.max(e,0),1):-1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(e){for(var n=0;n<this._runtimeAnimations.length;n++){this._runtimeAnimations[n]._prepareForSpeedRatioChange(e)}this._speedRatio=e},enumerable:!1,configurable:!0}),e.prototype.syncWith=function(e){if(this._syncRoot=e,e){var n=this._scene._activeAnimatables.indexOf(this);n>-1&&(this._scene._activeAnimatables.splice(n,1),this._scene._activeAnimatables.push(this))}return this},e.prototype.getAnimations=function(){return this._runtimeAnimations},e.prototype.appendAnimations=function(e,n){for(var t=this,i=0;i<n.length;i++){var r=n[i],o=new mt(e,r,this._scene,this);o._onLoop=function(){t.onAnimationLoopObservable.notifyObservers(t),t.onAnimationLoop&&t.onAnimationLoop()},this._runtimeAnimations.push(o)}},e.prototype.getAnimationByTargetProperty=function(e){for(var n=this._runtimeAnimations,t=0;t<n.length;t++)if(n[t].animation.targetProperty===e)return n[t].animation;return null},e.prototype.getRuntimeAnimationByTargetProperty=function(e){for(var n=this._runtimeAnimations,t=0;t<n.length;t++)if(n[t].animation.targetProperty===e)return n[t];return null},e.prototype.reset=function(){for(var e=this._runtimeAnimations,n=0;n<e.length;n++)e[n].reset(!0);this._localDelayOffset=null,this._pausedDelay=null},e.prototype.enableBlending=function(e){for(var n=this._runtimeAnimations,t=0;t<n.length;t++)n[t].animation.enableBlending=!0,n[t].animation.blendingSpeed=e},e.prototype.disableBlending=function(){for(var e=this._runtimeAnimations,n=0;n<e.length;n++)e[n].animation.enableBlending=!1},e.prototype.goToFrame=function(e){var n=this._runtimeAnimations;if(n[0]){var t=n[0].animation.framePerSecond,i=n[0].currentFrame,r=0===this.speedRatio?0:(e-i)/t*1e3/this.speedRatio;null===this._localDelayOffset&&(this._localDelayOffset=0),this._localDelayOffset-=r}for(var o=0;o<n.length;o++)n[o].goToFrame(e)},e.prototype.pause=function(){this._paused||(this._paused=!0)},e.prototype.restart=function(){this._paused=!1},e.prototype._raiseOnAnimationEnd=function(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)},e.prototype.stop=function(e,n){if(e||n){var t=this._scene._activeAnimatables.indexOf(this);if(t>-1){for(var i=(o=this._runtimeAnimations).length-1;i>=0;i--){var r=o[i];e&&r.animation.name!=e||(n&&!n(r.target)||(r.dispose(),o.splice(i,1)))}0==o.length&&(this._scene._activeAnimatables.splice(t,1),this._raiseOnAnimationEnd())}}else{if((i=this._scene._activeAnimatables.indexOf(this))>-1){this._scene._activeAnimatables.splice(i,1);var o=this._runtimeAnimations;for(i=0;i<o.length;i++)o[i].dispose();this._raiseOnAnimationEnd()}}},e.prototype.waitAsync=function(){var e=this;return new Promise((function(n,t){e.onAnimationEndObservable.add((function(){n(e)}),void 0,void 0,e,!0)}))},e.prototype._animate=function(e){if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),0===this._weight)return!0;var n,t=!1,i=this._runtimeAnimations;for(n=0;n<i.length;n++){var r=i[n].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||r}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(n=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(n,1),n=0;n<i.length;n++)i[n].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t},e}();o.prototype._animate=function(){if(this.animationsEnabled){var e=$.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=e}this.deltaTime=this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=e;var n=this._activeAnimatables;if(0!==n.length){this._animationTime+=this.deltaTime;for(var t=this._animationTime,i=0;i<n.length;i++){var r=n[i];!r._animate(t)&&r.disposeOnEnd&&i--}this._processLateAnimationBindings()}}},o.prototype.beginWeightedAnimation=function(e,n,t,i,r,o,a,s,l,c,f){void 0===i&&(i=1),void 0===o&&(o=1),void 0===f&&(f=!1);var u=this.beginAnimation(e,n,t,r,o,a,s,!1,l,c,f);return u.weight=i,u},o.prototype.beginAnimation=function(e,n,t,i,r,o,a,s,l,c,f){void 0===r&&(r=1),void 0===s&&(s=!0),void 0===f&&(f=!1),n>t&&r>0&&(r*=-1),s&&this.stopAnimation(e,void 0,l),a||(a=new _t(this,e,n,t,i,r,o,void 0,c,f));var u=!l||l(e);if(e.animations&&u&&a.appendAnimations(e,e.animations),e.getAnimatables)for(var d=e.getAnimatables(),h=0;h<d.length;h++)this.beginAnimation(d[h],n,t,i,r,o,a,s,l,c);return a.reset(),a},o.prototype.beginHierarchyAnimation=function(e,n,t,i,r,o,a,s,l,c,f,u){void 0===o&&(o=1),void 0===l&&(l=!0),void 0===u&&(u=!1);var d=e.getDescendants(n),h=[];h.push(this.beginAnimation(e,t,i,r,o,a,s,l,c,void 0,u));for(var p=0,m=d;p<m.length;p++){var _=m[p];h.push(this.beginAnimation(_,t,i,r,o,a,s,l,c,void 0,u))}return h},o.prototype.beginDirectAnimation=function(e,n,t,i,r,o,a,s,l){return void 0===l&&(l=!1),void 0===o&&(o=1),t>i&&o>0&&(o*=-1),new _t(this,e,t,i,r,o,a,n,s,l)},o.prototype.beginDirectHierarchyAnimation=function(e,n,t,i,r,o,a,s,l,c){void 0===c&&(c=!1);var f=e.getDescendants(n),u=[];u.push(this.beginDirectAnimation(e,t,i,r,o,a,s,l,c));for(var d=0,h=f;d<h.length;d++){var p=h[d];u.push(this.beginDirectAnimation(p,t,i,r,o,a,s,l,c))}return u},o.prototype.getAnimatableByTarget=function(e){for(var n=0;n<this._activeAnimatables.length;n++)if(this._activeAnimatables[n].target===e)return this._activeAnimatables[n];return null},o.prototype.getAllAnimatablesByTarget=function(e){for(var n=[],t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===e&&n.push(this._activeAnimatables[t]);return n},o.prototype.stopAnimation=function(e,n,t){for(var i=0,r=this.getAllAnimatablesByTarget(e);i<r.length;i++){r[i].stop(n,t)}},o.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(var e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop();this._activeAnimatables=[]}for(var n=0,t=this.animationGroups;n<t.length;n++){t[n].stop()}},o.prototype._registerTargetForLateAnimationBinding=function(e,n){var t=e.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[e.targetPath]||(t._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:n}),e.isAdditive?(t._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),t._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(t._lateAnimationHolders[e.targetPath].animations.push(e),t._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)},o.prototype._processLateAnimationBindingsForMatrices=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;var n=1,t=P.Vector3[0],i=P.Vector3[1],r=P.Quaternion[0],o=0,a=e.animations[0],s=e.originalValue,l=1,c=!1;if(e.totalWeight<1)l=1-e.totalWeight,s.decompose(i,r,t);else{if(o=1,n=e.totalWeight,1==(l=a.weight/n)){if(!e.totalAdditiveWeight)return a.currentValue;c=!0}a.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(var f=o;f<e.animations.length;f++){if(0!==(_=e.animations[f]).weight){l=_.weight/n;var u=P.Vector3[2],d=P.Vector3[3],h=P.Quaternion[1];_.currentValue.decompose(d,h,u),d.scaleAndAddToRef(l,i),h.scaleAndAddToRef(l,r),u.scaleAndAddToRef(l,t)}}}for(var p=0;p<e.additiveAnimations.length;p++){var _;if(0!==(_=e.additiveAnimations[p]).weight){u=P.Vector3[2],d=P.Vector3[3],h=P.Quaternion[1];_.currentValue.decompose(d,h,u),d.multiplyToRef(i,d),m.LerpToRef(i,d,_.weight,i),r.multiplyToRef(h,h),C.SlerpToRef(r,h,_.weight,r),u.scaleAndAddToRef(_.weight,t)}}var v=a?a._animationState.workValue:P.Matrix[0].clone();return A.ComposeToRef(i,r,t,v),v},o.prototype._processLateAnimationBindingsForQuaternions=function(e,n){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return n;var t=e.animations[0],i=e.originalValue,r=n;if(0===e.totalWeight&&e.totalAdditiveWeight>0)r.copyFrom(i);else if(1===e.animations.length){if(C.SlerpToRef(i,t.currentValue,Math.min(1,e.totalWeight),r),0===e.totalAdditiveWeight)return r}else if(e.animations.length>1){var o=1,a=void 0,s=void 0;if(e.totalWeight<1){var l=1-e.totalWeight;s=[],(a=[]).push(i),s.push(l)}else{if(2===e.animations.length&&(C.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,n),0===e.totalAdditiveWeight))return n;a=[],s=[],o=e.totalWeight}for(var c=0;c<e.animations.length;c++){var f=e.animations[c];a.push(f.currentValue),s.push(f.weight/o)}for(var u=0,d=0;d<a.length;)d?(u+=s[d],C.SlerpToRef(r,a[d],s[d]/u,r),d++):(C.SlerpToRef(a[d],a[d+1],s[d+1]/(s[d]+s[d+1]),n),r=n,u=s[d]+s[d+1],d+=2)}for(var h=0;h<e.additiveAnimations.length;h++){0!==(f=e.additiveAnimations[h]).weight&&(r.multiplyToRef(f.currentValue,P.Quaternion[0]),C.SlerpToRef(r,P.Quaternion[0],f.weight,r))}return r},o.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(var e=0;e<this._registeredForLateAnimationBindings.length;e++){var n=this._registeredForLateAnimationBindings.data[e];for(var t in n._lateAnimationHolders){var i=n._lateAnimationHolders[t],r=i.animations[0],o=i.originalValue,a=N.AllowMatrixDecomposeForInterpolation&&o.m,s=n[t];if(a)s=this._processLateAnimationBindingsForMatrices(i);else if(void 0!==o.w)s=this._processLateAnimationBindingsForQuaternions(i,s||C.Identity());else{var l=0,c=1;if(i.totalWeight<1)s=r&&o.scale?o.scale(1-i.totalWeight):r?o*(1-i.totalWeight):o.clone?o.clone():o;else if(r){c=i.totalWeight;var f=r.weight/c;s=1!==f?r.currentValue.scale?r.currentValue.scale(f):r.currentValue*f:r.currentValue,l=1}for(var u=l;u<i.animations.length;u++){(p=(h=i.animations[u]).weight/c)&&(h.currentValue.scaleAndAddToRef?h.currentValue.scaleAndAddToRef(p,s):s+=h.currentValue*p)}for(var d=0;d<i.additiveAnimations.length;d++){var h,p;(p=(h=i.additiveAnimations[d]).weight)&&(h.currentValue.scaleAndAddToRef?h.currentValue.scaleAndAddToRef(p,s):s+=h.currentValue*p)}}n[t]=s}n._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}},Rn.prototype.copyAnimationRange=function(e,n,t,i,r){void 0===i&&(i=!1),void 0===r&&(r=null),0===this.animations.length&&(this.animations.push(new N(this.name,"_matrix",e.animations[0].framePerSecond,N.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));var o=e.animations[0].getRange(n);if(!o)return!1;for(var a,s,l,c=o.from,f=o.to,u=e.animations[0].getKeys(),d=e.length,h=e.getParent(),p=this.getParent(),m=i&&h&&d&&this.length&&d!==this.length,_=m&&p&&h?p.length/h.length:1,v=i&&!p&&r&&(1!==r.x||1!==r.y||1!==r.z),A=this.animations[0].getKeys(),g=0,E=u.length;g<E;g++)(a=u[g]).frame>=c&&a.frame<=f&&(i?(l=a.value.clone(),m?(s=l.getTranslation(),l.setTranslation(s.scaleInPlace(_))):v&&r?(s=l.getTranslation(),l.setTranslation(s.multiplyInPlace(r))):l=a.value):l=a.value,A.push({frame:a.frame+t,value:l}));return this.animations[0].createRange(n,c+t,f+t),!0};var vt=function(){function e(){}return e.prototype.getClassName=function(){return"TargetedAnimation"},e.prototype.serialize=function(){var e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e},e}(),At=function(){function e(e,n){void 0===n&&(n=null),this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this.onAnimationEndObservable=new a,this.onAnimationLoopObservable=new a,this.onAnimationGroupLoopObservable=new a,this.onAnimationGroupEndObservable=new a,this.onAnimationGroupPauseObservable=new a,this.onAnimationGroupPlayObservable=new a,this._scene=n||s.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}return Object.defineProperty(e.prototype,"from",{get:function(){return this._from},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"to",{get:function(){return this._to},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isStarted",{get:function(){return this._isStarted},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isPlaying",{get:function(){return this._isStarted&&!this._isPaused},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"speedRatio",{get:function(){return this._speedRatio},set:function(e){if(this._speedRatio!==e){this._speedRatio=e;for(var n=0;n<this._animatables.length;n++){this._animatables[n].speedRatio=this._speedRatio}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"loopAnimation",{get:function(){return this._loopAnimation},set:function(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(var n=0;n<this._animatables.length;n++){this._animatables[n].loopAnimation=this._loopAnimation}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isAdditive",{get:function(){return this._isAdditive},set:function(e){if(this._isAdditive!==e){this._isAdditive=e;for(var n=0;n<this._animatables.length;n++){this._animatables[n].isAdditive=this._isAdditive}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"targetedAnimations",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animatables",{get:function(){return this._animatables},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._targetedAnimations},enumerable:!1,configurable:!0}),e.prototype.addTargetedAnimation=function(e,n){var t=new vt;t.animation=e,t.target=n;var i=e.getKeys();return this._from>i[0].frame&&(this._from=i[0].frame),this._to<i[i.length-1].frame&&(this._to=i[i.length-1].frame),this._targetedAnimations.push(t),t},e.prototype.normalize=function(e,n){void 0===e&&(e=null),void 0===n&&(n=null),null==e&&(e=this._from),null==n&&(n=this._to);for(var t=0;t<this._targetedAnimations.length;t++){var i=this._targetedAnimations[t].animation.getKeys(),r=i[0],o=i[i.length-1];if(r.frame>e){var a={frame:e,value:r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation};i.splice(0,0,a)}if(o.frame<n){a={frame:n,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};i.push(a)}}return this._from=e,this._to=n,this},e.prototype._processLoop=function(e,n,t){var i=this;e.onAnimationLoop=function(){i.onAnimationLoopObservable.notifyObservers(n),i._animationLoopFlags[t]||(i._animationLoopFlags[t]=!0,i._animationLoopCount++,i._animationLoopCount===i._targetedAnimations.length&&(i.onAnimationGroupLoopObservable.notifyObservers(i),i._animationLoopCount=0,i._animationLoopFlags=[]))}},e.prototype.start=function(e,n,t,i,r){var o=this;if(void 0===e&&(e=!1),void 0===n&&(n=1),this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags=[];for(var a=function(){var a=s._targetedAnimations[l],c=s._scene.beginDirectAnimation(a.target,[a.animation],void 0!==t?t:s._from,void 0!==i?i:s._to,e,n,void 0,void 0,void 0!==r?r:s._isAdditive);c.onAnimationEnd=function(){o.onAnimationEndObservable.notifyObservers(a),o._checkAnimationGroupEnded(c)},s._processLoop(c,a,l),s._animatables.push(c)},s=this,l=0;l<this._targetedAnimations.length;l++)a();if(this._speedRatio=n,void 0!==t&&void 0!==i)if(t<i&&this._speedRatio<0){var c=i;i=t,t=c}else t>i&&this._speedRatio>0&&(this._speedRatio=-n);return this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this},e.prototype.pause=function(){if(!this._isStarted)return this;this._isPaused=!0;for(var e=0;e<this._animatables.length;e++){this._animatables[e].pause()}return this.onAnimationGroupPauseObservable.notifyObservers(this),this},e.prototype.play=function(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this},e.prototype.reset=function(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(var e=0;e<this._animatables.length;e++){this._animatables[e].reset()}return this},e.prototype.restart=function(){if(!this._isStarted)return this;for(var e=0;e<this._animatables.length;e++){this._animatables[e].restart()}return this.onAnimationGroupPlayObservable.notifyObservers(this),this},e.prototype.stop=function(){if(!this._isStarted)return this;for(var e=this._animatables.slice(),n=0;n<e.length;n++)e[n].stop();return this._isStarted=!1,this},e.prototype.setWeightForAllAnimatables=function(e){for(var n=0;n<this._animatables.length;n++){this._animatables[n].weight=e}return this},e.prototype.syncAllAnimationsWith=function(e){for(var n=0;n<this._animatables.length;n++){this._animatables[n].syncWith(e)}return this},e.prototype.goToFrame=function(e){if(!this._isStarted)return this;for(var n=0;n<this._animatables.length;n++){this._animatables[n].goToFrame(e)}return this},e.prototype.dispose=function(){this._targetedAnimations=[],this._animatables=[];var e=this._scene.animationGroups.indexOf(this);e>-1&&this._scene.animationGroups.splice(e,1),this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()},e.prototype._checkAnimationGroupEnded=function(e){var n=this._animatables.indexOf(e);n>-1&&this._animatables.splice(n,1),0===this._animatables.length&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))},e.prototype.clone=function(n,t){for(var i=new e(n||this.name,this._scene),r=0,o=this._targetedAnimations;r<o.length;r++){var a=o[r];i.addTargetedAnimation(a.animation.clone(),t?t(a.target):a.target)}return i},e.prototype.serialize=function(){var e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(var n=0;n<this.targetedAnimations.length;n++){var t=this.targetedAnimations[n];e.targetedAnimations[n]=t.serialize()}return e},e.Parse=function(n,t){for(var i=new e(n.name,t),r=0;r<n.targetedAnimations.length;r++){var o=n.targetedAnimations[r],a=N.Parse(o.animation),s=o.targetId;if("influence"===o.animation.property){var l=t.getMorphTargetById(s);l&&i.addTargetedAnimation(a,l)}else{var c=t.getNodeByID(s);null!=c&&i.addTargetedAnimation(a,c)}}return null!==n.from&&null!==n.to&&i.normalize(n.from,n.to),i},e.MakeAnimationAdditive=function(e,n,t,i,r){void 0===n&&(n=0),void 0===i&&(i=!1);var o=e;i&&(o=e.clone(r||o.name));for(var a=o.targetedAnimations,s=0;s<a.length;s++){var l=a[s];N.MakeAnimationAdditive(l.animation,n,t)}return o.isAdditive=!0,o},e.prototype.getClassName=function(){return"AnimationGroup"},e.prototype.toString=function(e){var n="Name: "+this.name;return n+=", type: "+this.getClassName(),e&&(n+=", from: "+this._from,n+=", to: "+this._to,n+=", isStarted: "+this._isStarted,n+=", speedRatio: "+this._speedRatio,n+=", targetedAnimations length: "+this._targetedAnimations.length,n+=", animatables length: "+this._animatables),n},e}();z.ShadersStore.rgbdDecodePixelShader="\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\nvoid main(void)\n{\ngl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);\n}";var gt=function(){function e(){}return e.ExpandRGBDTexture=function(e){var n=e._texture;if(n&&e.isRGBD){var t=n.getEngine(),i=t.getCaps(),r=!1;i.textureHalfFloatRender&&i.textureHalfFloatLinearFiltering?(r=!0,n.type=2):i.textureFloatRender&&i.textureFloatLinearFiltering&&(r=!0,n.type=1),r&&(n.isReady=!1,n._isRGBD=!1,n.invertY=!1),e.onLoadObservable.addOnce((function(){if(r){var i=new Ie("rgbdDecode","rgbdDecode",null,null,1,null,3,t,!1,void 0,n.type,void 0,null,!1),o=t.createRenderTargetTexture(n.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:n.samplingMode,type:n.type,format:5});i.getEffect().executeWhenCompiled((function(){i.onApply=function(e){e._bindTexture("textureSampler",n),e.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([i],o,!0),t.restoreDefaultFramebuffer(),t._releaseTexture(n),t._releaseFramebufferObjects(o),i&&i.dispose(),o._swapAndDie(n),n.isReady=!0}))}}))}},e}(),Et=function(){function e(){}return e.GetEnvironmentBRDFTexture=function(e){if(!e.environmentBRDFTexture){var n=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;var t=e._blockEntityCollection;e._blockEntityCollection=!1;var i=ge.CreateFromBase64String(this._environmentBRDFBase64Texture,"EnvironmentBRDFTexture"+this._instanceNumber++,e,!0,!1,ge.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=t;var r=e.getEngine().getLoadedTexturesCache(),o=r.indexOf(i.getInternalTexture());-1!==o&&r.splice(o,1),i.isRGBD=!0,i.wrapU=ge.CLAMP_ADDRESSMODE,i.wrapV=ge.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=i,e.useDelayedTextureLoading=n,gt.ExpandRGBDTexture(i)}return e.environmentBRDFTexture},e._instanceNumber=0,e._environmentBRDFBase64Texture="data:image/png;base64,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",e}(),Tt=function(){function e(n){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=e._DefaultIndexOfRefraction,this.indexOfRefraction=e._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=w.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=n}return e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype.isReadyForSubMesh=function(e,n,t,i){if(e._areTexturesDirty&&n.texturesEnabled){if(this._texture&&Oe.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Oe.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1;if(t.getCaps().standardDerivatives&&this._bumpTexture&&Oe.ClearCoatBumpTextureEnabled&&!i&&!this._bumpTexture.isReady())return!1;if(this._isTintEnabled&&this._tintTexture&&Oe.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking())return!1}return!0},e.prototype.prepareDefines=function(n,t){var i;this._isEnabled?(n.CLEARCOAT=!0,n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,n.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(i=this._textureRoughness)||void 0===i?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),n.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,n._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Oe.ClearCoatTextureEnabled?Ee.PrepareDefinesForMergedUV(this._texture,n,"CLEARCOAT_TEXTURE"):n.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&Oe.ClearCoatTextureEnabled?Ee.PrepareDefinesForMergedUV(this._textureRoughness,n,"CLEARCOAT_TEXTURE_ROUGHNESS"):n.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&Oe.ClearCoatBumpTextureEnabled?Ee.PrepareDefinesForMergedUV(this._bumpTexture,n,"CLEARCOAT_BUMP"):n.CLEARCOAT_BUMP=!1,n.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===e._DefaultIndexOfRefraction,this._isTintEnabled?(n.CLEARCOAT_TINT=!0,this._tintTexture&&Oe.ClearCoatTintTextureEnabled?Ee.PrepareDefinesForMergedUV(this._tintTexture,n,"CLEARCOAT_TINT_TEXTURE"):n.CLEARCOAT_TINT_TEXTURE=!1):(n.CLEARCOAT_TINT=!1,n.CLEARCOAT_TINT_TEXTURE=!1))):(n.CLEARCOAT=!1,n.CLEARCOAT_TEXTURE=!1,n.CLEARCOAT_TEXTURE_ROUGHNESS=!1,n.CLEARCOAT_BUMP=!1,n.CLEARCOAT_TINT=!1,n.CLEARCOAT_TINT_TEXTURE=!1,n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,n.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1)},e.prototype.bindForSubMesh=function(e,n,t,i,r,o,a,s){var l,c,f,u,d,h,p,m,_=s._materialDefines,v=_.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!r||!e.isSync){v&&Oe.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Ee.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&Oe.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",null!==(c=null===(l=this._texture)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==c?c:0,null!==(u=null===(f=this._texture)||void 0===f?void 0:f.level)&&void 0!==u?u:0,null!==(h=null===(d=this._textureRoughness)||void 0===d?void 0:d.coordinatesIndex)&&void 0!==h?h:0,null!==(m=null===(p=this._textureRoughness)||void 0===p?void 0:p.level)&&void 0!==m?m:0),this._texture&&Ee.BindTextureMatrix(this._texture,e,"clearCoat"),!this._textureRoughness||v||_.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE||Ee.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&t.getCaps().standardDerivatives&&Oe.ClearCoatTextureEnabled&&!i&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),Ee.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),n._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",o?1:-1,a?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",o?-1:1,a?-1:1)),this._tintTexture&&Oe.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),Ee.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);var A=1-this._indexOfRefraction,g=1+this._indexOfRefraction,E=Math.pow(-A/g,2),T=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",E,T,A,g),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}n.texturesEnabled&&(this._texture&&Oe.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!v&&!_.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&Oe.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&t.getCaps().standardDerivatives&&Oe.ClearCoatBumpTextureEnabled&&!i&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&Oe.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))},e.prototype.hasTexture=function(e){return this._texture===e||(this._textureRoughness===e||(this._bumpTexture===e||this._tintTexture===e))},e.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)},e.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)},e.prototype.dispose=function(e){var n,t,i,r;e&&(null===(n=this._texture)||void 0===n||n.dispose(),null===(t=this._textureRoughness)||void 0===t||t.dispose(),null===(i=this._bumpTexture)||void 0===i||i.dispose(),null===(r=this._tintTexture)||void 0===r||r.dispose())},e.prototype.getClassName=function(){return"PBRClearCoatConfiguration"},e.AddFallbacks=function(e,n,t){return e.CLEARCOAT_BUMP&&n.addFallback(t++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&n.addFallback(t++,"CLEARCOAT_TINT"),e.CLEARCOAT&&n.addFallback(t++,"CLEARCOAT"),t},e.AddUniforms=function(e){e.push("vClearCoatTangentSpaceParams","vClearCoatParams","vClearCoatRefractionParams","vClearCoatTintParams","clearCoatColorAtDistance","clearCoatMatrix","clearCoatRoughnessMatrix","clearCoatBumpMatrix","clearCoatTintMatrix","vClearCoatInfos","vClearCoatBumpInfos","vClearCoatTintInfos")},e.AddSamplers=function(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")},e.PrepareUniformBuffer=function(e){e.addUniform("vClearCoatParams",2),e.addUniform("vClearCoatRefractionParams",4),e.addUniform("vClearCoatInfos",4),e.addUniform("clearCoatMatrix",16),e.addUniform("clearCoatRoughnessMatrix",16),e.addUniform("vClearCoatBumpInfos",2),e.addUniform("vClearCoatTangentSpaceParams",2),e.addUniform("clearCoatBumpMatrix",16),e.addUniform("vClearCoatTintParams",4),e.addUniform("clearCoatColorAtDistance",1),e.addUniform("vClearCoatTintInfos",2),e.addUniform("clearCoatTintMatrix",16)},e.prototype.copyTo=function(e){U.Clone((function(){return e}),this)},e.prototype.serialize=function(){return U.Serialize(this)},e.prototype.parse=function(e,n,t){var i=this;U.Parse((function(){return i}),e,n,t)},e._DefaultIndexOfRefraction=1.5,d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isEnabled",void 0),d([h()],e.prototype,"intensity",void 0),d([h()],e.prototype,"roughness",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"indexOfRefraction",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"texture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useRoughnessFromMainTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"textureRoughness",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"remapF0OnInterfaceChange",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"bumpTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isTintEnabled",void 0),d([te()],e.prototype,"tintColor",void 0),d([h()],e.prototype,"tintColorAtDistance",void 0),d([h()],e.prototype,"tintThickness",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"tintTexture",void 0),e}(),yt=function(){function e(e){this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new T(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e}return e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype.isReadyForSubMesh=function(e,n){return!(e._areTexturesDirty&&n.texturesEnabled&&this._texture&&Oe.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking())},e.prototype.prepareDefines=function(e,n,t){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!n.isVerticesDataPresent(F.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&Oe.AnisotropicTextureEnabled?Ee.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1)},e.prototype.bindForSubMesh=function(e,n,t){e.useUbo&&t&&e.isSync||(this._texture&&Oe.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),Ee.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),n.texturesEnabled&&this._texture&&Oe.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)},e.prototype.hasTexture=function(e){return this._texture===e},e.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture)},e.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)},e.prototype.dispose=function(e){e&&this._texture&&this._texture.dispose()},e.prototype.getClassName=function(){return"PBRAnisotropicConfiguration"},e.AddFallbacks=function(e,n,t){return e.ANISOTROPIC&&n.addFallback(t++,"ANISOTROPIC"),t},e.AddUniforms=function(e){e.push("vAnisotropy","vAnisotropyInfos","anisotropyMatrix")},e.PrepareUniformBuffer=function(e){e.addUniform("vAnisotropy",3),e.addUniform("vAnisotropyInfos",2),e.addUniform("anisotropyMatrix",16)},e.AddSamplers=function(e){e.push("anisotropySampler")},e.prototype.copyTo=function(e){U.Clone((function(){return e}),this)},e.prototype.serialize=function(){return U.Serialize(this)},e.prototype.parse=function(e,n,t){var i=this;U.Parse((function(){return i}),e,n,t)},d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isEnabled",void 0),d([h()],e.prototype,"intensity",void 0),d([ie()],e.prototype,"direction",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"texture",void 0),e}(),Rt=function(){function e(n){this._useEnergyConservation=e.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=e.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=e.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=e.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=e.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=e.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=e.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=e.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=n}return e.prototype._markAllSubMeshesAsMiscDirty=function(){this._internalMarkAllSubMeshesAsMiscDirty()},e.prototype.prepareDefines=function(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation},e.prototype.getClassName=function(){return"PBRBRDFConfiguration"},e.prototype.copyTo=function(e){U.Clone((function(){return e}),this)},e.prototype.serialize=function(){return U.Serialize(this)},e.prototype.parse=function(e,n,t){var i=this;U.Parse((function(){return i}),e,n,t)},e.DEFAULT_USE_ENERGY_CONSERVATION=!0,e.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,e.DEFAULT_USE_SPHERICAL_HARMONICS=!0,e.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,d([h(),ee("_markAllSubMeshesAsMiscDirty")],e.prototype,"useEnergyConservation",void 0),d([h(),ee("_markAllSubMeshesAsMiscDirty")],e.prototype,"useSmithVisibilityHeightCorrelated",void 0),d([h(),ee("_markAllSubMeshesAsMiscDirty")],e.prototype,"useSphericalHarmonics",void 0),d([h(),ee("_markAllSubMeshesAsMiscDirty")],e.prototype,"useSpecularGlossinessInputEnergyConservation",void 0),e}(),Ct=function(){function e(e){this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=w.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e}return e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype.isReadyForSubMesh=function(e,n){if(e._areTexturesDirty&&n.texturesEnabled){if(this._texture&&Oe.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking())return!1;if(this._textureRoughness&&Oe.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())return!1}return!0},e.prototype.prepareDefines=function(e,n){var t;this._isEnabled?(e.SHEEN=this._isEnabled,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=null!==this._texture&&this._texture._texture===(null===(t=this._textureRoughness)||void 0===t?void 0:t._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&n.texturesEnabled&&(this._texture&&Oe.SheenTextureEnabled?Ee.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"):e.SHEEN_TEXTURE=!1,this._textureRoughness&&Oe.SheenTextureEnabled?Ee.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1)},e.prototype.bindForSubMesh=function(e,n,t,i){var r,o,a,s,l,c,f,u,d=i._materialDefines,h=d.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;e.useUbo&&t&&e.isSync||(h&&Oe.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),Ee.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&Oe.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",null!==(o=null===(r=this._texture)||void 0===r?void 0:r.coordinatesIndex)&&void 0!==o?o:0,null!==(s=null===(a=this._texture)||void 0===a?void 0:a.level)&&void 0!==s?s:0,null!==(c=null===(l=this._textureRoughness)||void 0===l?void 0:l.coordinatesIndex)&&void 0!==c?c:0,null!==(u=null===(f=this._textureRoughness)||void 0===f?void 0:f.level)&&void 0!==u?u:0),this._texture&&Ee.BindTextureMatrix(this._texture,e,"sheen"),!this._textureRoughness||h||d.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE||Ee.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),n.texturesEnabled&&(this._texture&&Oe.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!h&&!d.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&Oe.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))},e.prototype.hasTexture=function(e){return this._texture===e||this._textureRoughness===e},e.prototype.getActiveTextures=function(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)},e.prototype.getAnimatables=function(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)},e.prototype.dispose=function(e){var n,t;e&&(null===(n=this._texture)||void 0===n||n.dispose(),null===(t=this._textureRoughness)||void 0===t||t.dispose())},e.prototype.getClassName=function(){return"PBRSheenConfiguration"},e.AddFallbacks=function(e,n,t){return e.SHEEN&&n.addFallback(t++,"SHEEN"),t},e.AddUniforms=function(e){e.push("vSheenColor","vSheenRoughness","vSheenInfos","sheenMatrix","sheenRoughnessMatrix")},e.PrepareUniformBuffer=function(e){e.addUniform("vSheenColor",4),e.addUniform("vSheenRoughness",1),e.addUniform("vSheenInfos",4),e.addUniform("sheenMatrix",16),e.addUniform("sheenRoughnessMatrix",16)},e.AddSamplers=function(e){e.push("sheenSampler"),e.push("sheenRoughnessSampler")},e.prototype.copyTo=function(e){U.Clone((function(){return e}),this)},e.prototype.serialize=function(){return U.Serialize(this)},e.prototype.parse=function(e,n,t){var i=this;U.Parse((function(){return i}),e,n,t)},d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isEnabled",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"linkSheenWithAlbedo",void 0),d([h()],e.prototype,"intensity",void 0),d([te()],e.prototype,"color",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"texture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useRoughnessFromMainTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"roughness",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"textureRoughness",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"albedoScaling",void 0),e}(),bt=function(){function e(e,n,t){this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.tintColor=w.White(),this.tintColorAtDistance=1,this.diffusionDistance=w.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._useMaskFromThicknessTextureGltf=!1,this.useMaskFromThicknessTextureGltf=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e,this._internalMarkScenePrePassDirty=n,this._scene=t}return Object.defineProperty(e.prototype,"scatteringDiffusionProfile",{get:function(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null},set:function(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volumeIndexOfRefraction",{get:function(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction},set:function(e){this._volumeIndexOfRefraction=e>=1?e:-1},enumerable:!1,configurable:!0}),e.prototype._markAllSubMeshesAsTexturesDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty()},e.prototype._markScenePrePassDirty=function(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()},e.prototype.isReadyForSubMesh=function(e,n){if(e._areTexturesDirty&&n.texturesEnabled){if(this._thicknessTexture&&Oe.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;var t=this._getRefractionTexture(n);if(t&&Oe.RefractionTextureEnabled&&!t.isReadyOrNotBlocking())return!1}return!0},e.prototype.prepareDefines=function(e,n){if(e._areTexturesDirty&&(e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,e.SS_REFRACTION=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled)&&(e.SUBSURFACE=!0,e._areTexturesDirty&&n.texturesEnabled&&this._thicknessTexture&&Oe.ThicknessTextureEnabled&&Ee.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),e.SS_MASK_FROM_THICKNESS_TEXTURE=this._useMaskFromThicknessTexture,e.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=this._useMaskFromThicknessTextureGltf),this._isRefractionEnabled&&n.texturesEnabled)){var t=this._getRefractionTexture(n);t&&Oe.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=t.isCube,e.SS_GAMMAREFRACTION=t.gammaSpace,e.SS_RGBDREFRACTION=t.isRGBD,e.SS_LINEARSPECULARREFRACTION=t.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=t.invertZ,e.SS_LODINREFRACTIONALPHA=t.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction)}},e.prototype.bindForSubMesh=function(e,n,t,i,r,o){var a=this._getRefractionTexture(n);if(!e.useUbo||!i||!e.isSync){if(this._thicknessTexture&&Oe.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),Ee.BindTextureMatrix(this._thicknessTexture,e,"thickness")),e.updateFloat2("vThicknessParam",this.minimumThickness,this.maximumThickness-this.minimumThickness),a&&Oe.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",a.getReflectionTextureMatrix());var s=1;a.isCube||a.depth&&(s=a.depth);var l=a.getSize().width,c=this.volumeIndexOfRefraction;e.updateFloat4("vRefractionInfos",a.level,1/c,s,this._invertRefractionY?-1:1),e.updateFloat3("vRefractionMicrosurfaceInfos",l,a.lodGenerationScale,a.lodGenerationOffset),o&&e.updateFloat2("vRefractionFilteringInfo",l,re.Log2(l))}this.isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,this.tintColorAtDistance),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}n.texturesEnabled&&(this._thicknessTexture&&Oe.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),a&&Oe.RefractionTextureEnabled&&(r?e.setTexture("refractionSampler",a):(e.setTexture("refractionSampler",a._lodTextureMid||a),e.setTexture("refractionSamplerLow",a._lodTextureLow||a),e.setTexture("refractionSamplerHigh",a._lodTextureHigh||a))))},e.prototype.unbind=function(e){return!(!this._refractionTexture||!this._refractionTexture.isRenderTarget)&&(e.setTexture("refractionSampler",null),!0)},e.prototype._getRefractionTexture=function(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null},Object.defineProperty(e.prototype,"disableAlphaBlending",{get:function(){return this.isRefractionEnabled&&this._linkRefractionWithTransparency},enumerable:!1,configurable:!0}),e.prototype.fillRenderTargetTextures=function(e){Oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)},e.prototype.hasTexture=function(e){return this._thicknessTexture===e||this._refractionTexture===e},e.prototype.hasRenderTargetTextures=function(){return!!(Oe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)},e.prototype.getActiveTextures=function(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)},e.prototype.getAnimatables=function(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)},e.prototype.dispose=function(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())},e.prototype.getClassName=function(){return"PBRSubSurfaceConfiguration"},e.AddFallbacks=function(e,n,t){return e.SS_SCATTERING&&n.addFallback(t++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&n.addFallback(t++,"SS_TRANSLUCENCY"),t},e.AddUniforms=function(e){e.push("vDiffusionDistance","vTintColor","vSubSurfaceIntensity","vRefractionMicrosurfaceInfos","vRefractionFilteringInfo","vRefractionInfos","vThicknessInfos","vThicknessParam","refractionMatrix","thicknessMatrix","scatteringDiffusionProfile")},e.AddSamplers=function(e){e.push("thicknessSampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")},e.PrepareUniformBuffer=function(e){e.addUniform("vRefractionMicrosurfaceInfos",3),e.addUniform("vRefractionFilteringInfo",2),e.addUniform("vRefractionInfos",4),e.addUniform("refractionMatrix",16),e.addUniform("vThicknessInfos",2),e.addUniform("thicknessMatrix",16),e.addUniform("vThicknessParam",2),e.addUniform("vDiffusionDistance",3),e.addUniform("vTintColor",4),e.addUniform("vSubSurfaceIntensity",3),e.addUniform("scatteringDiffusionProfile",1)},e.prototype.copyTo=function(e){U.Clone((function(){return e}),this)},e.prototype.serialize=function(){return U.Serialize(this)},e.prototype.parse=function(e,n,t){var i=this;U.Parse((function(){return i}),e,n,t)},d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isRefractionEnabled",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"isTranslucencyEnabled",void 0),d([h(),ee("_markScenePrePassDirty")],e.prototype,"isScatteringEnabled",void 0),d([h()],e.prototype,"_scatteringDiffusionProfileIndex",void 0),d([h()],e.prototype,"refractionIntensity",void 0),d([h()],e.prototype,"translucencyIntensity",void 0),d([h()],e.prototype,"useAlbedoToTintRefraction",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"thicknessTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"refractionTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"indexOfRefraction",void 0),d([h()],e.prototype,"_volumeIndexOfRefraction",void 0),d([ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"volumeIndexOfRefraction",null),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"invertRefractionY",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"linkRefractionWithTransparency",void 0),d([h()],e.prototype,"minimumThickness",void 0),d([h()],e.prototype,"maximumThickness",void 0),d([te()],e.prototype,"tintColor",void 0),d([h()],e.prototype,"tintColorAtDistance",void 0),d([te()],e.prototype,"diffusionDistance",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useMaskFromThicknessTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],e.prototype,"useMaskFromThicknessTextureGltf",void 0),e}(),St=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],It=[function(e){return 1},function(e){return e.y},function(e){return e.z},function(e){return e.x},function(e){return e.x*e.y},function(e){return e.y*e.z},function(e){return 3*e.z*e.z-1},function(e){return e.x*e.z},function(e){return e.x*e.x-e.y*e.y}],Ot=function(e,n){return St[e]*It[e](n)},Mt=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],xt=function(){function e(){this.preScaled=!1,this.l00=m.Zero(),this.l1_1=m.Zero(),this.l10=m.Zero(),this.l11=m.Zero(),this.l2_2=m.Zero(),this.l2_1=m.Zero(),this.l20=m.Zero(),this.l21=m.Zero(),this.l22=m.Zero()}return e.prototype.addLight=function(e,n,t){var i=new m(n.r,n.g,n.b).scale(t);this.l00=this.l00.add(i.scale(Ot(0,e))),this.l1_1=this.l1_1.add(i.scale(Ot(1,e))),this.l10=this.l10.add(i.scale(Ot(2,e))),this.l11=this.l11.add(i.scale(Ot(3,e))),this.l2_2=this.l2_2.add(i.scale(Ot(4,e))),this.l2_1=this.l2_1.add(i.scale(Ot(5,e))),this.l20=this.l20.add(i.scale(Ot(6,e))),this.l21=this.l21.add(i.scale(Ot(7,e))),this.l22=this.l22.add(i.scale(Ot(8,e)))},e.prototype.scaleInPlace=function(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)},e.prototype.convertIncidentRadianceToIrradiance=function(){this.l00.scaleInPlace(Mt[0]),this.l1_1.scaleInPlace(Mt[1]),this.l10.scaleInPlace(Mt[2]),this.l11.scaleInPlace(Mt[3]),this.l2_2.scaleInPlace(Mt[4]),this.l2_1.scaleInPlace(Mt[5]),this.l20.scaleInPlace(Mt[6]),this.l21.scaleInPlace(Mt[7]),this.l22.scaleInPlace(Mt[8])},e.prototype.convertIrradianceToLambertianRadiance=function(){this.scaleInPlace(1/Math.PI)},e.prototype.preScaleForRendering=function(){this.preScaled=!0,this.l00.scaleInPlace(St[0]),this.l1_1.scaleInPlace(St[1]),this.l10.scaleInPlace(St[2]),this.l11.scaleInPlace(St[3]),this.l2_2.scaleInPlace(St[4]),this.l2_1.scaleInPlace(St[5]),this.l20.scaleInPlace(St[6]),this.l21.scaleInPlace(St[7]),this.l22.scaleInPlace(St[8])},e.FromArray=function(n){var t=new e;return m.FromArrayToRef(n[0],0,t.l00),m.FromArrayToRef(n[1],0,t.l1_1),m.FromArrayToRef(n[2],0,t.l10),m.FromArrayToRef(n[3],0,t.l11),m.FromArrayToRef(n[4],0,t.l2_2),m.FromArrayToRef(n[5],0,t.l2_1),m.FromArrayToRef(n[6],0,t.l20),m.FromArrayToRef(n[7],0,t.l21),m.FromArrayToRef(n[8],0,t.l22),t},e.FromPolynomial=function(n){var t=new e;return t.l00=n.xx.scale(.376127).add(n.yy.scale(.376127)).add(n.zz.scale(.376126)),t.l1_1=n.y.scale(.977204),t.l10=n.z.scale(.977204),t.l11=n.x.scale(.977204),t.l2_2=n.xy.scale(1.16538),t.l2_1=n.yz.scale(1.16538),t.l20=n.zz.scale(1.34567).subtract(n.xx.scale(.672834)).subtract(n.yy.scale(.672834)),t.l21=n.zx.scale(1.16538),t.l22=n.xx.scale(1.16538).subtract(n.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t},e}(),Lt=function(){function e(){this.x=m.Zero(),this.y=m.Zero(),this.z=m.Zero(),this.xx=m.Zero(),this.yy=m.Zero(),this.zz=m.Zero(),this.xy=m.Zero(),this.yz=m.Zero(),this.zx=m.Zero()}return Object.defineProperty(e.prototype,"preScaledHarmonics",{get:function(){return this._harmonics||(this._harmonics=xt.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics},enumerable:!1,configurable:!0}),e.prototype.addAmbient=function(e){var n=new m(e.r,e.g,e.b);this.xx=this.xx.add(n),this.yy=this.yy.add(n),this.zz=this.zz.add(n)},e.prototype.scaleInPlace=function(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)},e.FromHarmonics=function(n){var t=new e;return t._harmonics=n,t.x=n.l11.scale(1.02333).scale(-1),t.y=n.l1_1.scale(1.02333).scale(-1),t.z=n.l10.scale(1.02333),t.xx=n.l00.scale(.886277).subtract(n.l20.scale(.247708)).add(n.l22.scale(.429043)),t.yy=n.l00.scale(.886277).subtract(n.l20.scale(.247708)).subtract(n.l22.scale(.429043)),t.zz=n.l00.scale(.886277).add(n.l20.scale(.495417)),t.yz=n.l2_1.scale(.858086).scale(-1),t.zx=n.l21.scale(.858086).scale(-1),t.xy=n.l2_2.scale(.858086),t.scaleInPlace(1/Math.PI),t},e.FromArray=function(n){var t=new e;return m.FromArrayToRef(n[0],0,t.x),m.FromArrayToRef(n[1],0,t.y),m.FromArrayToRef(n[2],0,t.z),m.FromArrayToRef(n[3],0,t.xx),m.FromArrayToRef(n[4],0,t.yy),m.FromArrayToRef(n[5],0,t.zz),m.FromArrayToRef(n[6],0,t.yz),m.FromArrayToRef(n[7],0,t.zx),m.FromArrayToRef(n[8],0,t.xy),t},e}(),Pt=function(e,n,t,i){this.name=e,this.worldAxisForNormal=n,this.worldAxisForFileX=t,this.worldAxisForFileY=i},Nt=function(){function e(){}return e.ConvertCubeMapTextureToSphericalPolynomial=function(e){if(!e.isCube)return null;var n,t,i=e.getSize().width,r=e.readPixels(0),o=e.readPixels(1);e.isRenderTarget?(n=e.readPixels(3),t=e.readPixels(2)):(n=e.readPixels(2),t=e.readPixels(3));var a=e.readPixels(4),s=e.readPixels(5),l=e.gammaSpace,c=0;1!=e.textureType&&2!=e.textureType||(c=1);var f={size:i,right:r,left:o,up:n,down:t,front:a,back:s,format:5,type:c,gammaSpace:l};return this.ConvertCubeMapToSphericalPolynomial(f)},e.ConvertCubeMapToSphericalPolynomial=function(e){for(var n=new xt,t=0,i=2/e.size,r=i,o=.5*i-1,a=0;a<6;a++)for(var s=this.FileFaces[a],l=e[s.name],c=o,f=5===e.format?4:3,u=0;u<e.size;u++){for(var d=o,h=0;h<e.size;h++){var p=s.worldAxisForFileX.scale(d).add(s.worldAxisForFileY.scale(c)).add(s.worldAxisForNormal);p.normalize();var m=Math.pow(1+d*d+c*c,-1.5),_=l[u*e.size*f+h*f+0],v=l[u*e.size*f+h*f+1],A=l[u*e.size*f+h*f+2];isNaN(_)&&(_=0),isNaN(v)&&(v=0),isNaN(A)&&(A=0),0===e.type&&(_/=255,v/=255,A/=255),e.gammaSpace&&(_=Math.pow(re.Clamp(_),oe),v=Math.pow(re.Clamp(v),oe),A=Math.pow(re.Clamp(A),oe));var g=4096;_=re.Clamp(_,0,g),v=re.Clamp(v,0,g),A=re.Clamp(A,0,g);var E=new w(_,v,A);n.addLight(p,E,m),t+=m,d+=i}c+=r}var T=6*(4*Math.PI)/6/t;return n.scaleInPlace(T),n.convertIncidentRadianceToIrradiance(),n.convertIrradianceToLambertianRadiance(),Lt.FromHarmonics(n)},e.FileFaces=[new Pt("right",new m(1,0,0),new m(0,0,-1),new m(0,-1,0)),new Pt("left",new m(-1,0,0),new m(0,0,1),new m(0,-1,0)),new Pt("up",new m(0,1,0),new m(1,0,0),new m(0,0,1)),new Pt("down",new m(0,-1,0),new m(1,0,0),new m(0,0,-1)),new Pt("front",new m(0,0,1),new m(1,0,0),new m(0,-1,0)),new Pt("back",new m(0,0,-1),new m(-1,0,0),new m(0,-1,0))],e}();Object.defineProperty(Me.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomial=Nt.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomial}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});z.IncludesShadersStore.pbrFragmentDeclaration="uniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\n\nuniform vec4 vLightingIntensity;\nuniform vec4 vReflectivityColor;\nuniform vec4 vMetallicReflectanceFactors;\nuniform vec3 vEmissiveColor;\nuniform float visibility;\n\n#ifdef ALBEDO\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform vec2 vTangentSpaceParams;\n#endif\n#ifdef OPACITY\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\n#endif\n\n#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION)\nuniform mat4 view;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\n#ifdef REALTIME_FILTERING\nuniform vec2 vReflectionFilteringInfo;\n#endif\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionMicrosurfaceInfos;\n#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize;\n#endif\n#endif\n\n#ifdef CLEARCOAT\nuniform vec2 vClearCoatParams;\nuniform vec4 vClearCoatRefractionParams;\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform vec2 vClearCoatTangentSpaceParams;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT\nuniform vec4 vClearCoatTintParams;\nuniform float clearCoatColorAtDistance;\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n#endif\n\n#ifdef ANISOTROPIC\nuniform vec3 vAnisotropy;\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n\n#ifdef SHEEN\nuniform vec4 vSheenColor;\n#ifdef SHEEN_ROUGHNESS\nuniform float vSheenRoughness;\n#endif\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec3 vRefractionMicrosurfaceInfos;\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#ifdef REALTIME_FILTERING\nuniform vec2 vRefractionFilteringInfo;\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\nuniform vec2 vThicknessParam;\nuniform vec3 vDiffusionDistance;\nuniform vec4 vTintColor;\nuniform vec3 vSubSurfaceIntensity;\n#endif\n#ifdef PREPASS\n#ifdef PREPASS_IRRADIANCE\nuniform float scatteringDiffusionProfile;\n#endif\n#endif";z.IncludesShadersStore.pbrUboDeclaration="layout(std140,column_major) uniform;\nuniform Material\n{\nuniform vec2 vAlbedoInfos;\nuniform vec4 vAmbientInfos;\nuniform vec2 vOpacityInfos;\nuniform vec2 vEmissiveInfos;\nuniform vec2 vLightmapInfos;\nuniform vec3 vReflectivityInfos;\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform vec2 vReflectionInfos;\nuniform vec2 vReflectionFilteringInfo;\nuniform vec3 vReflectionPosition;\nuniform vec3 vReflectionSize;\nuniform vec3 vBumpInfos;\nuniform mat4 albedoMatrix;\nuniform mat4 ambientMatrix;\nuniform mat4 opacityMatrix;\nuniform mat4 emissiveMatrix;\nuniform mat4 lightmapMatrix;\nuniform mat4 reflectivityMatrix;\nuniform mat4 microSurfaceSamplerMatrix;\nuniform mat4 bumpMatrix;\nuniform vec2 vTangentSpaceParams;\nuniform mat4 reflectionMatrix;\nuniform vec3 vReflectionColor;\nuniform vec4 vAlbedoColor;\nuniform vec4 vLightingIntensity;\nuniform vec3 vReflectionMicrosurfaceInfos;\nuniform float pointSize;\nuniform vec4 vReflectivityColor;\nuniform vec3 vEmissiveColor;\nuniform float visibility;\nuniform vec4 vMetallicReflectanceFactors;\nuniform vec2 vMetallicReflectanceInfos;\nuniform mat4 metallicReflectanceMatrix;\nuniform vec2 vClearCoatParams;\nuniform vec4 vClearCoatRefractionParams;\nuniform vec4 vClearCoatInfos;\nuniform mat4 clearCoatMatrix;\nuniform mat4 clearCoatRoughnessMatrix;\nuniform vec2 vClearCoatBumpInfos;\nuniform vec2 vClearCoatTangentSpaceParams;\nuniform mat4 clearCoatBumpMatrix;\nuniform vec4 vClearCoatTintParams;\nuniform float clearCoatColorAtDistance;\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\nuniform vec3 vAnisotropy;\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\nuniform vec4 vSheenColor;\nuniform float vSheenRoughness;\nuniform vec4 vSheenInfos;\nuniform mat4 sheenMatrix;\nuniform mat4 sheenRoughnessMatrix;\nuniform vec3 vRefractionMicrosurfaceInfos;\nuniform vec2 vRefractionFilteringInfo;\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\nuniform vec2 vThicknessParam;\nuniform vec3 vDiffusionDistance;\nuniform vec4 vTintColor;\nuniform vec3 vSubSurfaceIntensity;\nuniform float scatteringDiffusionProfile;\nuniform vec4 vDetailInfos;\nuniform mat4 detailMatrix;\n};\nuniform Scene {\nmat4 viewProjection;\n#ifdef MULTIVIEW\nmat4 viewProjectionR;\n#endif\nmat4 view;\n};";z.IncludesShadersStore.pbrFragmentExtraDeclaration="uniform vec4 vEyePosition;\nuniform vec3 vAmbientColor;\nuniform vec4 vCameraInfos;\n\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nuniform vec2 vDebugMode;\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif";z.IncludesShadersStore.pbrFragmentSamplersDeclaration="#ifdef ALBEDO\n#if ALBEDODIRECTUV == 1\n#define vAlbedoUV vMainUV1\n#elif ALBEDODIRECTUV == 2\n#define vAlbedoUV vMainUV2\n#else\nvarying vec2 vAlbedoUV;\n#endif\nuniform sampler2D albedoSampler;\n#endif\n#ifdef AMBIENT\n#if AMBIENTDIRECTUV == 1\n#define vAmbientUV vMainUV1\n#elif AMBIENTDIRECTUV == 2\n#define vAmbientUV vMainUV2\n#else\nvarying vec2 vAmbientUV;\n#endif\nuniform sampler2D ambientSampler;\n#endif\n#ifdef OPACITY\n#if OPACITYDIRECTUV == 1\n#define vOpacityUV vMainUV1\n#elif OPACITYDIRECTUV == 2\n#define vOpacityUV vMainUV2\n#else\nvarying vec2 vOpacityUV;\n#endif\nuniform sampler2D opacitySampler;\n#endif\n#ifdef EMISSIVE\n#if EMISSIVEDIRECTUV == 1\n#define vEmissiveUV vMainUV1\n#elif EMISSIVEDIRECTUV == 2\n#define vEmissiveUV vMainUV2\n#else\nvarying vec2 vEmissiveUV;\n#endif\nuniform sampler2D emissiveSampler;\n#endif\n#ifdef LIGHTMAP\n#if LIGHTMAPDIRECTUV == 1\n#define vLightmapUV vMainUV1\n#elif LIGHTMAPDIRECTUV == 2\n#define vLightmapUV vMainUV2\n#else\nvarying vec2 vLightmapUV;\n#endif\nuniform sampler2D lightmapSampler;\n#endif\n#ifdef REFLECTIVITY\n#if REFLECTIVITYDIRECTUV == 1\n#define vReflectivityUV vMainUV1\n#elif REFLECTIVITYDIRECTUV == 2\n#define vReflectivityUV vMainUV2\n#else\nvarying vec2 vReflectivityUV;\n#endif\nuniform sampler2D reflectivitySampler;\n#endif\n#ifdef MICROSURFACEMAP\n#if MICROSURFACEMAPDIRECTUV == 1\n#define vMicroSurfaceSamplerUV vMainUV1\n#elif MICROSURFACEMAPDIRECTUV == 2\n#define vMicroSurfaceSamplerUV vMainUV2\n#else\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\nuniform sampler2D microSurfaceSampler;\n#endif\n#ifdef METALLIC_REFLECTANCE\n#if METALLIC_REFLECTANCEDIRECTUV == 1\n#define vMetallicReflectanceUV vMainUV1\n#elif METALLIC_REFLECTANCEDIRECTUV == 2\n#define vMetallicReflectanceUV vMainUV2\n#else\nvarying vec2 vMetallicReflectanceUV;\n#endif\nuniform sampler2D metallicReflectanceSampler;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE)\n#if CLEARCOAT_TEXTUREDIRECTUV == 1\n#define vClearCoatUV vMainUV1\n#elif CLEARCOAT_TEXTUREDIRECTUV == 2\n#define vClearCoatUV vMainUV2\n#else\nvarying vec2 vClearCoatUV;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)\n#if CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 1\n#define vClearCoatRoughnessUV vMainUV1\n#elif CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 2\n#define vClearCoatRoughnessUV vMainUV2\n#else\nvarying vec2 vClearCoatRoughnessUV;\n#endif\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform sampler2D clearCoatSampler;\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D clearCoatRoughnessSampler;\n#endif\n#ifdef CLEARCOAT_BUMP\n#if CLEARCOAT_BUMPDIRECTUV == 1\n#define vClearCoatBumpUV vMainUV1\n#elif CLEARCOAT_BUMPDIRECTUV == 2\n#define vClearCoatBumpUV vMainUV2\n#else\nvarying vec2 vClearCoatBumpUV;\n#endif\nuniform sampler2D clearCoatBumpSampler;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\n#if CLEARCOAT_TINT_TEXTUREDIRECTUV == 1\n#define vClearCoatTintUV vMainUV1\n#elif CLEARCOAT_TINT_TEXTUREDIRECTUV == 2\n#define vClearCoatTintUV vMainUV2\n#else\nvarying vec2 vClearCoatTintUV;\n#endif\nuniform sampler2D clearCoatTintSampler;\n#endif\n#endif\n#ifdef SHEEN\n#ifdef SHEEN_TEXTURE\n#if SHEEN_TEXTUREDIRECTUV == 1\n#define vSheenUV vMainUV1\n#elif SHEEN_TEXTUREDIRECTUV == 2\n#define vSheenUV vMainUV2\n#else\nvarying vec2 vSheenUV;\n#endif\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\n#if SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 1\n#define vSheenRoughnessUV vMainUV1\n#elif SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 2\n#define vSheenRoughnessUV vMainUV2\n#else\nvarying vec2 vSheenRoughnessUV;\n#endif\n#endif\n#ifdef SHEEN_TEXTURE\nuniform sampler2D sheenSampler;\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)\nuniform sampler2D sheenRoughnessSampler;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\n#if ANISOTROPIC_TEXTUREDIRECTUV == 1\n#define vAnisotropyUV vMainUV1\n#elif ANISOTROPIC_TEXTUREDIRECTUV == 2\n#define vAnisotropyUV vMainUV2\n#else\nvarying vec2 vAnisotropyUV;\n#endif\nuniform sampler2D anisotropySampler;\n#endif\n#endif\n\n#ifdef REFLECTION\n#ifdef REFLECTIONMAP_3D\n#define sampleReflection(s,c) textureCube(s,c)\nuniform samplerCube reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube reflectionSamplerLow;\nuniform samplerCube reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform samplerCube irradianceSampler;\n#endif\n#else\n#define sampleReflection(s,c) texture2D(s,c)\nuniform sampler2D reflectionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D reflectionSamplerLow;\nuniform sampler2D reflectionSamplerHigh;\n#endif\n#ifdef USEIRRADIANCEMAP\nuniform sampler2D irradianceSampler;\n#endif\n#endif\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#else\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#endif\n#endif\n#ifdef ENVIRONMENTBRDF\nuniform sampler2D environmentBrdfSampler;\n#endif\n\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\n#ifdef SS_REFRACTIONMAP_3D\n#define sampleRefraction(s,c) textureCube(s,c)\nuniform samplerCube refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)\n#else\nuniform samplerCube refractionSamplerLow;\nuniform samplerCube refractionSamplerHigh;\n#endif\n#else\n#define sampleRefraction(s,c) texture2D(s,c)\nuniform sampler2D refractionSampler;\n#ifdef LODBASEDMICROSFURACE\n#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)\n#else\nuniform sampler2D refractionSamplerLow;\nuniform sampler2D refractionSamplerHigh;\n#endif\n#endif\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\n#if SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 1\n#define vThicknessUV vMainUV1\n#elif SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 2\n#define vThicknessUV vMainUV2\n#else\nvarying vec2 vThicknessUV;\n#endif\nuniform sampler2D thicknessSampler;\n#endif\n#endif";z.IncludesShadersStore.subSurfaceScatteringFunctions="bool testLightingForSSS(float diffusionProfile)\n{\nreturn diffusionProfile<1.;\n}";z.IncludesShadersStore.importanceSampling="\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvec3 hemisphereCosSample(vec2 u) {\n\nfloat phi=2.*PI*u.x;\nfloat cosTheta2=1.-u.y;\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvec3 hemisphereImportanceSampleDggx(vec2 u,float a) {\n\nfloat phi=2.*PI*u.x;\n\nfloat cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));\nfloat cosTheta=sqrt(cosTheta2);\nfloat sinTheta=sqrt(1.-cosTheta2);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) {\n\nfloat phi=2.*PI*u.x;\nfloat sinTheta=pow(u.y,a/(2.*a+1.));\nfloat cosTheta=sqrt(1.-sinTheta*sinTheta);\nreturn vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);\n}";z.IncludesShadersStore.pbrHelperFunctions="\n#define RECIPROCAL_PI2 0.15915494\n#define RECIPROCAL_PI 0.31830988618\n\n#define MINIMUMVARIANCE 0.0005\nfloat convertRoughnessToAverageSlope(float roughness)\n{\n\nreturn square(roughness)+MINIMUMVARIANCE;\n}\nfloat fresnelGrazingReflectance(float reflectance0) {\n\n\nfloat reflectance90=saturate(reflectance0*25.0);\nreturn reflectance90;\n}\nvec2 getAARoughnessFactors(vec3 normalVector) {\n#ifdef SPECULARAA\nvec3 nDfdx=dFdx(normalVector.xyz);\nvec3 nDfdy=dFdy(normalVector.xyz);\nfloat slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));\n\nfloat geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);\n\nfloat geometricAlphaGFactor=sqrt(slopeSquare);\n\ngeometricAlphaGFactor*=0.75;\nreturn vec2(geometricRoughnessFactor,geometricAlphaGFactor);\n#else\nreturn vec2(0.);\n#endif\n}\n#ifdef ANISOTROPIC\n\n\nvec2 getAnisotropicRoughness(float alphaG,float anisotropy) {\nfloat alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);\nfloat alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);\nreturn vec2(alphaT,alphaB);\n}\n\n\nvec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {\nvec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;\nvec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);\nvec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);\nvec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));\nreturn anisotropicNormal;\n\n}\n#endif\n#if defined(CLEARCOAT) || defined(SS_REFRACTION)\n\n\n\nvec3 cocaLambert(vec3 alpha,float distance) {\nreturn exp(-alpha*distance);\n}\n\nvec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {\nreturn cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));\n}\n\nvec3 computeColorAtDistanceInMedia(vec3 color,float distance) {\nreturn -log(color)/distance;\n}\nvec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 clearCoatAbsorption=mix(vec3(1.0),\ncocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),\nclearCoatIntensity);\nreturn clearCoatAbsorption;\n}\n#endif\n\n\n\n\n#ifdef MICROSURFACEAUTOMATIC\nfloat computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)\n{\nconst float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;\nfloat reflectivityLuminance=getLuminance(reflectivityColor);\nfloat reflectivityLuma=sqrt(reflectivityLuminance);\nmicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;\nreturn microSurface;\n}\n#endif";z.IncludesShadersStore.harmonicsFunctions="#ifdef USESPHERICALFROMREFLECTIONMAP\n#ifdef SPHERICAL_HARMONICS\nuniform vec3 vSphericalL00;\nuniform vec3 vSphericalL1_1;\nuniform vec3 vSphericalL10;\nuniform vec3 vSphericalL11;\nuniform vec3 vSphericalL2_2;\nuniform vec3 vSphericalL2_1;\nuniform vec3 vSphericalL20;\nuniform vec3 vSphericalL21;\nuniform vec3 vSphericalL22;\n\n\n\n\n\n\n\nvec3 computeEnvironmentIrradiance(vec3 normal) {\nreturn vSphericalL00\n+vSphericalL1_1*(normal.y)\n+vSphericalL10*(normal.z)\n+vSphericalL11*(normal.x)\n+vSphericalL2_2*(normal.y*normal.x)\n+vSphericalL2_1*(normal.y*normal.z)\n+vSphericalL20*((3.0*normal.z*normal.z)-1.0)\n+vSphericalL21*(normal.z*normal.x)\n+vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));\n}\n#else\nuniform vec3 vSphericalX;\nuniform vec3 vSphericalY;\nuniform vec3 vSphericalZ;\nuniform vec3 vSphericalXX_ZZ;\nuniform vec3 vSphericalYY_ZZ;\nuniform vec3 vSphericalZZ;\nuniform vec3 vSphericalXY;\nuniform vec3 vSphericalYZ;\nuniform vec3 vSphericalZX;\n\nvec3 computeEnvironmentIrradiance(vec3 normal) {\n\n\n\n\n\n\n\n\n\nfloat Nx=normal.x;\nfloat Ny=normal.y;\nfloat Nz=normal.z;\nvec3 C1=vSphericalZZ.rgb;\nvec3 Cx=vSphericalX.rgb;\nvec3 Cy=vSphericalY.rgb;\nvec3 Cz=vSphericalZ.rgb;\nvec3 Cxx_zz=vSphericalXX_ZZ.rgb;\nvec3 Cyy_zz=vSphericalYY_ZZ.rgb;\nvec3 Cxy=vSphericalXY.rgb;\nvec3 Cyz=vSphericalYZ.rgb;\nvec3 Czx=vSphericalZX.rgb;\nvec3 a1=Cyy_zz*Ny+Cy;\nvec3 a2=Cyz*Nz+a1;\nvec3 b1=Czx*Nz+Cx;\nvec3 b2=Cxy*Ny+b1;\nvec3 b3=Cxx_zz*Nx+b2;\nvec3 t1=Cz*Nz+C1;\nvec3 t2=a2*Ny+t1;\nvec3 t3=b3*Nx+t2;\nreturn t3;\n}\n#endif\n#endif";z.IncludesShadersStore.pbrDirectLightingSetupFunctions="\nstruct preLightingInfo\n{\n\nvec3 lightOffset;\nfloat lightDistanceSquared;\nfloat lightDistance;\n\nfloat attenuation;\n\nvec3 L;\nvec3 H;\nfloat NdotV;\nfloat NdotLUnclamped;\nfloat NdotL;\nfloat VdotH;\nfloat roughness;\n};\npreLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\n\nresult.lightOffset=lightData.xyz-vPositionW;\nresult.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);\n\nresult.lightDistance=sqrt(result.lightDistanceSquared);\n\nresult.L=normalize(result.lightOffset);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\n\nresult.lightDistance=length(-lightData.xyz);\n\nresult.L=normalize(-lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\nresult.NdotLUnclamped=dot(N,result.L);\nresult.NdotL=saturateEps(result.NdotLUnclamped);\nreturn result;\n}\npreLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {\npreLightingInfo result;\n\n\nresult.NdotL=dot(N,lightData.xyz)*0.5+0.5;\nresult.NdotL=saturateEps(result.NdotL);\nresult.NdotLUnclamped=result.NdotL;\n#ifdef SPECULARTERM\nresult.L=normalize(lightData.xyz);\nresult.H=normalize(V+result.L);\nresult.VdotH=saturate(dot(V,result.H));\n#endif\nreturn result;\n}";z.IncludesShadersStore.pbrDirectLightingFalloffFunctions="float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)\n{\nreturn max(0.,1.0-length(lightOffset)/range);\n}\nfloat computeDistanceLightFalloff_Physical(float lightDistanceSquared)\n{\nreturn 1.0/maxEps(lightDistanceSquared);\n}\nfloat computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)\n{\nfloat lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);\nfloat factor=lightDistanceSquared*inverseSquaredRange;\nfloat attenuation=saturate(1.0-factor*factor);\nattenuation*=attenuation;\n\nlightDistanceFalloff*=attenuation;\nreturn lightDistanceFalloff;\n}\nfloat computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDistanceLightFalloff_Physical(lightDistanceSquared);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);\n#else\nreturn computeDistanceLightFalloff_Standard(lightOffset,range);\n#endif\n}\nfloat computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)\n{\nfloat falloff=0.0;\nfloat cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));\nif (cosAngle>=cosHalfAngle)\n{\nfalloff=max(0.,pow(cosAngle,exponent));\n}\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)\n{\nconst float kMinusLog2ConeAngleIntensityRatio=6.64385618977;\n\n\n\n\n\nfloat concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);\n\n\nvec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);\nfloat falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)\n{\n\n\n\nfloat cd=dot(-lightDirection,directionToLightCenterW);\nfloat falloff=saturate(cd*lightAngleScale+lightAngleOffset);\n\nfalloff*=falloff;\nreturn falloff;\n}\nfloat computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)\n{\n#ifdef USEPHYSICALLIGHTFALLOFF\nreturn computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);\n#elif defined(USEGLTFLIGHTFALLOFF)\nreturn computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);\n#else\nreturn computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);\n#endif\n}";z.IncludesShadersStore.pbrBRDFFunctions="\n#define FRESNEL_MAXIMUM_ON_ROUGH 0.25\n\n\n\n\n#ifdef MS_BRDF_ENERGY_CONSERVATION\n\n\nvec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\nreturn 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);\n}\n#endif\n#ifdef ENVIRONMENTBRDF\nvec3 getBRDFLookup(float NdotV,float perceptualRoughness) {\n\nvec2 UV=vec2(NdotV,perceptualRoughness);\n\nvec4 brdfLookup=texture2D(environmentBrdfSampler,UV);\n#ifdef ENVIRONMENTBRDF_RGBD\nbrdfLookup.rgb=fromRGBD(brdfLookup.rgba);\n#endif\nreturn brdfLookup.rgb;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;\n\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;\n#endif\nreturn reflectance;\n}\nvec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {\n#ifdef BRDF_V_HEIGHT_CORRELATED\nvec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);\n#else\nvec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;\n#endif\nreturn reflectance;\n}\n#endif\n\n#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)\nvec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)\n{\n\nfloat weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);\nreturn reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));\n}\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\n\nvec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {\nvec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;\nreturn sheenEnvironmentReflectance;\n}\n#endif\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nvec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\nfloat fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)\n{\nreturn reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);\n}\n#ifdef CLEARCOAT\n\n\n\n\n\nvec3 getR0RemappedForClearCoat(vec3 f0) {\n#ifdef CLEARCOAT_DEFAULTIOR\n#ifdef MOBILE\nreturn saturate(f0*(f0*0.526868+0.529324)-0.0482256);\n#else\nreturn saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);\n#endif\n#else\nvec3 s=sqrt(f0);\nvec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);\nreturn t*t;\n#endif\n}\n#endif\n\n\n\n\n\n\nfloat normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)\n{\n\n\n\nfloat a2=square(alphaG);\nfloat d=NdotH*NdotH*(a2-1.0)+1.0;\nreturn a2/(PI*d*d);\n}\n#ifdef SHEEN\n\n\nfloat normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)\n{\nfloat invR=1./alphaG;\nfloat cos2h=NdotH*NdotH;\nfloat sin2h=1.-cos2h;\nreturn (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);\n}\n#endif\n#ifdef ANISOTROPIC\n\n\nfloat normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {\nfloat a2=alphaTB.x*alphaTB.y;\nvec3 v=vec3(alphaTB.y*TdotH,alphaTB.x*BdotH,a2*NdotH);\nfloat v2=dot(v,v);\nfloat w2=a2/v2;\nreturn a2*w2*w2*RECIPROCAL_PI;\n}\n#endif\n\n\n\n\n#ifdef BRDF_V_HEIGHT_CORRELATED\n\n\n\nfloat smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {\n#ifdef MOBILE\n\nfloat GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);\nfloat GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);\nreturn 0.5/(GGXV+GGXL);\n#else\nfloat a2=alphaG*alphaG;\nfloat GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);\nfloat GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);\nreturn 0.5/(GGXV+GGXL);\n#endif\n}\n#else\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nfloat smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)\n{\n#ifdef MOBILE\n\nreturn 1.0/(dot+alphaG+(1.0-alphaG)*dot ));\n#else\nfloat alphaSquared=alphaG*alphaG;\nreturn 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));\n#endif\n}\nfloat smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)\n{\nfloat visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);\n\nreturn visibility;\n}\n#endif\n#ifdef ANISOTROPIC\n\n\nfloat smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {\nfloat lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));\nfloat lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));\nfloat v=0.5/(lambdaV+lambdaL);\nreturn v;\n}\n#endif\n#ifdef CLEARCOAT\nfloat visibility_Kelemen(float VdotH) {\n\n\n\nreturn 0.25/(VdotH*VdotH);\n}\n#endif\n#ifdef SHEEN\n\n\n\nfloat visibility_Ashikhmin(float NdotL,float NdotV)\n{\nreturn 1./(4.*(NdotL+NdotV-NdotL*NdotV));\n}\n\n#endif\n\n\n\n\n\n\n\nfloat diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {\n\n\nfloat diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));\nfloat diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));\nfloat diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;\nfloat fresnel =\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *\n(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);\nreturn fresnel/PI;\n}\n#ifdef SS_TRANSLUCENCY\n\n\nvec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {\nvec3 S=1./maxEps(diffusionDistance);\nvec3 temp=exp((-0.333333333*thickness)*S);\nreturn tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);\n}\n\n\nfloat computeWrappedDiffuseNdotL(float NdotL,float w) {\nfloat t=1.0+w;\nfloat invt2=1.0/square(t);\nreturn saturate((NdotL+w)*invt2);\n}\n#endif\n";z.IncludesShadersStore.hdrFilteringFunctions="#ifdef NUM_SAMPLES\n#if NUM_SAMPLES>0\n#ifdef WEBGL2\n\n\nfloat radicalInverse_VdC(uint bits)\n{\nbits=(bits << 16u) | (bits >> 16u);\nbits=((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);\nbits=((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);\nbits=((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);\nbits=((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);\nreturn float(bits)*2.3283064365386963e-10;\n}\nvec2 hammersley(uint i,uint N)\n{\nreturn vec2(float(i)/float(N),radicalInverse_VdC(i));\n}\n#else\nfloat vanDerCorpus(int n,int base)\n{\nfloat invBase=1.0/float(base);\nfloat denom=1.0;\nfloat result=0.0;\nfor(int i=0; i<32; ++i)\n{\nif(n>0)\n{\ndenom=mod(float(n),2.0);\nresult+=denom*invBase;\ninvBase=invBase/2.0;\nn=int(float(n)/2.0);\n}\n}\nreturn result;\n}\nvec2 hammersley(int i,int N)\n{\nreturn vec2(float(i)/float(N),vanDerCorpus(i,2));\n}\n#endif\nfloat log4(float x) {\nreturn log2(x)/2.;\n}\nconst float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);\nconst float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;\nconst float K=4.;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n#define inline\nvec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nvec3 result=vec3(0.0);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\n#ifdef WEBGL2\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 Ls=hemisphereCosSample(Xi);\nLs=normalize(Ls);\nvec3 Ns=vec3(0.,0.,1.);\nfloat NoL=dot(Ns,Ls);\nif (NoL>0.) {\nfloat pdf_inversed=PI/NoL;\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(l,0.0,maxLevel);\nvec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c;\n}\n}\nresult=result*NUM_SAMPLES_FLOAT_INVERSED;\nreturn result;\n}\n#define inline\nvec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)\n{\nvec3 n=normalize(inputN);\nif (alphaG == 0.) {\nvec3 c=textureCube(inputTexture,n).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nreturn c;\n}\nvec3 result=vec3(0.);\nvec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);\ntangent=normalize(cross(tangent,n));\nvec3 bitangent=cross(n,tangent);\nmat3 tbn=mat3(tangent,bitangent,n);\nfloat maxLevel=filteringInfo.y;\nfloat dim0=filteringInfo.x;\nfloat omegaP=(4.*PI)/(6.*dim0*dim0);\nfloat weight=0.;\n#ifdef WEBGL2\nfor(uint i=0u; i<NUM_SAMPLES; ++i)\n#else\nfor(int i=0; i<NUM_SAMPLES; ++i)\n#endif\n{\nvec2 Xi=hammersley(i,NUM_SAMPLES);\nvec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);\nfloat NoV=1.;\nfloat NoH=H.z;\nfloat NoH2=H.z*H.z;\nfloat NoL=2.*NoH2-1.;\nvec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);\nL=normalize(L);\nif (NoL>0.) {\nfloat pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);\nfloat omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;\nfloat l=log4(omegaS)-log4(omegaP)+log4(K);\nfloat mipLevel=clamp(float(l),0.0,maxLevel);\nweight+=NoL;\nvec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;\n#ifdef GAMMA_INPUT\nc=toLinearSpace(c);\n#endif\nresult+=c*NoL;\n}\n}\nresult=result/weight;\nreturn result;\n}\n#endif\n#endif";z.IncludesShadersStore.pbrDirectLightingFunctions="#define CLEARCOATREFLECTANCE90 1.0\n\nstruct lightingInfo\n{\nvec3 diffuse;\n#ifdef SPECULARTERM\nvec3 specular;\n#endif\n#ifdef CLEARCOAT\n\n\nvec4 clearCoat;\n#endif\n#ifdef SHEEN\nvec3 sheen;\n#endif\n};\n\nfloat adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {\n#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)\n\nfloat lightRoughness=lightRadius/lightDistance;\n\nfloat totalRoughness=saturate(lightRoughness+roughness);\nreturn totalRoughness;\n#else\nreturn roughness;\n#endif\n}\nvec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {\nreturn mix(groundColor,lightColor,info.NdotL);\n}\nvec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {\nfloat diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*info.attenuation*info.NdotL*lightColor;\n}\n#define inline\nvec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){\nvec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);\nstrq/=strq.w;\nvec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;\nreturn toLinearSpace(textureColor);\n}\n#ifdef SS_TRANSLUCENCY\nvec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {\nfloat NdotL=absEps(info.NdotLUnclamped);\n\nfloat wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);\n\nfloat trAdapt=step(0.,info.NdotLUnclamped);\nvec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);\nfloat diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);\nreturn diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;\n}\n#endif\n#ifdef SPECULARTERM\nvec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);\n#ifdef BRDF_V_HEIGHT_CORRELATED\nfloat smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);\n#else\nfloat smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);\n#endif\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef ANISOTROPIC\nvec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat TdotH=dot(T,info.H);\nfloat BdotH=dot(B,info.H);\nfloat TdotV=dot(T,V);\nfloat BdotV=dot(B,V);\nfloat TdotL=dot(T,info.L);\nfloat BdotL=dot(B,info.L);\nfloat alphaG=convertRoughnessToAverageSlope(info.roughness);\nvec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);\nalphaTB=max(alphaTB,square(geometricRoughnessFactor));\nvec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);\nfloat distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);\nfloat smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);\nvec3 specTerm=fresnel*distribution*smithVisibility;\nreturn specTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n#ifdef CLEARCOAT\nvec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {\nfloat NccdotL=saturateEps(dot(Ncc,info.L));\nfloat NccdotH=saturateEps(dot(Ncc,info.H));\nfloat clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\nfloat fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnel*=clearCoatIntensity;\nfloat distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);\nfloat kelemenVisibility=visibility_Kelemen(info.VdotH);\nfloat clearCoatTerm=fresnel*distribution*kelemenVisibility;\nreturn vec4(\nclearCoatTerm*info.attenuation*NccdotL*lightColor,\n1.0-fresnel\n);\n}\nvec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {\nvec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);\nfloat NdotLRefract=saturateEps(dot(Ncc,LRefract));\nvec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);\nreturn absorption;\n}\n#endif\n#ifdef SHEEN\nvec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {\nfloat NdotH=saturateEps(dot(N,info.H));\nfloat roughness=max(info.roughness,geometricRoughnessFactor);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\n\n\nfloat fresnel=1.;\nfloat distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);\n\nfloat visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);\n\nfloat sheenTerm=fresnel*distribution*visibility;\nreturn sheenTerm*info.attenuation*info.NdotL*lightColor;\n}\n#endif\n";z.IncludesShadersStore.pbrIBLFunctions="#if defined(REFLECTION) || defined(SS_REFRACTION)\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {\nfloat microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;\nfloat lod=log2(microsurfaceAverageSlopeTexels);\nreturn lod;\n}\nfloat getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {\nfloat lod=log2(cubeMapDimensionPixels)*roughness;\nreturn lod;\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)\nfloat environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {\n\n\nfloat temp=NdotVUnclamped+ambientOcclusion;\nreturn saturate(square(temp)-1.0+ambientOcclusion);\n}\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)\nfloat environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {\n\nvec3 reflection=reflect(view,normal);\nfloat temp=saturate(1.0+1.1*dot(reflection,geometricNormal));\nreturn square(temp);\n}\n#endif\n\n\n\n\n#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)\n\n\n#define UNPACK_LOD(x) (1.0-x)*255.0\nfloat getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {\nfloat microsurfaceAverageSlope=alphaG;\n\n\n\n\n\n\nmicrosurfaceAverageSlope*=sqrt(abs(NdotV));\nreturn getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);\n}\n#endif";z.IncludesShadersStore.pbrBlockAlbedoOpacity="struct albedoOpacityOutParams\n{\nvec3 surfaceAlbedo;\nfloat alpha;\n};\n#define pbr_inline\nvoid albedoOpacityBlock(\nconst in vec4 vAlbedoColor,\n#ifdef ALBEDO\nconst in vec4 albedoTexture,\nconst in vec2 albedoInfos,\n#endif\n#ifdef OPACITY\nconst in vec4 opacityMap,\nconst in vec2 vOpacityInfos,\n#endif\n#ifdef DETAIL\nconst in vec4 detailColor,\nconst in vec4 vDetailInfos,\n#endif\nout albedoOpacityOutParams outParams\n)\n{\n\nvec3 surfaceAlbedo=vAlbedoColor.rgb;\nfloat alpha=vAlbedoColor.a;\n#ifdef ALBEDO\n#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)\nalpha*=albedoTexture.a;\n#endif\n#ifdef GAMMAALBEDO\nsurfaceAlbedo*=toLinearSpace(albedoTexture.rgb);\n#else\nsurfaceAlbedo*=albedoTexture.rgb;\n#endif\nsurfaceAlbedo*=albedoInfos.y;\n#endif\n#ifdef VERTEXCOLOR\nsurfaceAlbedo*=vColor.rgb;\n#endif\n#ifdef DETAIL\nfloat detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);\nsurfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_ALBEDO\n\n#ifdef OPACITY\n#ifdef OPACITYRGB\nalpha=getLuminance(opacityMap.rgb);\n#else\nalpha*=opacityMap.a;\n#endif\nalpha*=vOpacityInfos.y;\n#endif\n#ifdef VERTEXALPHA\nalpha*=vColor.a;\n#endif\n#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)\n#ifdef ALPHATEST\nif (alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\nalpha=1.0;\n#endif\n#endif\n#endif\noutParams.surfaceAlbedo=surfaceAlbedo;\noutParams.alpha=alpha;\n}\n";z.IncludesShadersStore.pbrBlockReflectivity="struct reflectivityOutParams\n{\nfloat microSurface;\nfloat roughness;\nvec3 surfaceReflectivityColor;\n#ifdef METALLICWORKFLOW\nvec3 surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nvec3 ambientOcclusionColor;\n#endif\n#if DEBUGMODE>0\nvec4 surfaceMetallicColorMap;\nvec4 surfaceReflectivityColorMap;\nvec2 metallicRoughness;\nvec3 metallicF0;\n#endif\n};\n#define pbr_inline\nvoid reflectivityBlock(\nconst in vec4 vReflectivityColor,\n#ifdef METALLICWORKFLOW\nconst in vec3 surfaceAlbedo,\nconst in vec4 metallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nconst in vec3 reflectivityInfos,\nconst in vec4 surfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\nconst in vec3 ambientOcclusionColorIn,\n#endif\n#ifdef MICROSURFACEMAP\nconst in vec4 microSurfaceTexel,\n#endif\n#ifdef DETAIL\nconst in vec4 detailColor,\nconst in vec4 vDetailInfos,\n#endif\nout reflectivityOutParams outParams\n)\n{\nfloat microSurface=vReflectivityColor.a;\nvec3 surfaceReflectivityColor=vReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec2 metallicRoughness=surfaceReflectivityColor.rg;\n#ifdef REFLECTIVITY\n#if DEBUGMODE>0\noutParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef AOSTOREINMETALMAPRED\nvec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);\noutParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);\n#endif\n#ifdef METALLNESSSTOREINMETALMAPBLUE\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;\n#else\nmetallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;\n#endif\n#ifdef ROUGHNESSSTOREINMETALMAPALPHA\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;\n#else\n#ifdef ROUGHNESSSTOREINMETALMAPGREEN\nmetallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;\n#endif\n#endif\n#endif\n#ifdef DETAIL\nfloat detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);\nfloat loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);\nfloat hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);\nmetallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));\n#endif\n#ifdef MICROSURFACEMAP\nmetallicRoughness.g*=microSurfaceTexel.r;\n#endif\n#if DEBUGMODE>0\noutParams.metallicRoughness=metallicRoughness;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS\n\nmicroSurface=1.0-metallicRoughness.g;\n\nvec3 baseColor=surfaceAlbedo;\n#ifdef FROSTBITE_REFLECTANCE\n\n\n\n\n\n\noutParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);\n\nsurfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);\n#else\nvec3 metallicF0=metallicReflectanceFactors.rgb;\n#if DEBUGMODE>0\noutParams.metallicF0=metallicF0;\n#endif\n\noutParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);\n\nsurfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);\n#endif\n#else\n#ifdef REFLECTIVITY\nsurfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;\n#if DEBUGMODE>0\noutParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;\n#endif\n#ifdef MICROSURFACEFROMREFLECTIVITYMAP\nmicroSurface*=surfaceMetallicOrReflectivityColorMap.a;\nmicroSurface*=reflectivityInfos.z;\n#else\n#ifdef MICROSURFACEAUTOMATIC\nmicroSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurface*=microSurfaceTexel.r;\n#endif\n#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE\n#endif\n#endif\n#endif\n\nmicroSurface=saturate(microSurface);\n\nfloat roughness=1.-microSurface;\noutParams.microSurface=microSurface;\noutParams.roughness=roughness;\noutParams.surfaceReflectivityColor=surfaceReflectivityColor;\n}\n";z.IncludesShadersStore.pbrBlockAmbientOcclusion="struct ambientOcclusionOutParams\n{\nvec3 ambientOcclusionColor;\n#if DEBUGMODE>0\nvec3 ambientOcclusionColorMap;\n#endif\n};\n#define pbr_inline\nvoid ambientOcclusionBlock(\n#ifdef AMBIENT\nconst in vec3 ambientOcclusionColorMap_,\nconst in vec4 vAmbientInfos,\n#endif\nout ambientOcclusionOutParams outParams\n)\n{\nvec3 ambientOcclusionColor=vec3(1.,1.,1.);\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;\n#ifdef AMBIENTINGRAYSCALE\nambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);\n#endif\nambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);\n#if DEBUGMODE>0\noutParams.ambientOcclusionColorMap=ambientOcclusionColorMap;\n#endif\n#endif\noutParams.ambientOcclusionColor=ambientOcclusionColor;\n}\n";z.IncludesShadersStore.pbrBlockAlphaFresnel="#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nstruct alphaFresnelOutParams\n{\nfloat alpha;\n};\n#define pbr_inline\nvoid alphaFresnelBlock(\nconst in vec3 normalW,\nconst in vec3 viewDirectionW,\nconst in float alpha,\nconst in float microSurface,\nout alphaFresnelOutParams outParams\n)\n{\n\n\n\nfloat opacityPerceptual=alpha;\n#ifdef LINEARALPHAFRESNEL\nfloat opacity0=opacityPerceptual;\n#else\nfloat opacity0=opacityPerceptual*opacityPerceptual;\n#endif\nfloat opacity90=fresnelGrazingReflectance(opacity0);\nvec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);\n\noutParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;\n#ifdef ALPHATEST\nif (outParams.alpha<ALPHATESTVALUE)\ndiscard;\n#ifndef ALPHABLEND\n\noutParams.alpha=1.0;\n#endif\n#endif\n}\n#endif\n#endif\n";z.IncludesShadersStore.pbrBlockAnisotropic="#ifdef ANISOTROPIC\nstruct anisotropicOutParams\n{\nfloat anisotropy;\nvec3 anisotropicTangent;\nvec3 anisotropicBitangent;\nvec3 anisotropicNormal;\n#if DEBUGMODE>0\nvec3 anisotropyMapData;\n#endif\n};\n#define pbr_inline\nvoid anisotropicBlock(\nconst in vec3 vAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nconst in vec3 anisotropyMapData,\n#endif\nconst in mat3 TBN,\nconst in vec3 normalW,\nconst in vec3 viewDirectionW,\nout anisotropicOutParams outParams\n)\n{\nfloat anisotropy=vAnisotropy.b;\nvec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);\n#ifdef ANISOTROPIC_TEXTURE\nanisotropy*=anisotropyMapData.b;\nanisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;\n#if DEBUGMODE>0\noutParams.anisotropyMapData=anisotropyMapData;\n#endif\n#endif\nmat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));\nvec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);\nvec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));\noutParams.anisotropy=anisotropy;\noutParams.anisotropicTangent=anisotropicTangent;\noutParams.anisotropicBitangent=anisotropicBitangent;\noutParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);\n}\n#endif\n";z.IncludesShadersStore.pbrBlockReflection="#ifdef REFLECTION\nstruct reflectionOutParams\n{\nvec4 environmentRadiance;\nvec3 environmentIrradiance;\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords;\n#else\nvec2 reflectionCoords;\n#endif\n#ifdef SS_TRANSLUCENCY\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nvec3 irradianceVector;\n#endif\n#endif\n#endif\n};\n#define pbr_inline\nvoid createReflectionCoords(\nconst in vec3 vPositionW,\nconst in vec3 normalW,\n#ifdef ANISOTROPIC\nconst in anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REFLECTIONMAP_3D\nout vec3 reflectionCoords\n#else\nout vec2 reflectionCoords\n#endif\n)\n{\n#ifdef ANISOTROPIC\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);\n#else\nvec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nreflectionCoords=reflectionVector;\n#else\nreflectionCoords=reflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nreflectionCoords/=reflectionVector.z;\n#endif\nreflectionCoords.y=1.0-reflectionCoords.y;\n#endif\n}\n#define pbr_inline\n#define inline\nvoid sampleReflectionTexture(\nconst in float alphaG,\nconst in vec3 vReflectionMicrosurfaceInfos,\nconst in vec2 vReflectionInfos,\nconst in vec3 vReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nconst in float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nconst in float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSampler,\nconst vec3 reflectionCoords,\n#else\nconst in sampler2D reflectionSampler,\nconst vec2 reflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSamplerLow,\nconst in samplerCube reflectionSamplerHigh,\n#else\nconst in sampler2D reflectionSamplerLow,\nconst in sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nconst in vec2 vReflectionFilteringInfo,\n#endif\nout vec4 environmentRadiance\n)\n{\n\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(LINEARSPECULARREFLECTION)\nfloat reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);\n#else\nfloat reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nreflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;\n#ifdef LODINREFLECTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);\nfloat requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);\n#else\nfloat requestedReflectionLOD=reflectionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);\n#else\nenvironmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);\n#endif\n#else\nfloat lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));\nfloat lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;\nvec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);\nif (lodReflectionNormalizedDoubled<1.0){\nenvironmentRadiance=mix(\nsampleReflection(reflectionSamplerHigh,reflectionCoords),\nenvironmentMid,\nlodReflectionNormalizedDoubled\n);\n} else {\nenvironmentRadiance=mix(\nenvironmentMid,\nsampleReflection(reflectionSamplerLow,reflectionCoords),\nlodReflectionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef RGBDREFLECTION\nenvironmentRadiance.rgb=fromRGBD(environmentRadiance);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);\n#endif\n\nenvironmentRadiance.rgb*=vReflectionInfos.x;\nenvironmentRadiance.rgb*=vReflectionColor.rgb;\n}\n#define pbr_inline\n#define inline\nvoid reflectionBlock(\nconst in vec3 vPositionW,\nconst in vec3 normalW,\nconst in float alphaG,\nconst in vec3 vReflectionMicrosurfaceInfos,\nconst in vec2 vReflectionInfos,\nconst in vec3 vReflectionColor,\n#ifdef ANISOTROPIC\nconst in anisotropicOutParams anisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nconst in float NdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nconst in float roughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSampler,\n#else\nconst in sampler2D reflectionSampler,\n#endif\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nconst in vec3 vEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nconst in mat4 reflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube irradianceSampler,\n#else\nconst in sampler2D irradianceSampler,\n#endif\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSamplerLow,\nconst in samplerCube reflectionSamplerHigh,\n#else\nconst in sampler2D reflectionSamplerLow,\nconst in sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nconst in vec2 vReflectionFilteringInfo,\n#endif\nout reflectionOutParams outParams\n)\n{\n\nvec4 environmentRadiance=vec4(0.,0.,0.,0.);\n#ifdef REFLECTIONMAP_3D\nvec3 reflectionCoords=vec3(0.);\n#else\nvec2 reflectionCoords=vec2(0.);\n#endif\ncreateReflectionCoords(\nvPositionW,\nnormalW,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\nreflectionCoords\n);\nsampleReflectionTexture(\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\n#ifdef REFLECTIONMAP_3D\nreflectionSampler,\nreflectionCoords,\n#else\nreflectionSampler,\nreflectionCoords,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentRadiance\n);\n\nvec3 environmentIrradiance=vec3(0.,0.,0.);\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nenvironmentIrradiance=vEnvironmentIrradiance;\n#else\n#ifdef ANISOTROPIC\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;\n#else\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#endif\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#if defined(REALTIME_FILTERING)\nenvironmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);\n#else\nenvironmentIrradiance=computeEnvironmentIrradiance(irradianceVector);\n#endif\n#ifdef SS_TRANSLUCENCY\noutParams.irradianceVector=irradianceVector;\n#endif\n#endif\n#elif defined(USEIRRADIANCEMAP)\nvec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);\nenvironmentIrradiance=environmentIrradiance4.rgb;\n#ifdef RGBDREFLECTION\nenvironmentIrradiance.rgb=fromRGBD(environmentIrradiance4);\n#endif\n#ifdef GAMMAREFLECTION\nenvironmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);\n#endif\n#endif\nenvironmentIrradiance*=vReflectionColor.rgb;\noutParams.environmentRadiance=environmentRadiance;\noutParams.environmentIrradiance=environmentIrradiance;\noutParams.reflectionCoords=reflectionCoords;\n}\n#endif\n";z.IncludesShadersStore.pbrBlockSheen="#ifdef SHEEN\nstruct sheenOutParams\n{\nfloat sheenIntensity;\nvec3 sheenColor;\nfloat sheenRoughness;\n#ifdef SHEEN_LINKWITHALBEDO\nvec3 surfaceAlbedo;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfloat sheenAlbedoScaling;\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nvec3 finalSheenRadianceScaled;\n#endif\n#if DEBUGMODE>0\nvec4 sheenMapData;\nvec3 sheenEnvironmentReflectance;\n#endif\n};\n#define pbr_inline\n#define inline\nvoid sheenBlock(\nconst in vec4 vSheenColor,\n#ifdef SHEEN_ROUGHNESS\nconst in float vSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nconst in vec4 sheenMapRoughnessData,\n#endif\n#endif\nconst in float roughness,\n#ifdef SHEEN_TEXTURE\nconst in vec4 sheenMapData,\n#endif\nconst in float reflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nconst in vec3 baseColor,\nconst in vec3 surfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nconst in float NdotV,\nconst in vec3 environmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nconst in vec2 AARoughnessFactors,\nconst in vec3 vReflectionMicrosurfaceInfos,\nconst in vec2 vReflectionInfos,\nconst in vec3 vReflectionColor,\nconst in vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSampler,\nconst in vec3 reflectionCoords,\n#else\nconst in sampler2D reflectionSampler,\nconst in vec2 reflectionCoords,\n#endif\nconst in float NdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSamplerLow,\nconst in samplerCube reflectionSamplerHigh,\n#else\nconst in sampler2D reflectionSamplerLow,\nconst in sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nconst in vec2 vReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nconst in float seo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nconst in float eho,\n#endif\n#endif\nout sheenOutParams outParams\n)\n{\nfloat sheenIntensity=vSheenColor.a;\n#ifdef SHEEN_TEXTURE\n#if DEBUGMODE>0\noutParams.sheenMapData=sheenMapData;\n#endif\n#endif\n#ifdef SHEEN_LINKWITHALBEDO\nfloat sheenFactor=pow5(1.0-sheenIntensity);\nvec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);\nfloat sheenRoughness=sheenIntensity;\noutParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#else\nvec3 sheenColor=vSheenColor.rgb;\n#ifdef SHEEN_TEXTURE\nsheenColor.rgb*=sheenMapData.rgb;\n#endif\n#ifdef SHEEN_ROUGHNESS\nfloat sheenRoughness=vSheenRoughness;\n#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE\n#if defined(SHEEN_TEXTURE)\nsheenRoughness*=sheenMapData.a;\n#endif\n#elif defined(SHEEN_TEXTURE_ROUGHNESS)\n#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL\nsheenRoughness*=sheenMapData.a;\n#else\nsheenRoughness*=sheenMapRoughnessData.a;\n#endif\n#endif\n#else\nfloat sheenRoughness=roughness;\n#ifdef SHEEN_TEXTURE\nsheenIntensity*=sheenMapData.a;\n#endif\n#endif\n\n#if !defined(SHEEN_ALBEDOSCALING)\nsheenIntensity*=(1.-reflectance);\n#endif\n\nsheenColor*=sheenIntensity;\n#endif\n\n#ifdef ENVIRONMENTBRDF\n\n#ifdef SHEEN_ROUGHNESS\nvec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);\n#else\nvec3 environmentSheenBrdf=environmentBrdf;\n#endif\n\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nfloat sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);\n#ifdef SPECULARAA\n\nsheenAlphaG+=AARoughnessFactors.y;\n#endif\nvec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);\nsampleReflectionTexture(\nsheenAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nsheenRoughness,\n#endif\nreflectionSampler,\nreflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentSheenRadiance\n);\nvec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nsheenEnvironmentReflectance*=seo;\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\nsheenEnvironmentReflectance*=eho;\n#endif\n#if DEBUGMODE>0\noutParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;\n#endif\noutParams.finalSheenRadianceScaled=\nenvironmentSheenRadiance.rgb *\nsheenEnvironmentReflectance *\nvLightingIntensity.z;\n\n\n\n\n\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\n\n\n\noutParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;\n#endif\n\noutParams.sheenIntensity=sheenIntensity;\noutParams.sheenColor=sheenColor;\noutParams.sheenRoughness=sheenRoughness;\n}\n#endif\n";z.IncludesShadersStore.pbrBlockClearcoat="struct clearcoatOutParams\n{\nvec3 specularEnvironmentR0;\nfloat conservationFactor;\nvec3 clearCoatNormalW;\nvec2 clearCoatAARoughnessFactors;\nfloat clearCoatIntensity;\nfloat clearCoatRoughness;\n#ifdef REFLECTION\nvec3 finalClearCoatRadianceScaled;\n#endif\n#ifdef CLEARCOAT_TINT\nvec3 absorption;\nfloat clearCoatNdotVRefract;\nvec3 clearCoatColor;\nfloat clearCoatThickness;\n#endif\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nvec3 energyConservationFactorClearCoat;\n#endif\n#if DEBUGMODE>0\nmat3 TBNClearCoat;\nvec2 clearCoatMapData;\nvec4 clearCoatTintMapData;\nvec4 environmentClearCoatRadiance;\nfloat clearCoatNdotV;\nvec3 clearCoatEnvironmentReflectance;\n#endif\n};\n#ifdef CLEARCOAT\n#define pbr_inline\n#define inline\nvoid clearcoatBlock(\nconst in vec3 vPositionW,\nconst in vec3 geometricNormalW,\nconst in vec3 viewDirectionW,\nconst in vec2 vClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nconst in vec4 clearCoatMapRoughnessData,\n#endif\nconst in vec3 specularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nconst in vec2 clearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nconst in vec4 vClearCoatTintParams,\nconst in float clearCoatColorAtDistance,\nconst in vec4 vClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nconst in vec4 clearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nconst in vec2 vClearCoatBumpInfos,\nconst in vec4 clearCoatBumpMapData,\nconst in vec2 vClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nconst in mat3 vTBN,\n#else\nconst in vec2 vClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nconst in mat4 normalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nconst in vec3 faceNormal,\n#endif\n#ifdef REFLECTION\nconst in vec3 vReflectionMicrosurfaceInfos,\nconst in vec2 vReflectionInfos,\nconst in vec3 vReflectionColor,\nconst in vec4 vLightingIntensity,\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSampler,\n#else\nconst in sampler2D reflectionSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube reflectionSamplerLow,\nconst in samplerCube reflectionSamplerHigh,\n#else\nconst in sampler2D reflectionSamplerLow,\nconst in sampler2D reflectionSamplerHigh,\n#endif\n#endif\n#ifdef REALTIME_FILTERING\nconst in vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nconst in float ambientMonochrome,\n#endif\n#endif\nout clearcoatOutParams outParams\n)\n{\n\nfloat clearCoatIntensity=vClearCoatParams.x;\nfloat clearCoatRoughness=vClearCoatParams.y;\n#ifdef CLEARCOAT_TEXTURE\nclearCoatIntensity*=clearCoatMapData.x;\n#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE\nclearCoatRoughness*=clearCoatMapData.y;\n#endif\n#if DEBUGMODE>0\noutParams.clearCoatMapData=clearCoatMapData;\n#endif\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL\nclearCoatRoughness*=clearCoatMapData.y;\n#else\nclearCoatRoughness*=clearCoatMapRoughnessData.y;\n#endif\n#endif\noutParams.clearCoatIntensity=clearCoatIntensity;\noutParams.clearCoatRoughness=clearCoatRoughness;\n#ifdef CLEARCOAT_TINT\nvec3 clearCoatColor=vClearCoatTintParams.rgb;\nfloat clearCoatThickness=vClearCoatTintParams.a;\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatColor*=clearCoatTintMapData.rgb;\nclearCoatThickness*=clearCoatTintMapData.a;\n#if DEBUGMODE>0\noutParams.clearCoatTintMapData=clearCoatTintMapData;\n#endif\n#endif\noutParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);\noutParams.clearCoatThickness=clearCoatThickness;\n#endif\n\n\n\n\n#ifdef CLEARCOAT_REMAP_F0\nvec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);\n#else\nvec3 specularEnvironmentR0Updated=specularEnvironmentR0;\n#endif\noutParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);\n\nvec3 clearCoatNormalW=geometricNormalW;\n#ifdef CLEARCOAT_BUMP\n#ifdef NORMALXYSCALE\nfloat clearCoatNormalScale=1.0;\n#else\nfloat clearCoatNormalScale=vClearCoatBumpInfos.y;\n#endif\n#if defined(TANGENT) && defined(NORMAL)\nmat3 TBNClearCoat=vTBN;\n#else\nmat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,vClearCoatBumpUV,vClearCoatTangentSpaceParams);\n#endif\n#if DEBUGMODE>0\noutParams.TBNClearCoat=TBNClearCoat;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nclearCoatNormalW=normalize(clearCoatBumpMapData.xyz*2.0-1.0);\nclearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);\n#else\nclearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nclearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nclearCoatNormalW=gl_FrontFacing ? clearCoatNormalW : -clearCoatNormalW;\n#endif\noutParams.clearCoatNormalW=clearCoatNormalW;\n\noutParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);\n\nfloat clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);\n\nfloat clearCoatNdotV=absEps(clearCoatNdotVUnclamped);\n#if DEBUGMODE>0\noutParams.clearCoatNdotV=clearCoatNdotV;\n#endif\n#ifdef CLEARCOAT_TINT\n\nvec3 clearCoatVRefract=-refract(vPositionW,clearCoatNormalW,vClearCoatRefractionParams.y);\n\noutParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n\nvec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);\n#endif\n\n#if defined(REFLECTION)\nfloat clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);\n#ifdef SPECULARAA\n\nclearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;\n#endif\nvec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);\nvec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);\n#ifdef REFLECTIONMAP_OPPOSITEZ\nclearCoatReflectionVector.z*=-1.0;\n#endif\n\n#ifdef REFLECTIONMAP_3D\nvec3 clearCoatReflectionCoords=clearCoatReflectionVector;\n#else\nvec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nclearCoatReflectionCoords/=clearCoatReflectionVector.z;\n#endif\nclearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;\n#endif\nsampleReflectionTexture(\nclearCoatAlphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nclearCoatNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nclearCoatRoughness,\n#endif\nreflectionSampler,\nclearCoatReflectionCoords,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nenvironmentClearCoatRadiance\n);\n#if DEBUGMODE>0\noutParams.environmentClearCoatRadiance=environmentClearCoatRadiance;\n#endif\n\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);\n#ifdef RADIANCEOCCLUSION\nfloat clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);\nclearCoatEnvironmentReflectance*=clearCoatSeo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);\nclearCoatEnvironmentReflectance*=clearCoatEho;\n#endif\n#endif\n#endif\n#else\n\nvec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));\n#endif\nclearCoatEnvironmentReflectance*=clearCoatIntensity;\n#if DEBUGMODE>0\noutParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;\n#endif\noutParams.finalClearCoatRadianceScaled=\nenvironmentClearCoatRadiance.rgb *\nclearCoatEnvironmentReflectance *\nvLightingIntensity.z;\n#endif\n#if defined(CLEARCOAT_TINT)\n\noutParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);\n#endif\n\nfloat fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);\nfresnelIBLClearCoat*=clearCoatIntensity;\noutParams.conservationFactor=(1.-fresnelIBLClearCoat);\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\noutParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);\n#endif\n}\n#endif\n";z.IncludesShadersStore.pbrBlockSubSurface="struct subSurfaceOutParams\n{\nvec3 specularEnvironmentReflectance;\n#ifdef SS_REFRACTION\nvec3 finalRefraction;\nvec3 surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nfloat alpha;\n#endif\n#ifdef REFLECTION\nfloat refractionFactorForIrradiance;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvec3 transmittance;\nfloat translucencyIntensity;\n#ifdef REFLECTION\nvec3 refractionIrradiance;\n#endif\n#endif\n#if DEBUGMODE>0\nvec4 thicknessMap;\nvec4 environmentRefraction;\nvec3 refractionTransmittance;\n#endif\n};\n#ifdef SUBSURFACE\n#define pbr_inline\n#define inline\nvoid subSurfaceBlock(\nconst in vec3 vSubSurfaceIntensity,\nconst in vec2 vThicknessParam,\nconst in vec4 vTintColor,\nconst in vec3 normalW,\nconst in vec3 specularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nconst in vec4 thicknessMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nconst in mat4 reflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nconst in vec3 irradianceVector_,\n#endif\n#if defined(REALTIME_FILTERING)\nconst in samplerCube reflectionSampler,\nconst in vec2 vReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\n#ifdef REFLECTIONMAP_3D\nconst in samplerCube irradianceSampler,\n#else\nconst in sampler2D irradianceSampler,\n#endif\n#endif\n#endif\n#endif\n#ifdef SS_REFRACTION\nconst in vec3 vPositionW,\nconst in vec3 viewDirectionW,\nconst in mat4 view,\nconst in vec3 surfaceAlbedo,\nconst in vec4 vRefractionInfos,\nconst in mat4 refractionMatrix,\nconst in vec3 vRefractionMicrosurfaceInfos,\nconst in vec4 vLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nconst in float alpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nconst in float NdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nconst in float roughness,\n#else\nconst in float alphaG,\n#endif\n#ifdef SS_REFRACTIONMAP_3D\nconst in samplerCube refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nconst in samplerCube refractionSamplerLow,\nconst in samplerCube refractionSamplerHigh,\n#endif\n#else\nconst in sampler2D refractionSampler,\n#ifndef LODBASEDMICROSFURACE\nconst in sampler2D refractionSamplerLow,\nconst in sampler2D refractionSamplerHigh,\n#endif\n#endif\n#ifdef ANISOTROPIC\nconst in anisotropicOutParams anisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nconst in vec2 vRefractionFilteringInfo,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nconst in vec3 vDiffusionDistance,\n#endif\nout subSurfaceOutParams outParams\n)\n{\noutParams.specularEnvironmentReflectance=specularEnvironmentReflectance;\n\n\n\n#ifdef SS_REFRACTION\nfloat refractionIntensity=vSubSurfaceIntensity.x;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nrefractionIntensity*=(1.0-alpha);\n\noutParams.alpha=1.0;\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nfloat translucencyIntensity=vSubSurfaceIntensity.y;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nfloat thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;\n#if DEBUGMODE>0\noutParams.thicknessMap=thicknessMap;\n#endif\n#ifdef SS_MASK_FROM_THICKNESS_TEXTURE\n#ifdef SS_REFRACTION\nrefractionIntensity*=thicknessMap.g;\n#endif\n#ifdef SS_TRANSLUCENCY\ntranslucencyIntensity*=thicknessMap.b;\n#endif\n#elif defined(SS_MASK_FROM_THICKNESS_TEXTURE_GLTF)\n#ifdef SS_REFRACTION\nrefractionIntensity*=thicknessMap.r;\n#elif defined(SS_TRANSLUCENCY)\ntranslucencyIntensity*=thicknessMap.r;\n#endif\nthickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;\n#endif\n#else\nfloat thickness=vThicknessParam.y;\n#endif\n\n\n\n#ifdef SS_TRANSLUCENCY\nthickness=maxEps(thickness);\nvec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);\ntransmittance*=translucencyIntensity;\noutParams.transmittance=transmittance;\noutParams.translucencyIntensity=translucencyIntensity;\n#endif\n\n\n\n#ifdef SS_REFRACTION\nvec4 environmentRefraction=vec4(0.,0.,0.,0.);\n#ifdef ANISOTROPIC\nvec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);\n#else\nvec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);\n#endif\n#ifdef SS_REFRACTIONMAP_OPPOSITEZ\nrefractionVector.z*=-1.0;\n#endif\n\n#ifdef SS_REFRACTIONMAP_3D\nrefractionVector.y=refractionVector.y*vRefractionInfos.w;\nvec3 refractionCoords=refractionVector;\nrefractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));\n#else\nvec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));\nvec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;\nrefractionCoords.y=1.0-refractionCoords.y;\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);\n#elif defined(SS_LINEARSPECULARREFRACTION)\nfloat refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,roughness);\n#else\nfloat refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,alphaG);\n#endif\n#ifdef LODBASEDMICROSFURACE\n\nrefractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;\n#ifdef SS_LODINREFRACTIONALPHA\n\n\n\n\n\n\n\n\n\nfloat automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);\nfloat requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);\n#else\nfloat requestedRefractionLOD=refractionLOD;\n#endif\n#ifdef REALTIME_FILTERING\nenvironmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);\n#else\nenvironmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);\n#endif\n#else\nfloat lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));\nfloat lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;\nvec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);\nif (lodRefractionNormalizedDoubled<1.0){\nenvironmentRefraction=mix(\nsampleRefraction(refractionSamplerHigh,refractionCoords),\nenvironmentRefractionMid,\nlodRefractionNormalizedDoubled\n);\n} else {\nenvironmentRefraction=mix(\nenvironmentRefractionMid,\nsampleRefraction(refractionSamplerLow,refractionCoords),\nlodRefractionNormalizedDoubled-1.0\n);\n}\n#endif\n#ifdef SS_RGBDREFRACTION\nenvironmentRefraction.rgb=fromRGBD(environmentRefraction);\n#endif\n#ifdef SS_GAMMAREFRACTION\nenvironmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);\n#endif\n\nenvironmentRefraction.rgb*=vRefractionInfos.x;\n#endif\n\n\n\n#ifdef SS_REFRACTION\nvec3 refractionTransmittance=vec3(refractionIntensity);\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\n\n\n\n\n\nrefractionTransmittance*=cocaLambert(volumeAlbedo,thickness);\n#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)\n\nfloat maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);\nvec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);\n\nenvironmentRefraction.rgb*=volumeAlbedo;\n#else\n\nvec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);\nrefractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);\n#endif\n#ifdef SS_ALBEDOFORREFRACTIONTINT\n\nenvironmentRefraction.rgb*=surfaceAlbedo.rgb;\n#endif\n\noutParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);\n#ifdef REFLECTION\n\noutParams.refractionFactorForIrradiance=(1.-refractionIntensity);\n\n#endif\n\nvec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);\noutParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);\n\nrefractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;\n#if DEBUGMODE>0\noutParams.refractionTransmittance=refractionTransmittance;\n#endif\noutParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;\n#if DEBUGMODE>0\noutParams.environmentRefraction=environmentRefraction;\n#endif\n#endif\n\n\n\n#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)\nvec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nirradianceVector.z*=-1.0;\n#endif\n#ifdef INVERTCUBICMAP\nirradianceVector.y*=-1.0;\n#endif\n#else\nvec3 irradianceVector=irradianceVector_;\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP)\n#if defined(REALTIME_FILTERING)\nvec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);\n#else\nvec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);\n#endif\n#elif defined(USEIRRADIANCEMAP)\n#ifdef REFLECTIONMAP_3D\nvec3 irradianceCoords=irradianceVector;\n#else\nvec2 irradianceCoords=irradianceVector.xy;\n#ifdef REFLECTIONMAP_PROJECTION\nirradianceCoords/=irradianceVector.z;\n#endif\nirradianceCoords.y=1.0-irradianceCoords.y;\n#endif\nvec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);\n#ifdef RGBDREFLECTION\nrefractionIrradiance.rgb=fromRGBD(refractionIrradiance);\n#endif\n#ifdef GAMMAREFLECTION\nrefractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);\n#endif\n#else\nvec4 refractionIrradiance=vec4(0.);\n#endif\nrefractionIrradiance.rgb*=transmittance;\noutParams.refractionIrradiance=refractionIrradiance.rgb;\n#endif\n}\n#endif\n";z.IncludesShadersStore.pbrBlockNormalGeometric="vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);\n#ifdef NORMAL\nvec3 normalW=normalize(vNormalW);\n#else\nvec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#endif\nvec3 geometricNormalW=normalW;\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\ngeometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;\n#endif\n";z.IncludesShadersStore.pbrBlockNormalFinal="#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nvec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;\n#if defined(TWOSIDEDLIGHTING)\nfaceNormal=gl_FrontFacing ? faceNormal : -faceNormal;\n#endif\nnormalW*=sign(dot(normalW,faceNormal));\n#endif\n#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\nnormalW=gl_FrontFacing ? normalW : -normalW;\n#endif\n";z.IncludesShadersStore.pbrBlockLightmapInit="#ifdef LIGHTMAP\nvec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);\n#ifdef RGBDLIGHTMAP\nlightmapColor.rgb=fromRGBD(lightmapColor);\n#endif\n#ifdef GAMMALIGHTMAP\nlightmapColor.rgb=toLinearSpace(lightmapColor.rgb);\n#endif\nlightmapColor.rgb*=vLightmapInfos.y;\n#endif\n";z.IncludesShadersStore.pbrBlockGeometryInfo="float NdotVUnclamped=dot(normalW,viewDirectionW);\n\nfloat NdotV=absEps(NdotVUnclamped);\nfloat alphaG=convertRoughnessToAverageSlope(roughness);\nvec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);\n#ifdef SPECULARAA\n\nalphaG+=AARoughnessFactors.y;\n#endif\n#if defined(ENVIRONMENTBRDF)\n\nvec3 environmentBrdf=getBRDFLookup(NdotV,roughness);\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\n#ifdef AMBIENTINGRAYSCALE\nfloat ambientMonochrome=aoOut.ambientOcclusionColor.r;\n#else\nfloat ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);\n#endif\nfloat seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nfloat eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);\n#endif\n#endif\n#endif\n#endif\n";z.IncludesShadersStore.pbrBlockReflectance0="float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);\nvec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;\n#ifdef METALLICWORKFLOW\nvec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);\n#else\nvec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);\n#endif\n\n#ifdef ALPHAFRESNEL\nfloat reflectance90=fresnelGrazingReflectance(reflectance);\nspecularEnvironmentR90=specularEnvironmentR90*reflectance90;\n#endif\n";z.IncludesShadersStore.pbrBlockReflectance="#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\nvec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);\n#ifdef RADIANCEOCCLUSION\nspecularEnvironmentReflectance*=seo;\n#endif\n#ifdef HORIZONOCCLUSION\n#ifdef BUMP\n#ifdef REFLECTIONMAP_3D\nspecularEnvironmentReflectance*=eho;\n#endif\n#endif\n#endif\n#else\n\nvec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));\n#endif\n#ifdef CLEARCOAT\nspecularEnvironmentReflectance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nspecularEnvironmentReflectance*=clearcoatOut.absorption;\n#endif\n#endif\n";z.IncludesShadersStore.pbrBlockDirectLighting="vec3 diffuseBase=vec3(0.,0.,0.);\n#ifdef SPECULARTERM\nvec3 specularBase=vec3(0.,0.,0.);\n#endif\n#ifdef CLEARCOAT\nvec3 clearCoatBase=vec3(0.,0.,0.);\n#endif\n#ifdef SHEEN\nvec3 sheenBase=vec3(0.,0.,0.);\n#endif\n\npreLightingInfo preInfo;\nlightingInfo info;\nfloat shadow=1.;\n#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\nvec3 absorption=vec3(0.);\n#endif\n";z.IncludesShadersStore.pbrBlockFinalLitComponents="\n\n\n\n#if defined(ENVIRONMENTBRDF)\n#ifdef MS_BRDF_ENERGY_CONSERVATION\nvec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);\n#endif\n#endif\n#ifndef METALLICWORKFLOW\n#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION\nsurfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;\n#endif\n#endif\n#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)\nsurfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;\n#endif\n\n#ifdef REFLECTION\nvec3 finalIrradiance=reflectionOut.environmentIrradiance;\n#if defined(CLEARCOAT)\nfinalIrradiance*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nfinalIrradiance*=clearcoatOut.absorption;\n#endif\n#endif\n#if defined(SS_REFRACTION)\nfinalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;\n#endif\n#if defined(SS_TRANSLUCENCY)\nfinalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);\nfinalIrradiance+=subSurfaceOut.refractionIrradiance;\n#endif\nfinalIrradiance*=surfaceAlbedo.rgb;\nfinalIrradiance*=vLightingIntensity.z;\nfinalIrradiance*=aoOut.ambientOcclusionColor;\n#endif\n\n#ifdef SPECULARTERM\nvec3 finalSpecular=specularBase;\nfinalSpecular=max(finalSpecular,0.0);\nvec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalSpecularScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalSpecularScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n\n#ifdef REFLECTION\nvec3 finalRadiance=reflectionOut.environmentRadiance.rgb;\nfinalRadiance*=subSurfaceOut.specularEnvironmentReflectance;\nvec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalRadianceScaled*=energyConservationFactor;\n#endif\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)\nfinalRadianceScaled*=sheenOut.sheenAlbedoScaling;\n#endif\n#endif\n\n#ifdef SHEEN\nvec3 finalSheen=sheenBase*sheenOut.sheenColor;\nfinalSheen=max(finalSheen,0.0);\nvec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;\n#if defined(CLEARCOAT_TINT)\nsheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n\n#ifdef CLEARCOAT\nvec3 finalClearCoat=clearCoatBase;\nfinalClearCoat=max(finalClearCoat,0.0);\nvec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;\n#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)\nfinalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;\n#ifdef CLEARCOAT_TINT\nsubSurfaceOut.finalRefraction*=clearcoatOut.absorption;\n#endif\n#endif\n#endif\n\n#ifdef ALPHABLEND\nfloat luminanceOverAlpha=0.0;\n#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalRadianceScaled);\n#if defined(CLEARCOAT)\nluminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);\n#endif\n#endif\n#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)\nluminanceOverAlpha+=getLuminance(finalSpecularScaled);\n#endif\n#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)\nluminanceOverAlpha+=getLuminance(finalClearCoatScaled);\n#endif\n#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)\nalpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);\n#endif\n#endif\n";z.IncludesShadersStore.pbrBlockFinalUnlitComponents="\nvec3 finalDiffuse=diffuseBase;\nfinalDiffuse*=surfaceAlbedo.rgb;\nfinalDiffuse=max(finalDiffuse,0.0);\nfinalDiffuse*=vLightingIntensity.x;\n\nvec3 finalAmbient=vAmbientColor;\nfinalAmbient*=surfaceAlbedo.rgb;\n\nvec3 finalEmissive=vEmissiveColor;\n#ifdef EMISSIVE\nvec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;\nfinalEmissive*=toLinearSpace(emissiveColorTex.rgb);\nfinalEmissive*=vEmissiveInfos.y;\n#endif\nfinalEmissive*=vLightingIntensity.y;\n\n#ifdef AMBIENT\nvec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);\n#else\nvec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;\n#endif\nfinalAmbient*=aoOut.ambientOcclusionColor;\nfinalDiffuse*=ambientOcclusionForDirectDiffuse;\n";z.IncludesShadersStore.pbrBlockFinalColorComposition="vec4 finalColor=vec4(\nfinalAmbient +\nfinalDiffuse +\n#ifndef UNLIT\n#ifdef REFLECTION\nfinalIrradiance +\n#endif\n#ifdef SPECULARTERM\nfinalSpecularScaled +\n#endif\n#ifdef SHEEN\nfinalSheenScaled +\n#endif\n#ifdef CLEARCOAT\nfinalClearCoatScaled +\n#endif\n#ifdef REFLECTION\nfinalRadianceScaled +\n#if defined(SHEEN) && defined(ENVIRONMENTBRDF)\nsheenOut.finalSheenRadianceScaled +\n#endif\n#ifdef CLEARCOAT\nclearcoatOut.finalClearCoatRadianceScaled +\n#endif\n#endif\n#ifdef SS_REFRACTION\nsubSurfaceOut.finalRefraction +\n#endif\n#endif\nfinalEmissive,\nalpha);\n\n#ifdef LIGHTMAP\n#ifndef LIGHTMAPEXCLUDED\n#ifdef USELIGHTMAPASSHADOWMAP\nfinalColor.rgb*=lightmapColor.rgb;\n#else\nfinalColor.rgb+=lightmapColor.rgb;\n#endif\n#endif\n#endif\n#define CUSTOM_FRAGMENT_BEFORE_FOG\n\nfinalColor=max(finalColor,0.0);\n";z.IncludesShadersStore.pbrBlockImageProcessing="#ifdef IMAGEPROCESSINGPOSTPROCESS\n\n\nfinalColor.rgb=clamp(finalColor.rgb,0.,30.0);\n#else\n\nfinalColor=applyImageProcessing(finalColor);\n#endif\nfinalColor.a*=visibility;\n#ifdef PREMULTIPLYALPHA\n\nfinalColor.rgb*=finalColor.a;\n#endif\n";z.IncludesShadersStore.pbrDebug="#if DEBUGMODE>0\nif (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {\n\n#if DEBUGMODE == 1\ngl_FragColor.rgb=vPositionW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 2 && defined(NORMAL)\ngl_FragColor.rgb=vNormalW.rgb;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 3 && defined(BUMP) || DEBUGMODE == 3 && defined(PARALLAX) || DEBUGMODE == 3 && defined(ANISOTROPIC)\n\ngl_FragColor.rgb=TBN[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 4 && defined(BUMP) || DEBUGMODE == 4 && defined(PARALLAX) || DEBUGMODE == 4 && defined(ANISOTROPIC)\n\ngl_FragColor.rgb=TBN[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 5\n\ngl_FragColor.rgb=normalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 6 && defined(MAINUV1)\ngl_FragColor.rgb=vec3(vMainUV1,0.0);\n#elif DEBUGMODE == 7 && defined(MAINUV2)\ngl_FragColor.rgb=vec3(vMainUV2,0.0);\n#elif DEBUGMODE == 8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\n\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)\n\ngl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 10 && defined(CLEARCOAT)\n\ngl_FragColor.rgb=clearcoatOut.clearCoatNormalW;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 11 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicNormal;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 12 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicTangent;\n#define DEBUGMODE_NORMALIZE\n#elif DEBUGMODE == 13 && defined(ANISOTROPIC)\ngl_FragColor.rgb=anisotropicOut.anisotropicBitangent;\n#define DEBUGMODE_NORMALIZE\n\n#elif DEBUGMODE == 20 && defined(ALBEDO)\ngl_FragColor.rgb=albedoTexture.rgb;\n#elif DEBUGMODE == 21 && defined(AMBIENT)\ngl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;\n#elif DEBUGMODE == 22 && defined(OPACITY)\ngl_FragColor.rgb=opacityMap.rgb;\n#elif DEBUGMODE == 23 && defined(EMISSIVE)\ngl_FragColor.rgb=emissiveColorTex.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 24 && defined(LIGHTMAP)\ngl_FragColor.rgb=lightmapColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;\n#elif DEBUGMODE == 26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);\n#elif DEBUGMODE == 28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\ngl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;\n#elif DEBUGMODE == 29 && defined(SHEEN) && defined(SHEEN_TEXTURE)\ngl_FragColor.rgb=sheenOut.sheenMapData.rgb;\n#elif DEBUGMODE == 30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)\ngl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;\n#elif DEBUGMODE == 31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)\ngl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;\n\n#elif DEBUGMODE == 40 && defined(SS_REFRACTION)\n\ngl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 41 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 42 && defined(CLEARCOAT) && defined(REFLECTION)\ngl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;\n#define DEBUGMODE_GAMMA\n\n#elif DEBUGMODE == 50\ngl_FragColor.rgb=diffuseBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 51 && defined(SPECULARTERM)\ngl_FragColor.rgb=specularBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 52 && defined(CLEARCOAT)\ngl_FragColor.rgb=clearCoatBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 53 && defined(SHEEN)\ngl_FragColor.rgb=sheenBase.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 54 && defined(REFLECTION)\ngl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;\n#define DEBUGMODE_GAMMA\n\n#elif DEBUGMODE == 60\ngl_FragColor.rgb=surfaceAlbedo.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 61\ngl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 62 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);\n#elif DEBUGMODE == 71 && defined(METALLICWORKFLOW)\ngl_FragColor.rgb=reflectivityOut.metallicF0;\n#elif DEBUGMODE == 63\ngl_FragColor.rgb=vec3(roughness);\n#elif DEBUGMODE == 64\ngl_FragColor.rgb=vec3(alphaG);\n#elif DEBUGMODE == 65\ngl_FragColor.rgb=vec3(NdotV);\n#elif DEBUGMODE == 66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)\ngl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 67 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);\n#elif DEBUGMODE == 68 && defined(CLEARCOAT)\ngl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);\n#elif DEBUGMODE == 69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)\ngl_FragColor.rgb=subSurfaceOut.transmittance;\n#elif DEBUGMODE == 70 && defined(SUBSURFACE) && defined(SS_REFRACTION)\ngl_FragColor.rgb=subSurfaceOut.refractionTransmittance;\n\n#elif DEBUGMODE == 80 && defined(RADIANCEOCCLUSION)\ngl_FragColor.rgb=vec3(seo);\n#elif DEBUGMODE == 81 && defined(HORIZONOCCLUSION)\ngl_FragColor.rgb=vec3(eho);\n#elif DEBUGMODE == 82 && defined(MS_BRDF_ENERGY_CONSERVATION)\ngl_FragColor.rgb=vec3(energyConservationFactor);\n#elif DEBUGMODE == 83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=specularEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\ngl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 85 && defined(SHEEN) && defined(REFLECTION)\ngl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;\n#define DEBUGMODE_GAMMA\n#elif DEBUGMODE == 86 && defined(ALPHABLEND)\ngl_FragColor.rgb=vec3(luminanceOverAlpha);\n#elif DEBUGMODE == 87\ngl_FragColor.rgb=vec3(alpha);\n#endif\ngl_FragColor.rgb*=vDebugMode.y;\n#ifdef DEBUGMODE_NORMALIZE\ngl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;\n#endif\n#ifdef DEBUGMODE_GAMMA\ngl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);\n#endif\ngl_FragColor.a=1.0;\n#ifdef PREPASS\ngl_FragData[0]=toLinearSpace(gl_FragColor);\ngl_FragData[1]=vec4(0.,0.,0.,0.);\n#endif\nreturn;\n}\n#endif";z.ShadersStore.pbrPixelShader="#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#ifdef LODBASEDMICROSFURACE\n#extension GL_EXT_shader_texture_lod : enable\n#endif\n#define CUSTOM_FRAGMENT_BEGIN\n#ifdef LOGARITHMICDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n#include<prePassDeclaration>[SCENE_MRT_COUNT]\nprecision highp float;\n\n#ifndef FROMLINEARSPACE\n#define FROMLINEARSPACE\n#endif\n\n#include<__decl__pbrFragment>\n#include<pbrFragmentExtraDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<pbrFragmentSamplersDeclaration>\n#include<imageProcessingDeclaration>\n#include<clipPlaneFragmentDeclaration>\n#include<logDepthDeclaration>\n#include<fogFragmentDeclaration>\n\n#include<helperFunctions>\n#include<subSurfaceScatteringFunctions>\n#include<importanceSampling>\n#include<pbrHelperFunctions>\n#include<imageProcessingFunctions>\n#include<shadowsFragmentFunctions>\n#include<harmonicsFunctions>\n#include<pbrDirectLightingSetupFunctions>\n#include<pbrDirectLightingFalloffFunctions>\n#include<pbrBRDFFunctions>\n#include<hdrFilteringFunctions>\n#include<pbrDirectLightingFunctions>\n#include<pbrIBLFunctions>\n#include<bumpFragmentMainFunctions>\n#include<bumpFragmentFunctions>\n#ifdef REFLECTION\n#include<reflectionFunction>\n#endif\n#define CUSTOM_FRAGMENT_DEFINITIONS\n#include<pbrBlockAlbedoOpacity>\n#include<pbrBlockReflectivity>\n#include<pbrBlockAmbientOcclusion>\n#include<pbrBlockAlphaFresnel>\n#include<pbrBlockAnisotropic>\n#include<pbrBlockReflection>\n#include<pbrBlockSheen>\n#include<pbrBlockClearcoat>\n#include<pbrBlockSubSurface>\n\nvoid main(void) {\n#define CUSTOM_FRAGMENT_MAIN_BEGIN\n#include<clipPlaneFragment>\n\n#include<pbrBlockNormalGeometric>\n#include<bumpFragment>\n#include<pbrBlockNormalFinal>\n\nalbedoOpacityOutParams albedoOpacityOut;\n#ifdef ALBEDO\nvec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);\n#endif\n#ifdef OPACITY\nvec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);\n#endif\nalbedoOpacityBlock(\nvAlbedoColor,\n#ifdef ALBEDO\nalbedoTexture,\nvAlbedoInfos,\n#endif\n#ifdef OPACITY\nopacityMap,\nvOpacityInfos,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nalbedoOpacityOut\n);\nvec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;\nfloat alpha=albedoOpacityOut.alpha;\n#define CUSTOM_FRAGMENT_UPDATE_ALPHA\n#include<depthPrePass>\n#define CUSTOM_FRAGMENT_BEFORE_LIGHTS\n\nambientOcclusionOutParams aoOut;\n#ifdef AMBIENT\nvec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;\n#endif\nambientOcclusionBlock(\n#ifdef AMBIENT\nambientOcclusionColorMap,\nvAmbientInfos,\n#endif\naoOut\n);\n#include<pbrBlockLightmapInit>\n#ifdef UNLIT\nvec3 diffuseBase=vec3(1.,1.,1.);\n#else\n\nvec3 baseColor=surfaceAlbedo;\nreflectivityOutParams reflectivityOut;\n#if defined(REFLECTIVITY)\nvec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);\nvec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;\n#ifndef METALLICWORKFLOW\nsurfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);\nsurfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;\n#endif\n#endif\n#if defined(MICROSURFACEMAP)\nvec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;\n#endif\n#ifdef METALLICWORKFLOW\nvec4 metallicReflectanceFactors=vMetallicReflectanceFactors;\n#ifdef METALLIC_REFLECTANCE\nvec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);\nmetallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);\nmetallicReflectanceFactors*=metallicReflectanceFactorsMap;\n#endif\n#endif\nreflectivityBlock(\nvReflectivityColor,\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo,\nmetallicReflectanceFactors,\n#endif\n#ifdef REFLECTIVITY\nvReflectivityInfos,\nsurfaceMetallicOrReflectivityColorMap,\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor,\n#endif\n#ifdef MICROSURFACEMAP\nmicroSurfaceTexel,\n#endif\n#ifdef DETAIL\ndetailColor,\nvDetailInfos,\n#endif\nreflectivityOut\n);\nfloat microSurface=reflectivityOut.microSurface;\nfloat roughness=reflectivityOut.roughness;\n#ifdef METALLICWORKFLOW\nsurfaceAlbedo=reflectivityOut.surfaceAlbedo;\n#endif\n#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)\naoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;\n#endif\n\n#ifdef ALPHAFRESNEL\n#if defined(ALPHATEST) || defined(ALPHABLEND)\nalphaFresnelOutParams alphaFresnelOut;\nalphaFresnelBlock(\nnormalW,\nviewDirectionW,\nalpha,\nmicroSurface,\nalphaFresnelOut\n);\nalpha=alphaFresnelOut.alpha;\n#endif\n#endif\n\n#include<pbrBlockGeometryInfo>\n\n#ifdef ANISOTROPIC\nanisotropicOutParams anisotropicOut;\n#ifdef ANISOTROPIC_TEXTURE\nvec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;\n#endif\nanisotropicBlock(\nvAnisotropy,\n#ifdef ANISOTROPIC_TEXTURE\nanisotropyMapData,\n#endif\nTBN,\nnormalW,\nviewDirectionW,\nanisotropicOut\n);\n#endif\n\n#ifdef REFLECTION\nreflectionOutParams reflectionOut;\nreflectionBlock(\nvPositionW,\nnormalW,\nalphaG,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)\nNdotVUnclamped,\n#endif\n#ifdef LINEARSPECULARREFLECTION\nroughness,\n#endif\nreflectionSampler,\n#if defined(NORMAL) && defined(USESPHERICALINVERTEX)\nvEnvironmentIrradiance,\n#endif\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionMatrix,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\nreflectionOut\n);\n#endif\n\n#include<pbrBlockReflectance0>\n\n#ifdef SHEEN\nsheenOutParams sheenOut;\n#ifdef SHEEN_TEXTURE\nvec4 sheenMapData=toLinearSpace(texture2D(sheenSampler,vSheenUV+uvOffset))*vSheenInfos.y;\n#endif\n#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;\n#endif\nsheenBlock(\nvSheenColor,\n#ifdef SHEEN_ROUGHNESS\nvSheenRoughness,\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)\nsheenMapRoughnessData,\n#endif\n#endif\nroughness,\n#ifdef SHEEN_TEXTURE\nsheenMapData,\n#endif\nreflectance,\n#ifdef SHEEN_LINKWITHALBEDO\nbaseColor,\nsurfaceAlbedo,\n#endif\n#ifdef ENVIRONMENTBRDF\nNdotV,\nenvironmentBrdf,\n#endif\n#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)\nAARoughnessFactors,\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\nreflectionOut.reflectionCoords,\nNdotVUnclamped,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)\nseo,\n#endif\n#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)\neho,\n#endif\n#endif\nsheenOut\n);\n#ifdef SHEEN_LINKWITHALBEDO\nsurfaceAlbedo=sheenOut.surfaceAlbedo;\n#endif\n#endif\n\nclearcoatOutParams clearcoatOut;\n#ifdef CLEARCOAT\n#ifdef CLEARCOAT_TEXTURE\nvec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nvec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;\n#endif\n#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)\nvec4 clearCoatTintMapData=toLinearSpace(texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset));\n#endif\n#ifdef CLEARCOAT_BUMP\nvec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);\n#endif\nclearcoatBlock(\nvPositionW,\ngeometricNormalW,\nviewDirectionW,\nvClearCoatParams,\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)\nclearCoatMapRoughnessData,\n#endif\nspecularEnvironmentR0,\n#ifdef CLEARCOAT_TEXTURE\nclearCoatMapData,\n#endif\n#ifdef CLEARCOAT_TINT\nvClearCoatTintParams,\nclearCoatColorAtDistance,\nvClearCoatRefractionParams,\n#ifdef CLEARCOAT_TINT_TEXTURE\nclearCoatTintMapData,\n#endif\n#endif\n#ifdef CLEARCOAT_BUMP\nvClearCoatBumpInfos,\nclearCoatBumpMapData,\nvClearCoatBumpUV,\n#if defined(TANGENT) && defined(NORMAL)\nvTBN,\n#else\nvClearCoatTangentSpaceParams,\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nnormalMatrix,\n#endif\n#endif\n#if defined(FORCENORMALFORWARD) && defined(NORMAL)\nfaceNormal,\n#endif\n#ifdef REFLECTION\nvReflectionMicrosurfaceInfos,\nvReflectionInfos,\nvReflectionColor,\nvLightingIntensity,\nreflectionSampler,\n#ifndef LODBASEDMICROSFURACE\nreflectionSamplerLow,\nreflectionSamplerHigh,\n#endif\n#ifdef REALTIME_FILTERING\nvReflectionFilteringInfo,\n#endif\n#endif\n#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)\n#ifdef RADIANCEOCCLUSION\nambientMonochrome,\n#endif\n#endif\nclearcoatOut\n);\n#else\nclearcoatOut.specularEnvironmentR0=specularEnvironmentR0;\n#endif\n\n#include<pbrBlockReflectance>\n\nsubSurfaceOutParams subSurfaceOut;\n#ifdef SUBSURFACE\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nvec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);\n#endif\nsubSurfaceBlock(\nvSubSurfaceIntensity,\nvThicknessParam,\nvTintColor,\nnormalW,\nspecularEnvironmentReflectance,\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nthicknessMap,\n#endif\n#ifdef REFLECTION\n#ifdef SS_TRANSLUCENCY\nreflectionMatrix,\n#ifdef USESPHERICALFROMREFLECTIONMAP\n#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)\nreflectionOut.irradianceVector,\n#endif\n#if defined(REALTIME_FILTERING)\nreflectionSampler,\nvReflectionFilteringInfo,\n#endif\n#endif\n#ifdef USEIRRADIANCEMAP\nirradianceSampler,\n#endif\n#endif\n#endif\n#ifdef SS_REFRACTION\nvPositionW,\nviewDirectionW,\nview,\nsurfaceAlbedo,\nvRefractionInfos,\nrefractionMatrix,\nvRefractionMicrosurfaceInfos,\nvLightingIntensity,\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha,\n#endif\n#ifdef SS_LODINREFRACTIONALPHA\nNdotVUnclamped,\n#endif\n#ifdef SS_LINEARSPECULARREFRACTION\nroughness,\n#else\nalphaG,\n#endif\nrefractionSampler,\n#ifndef LODBASEDMICROSFURACE\nrefractionSamplerLow,\nrefractionSamplerHigh,\n#endif\n#ifdef ANISOTROPIC\nanisotropicOut,\n#endif\n#ifdef REALTIME_FILTERING\nvRefractionFilteringInfo,\n#endif\n#endif\n#ifdef SS_TRANSLUCENCY\nvDiffusionDistance,\n#endif\nsubSurfaceOut\n);\n#ifdef SS_REFRACTION\nsurfaceAlbedo=subSurfaceOut.surfaceAlbedo;\n#ifdef SS_LINKREFRACTIONTOTRANSPARENCY\nalpha=subSurfaceOut.alpha;\n#endif\n#endif\n#else\nsubSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;\n#endif\n\n#include<pbrBlockDirectLighting>\n#include<lightFragment>[0..maxSimultaneousLights]\n\n#include<pbrBlockFinalLitComponents>\n#endif\n#include<pbrBlockFinalUnlitComponents>\n#include<pbrBlockFinalColorComposition>\n#include<logDepthFragment>\n#include<fogFragment>(color,finalColor)\n#include<pbrBlockImageProcessing>\n#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR\n#ifdef PREPASS\n#ifdef PREPASS_POSITION\ngl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,1.0);\n#endif\n#ifdef PREPASS_VELOCITY\nvec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;\nvec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;\nvec2 velocity=abs(a-b);\nvelocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;\ngl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,1.0);\n#endif\n#ifdef PREPASS_IRRADIANCE\nvec3 irradiance=finalDiffuse;\n#ifndef UNLIT\n#ifdef REFLECTION\nirradiance+=finalIrradiance;\n#endif\n#endif\nvec3 sqAlbedo=sqrt(surfaceAlbedo);\n#ifdef SS_SCATTERING\ngl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a);\nirradiance/=sqAlbedo;\n#else\ngl_FragData[0]=finalColor;\nfloat scatteringDiffusionProfile=255.;\n#endif\ngl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(irradiance,scatteringDiffusionProfile/255.);\n#else\ngl_FragData[0]=vec4(finalColor.rgb,finalColor.a);\n#endif\n#ifdef PREPASS_DEPTHNORMAL\ngl_FragData[PREPASS_DEPTHNORMAL_INDEX]=vec4(vViewPos.z,(view*vec4(normalW,0.0)).rgb);\n#endif\n#ifdef PREPASS_ALBEDO\ngl_FragData[PREPASS_ALBEDO_INDEX]=vec4(sqAlbedo,1.0);\n#endif\n#ifdef PREPASS_REFLECTIVITY\n#if defined(REFLECTIVITY)\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(baseReflectivity.rgb,1.0);\n#else\ngl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0);\n#endif\n#endif\n#endif\n#if !defined(PREPASS) || defined(WEBGL2)\ngl_FragColor=finalColor;\n#endif\n#include<pbrDebug>\n}\n";z.IncludesShadersStore.pbrVertexDeclaration="uniform mat4 view;\nuniform mat4 viewProjection;\n#ifdef ALBEDO\nuniform mat4 albedoMatrix;\nuniform vec2 vAlbedoInfos;\n#endif\n#ifdef AMBIENT\nuniform mat4 ambientMatrix;\nuniform vec4 vAmbientInfos;\n#endif\n#ifdef OPACITY\nuniform mat4 opacityMatrix;\nuniform vec2 vOpacityInfos;\n#endif\n#ifdef EMISSIVE\nuniform vec2 vEmissiveInfos;\nuniform mat4 emissiveMatrix;\n#endif\n#ifdef LIGHTMAP\nuniform vec2 vLightmapInfos;\nuniform mat4 lightmapMatrix;\n#endif\n#ifdef REFLECTIVITY\nuniform vec3 vReflectivityInfos;\nuniform mat4 reflectivityMatrix;\n#endif\n#ifdef METALLIC_REFLECTANCE\nuniform vec2 vMetallicReflectanceInfos;\nuniform mat4 metallicReflectanceMatrix;\n#endif\n#ifdef MICROSURFACEMAP\nuniform vec2 vMicroSurfaceSamplerInfos;\nuniform mat4 microSurfaceSamplerMatrix;\n#endif\n#ifdef BUMP\nuniform vec3 vBumpInfos;\nuniform mat4 bumpMatrix;\n#endif\n#ifdef POINTSIZE\nuniform float pointSize;\n#endif\n\n#ifdef REFLECTION\nuniform vec2 vReflectionInfos;\nuniform mat4 reflectionMatrix;\n#endif\n\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)\nuniform vec4 vClearCoatInfos;\n#endif\n#ifdef CLEARCOAT_TEXTURE\nuniform mat4 clearCoatMatrix;\n#endif\n#ifdef CLEARCOAT_TEXTURE_ROUGHNESS\nuniform mat4 clearCoatRoughnessMatrix;\n#endif\n#ifdef CLEARCOAT_BUMP\nuniform vec2 vClearCoatBumpInfos;\nuniform mat4 clearCoatBumpMatrix;\n#endif\n#ifdef CLEARCOAT_TINT_TEXTURE\nuniform vec2 vClearCoatTintInfos;\nuniform mat4 clearCoatTintMatrix;\n#endif\n#endif\n\n#ifdef ANISOTROPIC\n#ifdef ANISOTROPIC_TEXTURE\nuniform vec2 vAnisotropyInfos;\nuniform mat4 anisotropyMatrix;\n#endif\n#endif\n\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)\nuniform vec4 vSheenInfos;\n#endif\n#ifdef SHEEN_TEXTURE\nuniform mat4 sheenMatrix;\n#endif\n#ifdef SHEEN_TEXTURE_ROUGHNESS\nuniform mat4 sheenRoughnessMatrix;\n#endif\n#endif\n\n#ifdef SUBSURFACE\n#ifdef SS_REFRACTION\nuniform vec4 vRefractionInfos;\nuniform mat4 refractionMatrix;\n#endif\n#ifdef SS_THICKNESSANDMASK_TEXTURE\nuniform vec2 vThicknessInfos;\nuniform mat4 thicknessMatrix;\n#endif\n#endif\n";z.ShadersStore.pbrVertexShader="precision highp float;\n#include<__decl__pbrVertex>\n#define CUSTOM_VERTEX_BEGIN\n\nattribute vec3 position;\n#ifdef NORMAL\nattribute vec3 normal;\n#endif\n#ifdef TANGENT\nattribute vec4 tangent;\n#endif\n#ifdef UV1\nattribute vec2 uv;\n#endif\n#ifdef UV2\nattribute vec2 uv2;\n#endif\n#ifdef MAINUV1\nvarying vec2 vMainUV1;\n#endif\n#ifdef MAINUV2\nvarying vec2 vMainUV2;\n#endif\n#ifdef VERTEXCOLOR\nattribute vec4 color;\n#endif\n#include<helperFunctions>\n#include<bonesDeclaration>\n\n#include<instancesDeclaration>\n#include<prePassVertexDeclaration>\n#if defined(ALBEDO) && ALBEDODIRECTUV == 0\nvarying vec2 vAlbedoUV;\n#endif\n#if defined(DETAIL) && DETAILDIRECTUV == 0\nvarying vec2 vDetailUV;\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nvarying vec2 vAmbientUV;\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nvarying vec2 vOpacityUV;\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nvarying vec2 vEmissiveUV;\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nvarying vec2 vLightmapUV;\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0\nvarying vec2 vReflectivityUV;\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0\nvarying vec2 vMicroSurfaceSamplerUV;\n#endif\n#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0\nvarying vec2 vMetallicReflectanceUV;\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nvarying vec2 vBumpUV;\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0\nvarying vec2 vClearCoatUV;\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0\nvarying vec2 vClearCoatRoughnessUV;\n#endif\n#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0\nvarying vec2 vClearCoatBumpUV;\n#endif\n#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0\nvarying vec2 vClearCoatTintUV;\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0\nvarying vec2 vSheenUV;\n#endif\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0\nvarying vec2 vSheenRoughnessUV;\n#endif\n#endif\n#ifdef ANISOTROPIC\n#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0\nvarying vec2 vAnisotropyUV;\n#endif\n#endif\n#ifdef SUBSURFACE\n#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0\nvarying vec2 vThicknessUV;\n#endif\n#endif\n\nvarying vec3 vPositionW;\n#if DEBUGMODE>0\nvarying vec4 vClipSpacePosition;\n#endif\n#ifdef NORMAL\nvarying vec3 vNormalW;\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvarying vec3 vEnvironmentIrradiance;\n#include<harmonicsFunctions>\n#endif\n#endif\n#ifdef VERTEXCOLOR\nvarying vec4 vColor;\n#endif\n#include<bumpVertexDeclaration>\n#include<clipPlaneVertexDeclaration>\n#include<fogVertexDeclaration>\n#include<__decl__lightFragment>[0..maxSimultaneousLights]\n#include<morphTargetsVertexGlobalDeclaration>\n#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvarying vec3 vPositionUVW;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvarying vec3 vDirectionW;\n#endif\n#include<logDepthDeclaration>\n#define CUSTOM_VERTEX_DEFINITIONS\nvoid main(void) {\n#define CUSTOM_VERTEX_MAIN_BEGIN\nvec3 positionUpdated=position;\n#ifdef NORMAL\nvec3 normalUpdated=normal;\n#endif\n#ifdef TANGENT\nvec4 tangentUpdated=tangent;\n#endif\n#ifdef UV1\nvec2 uvUpdated=uv;\n#endif\n#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]\n#ifdef REFLECTIONMAP_SKYBOX\nvPositionUVW=positionUpdated;\n#endif\n#define CUSTOM_VERTEX_UPDATE_POSITION\n#define CUSTOM_VERTEX_UPDATE_NORMAL\n#include<instancesVertex>\n#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)\n\nvCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);\nvPreviousPosition=previousViewProjection*previousWorld*vec4(positionUpdated,1.0);\n#endif\n#include<bonesVertex>\nvec4 worldPos=finalWorld*vec4(positionUpdated,1.0);\nvPositionW=vec3(worldPos);\n#include<prePassVertex>\n#ifdef NORMAL\nmat3 normalWorld=mat3(finalWorld);\n#if defined(INSTANCES) && defined(THIN_INSTANCES)\nvNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));\nvNormalW=normalize(normalWorld*vNormalW);\n#else\n#ifdef NONUNIFORMSCALING\nnormalWorld=transposeMat3(inverseMat3(normalWorld));\n#endif\nvNormalW=normalize(normalWorld*normalUpdated);\n#endif\n#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)\nvec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;\n#ifdef REFLECTIONMAP_OPPOSITEZ\nreflectionVector.z*=-1.0;\n#endif\nvEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);\n#endif\n#endif\n#define CUSTOM_VERTEX_UPDATE_WORLDPOS\n#ifdef MULTIVIEW\nif (gl_ViewID_OVR == 0u) {\ngl_Position=viewProjection*worldPos;\n} else {\ngl_Position=viewProjectionR*worldPos;\n}\n#else\ngl_Position=viewProjection*worldPos;\n#endif\n#if DEBUGMODE>0\nvClipSpacePosition=gl_Position;\n#endif\n#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)\nvDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));\n#endif\n\n#ifndef UV1\nvec2 uvUpdated=vec2(0.,0.);\n#endif\n#ifndef UV2\nvec2 uv2=vec2(0.,0.);\n#endif\n#ifdef MAINUV1\nvMainUV1=uvUpdated;\n#endif\n#ifdef MAINUV2\nvMainUV2=uv2;\n#endif\n#if defined(ALBEDO) && ALBEDODIRECTUV == 0\nif (vAlbedoInfos.x == 0.)\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(DETAIL) && DETAILDIRECTUV == 0\nif (vDetailInfos.x == 0.)\n{\nvDetailUV=vec2(detailMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvDetailUV=vec2(detailMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(AMBIENT) && AMBIENTDIRECTUV == 0\nif (vAmbientInfos.x == 0.)\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvAmbientUV=vec2(ambientMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(OPACITY) && OPACITYDIRECTUV == 0\nif (vOpacityInfos.x == 0.)\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(EMISSIVE) && EMISSIVEDIRECTUV == 0\nif (vEmissiveInfos.x == 0.)\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvEmissiveUV=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(LIGHTMAP) && LIGHTMAPDIRECTUV == 0\nif (vLightmapInfos.x == 0.)\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvLightmapUV=vec2(lightmapMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(REFLECTIVITY) && REFLECTIVITYDIRECTUV == 0\nif (vReflectivityInfos.x == 0.)\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(MICROSURFACEMAP) && MICROSURFACEMAPDIRECTUV == 0\nif (vMicroSurfaceSamplerInfos.x == 0.)\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvMicroSurfaceSamplerUV=vec2(microSurfaceSamplerMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(METALLIC_REFLECTANCE) && METALLIC_REFLECTANCEDIRECTUV == 0\nif (vMetallicReflectanceInfos.x == 0.)\n{\nvMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvMetallicReflectanceUV=vec2(metallicReflectanceMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(BUMP) && BUMPDIRECTUV == 0\nif (vBumpInfos.x == 0.)\n{\nvBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#ifdef CLEARCOAT\n#if defined(CLEARCOAT_TEXTURE) && CLEARCOAT_TEXTUREDIRECTUV == 0\nif (vClearCoatInfos.x == 0.)\n{\nvClearCoatUV=vec2(clearCoatMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvClearCoatUV=vec2(clearCoatMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV == 0\nif (vClearCoatInfos.z == 0.)\n{\nvClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvClearCoatRoughnessUV=vec2(clearCoatRoughnessMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(CLEARCOAT_BUMP) && CLEARCOAT_BUMPDIRECTUV == 0\nif (vClearCoatBumpInfos.x == 0.)\n{\nvClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvClearCoatBumpUV=vec2(clearCoatBumpMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(CLEARCOAT_TINT_TEXTURE) && CLEARCOAT_TINT_TEXTUREDIRECTUV == 0\nif (vClearCoatTintInfos.x == 0.)\n{\nvClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvClearCoatTintUV=vec2(clearCoatTintMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#endif\n#ifdef SHEEN\n#if defined(SHEEN_TEXTURE) && SHEEN_TEXTUREDIRECTUV == 0\nif (vSheenInfos.x == 0.)\n{\nvSheenUV=vec2(sheenMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvSheenUV=vec2(sheenMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#if defined(SHEEN_TEXTURE_ROUGHNESS) && SHEEN_TEXTURE_ROUGHNESSDIRECTUV == 0\nif (vSheenInfos.z == 0.)\n{\nvSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvSheenRoughnessUV=vec2(sheenRoughnessMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#endif\n#ifdef ANISOTROPIC\n#if defined(ANISOTROPIC_TEXTURE) && ANISOTROPIC_TEXTUREDIRECTUV == 0\nif (vAnisotropyInfos.x == 0.)\n{\nvAnisotropyUV=vec2(anisotropyMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvAnisotropyUV=vec2(anisotropyMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#endif\n#ifdef SUBSURFACE\n#if defined(SS_THICKNESSANDMASK_TEXTURE) && SS_THICKNESSANDMASK_TEXTUREDIRECTUV == 0\nif (vThicknessInfos.x == 0.)\n{\nvThicknessUV=vec2(thicknessMatrix*vec4(uvUpdated,1.0,0.0));\n}\nelse\n{\nvThicknessUV=vec2(thicknessMatrix*vec4(uv2,1.0,0.0));\n}\n#endif\n#endif\n\n#include<bumpVertex>\n\n#include<clipPlaneVertex>\n\n#include<fogVertex>\n\n#include<shadowsVertex>[0..maxSimultaneousLights]\n\n#ifdef VERTEXCOLOR\nvColor=color;\n#endif\n\n#ifdef POINTSIZE\ngl_PointSize=pointSize;\n#endif\n\n#include<logDepthVertex>\n#define CUSTOM_VERTEX_MAIN_END\n}";var Dt={effect:null,subMesh:null},Ft=function(e){function n(){var n=e.call(this)||this;return n.PBR=!0,n.NUM_SAMPLES="0",n.REALTIME_FILTERING=!1,n.MAINUV1=!1,n.MAINUV2=!1,n.UV1=!1,n.UV2=!1,n.ALBEDO=!1,n.GAMMAALBEDO=!1,n.ALBEDODIRECTUV=0,n.VERTEXCOLOR=!1,n.DETAIL=!1,n.DETAILDIRECTUV=0,n.DETAIL_NORMALBLENDMETHOD=0,n.AMBIENT=!1,n.AMBIENTDIRECTUV=0,n.AMBIENTINGRAYSCALE=!1,n.OPACITY=!1,n.VERTEXALPHA=!1,n.OPACITYDIRECTUV=0,n.OPACITYRGB=!1,n.ALPHATEST=!1,n.DEPTHPREPASS=!1,n.ALPHABLEND=!1,n.ALPHAFROMALBEDO=!1,n.ALPHATESTVALUE="0.5",n.SPECULAROVERALPHA=!1,n.RADIANCEOVERALPHA=!1,n.ALPHAFRESNEL=!1,n.LINEARALPHAFRESNEL=!1,n.PREMULTIPLYALPHA=!1,n.EMISSIVE=!1,n.EMISSIVEDIRECTUV=0,n.REFLECTIVITY=!1,n.REFLECTIVITYDIRECTUV=0,n.SPECULARTERM=!1,n.MICROSURFACEFROMREFLECTIVITYMAP=!1,n.MICROSURFACEAUTOMATIC=!1,n.LODBASEDMICROSFURACE=!1,n.MICROSURFACEMAP=!1,n.MICROSURFACEMAPDIRECTUV=0,n.METALLICWORKFLOW=!1,n.ROUGHNESSSTOREINMETALMAPALPHA=!1,n.ROUGHNESSSTOREINMETALMAPGREEN=!1,n.METALLNESSSTOREINMETALMAPBLUE=!1,n.AOSTOREINMETALMAPRED=!1,n.METALLIC_REFLECTANCE=!1,n.METALLIC_REFLECTANCEDIRECTUV=0,n.ENVIRONMENTBRDF=!1,n.ENVIRONMENTBRDF_RGBD=!1,n.NORMAL=!1,n.TANGENT=!1,n.BUMP=!1,n.BUMPDIRECTUV=0,n.OBJECTSPACE_NORMALMAP=!1,n.PARALLAX=!1,n.PARALLAXOCCLUSION=!1,n.NORMALXYSCALE=!0,n.LIGHTMAP=!1,n.LIGHTMAPDIRECTUV=0,n.USELIGHTMAPASSHADOWMAP=!1,n.GAMMALIGHTMAP=!1,n.RGBDLIGHTMAP=!1,n.REFLECTION=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.USESPHERICALFROMREFLECTIONMAP=!1,n.USEIRRADIANCEMAP=!1,n.SPHERICAL_HARMONICS=!1,n.USESPHERICALINVERTEX=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1,n.LINEARSPECULARREFLECTION=!1,n.RADIANCEOCCLUSION=!1,n.HORIZONOCCLUSION=!1,n.INSTANCES=!1,n.THIN_INSTANCES=!1,n.PREPASS=!1,n.PREPASS_IRRADIANCE=!1,n.PREPASS_IRRADIANCE_INDEX=-1,n.PREPASS_ALBEDO=!1,n.PREPASS_ALBEDO_INDEX=-1,n.PREPASS_DEPTHNORMAL=!1,n.PREPASS_DEPTHNORMAL_INDEX=-1,n.PREPASS_POSITION=!1,n.PREPASS_POSITION_INDEX=-1,n.PREPASS_VELOCITY=!1,n.PREPASS_VELOCITY_INDEX=-1,n.PREPASS_REFLECTIVITY=!1,n.PREPASS_REFLECTIVITY_INDEX=-1,n.SCENE_MRT_COUNT=0,n.NUM_BONE_INFLUENCERS=0,n.BonesPerMesh=0,n.BONETEXTURE=!1,n.BONES_VELOCITY_ENABLED=!1,n.NONUNIFORMSCALING=!1,n.MORPHTARGETS=!1,n.MORPHTARGETS_NORMAL=!1,n.MORPHTARGETS_TANGENT=!1,n.MORPHTARGETS_UV=!1,n.NUM_MORPH_INFLUENCERS=0,n.IMAGEPROCESSING=!1,n.VIGNETTE=!1,n.VIGNETTEBLENDMODEMULTIPLY=!1,n.VIGNETTEBLENDMODEOPAQUE=!1,n.TONEMAPPING=!1,n.TONEMAPPING_ACES=!1,n.CONTRAST=!1,n.COLORCURVES=!1,n.COLORGRADING=!1,n.COLORGRADING3D=!1,n.SAMPLER3DGREENDEPTH=!1,n.SAMPLER3DBGRMAP=!1,n.IMAGEPROCESSINGPOSTPROCESS=!1,n.EXPOSURE=!1,n.MULTIVIEW=!1,n.USEPHYSICALLIGHTFALLOFF=!1,n.USEGLTFLIGHTFALLOFF=!1,n.TWOSIDEDLIGHTING=!1,n.SHADOWFLOAT=!1,n.CLIPPLANE=!1,n.CLIPPLANE2=!1,n.CLIPPLANE3=!1,n.CLIPPLANE4=!1,n.CLIPPLANE5=!1,n.CLIPPLANE6=!1,n.POINTSIZE=!1,n.FOG=!1,n.LOGARITHMICDEPTH=!1,n.FORCENORMALFORWARD=!1,n.SPECULARAA=!1,n.CLEARCOAT=!1,n.CLEARCOAT_DEFAULTIOR=!1,n.CLEARCOAT_TEXTURE=!1,n.CLEARCOAT_TEXTURE_ROUGHNESS=!1,n.CLEARCOAT_TEXTUREDIRECTUV=0,n.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,n.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,n.CLEARCOAT_BUMP=!1,n.CLEARCOAT_BUMPDIRECTUV=0,n.CLEARCOAT_REMAP_F0=!0,n.CLEARCOAT_TINT=!1,n.CLEARCOAT_TINT_TEXTURE=!1,n.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,n.ANISOTROPIC=!1,n.ANISOTROPIC_TEXTURE=!1,n.ANISOTROPIC_TEXTUREDIRECTUV=0,n.BRDF_V_HEIGHT_CORRELATED=!1,n.MS_BRDF_ENERGY_CONSERVATION=!1,n.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1,n.SHEEN=!1,n.SHEEN_TEXTURE=!1,n.SHEEN_TEXTURE_ROUGHNESS=!1,n.SHEEN_TEXTUREDIRECTUV=0,n.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,n.SHEEN_LINKWITHALBEDO=!1,n.SHEEN_ROUGHNESS=!1,n.SHEEN_ALBEDOSCALING=!1,n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,n.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,n.SUBSURFACE=!1,n.SS_REFRACTION=!1,n.SS_TRANSLUCENCY=!1,n.SS_SCATTERING=!1,n.SS_THICKNESSANDMASK_TEXTURE=!1,n.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,n.SS_REFRACTIONMAP_3D=!1,n.SS_REFRACTIONMAP_OPPOSITEZ=!1,n.SS_LODINREFRACTIONALPHA=!1,n.SS_GAMMAREFRACTION=!1,n.SS_RGBDREFRACTION=!1,n.SS_LINEARSPECULARREFRACTION=!1,n.SS_LINKREFRACTIONTOTRANSPARENCY=!1,n.SS_ALBEDOFORREFRACTIONTINT=!1,n.SS_MASK_FROM_THICKNESS_TEXTURE=!1,n.SS_MASK_FROM_THICKNESS_TEXTURE_GLTF=!1,n.UNLIT=!1,n.DEBUGMODE=0,n.rebuild(),n}return l(n,e),n.prototype.reset=function(){e.prototype.reset.call(this),this.ALPHATESTVALUE="0.5",this.PBR=!0},n}(ae),Ut=function(e){function t(n,i){var r=e.call(this,n,i)||this;return r._directIntensity=1,r._emissiveIntensity=1,r._environmentIntensity=1,r._specularIntensity=1,r._lightingInfos=new V(r._directIntensity,r._emissiveIntensity,r._environmentIntensity,r._specularIntensity),r._disableBumpMap=!1,r._albedoTexture=null,r._ambientTexture=null,r._ambientTextureStrength=1,r._ambientTextureImpactOnAnalyticalLights=t.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,r._opacityTexture=null,r._reflectionTexture=null,r._emissiveTexture=null,r._reflectivityTexture=null,r._metallicTexture=null,r._metallic=null,r._roughness=null,r._metallicF0Factor=1,r._metallicReflectanceColor=w.White(),r._metallicReflectanceTexture=null,r._microSurfaceTexture=null,r._bumpTexture=null,r._lightmapTexture=null,r._ambientColor=new w(0,0,0),r._albedoColor=new w(1,1,1),r._reflectivityColor=new w(1,1,1),r._reflectionColor=new w(1,1,1),r._emissiveColor=new w(0,0,0),r._microSurface=.9,r._useLightmapAsShadowmap=!1,r._useHorizonOcclusion=!0,r._useRadianceOcclusion=!0,r._useAlphaFromAlbedoTexture=!1,r._useSpecularOverAlpha=!0,r._useMicroSurfaceFromReflectivityMapAlpha=!1,r._useRoughnessFromMetallicTextureAlpha=!0,r._useRoughnessFromMetallicTextureGreen=!1,r._useMetallnessFromMetallicTextureBlue=!1,r._useAmbientOcclusionFromMetallicTextureRed=!1,r._useAmbientInGrayScale=!1,r._useAutoMicroSurfaceFromReflectivityMap=!1,r._lightFalloff=t.LIGHTFALLOFF_PHYSICAL,r._useRadianceOverAlpha=!0,r._useObjectSpaceNormalMap=!1,r._useParallax=!1,r._useParallaxOcclusion=!1,r._parallaxScaleBias=.05,r._disableLighting=!1,r._maxSimultaneousLights=4,r._invertNormalMapX=!1,r._invertNormalMapY=!1,r._twoSidedLighting=!1,r._alphaCutOff=.4,r._forceAlphaTest=!1,r._useAlphaFresnel=!1,r._useLinearAlphaFresnel=!1,r._environmentBRDFTexture=null,r._forceIrradianceInFragment=!1,r._realTimeFiltering=!1,r._realTimeFilteringQuality=8,r._forceNormalForward=!1,r._enableSpecularAntiAliasing=!1,r._imageProcessingObserver=null,r._renderTargets=new fe(16),r._globalAmbientColor=new w(0,0,0),r._useLogarithmicDepth=!1,r._unlit=!1,r._debugMode=0,r.debugMode=0,r.debugLimit=-1,r.debugFactor=1,r.clearCoat=new Tt(r._markAllSubMeshesAsTexturesDirty.bind(r)),r.anisotropy=new yt(r._markAllSubMeshesAsTexturesDirty.bind(r)),r.brdf=new Rt(r._markAllSubMeshesAsMiscDirty.bind(r)),r.sheen=new Ct(r._markAllSubMeshesAsTexturesDirty.bind(r)),r.detailMap=new xe(r._markAllSubMeshesAsTexturesDirty.bind(r)),r._rebuildInParallel=!1,r._attachImageProcessingConfiguration(null),r.getRenderTargetTextures=function(){return r._renderTargets.reset(),Oe.ReflectionTextureEnabled&&r._reflectionTexture&&r._reflectionTexture.isRenderTarget&&r._renderTargets.push(r._reflectionTexture),r.subSurface.fillRenderTargetTextures(r._renderTargets),r._renderTargets},r._environmentBRDFTexture=Et.GetEnvironmentBRDFTexture(i),r.subSurface=new bt(r._markAllSubMeshesAsTexturesDirty.bind(r),r._markScenePrePassDirty.bind(r),i),r.prePassConfiguration=new Le,r}return l(t,e),Object.defineProperty(t.prototype,"realTimeFiltering",{get:function(){return this._realTimeFiltering},set:function(e){this._realTimeFiltering=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"realTimeFilteringQuality",{get:function(){return this._realTimeFilteringQuality},set:function(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"canRenderToMRT",{get:function(){return!0},enumerable:!1,configurable:!0}),t.prototype._attachImageProcessingConfiguration=function(e){var n=this;e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration=e||this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add((function(){n._markAllSubMeshesAsImageProcessingDirty()}))))},Object.defineProperty(t.prototype,"hasRenderTargetTextures",{get:function(){return!!(Oe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget)||this.subSurface.hasRenderTargetTextures()},enumerable:!1,configurable:!0}),t.prototype.getClassName=function(){return"PBRBaseMaterial"},Object.defineProperty(t.prototype,"useLogarithmicDepth",{get:function(){return this._useLogarithmicDepth},set:function(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"_disableAlphaBlending",{get:function(){return this.subSurface.disableAlphaBlending||this._transparencyMode===t.PBRMATERIAL_OPAQUE||this._transparencyMode===t.PBRMATERIAL_ALPHATEST},enumerable:!1,configurable:!0}),t.prototype.needAlphaBlending=function(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())},t.prototype.needAlphaTesting=function(){return!!this._forceAlphaTest||!this.subSurface.disableAlphaBlending&&(this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===t.PBRMATERIAL_ALPHATEST))},t.prototype._shouldUseAlphaFromAlbedoTexture=function(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==t.PBRMATERIAL_OPAQUE},t.prototype._hasAlphaChannel=function(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture},t.prototype.getAlphaTestTexture=function(){return this._albedoTexture},t.prototype.isReadyForSubMesh=function(e,t,i){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady)return!0;t._materialDefines||(t._materialDefines=new Ft);var r=t._materialDefines;if(this._isReadyForSubMesh(t))return!0;var o=this.getScene(),a=o.getEngine();if(r._areTexturesDirty&&o.texturesEnabled){if(this._albedoTexture&&Oe.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking())return!1;if(this._ambientTexture&&Oe.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking())return!1;if(this._opacityTexture&&Oe.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;var s=this._getReflectionTexture();if(s&&Oe.ReflectionTextureEnabled){if(!s.isReadyOrNotBlocking())return!1;if(s.irradianceTexture&&!s.irradianceTexture.isReadyOrNotBlocking())return!1}if(this._lightmapTexture&&Oe.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking())return!1;if(this._emissiveTexture&&Oe.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(Oe.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking())return!1;if(this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&Oe.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady())return!1;if(this._environmentBRDFTexture&&Oe.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(!(this.subSurface.isReadyForSubMesh(r,o)&&this.clearCoat.isReadyForSubMesh(r,o,a,this._disableBumpMap)&&this.sheen.isReadyForSubMesh(r,o)&&this.anisotropy.isReadyForSubMesh(r,o)&&this.detailMap.isReadyForSubMesh(r,o)))return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;a.getCaps().standardDerivatives||e.isVerticesDataPresent(F.NormalKind)||(e.createNormals(!0),n.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));var l=t.effect,c=r._areLightsDisposed,f=this._prepareEffect(e,r,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances);if(f)if(this._onEffectCreatedObservable&&(Dt.effect=f,Dt.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Dt)),this.allowShaderHotSwapping&&l&&!f.isReady()){if(f=l,this._rebuildInParallel=!0,r.markAsUnprocessed(),c)return r._areLightsDisposed=!0,!1}else this._rebuildInParallel=!1,o.resetCachedMaterial(),t.setEffect(f,r),this.buildUniformLayout();return!(!t.effect||!t.effect.isReady())&&(r._renderId=o.getRenderId(),t.effect._wasPreviouslyReady=!0,!0)},t.prototype.isMetallicWorkflow=function(){return!(null==this._metallic&&null==this._roughness&&!this._metallicTexture)},t.prototype._prepareEffect=function(e,n,t,i,r,o,a){if(void 0===t&&(t=null),void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=null),this._prepareDefines(e,n,r,o,a),!n.isDirty)return null;n.markAsProcessed();var s=this.getScene().getEngine(),l=new Te,c=0;n.USESPHERICALINVERTEX&&l.addFallback(c++,"USESPHERICALINVERTEX"),n.FOG&&l.addFallback(c,"FOG"),n.SPECULARAA&&l.addFallback(c,"SPECULARAA"),n.POINTSIZE&&l.addFallback(c,"POINTSIZE"),n.LOGARITHMICDEPTH&&l.addFallback(c,"LOGARITHMICDEPTH"),n.PARALLAX&&l.addFallback(c,"PARALLAX"),n.PARALLAXOCCLUSION&&l.addFallback(c++,"PARALLAXOCCLUSION"),c=yt.AddFallbacks(n,l,c),c=yt.AddFallbacks(n,l,c),c=bt.AddFallbacks(n,l,c),c=Ct.AddFallbacks(n,l,c),n.ENVIRONMENTBRDF&&l.addFallback(c++,"ENVIRONMENTBRDF"),n.TANGENT&&l.addFallback(c++,"TANGENT"),n.BUMP&&l.addFallback(c++,"BUMP"),c=Ee.HandleFallbacksForShadows(n,l,this._maxSimultaneousLights,c++),n.SPECULARTERM&&l.addFallback(c++,"SPECULARTERM"),n.USESPHERICALFROMREFLECTIONMAP&&l.addFallback(c++,"USESPHERICALFROMREFLECTIONMAP"),n.USEIRRADIANCEMAP&&l.addFallback(c++,"USEIRRADIANCEMAP"),n.LIGHTMAP&&l.addFallback(c++,"LIGHTMAP"),n.NORMAL&&l.addFallback(c++,"NORMAL"),n.AMBIENT&&l.addFallback(c++,"AMBIENT"),n.EMISSIVE&&l.addFallback(c++,"EMISSIVE"),n.VERTEXCOLOR&&l.addFallback(c++,"VERTEXCOLOR"),n.MORPHTARGETS&&l.addFallback(c++,"MORPHTARGETS"),n.MULTIVIEW&&l.addFallback(0,"MULTIVIEW");var f=[F.PositionKind];n.NORMAL&&f.push(F.NormalKind),n.TANGENT&&f.push(F.TangentKind),n.UV1&&f.push(F.UVKind),n.UV2&&f.push(F.UV2Kind),n.VERTEXCOLOR&&f.push(F.ColorKind),Ee.PrepareAttributesForBones(f,e,n,l),Ee.PrepareAttributesForInstances(f,n),Ee.PrepareAttributesForMorphTargets(f,e,n);var u="pbr",d=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode"],h=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler"],p=["Material","Scene"];xe.AddUniforms(d),xe.AddSamplers(h),bt.AddUniforms(d),bt.AddSamplers(h),Tt.AddUniforms(d),Tt.AddSamplers(h),yt.AddUniforms(d),yt.AddSamplers(h),Ct.AddUniforms(d),Ct.AddSamplers(h),Le.AddUniforms(d),Le.AddSamplers(d),se&&(se.PrepareUniforms(d,n),se.PrepareSamplers(h,n)),Ee.PrepareUniformsAndSamplersList({uniformsNames:d,uniformBuffersNames:p,samplers:h,defines:n,maxSimultaneousLights:this._maxSimultaneousLights});var m={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,d,p,h,n,f,m));var _=n.toString();return s.createEffect(u,{attributes:f,uniformsNames:d,uniformBuffersNames:p,samplers:h,defines:_,fallbacks:l,onCompiled:t,onError:i,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},processFinalCode:m.processFinalCode,multiTarget:n.PREPASS},s)},t.prototype._prepareDefines=function(e,n,i,r,o){void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=!1);var a=this.getScene(),s=a.getEngine();if(Ee.PrepareDefinesForLights(a,e,n,!0,this._maxSimultaneousLights,this._disableLighting),n._needNormals=!0,Ee.PrepareDefinesForMultiview(a,n),Ee.PrepareDefinesForPrePass(a,n,this.canRenderToMRT),n.METALLICWORKFLOW=this.isMetallicWorkflow(),n._areTexturesDirty){if(n._needUVs=!1,a.texturesEnabled){a.getEngine().getCaps().textureLOD&&(n.LODBASEDMICROSFURACE=!0),this._albedoTexture&&Oe.DiffuseTextureEnabled?(Ee.PrepareDefinesForMergedUV(this._albedoTexture,n,"ALBEDO"),n.GAMMAALBEDO=this._albedoTexture.gammaSpace):n.ALBEDO=!1,this._ambientTexture&&Oe.AmbientTextureEnabled?(Ee.PrepareDefinesForMergedUV(this._ambientTexture,n,"AMBIENT"),n.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):n.AMBIENT=!1,this._opacityTexture&&Oe.OpacityTextureEnabled?(Ee.PrepareDefinesForMergedUV(this._opacityTexture,n,"OPACITY"),n.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):n.OPACITY=!1;var l=this._getReflectionTexture();if(l&&Oe.ReflectionTextureEnabled){switch(n.REFLECTION=!0,n.GAMMAREFLECTION=l.gammaSpace,n.RGBDREFLECTION=l.isRGBD,n.REFLECTIONMAP_OPPOSITEZ=this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,n.LODINREFLECTIONALPHA=l.lodLevelInAlpha,n.LINEARSPECULARREFLECTION=l.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(n.NUM_SAMPLES=""+this.realTimeFilteringQuality,s.webGLVersion>1&&(n.NUM_SAMPLES=n.NUM_SAMPLES+"u"),n.REALTIME_FILTERING=!0):n.REALTIME_FILTERING=!1,l.coordinatesMode===ge.INVCUBIC_MODE&&(n.INVERTCUBICMAP=!0),n.REFLECTIONMAP_3D=l.isCube,n.REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,l.coordinatesMode){case ge.EXPLICIT_MODE:n.REFLECTIONMAP_EXPLICIT=!0;break;case ge.PLANAR_MODE:n.REFLECTIONMAP_PLANAR=!0;break;case ge.PROJECTION_MODE:n.REFLECTIONMAP_PROJECTION=!0;break;case ge.SKYBOX_MODE:n.REFLECTIONMAP_SKYBOX=!0;break;case ge.SPHERICAL_MODE:n.REFLECTIONMAP_SPHERICAL=!0;break;case ge.EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case ge.FIXED_EQUIRECTANGULAR_MODE:n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case ge.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case ge.CUBIC_MODE:case ge.INVCUBIC_MODE:default:n.REFLECTIONMAP_CUBIC=!0,n.USE_LOCAL_REFLECTIONMAP_CUBIC=!!l.boundingBoxSize}l.coordinatesMode!==ge.SKYBOX_MODE&&(l.irradianceTexture?(n.USEIRRADIANCEMAP=!0,n.USESPHERICALFROMREFLECTIONMAP=!1):l.isCube&&(n.USESPHERICALFROMREFLECTIONMAP=!0,n.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||a.getEngine().getCaps().maxVaryingVectors<=8?n.USESPHERICALINVERTEX=!1:n.USESPHERICALINVERTEX=!0))}else n.REFLECTION=!1,n.REFLECTIONMAP_3D=!1,n.REFLECTIONMAP_SPHERICAL=!1,n.REFLECTIONMAP_PLANAR=!1,n.REFLECTIONMAP_CUBIC=!1,n.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,n.REFLECTIONMAP_PROJECTION=!1,n.REFLECTIONMAP_SKYBOX=!1,n.REFLECTIONMAP_EXPLICIT=!1,n.REFLECTIONMAP_EQUIRECTANGULAR=!1,n.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,n.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,n.INVERTCUBICMAP=!1,n.USESPHERICALFROMREFLECTIONMAP=!1,n.USEIRRADIANCEMAP=!1,n.USESPHERICALINVERTEX=!1,n.REFLECTIONMAP_OPPOSITEZ=!1,n.LODINREFLECTIONALPHA=!1,n.GAMMAREFLECTION=!1,n.RGBDREFLECTION=!1,n.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&Oe.LightmapTextureEnabled?(Ee.PrepareDefinesForMergedUV(this._lightmapTexture,n,"LIGHTMAP"),n.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,n.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,n.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):n.LIGHTMAP=!1,this._emissiveTexture&&Oe.EmissiveTextureEnabled?Ee.PrepareDefinesForMergedUV(this._emissiveTexture,n,"EMISSIVE"):n.EMISSIVE=!1,Oe.SpecularTextureEnabled?(this._metallicTexture?(Ee.PrepareDefinesForMergedUV(this._metallicTexture,n,"REFLECTIVITY"),n.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,n.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,n.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,n.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed):this._reflectivityTexture?(Ee.PrepareDefinesForMergedUV(this._reflectivityTexture,n,"REFLECTIVITY"),n.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,n.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap):n.REFLECTIVITY=!1,this._metallicReflectanceTexture?Ee.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,n,"METALLIC_REFLECTANCE"):n.METALLIC_REFLECTANCE=!1,this._microSurfaceTexture?Ee.PrepareDefinesForMergedUV(this._microSurfaceTexture,n,"MICROSURFACEMAP"):n.MICROSURFACEMAP=!1):(n.REFLECTIVITY=!1,n.MICROSURFACEMAP=!1),a.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&Oe.BumpTextureEnabled&&!this._disableBumpMap?(Ee.PrepareDefinesForMergedUV(this._bumpTexture,n,"BUMP"),this._useParallax&&this._albedoTexture&&Oe.DiffuseTextureEnabled?(n.PARALLAX=!0,n.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):n.PARALLAX=!1,n.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):n.BUMP=!1,this._environmentBRDFTexture&&Oe.ReflectionTextureEnabled?(n.ENVIRONMENTBRDF=!0,n.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(n.ENVIRONMENTBRDF=!1,n.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?n.ALPHAFROMALBEDO=!0:n.ALPHAFROMALBEDO=!1}n.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===t.LIGHTFALLOFF_STANDARD?(n.USEPHYSICALLIGHTFALLOFF=!1,n.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===t.LIGHTFALLOFF_GLTF?(n.USEPHYSICALLIGHTFALLOFF=!1,n.USEGLTFLIGHTFALLOFF=!0):(n.USEPHYSICALLIGHTFALLOFF=!0,n.USEGLTFLIGHTFALLOFF=!1),n.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?n.TWOSIDEDLIGHTING=!0:n.TWOSIDEDLIGHTING=!1,n.SPECULARAA=a.getEngine().getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(n._areTexturesDirty||n._areMiscDirty)&&(n.ALPHATESTVALUE=this._alphaCutOff+(this._alphaCutOff%1==0?".":""),n.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,n.ALPHABLEND=this.needAlphaBlendingForMesh(e),n.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,n.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),n._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(n),n.FORCENORMALFORWARD=this._forceNormalForward,n.RADIANCEOCCLUSION=this._useRadianceOcclusion,n.HORIZONOCCLUSION=this._useHorizonOcclusion,n._areMiscDirty&&(Ee.PrepareDefinesForMisc(e,a,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,n),n.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(F.NormalKind),n.DEBUGMODE=this._debugMode),this.detailMap.prepareDefines(n,a),this.subSurface.prepareDefines(n,a),this.clearCoat.prepareDefines(n,a),this.anisotropy.prepareDefines(n,e,a),this.brdf.prepareDefines(n),this.sheen.prepareDefines(n,a),Ee.PrepareDefinesForFrameBoundValues(a,s,n,!!i,r,o),Ee.PrepareDefinesForAttributes(e,n,!0,!0,!0,this._transparencyMode!==t.PBRMATERIAL_OPAQUE)},t.prototype.forceCompilation=function(e,n,t){var i=this,r=B({clipPlane:!1,useInstances:!1},t),o=new Ft,a=this._prepareEffect(e,o,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Dt.effect=a,Dt.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Dt)),a.isReady()?n&&n(this):a.onCompileObservable.add((function(){n&&n(i)}))},t.prototype.buildUniformLayout=function(){var e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("visibility",1),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),Tt.PrepareUniformBuffer(e),yt.PrepareUniformBuffer(e),Ct.PrepareUniformBuffer(e),bt.PrepareUniformBuffer(e),xe.PrepareUniformBuffer(e),e.create()},t.prototype.unbind=function(){if(this._activeEffect){var n=!1;this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&(this._activeEffect.setTexture("reflection2DSampler",null),n=!0),this.subSurface.unbind(this._activeEffect)&&(n=!0),n&&this._markAllSubMeshesAsTexturesDirty()}e.prototype.unbind.call(this)},t.prototype.bindForSubMesh=function(e,n,t){var i=this.getScene(),r=t._materialDefines;if(r){var a=t.effect;if(a){this._activeEffect=a,r.INSTANCES&&!r.THIN_INSTANCES||this.bindOnlyWorldMatrix(e),this.prePassConfiguration.bindForSubMesh(this._activeEffect,i,n,e,this.isFrozen),r.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));var s=this._mustRebind(i,a,n.visibility);Ee.BindBonesParameters(n,this._activeEffect,this.prePassConfiguration);var l=null,c=this._uniformBuffer;if(s){var f=i.getEngine();if(c.bindToEffect(a,"Material"),this.bindViewProjection(a),l=this._getReflectionTexture(),!c.useUbo||!this.isFrozen||!c.isSync){if(i.texturesEnabled){if(this._albedoTexture&&Oe.DiffuseTextureEnabled&&(c.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),Ee.BindTextureMatrix(this._albedoTexture,c,"albedo")),this._ambientTexture&&Oe.AmbientTextureEnabled&&(c.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),Ee.BindTextureMatrix(this._ambientTexture,c,"ambient")),this._opacityTexture&&Oe.OpacityTextureEnabled&&(c.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),Ee.BindTextureMatrix(this._opacityTexture,c,"opacity")),l&&Oe.ReflectionTextureEnabled){if(c.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),c.updateFloat2("vReflectionInfos",l.level,0),l.boundingBoxSize){var u=l;c.updateVector3("vReflectionPosition",u.boundingBoxPosition),c.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this.realTimeFiltering){var d=l.getSize().width;c.updateFloat2("vReflectionFilteringInfo",d,re.Log2(d))}if(!r.USEIRRADIANCEMAP){var h=l.sphericalPolynomial;if(r.USESPHERICALFROMREFLECTIONMAP&&h)if(r.SPHERICAL_HARMONICS){var p=h.preScaledHarmonics;this._activeEffect.setVector3("vSphericalL00",p.l00),this._activeEffect.setVector3("vSphericalL1_1",p.l1_1),this._activeEffect.setVector3("vSphericalL10",p.l10),this._activeEffect.setVector3("vSphericalL11",p.l11),this._activeEffect.setVector3("vSphericalL2_2",p.l2_2),this._activeEffect.setVector3("vSphericalL2_1",p.l2_1),this._activeEffect.setVector3("vSphericalL20",p.l20),this._activeEffect.setVector3("vSphericalL21",p.l21),this._activeEffect.setVector3("vSphericalL22",p.l22)}else this._activeEffect.setFloat3("vSphericalX",h.x.x,h.x.y,h.x.z),this._activeEffect.setFloat3("vSphericalY",h.y.x,h.y.y,h.y.z),this._activeEffect.setFloat3("vSphericalZ",h.z.x,h.z.y,h.z.z),this._activeEffect.setFloat3("vSphericalXX_ZZ",h.xx.x-h.zz.x,h.xx.y-h.zz.y,h.xx.z-h.zz.z),this._activeEffect.setFloat3("vSphericalYY_ZZ",h.yy.x-h.zz.x,h.yy.y-h.zz.y,h.yy.z-h.zz.z),this._activeEffect.setFloat3("vSphericalZZ",h.zz.x,h.zz.y,h.zz.z),this._activeEffect.setFloat3("vSphericalXY",h.xy.x,h.xy.y,h.xy.z),this._activeEffect.setFloat3("vSphericalYZ",h.yz.x,h.yz.y,h.yz.z),this._activeEffect.setFloat3("vSphericalZX",h.zx.x,h.zx.y,h.zx.z)}c.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset)}this._emissiveTexture&&Oe.EmissiveTextureEnabled&&(c.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),Ee.BindTextureMatrix(this._emissiveTexture,c,"emissive")),this._lightmapTexture&&Oe.LightmapTextureEnabled&&(c.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),Ee.BindTextureMatrix(this._lightmapTexture,c,"lightmap")),Oe.SpecularTextureEnabled&&(this._metallicTexture?(c.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),Ee.BindTextureMatrix(this._metallicTexture,c,"reflectivity")):this._reflectivityTexture&&(c.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),Ee.BindTextureMatrix(this._reflectivityTexture,c,"reflectivity")),this._metallicReflectanceTexture&&(c.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),Ee.BindTextureMatrix(this._metallicReflectanceTexture,c,"metallicReflectance")),this._microSurfaceTexture&&(c.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),Ee.BindTextureMatrix(this._microSurfaceTexture,c,"microSurfaceSampler"))),this._bumpTexture&&f.getCaps().standardDerivatives&&Oe.BumpTextureEnabled&&!this._disableBumpMap&&(c.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),Ee.BindTextureMatrix(this._bumpTexture,c,"bump"),i._mirroredCameraPosition?c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):c.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&c.updateFloat("pointSize",this.pointSize),r.METALLICWORKFLOW){le.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,le.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,c.updateColor4("vReflectivityColor",le.Color3[0],1);var m=this.subSurface.indexOfRefraction,_=Math.pow((m-1)/(m+1),2);this._metallicReflectanceColor.scaleToRef(_*this._metallicF0Factor,le.Color3[0]);var v=this._metallicF0Factor;c.updateColor4("vMetallicReflectanceFactors",le.Color3[0],v)}else c.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);c.updateColor3("vEmissiveColor",Oe.EmissiveTextureEnabled?this._emissiveColor:w.BlackReadOnly),c.updateColor3("vReflectionColor",this._reflectionColor),!r.SS_REFRACTION&&this.subSurface.linkRefractionWithTransparency?c.updateColor4("vAlbedoColor",this._albedoColor,1):c.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*i.environmentIntensity,this._lightingInfos.w=this._specularIntensity,c.updateVector4("vLightingIntensity",this._lightingInfos)}c.updateFloat("visibility",n.visibility),i.texturesEnabled&&(this._albedoTexture&&Oe.DiffuseTextureEnabled&&c.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&Oe.AmbientTextureEnabled&&c.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&Oe.OpacityTextureEnabled&&c.setTexture("opacitySampler",this._opacityTexture),l&&Oe.ReflectionTextureEnabled&&(r.LODBASEDMICROSFURACE?c.setTexture("reflectionSampler",l):(c.setTexture("reflectionSampler",l._lodTextureMid||l),c.setTexture("reflectionSamplerLow",l._lodTextureLow||l),c.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)),r.USEIRRADIANCEMAP&&c.setTexture("irradianceSampler",l.irradianceTexture)),r.ENVIRONMENTBRDF&&c.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&Oe.EmissiveTextureEnabled&&c.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&Oe.LightmapTextureEnabled&&c.setTexture("lightmapSampler",this._lightmapTexture),Oe.SpecularTextureEnabled&&(this._metallicTexture?c.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&c.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&c.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._microSurfaceTexture&&c.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&f.getCaps().standardDerivatives&&Oe.BumpTextureEnabled&&!this._disableBumpMap&&c.setTexture("bumpSampler",this._bumpTexture)),this.detailMap.bindForSubMesh(c,i,this.isFrozen),this.subSurface.bindForSubMesh(c,i,f,this.isFrozen,r.LODBASEDMICROSFURACE,this.realTimeFiltering),this.clearCoat.bindForSubMesh(c,i,f,this._disableBumpMap,this.isFrozen,this._invertNormalMapX,this._invertNormalMapY,t),this.anisotropy.bindForSubMesh(c,i,this.isFrozen),this.sheen.bindForSubMesh(c,i,this.isFrozen,t),Ee.BindClipPlane(this._activeEffect,i),i.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor);var A=i._forcedViewPosition?i._forcedViewPosition:i._mirroredCameraPosition?i._mirroredCameraPosition:i.activeCamera.globalPosition,g=i.useRightHandedSystem===(null!=i._mirroredCameraPosition);a.setFloat4("vEyePosition",A.x,A.y,A.z,g?-1:1),a.setColor3("vAmbientColor",this._globalAmbientColor),a.setFloat2("vDebugMode",this.debugLimit,this.debugFactor)}!s&&this.isFrozen||(i.lightsEnabled&&!this._disableLighting&&Ee.BindLights(i,n,this._activeEffect,r,this._maxSimultaneousLights,this._rebuildInParallel),(i.fogEnabled&&n.applyFog&&i.fogMode!==o.FOGMODE_NONE||l)&&this.bindView(a),Ee.BindFogParameters(i,n,this._activeEffect,!0),r.NUM_MORPH_INFLUENCERS&&Ee.BindMorphTargetParameters(n,this._activeEffect),this._imageProcessingConfiguration.bind(this._activeEffect),Ee.BindLogDepth(r,this._activeEffect,i)),c.update(),this._afterBind(n,this._activeEffect)}}},t.prototype.getAnimatables=function(){var e=[];return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this.detailMap.getAnimatables(e),this.subSurface.getAnimatables(e),this.clearCoat.getAnimatables(e),this.sheen.getAnimatables(e),this.anisotropy.getAnimatables(e),e},t.prototype._getReflectionTexture=function(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture},t.prototype.getActiveTextures=function(){var n=e.prototype.getActiveTextures.call(this);return this._albedoTexture&&n.push(this._albedoTexture),this._ambientTexture&&n.push(this._ambientTexture),this._opacityTexture&&n.push(this._opacityTexture),this._reflectionTexture&&n.push(this._reflectionTexture),this._emissiveTexture&&n.push(this._emissiveTexture),this._reflectivityTexture&&n.push(this._reflectivityTexture),this._metallicTexture&&n.push(this._metallicTexture),this._metallicReflectanceTexture&&n.push(this._metallicReflectanceTexture),this._microSurfaceTexture&&n.push(this._microSurfaceTexture),this._bumpTexture&&n.push(this._bumpTexture),this._lightmapTexture&&n.push(this._lightmapTexture),this.detailMap.getActiveTextures(n),this.subSurface.getActiveTextures(n),this.clearCoat.getActiveTextures(n),this.sheen.getActiveTextures(n),this.anisotropy.getActiveTextures(n),n},t.prototype.hasTexture=function(n){return!!e.prototype.hasTexture.call(this,n)||(this._albedoTexture===n||(this._ambientTexture===n||(this._opacityTexture===n||(this._reflectionTexture===n||(this._reflectivityTexture===n||(this._metallicTexture===n||(this._metallicReflectanceTexture===n||(this._microSurfaceTexture===n||(this._bumpTexture===n||(this._lightmapTexture===n||(this.detailMap.hasTexture(n)||this.subSurface.hasTexture(n)||this.clearCoat.hasTexture(n)||this.sheen.hasTexture(n)||this.anisotropy.hasTexture(n))))))))))))},t.prototype.setPrePassRenderer=function(e){if(this.subSurface.isScatteringEnabled){var n=this.getScene().enableSubSurfaceForPrePass();return n&&(n.enabled=!0),!0}return!1},t.prototype.dispose=function(n,t){var i,r,o,a,s,l,c,f,u,d,h;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),null===(i=this._albedoTexture)||void 0===i||i.dispose(),null===(r=this._ambientTexture)||void 0===r||r.dispose(),null===(o=this._opacityTexture)||void 0===o||o.dispose(),null===(a=this._reflectionTexture)||void 0===a||a.dispose(),null===(s=this._emissiveTexture)||void 0===s||s.dispose(),null===(l=this._metallicTexture)||void 0===l||l.dispose(),null===(c=this._reflectivityTexture)||void 0===c||c.dispose(),null===(f=this._bumpTexture)||void 0===f||f.dispose(),null===(u=this._lightmapTexture)||void 0===u||u.dispose(),null===(d=this._metallicReflectanceTexture)||void 0===d||d.dispose(),null===(h=this._microSurfaceTexture)||void 0===h||h.dispose()),this.detailMap.dispose(t),this.subSurface.dispose(t),this.clearCoat.dispose(t),this.sheen.dispose(t),this.anisotropy.dispose(t),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e.prototype.dispose.call(this,n,t)},t.PBRMATERIAL_OPAQUE=H.MATERIAL_OPAQUE,t.PBRMATERIAL_ALPHATEST=H.MATERIAL_ALPHATEST,t.PBRMATERIAL_ALPHABLEND=H.MATERIAL_ALPHABLEND,t.PBRMATERIAL_ALPHATESTANDBLEND=H.MATERIAL_ALPHATESTANDBLEND,t.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,t.LIGHTFALLOFF_PHYSICAL=0,t.LIGHTFALLOFF_GLTF=1,t.LIGHTFALLOFF_STANDARD=2,d([ce()],t.prototype,"_imageProcessingConfiguration",void 0),d([ee("_markAllSubMeshesAsMiscDirty")],t.prototype,"debugMode",void 0),d([h()],t.prototype,"useLogarithmicDepth",null),t}(Pe),Bt=function(e){function n(t,i){var r=e.call(this,t,i)||this;return r.directIntensity=1,r.emissiveIntensity=1,r.environmentIntensity=1,r.specularIntensity=1,r.disableBumpMap=!1,r.ambientTextureStrength=1,r.ambientTextureImpactOnAnalyticalLights=n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,r.metallicF0Factor=1,r.metallicReflectanceColor=w.White(),r.ambientColor=new w(0,0,0),r.albedoColor=new w(1,1,1),r.reflectivityColor=new w(1,1,1),r.reflectionColor=new w(1,1,1),r.emissiveColor=new w(0,0,0),r.microSurface=1,r.useLightmapAsShadowmap=!1,r.useAlphaFromAlbedoTexture=!1,r.forceAlphaTest=!1,r.alphaCutOff=.4,r.useSpecularOverAlpha=!0,r.useMicroSurfaceFromReflectivityMapAlpha=!1,r.useRoughnessFromMetallicTextureAlpha=!0,r.useRoughnessFromMetallicTextureGreen=!1,r.useMetallnessFromMetallicTextureBlue=!1,r.useAmbientOcclusionFromMetallicTextureRed=!1,r.useAmbientInGrayScale=!1,r.useAutoMicroSurfaceFromReflectivityMap=!1,r.useRadianceOverAlpha=!0,r.useObjectSpaceNormalMap=!1,r.useParallax=!1,r.useParallaxOcclusion=!1,r.parallaxScaleBias=.05,r.disableLighting=!1,r.forceIrradianceInFragment=!1,r.maxSimultaneousLights=4,r.invertNormalMapX=!1,r.invertNormalMapY=!1,r.twoSidedLighting=!1,r.useAlphaFresnel=!1,r.useLinearAlphaFresnel=!1,r.environmentBRDFTexture=null,r.forceNormalForward=!1,r.enableSpecularAntiAliasing=!1,r.useHorizonOcclusion=!0,r.useRadianceOcclusion=!0,r.unlit=!1,r._environmentBRDFTexture=Et.GetEnvironmentBRDFTexture(i),r}return l(n,e),Object.defineProperty(n.prototype,"refractionTexture",{get:function(){return this.subSurface.refractionTexture},set:function(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"indexOfRefraction",{get:function(){return this.subSurface.indexOfRefraction},set:function(e){this.subSurface.indexOfRefraction=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"invertRefractionY",{get:function(){return this.subSurface.invertRefractionY},set:function(e){this.subSurface.invertRefractionY=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"linkRefractionWithTransparency",{get:function(){return this.subSurface.linkRefractionWithTransparency},set:function(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"usePhysicalLightFalloff",{get:function(){return this._lightFalloff===Ut.LIGHTFALLOFF_PHYSICAL},set:function(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Ut.LIGHTFALLOFF_PHYSICAL:Ut.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"useGLTFLightFalloff",{get:function(){return this._lightFalloff===Ut.LIGHTFALLOFF_GLTF},set:function(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),this._lightFalloff=e?Ut.LIGHTFALLOFF_GLTF:Ut.LIGHTFALLOFF_STANDARD)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"imageProcessingConfiguration",{get:function(){return this._imageProcessingConfiguration},set:function(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorCurvesEnabled",{get:function(){return this.imageProcessingConfiguration.colorCurvesEnabled},set:function(e){this.imageProcessingConfiguration.colorCurvesEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorGradingEnabled",{get:function(){return this.imageProcessingConfiguration.colorGradingEnabled},set:function(e){this.imageProcessingConfiguration.colorGradingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraToneMappingEnabled",{get:function(){return this._imageProcessingConfiguration.toneMappingEnabled},set:function(e){this._imageProcessingConfiguration.toneMappingEnabled=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraExposure",{get:function(){return this._imageProcessingConfiguration.exposure},set:function(e){this._imageProcessingConfiguration.exposure=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraContrast",{get:function(){return this._imageProcessingConfiguration.contrast},set:function(e){this._imageProcessingConfiguration.contrast=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorGradingTexture",{get:function(){return this._imageProcessingConfiguration.colorGradingTexture},set:function(e){this._imageProcessingConfiguration.colorGradingTexture=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"cameraColorCurves",{get:function(){return this._imageProcessingConfiguration.colorCurves},set:function(e){this._imageProcessingConfiguration.colorCurves=e},enumerable:!1,configurable:!0}),n.prototype.getClassName=function(){return"PBRMaterial"},n.prototype.clone=function(e){var t=this,i=U.Clone((function(){return new n(e,t.getScene())}),this);return i.id=e,i.name=e,this.clearCoat.copyTo(i.clearCoat),this.anisotropy.copyTo(i.anisotropy),this.brdf.copyTo(i.brdf),this.sheen.copyTo(i.sheen),this.subSurface.copyTo(i.subSurface),i},n.prototype.serialize=function(){var e=U.Serialize(this);return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e},n.Parse=function(e,t,i){var r=U.Parse((function(){return new n(e.name,t)}),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),r},n.PBRMATERIAL_OPAQUE=Ut.PBRMATERIAL_OPAQUE,n.PBRMATERIAL_ALPHATEST=Ut.PBRMATERIAL_ALPHATEST,n.PBRMATERIAL_ALPHABLEND=Ut.PBRMATERIAL_ALPHABLEND,n.PBRMATERIAL_ALPHATESTANDBLEND=Ut.PBRMATERIAL_ALPHATESTANDBLEND,n.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Ut.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"directIntensity",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveIntensity",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"environmentIntensity",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"specularIntensity",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"disableBumpMap",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"albedoTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTextureStrength",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"opacityTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectionTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectivityTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallic",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"roughness",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicF0Factor",void 0),d([te(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicReflectanceColor",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"metallicReflectanceTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"microSurfaceTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"bumpTexture",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty",null)],n.prototype,"lightmapTexture",void 0),d([te("ambient"),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"ambientColor",void 0),d([te("albedo"),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"albedoColor",void 0),d([te("reflectivity"),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectivityColor",void 0),d([te("reflection"),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"reflectionColor",void 0),d([te("emissive"),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"emissiveColor",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"microSurface",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useLightmapAsShadowmap",void 0),d([h(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"useAlphaFromAlbedoTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"forceAlphaTest",void 0),d([h(),ee("_markAllSubMeshesAsTexturesAndMiscDirty")],n.prototype,"alphaCutOff",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useSpecularOverAlpha",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRoughnessFromMetallicTextureGreen",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useMetallnessFromMetallicTextureBlue",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAmbientInGrayScale",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),d([h()],n.prototype,"usePhysicalLightFalloff",null),d([h()],n.prototype,"useGLTFLightFalloff",null),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRadianceOverAlpha",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useObjectSpaceNormalMap",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useParallax",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useParallaxOcclusion",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"parallaxScaleBias",void 0),d([h(),ee("_markAllSubMeshesAsLightsDirty")],n.prototype,"disableLighting",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"forceIrradianceInFragment",void 0),d([h(),ee("_markAllSubMeshesAsLightsDirty")],n.prototype,"maxSimultaneousLights",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"invertNormalMapX",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"invertNormalMapY",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"twoSidedLighting",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useAlphaFresnel",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useLinearAlphaFresnel",void 0),d([ne(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"environmentBRDFTexture",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"forceNormalForward",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"enableSpecularAntiAliasing",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useHorizonOcclusion",void 0),d([h(),ee("_markAllSubMeshesAsTexturesDirty")],n.prototype,"useRadianceOcclusion",void 0),d([h(),ee("_markAllSubMeshesAsMiscDirty")],n.prototype,"unlit",void 0),n}(Ut);X.RegisteredTypes["BABYLON.PBRMaterial"]=Bt;var wt=function(){function e(e,n,t){void 0===n&&(n=0),void 0===t&&(t=null),this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new a,this._onDataLayoutChanged=new a,this._animationPropertiesOverride=null,this._scene=t||s.LastCreatedScene,this.influence=n,this._scene&&(this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(e.prototype,"influence",{get:function(){return this._influence},set:function(e){if(this._influence!==e){var n=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===n||0===e)}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"animationPropertiesOverride",{get:function(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride},set:function(e){this._animationPropertiesOverride=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasPositions",{get:function(){return!!this._positions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasNormals",{get:function(){return!!this._normals},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasTangents",{get:function(){return!!this._tangents},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hasUVs",{get:function(){return!!this._uvs},enumerable:!1,configurable:!0}),e.prototype.setPositions=function(e){var n=this.hasPositions;this._positions=e,n!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)},e.prototype.getPositions=function(){return this._positions},e.prototype.setNormals=function(e){var n=this.hasNormals;this._normals=e,n!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)},e.prototype.getNormals=function(){return this._normals},e.prototype.setTangents=function(e){var n=this.hasTangents;this._tangents=e,n!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)},e.prototype.getTangents=function(){return this._tangents},e.prototype.setUVs=function(e){var n=this.hasUVs;this._uvs=e,n!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)},e.prototype.getUVs=function(){return this._uvs},e.prototype.clone=function(){var n=this,t=U.Clone((function(){return new e(n.name,n.influence,n._scene)}),this);return t._positions=this._positions,t._normals=this._normals,t._tangents=this._tangents,t._uvs=this._uvs,t},e.prototype.serialize=function(){var e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),U.AppendSerializedAnimations(this,e),e},e.prototype.getClassName=function(){return"MorphTarget"},e.Parse=function(n){var t=new e(n.name,n.influence);if(t.setPositions(n.positions),null!=n.id&&(t.id=n.id),n.normals&&t.setNormals(n.normals),n.tangents&&t.setTangents(n.tangents),n.uvs&&t.setUVs(n.uvs),n.animations)for(var i=0;i<n.animations.length;i++){var r=n.animations[i],o=X.GetClass("BABYLON.Animation");o&&t.animations.push(o.Parse(r))}return t},e.FromMesh=function(n,t,i){t||(t=n.name);var r=new e(t,i,n.getScene());return r.setPositions(n.getVerticesData(F.PositionKind)),n.isVerticesDataPresent(F.NormalKind)&&r.setNormals(n.getVerticesData(F.NormalKind)),n.isVerticesDataPresent(F.TangentKind)&&r.setTangents(n.getVerticesData(F.TangentKind)),n.isVerticesDataPresent(F.UVKind)&&r.setUVs(n.getVerticesData(F.UVKind)),r},d([h()],e.prototype,"id",void 0),e}(),Gt=function(){function e(e){void 0===e&&(e=null),this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new fe(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,e||(e=s.LastCreatedScene),this._scene=e,this._scene&&(this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId())}return Object.defineProperty(e.prototype,"uniqueId",{get:function(){return this._uniqueId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"vertexCount",{get:function(){return this._vertexCount},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsNormals",{get:function(){return this._supportsNormals&&this.enableNormalMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsTangents",{get:function(){return this._supportsTangents&&this.enableTangentMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"supportsUVs",{get:function(){return this._supportsUVs&&this.enableUVMorphing},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numTargets",{get:function(){return this._targets.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"numInfluencers",{get:function(){return this._activeTargets.length},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"influences",{get:function(){return this._influences},enumerable:!1,configurable:!0}),e.prototype.getActiveTarget=function(e){return this._activeTargets.data[e]},e.prototype.getTarget=function(e){return this._targets[e]},e.prototype.addTarget=function(e){var n=this;this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add((function(e){n._syncActiveTargets(e)}))),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add((function(){n._syncActiveTargets(!0)}))),this._syncActiveTargets(!0)},e.prototype.removeTarget=function(e){var n=this._targets.indexOf(e);n>=0&&(this._targets.splice(n,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(n,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(n,1)[0]),this._syncActiveTargets(!0))},e.prototype.clone=function(){for(var n=new e(this._scene),t=0,i=this._targets;t<i.length;t++){var r=i[t];n.addTarget(r.clone())}return n.enableNormalMorphing=this.enableNormalMorphing,n.enableTangentMorphing=this.enableTangentMorphing,n.enableUVMorphing=this.enableUVMorphing,n},e.prototype.serialize=function(){var e={};e.id=this.uniqueId,e.targets=[];for(var n=0,t=this._targets;n<t.length;n++){var i=t[n];e.targets.push(i.serialize())}return e},e.prototype._syncActiveTargets=function(e){var t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0;for(var i=0,r=this._targets;i<r.length;i++){var o=r[i];if(0!==o.influence){this._activeTargets.push(o),this._tempInfluences[t++]=o.influence,this._supportsNormals=this._supportsNormals&&o.hasNormals,this._supportsTangents=this._supportsTangents&&o.hasTangents,this._supportsUVs=this._supportsUVs&&o.hasUVs;var a=o.getPositions();if(a){var s=a.length/3;if(0===this._vertexCount)this._vertexCount=s;else if(this._vertexCount!==s)return void n.Error("Incompatible target. Targets must all have the same vertices count.")}}}this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(var l=0;l<t;l++)this._influences[l]=this._tempInfluences[l];e&&this.synchronize()},e.prototype.synchronize=function(){if(this._scene)for(var e=0,n=this._scene.meshes;e<n.length;e++){var t=n[e];t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()}},e.Parse=function(n,t){var i=new e(t);i._uniqueId=n.id;for(var r=0,o=n.targets;r<o.length;r++){var a=o[r];i.addTarget(wt.Parse(a))}return i},e}(),Vt=function(){function e(){}return e.Get=function(e,n,t){if(!n||null==t||!n[t])throw new Error(e+": Failed to find index ("+t+")");return n[t]},e.Assign=function(e){if(e)for(var n=0;n<e.length;n++)e[n].index=n},e}(),kt=function(){function e(e){this._completePromises=new Array,this._forAssetContainer=!1,this._babylonLights=[],this._disableInstancedMesh=0,this._disposed=!1,this._state=null,this._extensions=new Array,this._defaultBabylonMaterialData={},this._parent=e}return e.RegisterExtension=function(t,i){e.UnregisterExtension(t)&&n.Warn("Extension with the name '"+t+"' already exists"),e._RegisteredExtensions[t]={factory:i}},e.UnregisterExtension=function(n){return!!e._RegisteredExtensions[n]&&(delete e._RegisteredExtensions[n],!0)},Object.defineProperty(e.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"gltf",{get:function(){return this._gltf},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bin",{get:function(){return this._bin},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"babylonScene",{get:function(){return this._babylonScene},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rootBabylonMesh",{get:function(){return this._rootBabylonMesh},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){if(!this._disposed){for(var e in this._disposed=!0,this._completePromises.length=0,this._extensions){var n=this._extensions[e];n.dispose&&n.dispose(),delete this._extensions[e]}this._gltf=null,this._babylonScene=null,this._rootBabylonMesh=null,this._parent.dispose()}},e.prototype.importMeshAsync=function(e,n,t,i,r,o,a){var s=this;return Promise.resolve().then((function(){s._babylonScene=n,s._rootUrl=r,s._fileName=a||"scene",s._forAssetContainer=t,s._loadData(i);var o=null;if(e){var l={};if(s._gltf.nodes)for(var c=0,f=s._gltf.nodes;c<f.length;c++){var u=f[c];u.name&&(l[u.name]=u.index)}o=(e instanceof Array?e:[e]).map((function(e){var n=l[e];if(void 0===n)throw new Error("Failed to find node '"+e+"'");return n}))}return s._loadAsync(o,(function(){return{meshes:s._getMeshes(),particleSystems:[],skeletons:s._getSkeletons(),animationGroups:s._getAnimationGroups(),lights:s._babylonLights,transformNodes:s._getTransformNodes(),geometries:s._getGeometries()}}))}))},e.prototype.loadAsync=function(e,n,t,i,r){var o=this;return Promise.resolve().then((function(){return o._babylonScene=e,o._rootUrl=t,o._fileName=r||"scene",o._loadData(n),o._loadAsync(null,(function(){}))}))},e.prototype._loadAsync=function(e,n){var t=this;return Promise.resolve().then((function(){t._uniqueRootUrl=-1===t._rootUrl.indexOf("file:")&&t._fileName?t._rootUrl:""+t._rootUrl+Date.now()+"/",t._loadExtensions(),t._checkExtensions();var i=Qe[Qe.LOADING]+" => "+Qe[Qe.READY],o=Qe[Qe.LOADING]+" => "+Qe[Qe.COMPLETE];t._parent._startPerformanceCounter(i),t._parent._startPerformanceCounter(o),t._setState(Qe.LOADING),t._extensionsOnLoading();var a=new Array,s=t._babylonScene.blockMaterialDirtyMechanism;if(t._babylonScene.blockMaterialDirtyMechanism=!0,e)a.push(t.loadSceneAsync("/nodes",{nodes:e,index:-1}));else if(null!=t._gltf.scene||t._gltf.scenes&&t._gltf.scenes[0]){var l=Vt.Get("/scene",t._gltf.scenes,t._gltf.scene||0);a.push(t.loadSceneAsync("/scenes/"+l.index,l))}if(t.parent.loadAllMaterials&&t._gltf.materials)for(var c=0;c<t._gltf.materials.length;++c){var f=t._gltf.materials[c],u="/materials/"+c,d=H.TriangleFillMode;a.push(t._loadMaterialAsync(u,f,null,d,(function(e){})))}t._babylonScene.blockMaterialDirtyMechanism=s,t._parent.compileMaterials&&a.push(t._compileMaterialsAsync()),t._parent.compileShadowGenerators&&a.push(t._compileShadowGeneratorsAsync());var h=Promise.all(a).then((function(){return t._rootBabylonMesh&&t._rootBabylonMesh.setEnabled(!0),t._extensionsOnReady(),t._setState(Qe.READY),t._startAnimations(),n()}));return h.then((function(){t._parent._endPerformanceCounter(i),r.SetImmediate((function(){t._disposed||Promise.all(t._completePromises).then((function(){t._parent._endPerformanceCounter(o),t._setState(Qe.COMPLETE),t._parent.onCompleteObservable.notifyObservers(void 0),t._parent.onCompleteObservable.clear(),t.dispose()}),(function(e){t._parent.onErrorObservable.notifyObservers(e),t._parent.onErrorObservable.clear(),t.dispose()}))}))})),h})).catch((function(e){throw t._disposed||(t._parent.onErrorObservable.notifyObservers(e),t._parent.onErrorObservable.clear(),t.dispose()),e}))},e.prototype._loadData=function(e){if(this._gltf=e.json,this._setupData(),e.bin){var t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){var i=t[0];(i.byteLength<e.bin.byteLength-3||i.byteLength>e.bin.byteLength)&&n.Warn("Binary buffer length ("+i.byteLength+") from JSON does not match chunk length ("+e.bin.byteLength+")"),this._bin=e.bin}else n.Warn("Unexpected BIN chunk")}},e.prototype._setupData=function(){if(Vt.Assign(this._gltf.accessors),Vt.Assign(this._gltf.animations),Vt.Assign(this._gltf.buffers),Vt.Assign(this._gltf.bufferViews),Vt.Assign(this._gltf.cameras),Vt.Assign(this._gltf.images),Vt.Assign(this._gltf.materials),Vt.Assign(this._gltf.meshes),Vt.Assign(this._gltf.nodes),Vt.Assign(this._gltf.samplers),Vt.Assign(this._gltf.scenes),Vt.Assign(this._gltf.skins),Vt.Assign(this._gltf.textures),this._gltf.nodes){for(var e={},n=0,t=this._gltf.nodes;n<t.length;n++){if((l=t[n]).children)for(var i=0,r=l.children;i<r.length;i++){e[r[i]]=l.index}}for(var o=this._createRootNode(),a=0,s=this._gltf.nodes;a<s.length;a++){var l,c=e[(l=s[a]).index];l.parent=void 0===c?o:this._gltf.nodes[c]}}},e.prototype._loadExtensions=function(){for(var t in e._RegisteredExtensions){var i=e._RegisteredExtensions[t].factory(this);i.name!==t&&n.Warn("The name of the glTF loader extension instance does not match the registered name: "+i.name+" !== "+t),this._extensions.push(i),this._parent.onExtensionLoadedObservable.notifyObservers(i)}this._extensions.sort((function(e,n){return(e.order||Number.MAX_VALUE)-(n.order||Number.MAX_VALUE)})),this._parent.onExtensionLoadedObservable.clear()},e.prototype._checkExtensions=function(){if(this._gltf.extensionsRequired)for(var e=function(e){if(!n._extensions.some((function(n){return n.name===e&&n.enabled})))throw new Error("Require extension "+e+" is not available")},n=this,t=0,i=this._gltf.extensionsRequired;t<i.length;t++){e(i[t])}},e.prototype._setState=function(e){this._state=e,this.log(Qe[this._state])},e.prototype._createRootNode=function(){this._babylonScene._blockEntityCollection=this._forAssetContainer,this._rootBabylonMesh=new c("__root__",this._babylonScene),this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);var n={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Xe.AUTO:this._babylonScene.useRightHandedSystem||(n.rotation=[0,1,0,0],n.scale=[1,1,-1],e._LoadTransform(n,this._rootBabylonMesh));break;case Xe.FORCE_RIGHT_HANDED:this._babylonScene.useRightHandedSystem=!0;break;default:throw new Error("Invalid coordinate system mode ("+this._parent.coordinateSystemMode+")")}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),n},e.prototype.loadSceneAsync=function(e,n){var t=this,i=this._extensionsLoadSceneAsync(e,n);if(i)return i;var r=new Array;if(this.logOpen(e+" "+(n.name||"")),n.nodes)for(var o=0,a=n.nodes;o<a.length;o++){var s=a[o],l=Vt.Get(e+"/nodes/"+s,this._gltf.nodes,s);r.push(this.loadNodeAsync("/nodes/"+l.index,l,(function(e){e.parent=t._rootBabylonMesh})))}if(this._gltf.nodes)for(var c=0,f=this._gltf.nodes;c<f.length;c++){if((l=f[c])._babylonTransformNode&&l._babylonBones)for(var u=0,d=l._babylonBones;u<d.length;u++){d[u].linkTransformNode(l._babylonTransformNode)}}return r.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(r).then((function(){}))},e.prototype._forEachPrimitive=function(e,n){if(e._primitiveBabylonMeshes)for(var t=0,i=e._primitiveBabylonMeshes;t<i.length;t++){n(i[t])}},e.prototype._getGeometries=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var t=0,i=n;t<i.length;t++){var r=i[t];this._forEachPrimitive(r,(function(n){var t=n.geometry;t&&-1===e.indexOf(t)&&e.push(t)}))}return e},e.prototype._getMeshes=function(){var e=new Array;e.push(this._rootBabylonMesh);var n=this._gltf.nodes;if(n)for(var t=0,i=n;t<i.length;t++){var r=i[t];this._forEachPrimitive(r,(function(n){e.push(n)}))}return e},e.prototype._getTransformNodes=function(){var e=new Array,n=this._gltf.nodes;if(n)for(var t=0,i=n;t<i.length;t++){var r=i[t];r._babylonTransformNode&&"TransformNode"===r._babylonTransformNode.getClassName()&&e.push(r._babylonTransformNode)}return e},e.prototype._getSkeletons=function(){var e=new Array,n=this._gltf.skins;if(n)for(var t=0,i=n;t<i.length;t++){var r=i[t];r._data&&e.push(r._data.babylonSkeleton)}return e},e.prototype._getAnimationGroups=function(){var e=new Array,n=this._gltf.animations;if(n)for(var t=0,i=n;t<i.length;t++){var r=i[t];r._babylonAnimationGroup&&e.push(r._babylonAnimationGroup)}return e},e.prototype._startAnimations=function(){switch(this._parent.animationStartMode){case ze.NONE:break;case ze.FIRST:0!==(e=this._getAnimationGroups()).length&&e[0].start(!0);break;case ze.ALL:for(var e,t=0,i=e=this._getAnimationGroups();t<i.length;t++){i[t].start(!0)}break;default:return void n.Error("Invalid animation start mode ("+this._parent.animationStartMode+")")}},e.prototype.loadNodeAsync=function(n,t,i){var r=this;void 0===i&&(i=function(){});var o=this._extensionsLoadNodeAsync(n,t,i);if(o)return o;if(t._babylonTransformNode)throw new Error(n+": Invalid recursive node hierarchy");var a=new Array;this.logOpen(n+" "+(t.name||""));var s=function(o){if(e.AddPointerMetadata(o,n),e._LoadTransform(t,o),null!=t.camera){var s=Vt.Get(n+"/camera",r._gltf.cameras,t.camera);a.push(r.loadCameraAsync("/cameras/"+s.index,s,(function(e){e.parent=o})))}if(t.children)for(var l=0,c=t.children;l<c.length;l++){var f=c[l],u=Vt.Get(n+"/children/"+f,r._gltf.nodes,f);a.push(r.loadNodeAsync("/nodes/"+u.index,u,(function(e){e.parent=o})))}i(o)};if(null==t.mesh){var l=t.name||"node"+t.index;this._babylonScene._blockEntityCollection=this._forAssetContainer,t._babylonTransformNode=new ue(l,this._babylonScene),this._babylonScene._blockEntityCollection=!1,s(t._babylonTransformNode)}else{var c=Vt.Get(n+"/mesh",this._gltf.meshes,t.mesh);a.push(this._loadMeshAsync("/meshes/"+c.index,t,c,s))}return this.logClose(),Promise.all(a).then((function(){return r._forEachPrimitive(t,(function(e){e.geometry&&e.geometry.useBoundingInfoFromGeometry?e._updateBoundingInfo():e.refreshBoundingInfo(!0)})),t._babylonTransformNode}))},e.prototype._loadMeshAsync=function(e,n,t,i){var r=t.primitives;if(!r||!r.length)throw new Error(e+": Primitives are missing");null==r[0].index&&Vt.Assign(r);var o=new Array;this.logOpen(e+" "+(t.name||""));var a=n.name||"node"+n.index;if(1===r.length){var s=t.primitives[0];o.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+s.index,a,n,t,s,(function(e){n._babylonTransformNode=e,n._primitiveBabylonMeshes=[e]})))}else{this._babylonScene._blockEntityCollection=this._forAssetContainer,n._babylonTransformNode=new ue(a,this._babylonScene),this._babylonScene._blockEntityCollection=!1,n._primitiveBabylonMeshes=[];for(var l=0,c=r;l<c.length;l++){s=c[l];o.push(this._loadMeshPrimitiveAsync(e+"/primitives/"+s.index,a+"_primitive"+s.index,n,t,s,(function(e){e.parent=n._babylonTransformNode,n._primitiveBabylonMeshes.push(e)})))}}if(null!=n.skin){var f=Vt.Get(e+"/skin",this._gltf.skins,n.skin);o.push(this._loadSkinAsync("/skins/"+f.index,n,f))}return i(n._babylonTransformNode),this.logClose(),Promise.all(o).then((function(){return n._babylonTransformNode}))},e.prototype._loadMeshPrimitiveAsync=function(n,t,i,r,o,a){var s=this,l=this._extensionsLoadMeshPrimitiveAsync(n,t,i,r,o,a);if(l)return l;this.logOpen(""+n);var f,u,d=0===this._disableInstancedMesh&&this._parent.createInstances&&null==i.skin&&!r.primitives[0].targets;if(d&&o._instanceData)f=o._instanceData.babylonSourceMesh.createInstance(t),u=o._instanceData.promise;else{var h=new Array;this._babylonScene._blockEntityCollection=this._forAssetContainer;var p=new c(t,this._babylonScene);this._babylonScene._blockEntityCollection=!1,p.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?H.CounterClockWiseSideOrientation:H.ClockWiseSideOrientation,this._createMorphTargets(n,i,r,o,p),h.push(this._loadVertexDataAsync(n,o,p).then((function(e){return s._loadMorphTargetsAsync(n,o,p,e).then((function(){s._babylonScene._blockEntityCollection=s._forAssetContainer,e.applyToMesh(p),s._babylonScene._blockEntityCollection=!1}))})));var m=e._GetDrawMode(n,o.mode);if(null==o.material){var _=this._defaultBabylonMaterialData[m];_||(_=this._createDefaultMaterial("__GLTFLoader._default",m),this._parent.onMaterialLoadedObservable.notifyObservers(_),this._defaultBabylonMaterialData[m]=_),p.material=_}else{var v=Vt.Get(n+"/material",this._gltf.materials,o.material);h.push(this._loadMaterialAsync("/materials/"+v.index,v,p,m,(function(e){p.material=e})))}u=Promise.all(h),d&&(o._instanceData={babylonSourceMesh:p,promise:u}),f=p}return e.AddPointerMetadata(f,n),this._parent.onMeshLoadedObservable.notifyObservers(f),a(f),this.logClose(),u.then((function(){return f}))},e.prototype._loadVertexDataAsync=function(e,n,t){var i=this,r=this._extensionsLoadVertexDataAsync(e,n,t);if(r)return r;var o=n.attributes;if(!o)throw new Error(e+": Attributes are missing");var a=new Array,s=new K(t.name,this._babylonScene);if(null==n.indices)t.isUnIndexed=!0;else{var l=Vt.Get(e+"/indices",this._gltf.accessors,n.indices);a.push(this._loadIndicesAccessorAsync("/accessors/"+l.index,l).then((function(e){s.setIndices(e)})))}var c=function(n,r,l){if(null!=o[n]){t._delayInfo=t._delayInfo||[],-1===t._delayInfo.indexOf(r)&&t._delayInfo.push(r);var c=Vt.Get(e+"/attributes/"+n,i._gltf.accessors,o[n]);a.push(i._loadVertexAccessorAsync("/accessors/"+c.index,c,r).then((function(e){if(e.getKind()===F.PositionKind&&!i.parent.alwaysComputeBoundingBox&&!t.skeleton){var n=c.min,r=c.max;if(void 0!==n&&void 0!==r){var o=P.Vector3[0],a=P.Vector3[1];o.copyFromFloats.apply(o,n),a.copyFromFloats.apply(a,r),s._boundingInfo=new pe(o,a),s.useBoundingInfoFromGeometry=!0}}s.setVerticesBuffer(e,c.count)}))),r==F.MatricesIndicesExtraKind&&(t.numBoneInfluencers=8),l&&l(c)}};return c("POSITION",F.PositionKind),c("NORMAL",F.NormalKind),c("TANGENT",F.TangentKind),c("TEXCOORD_0",F.UVKind),c("TEXCOORD_1",F.UV2Kind),c("JOINTS_0",F.MatricesIndicesKind),c("WEIGHTS_0",F.MatricesWeightsKind),c("JOINTS_1",F.MatricesIndicesExtraKind),c("WEIGHTS_1",F.MatricesWeightsExtraKind),c("COLOR_0",F.ColorKind,(function(e){"VEC4"===e.type&&(t.hasVertexAlpha=!0)})),Promise.all(a).then((function(){return s}))},e.prototype._createMorphTargets=function(e,n,t,i,r){if(i.targets){if(null==n._numMorphTargets)n._numMorphTargets=i.targets.length;else if(i.targets.length!==n._numMorphTargets)throw new Error(e+": Primitives do not have the same number of targets");var o=t.extras?t.extras.targetNames:null;r.morphTargetManager=new Gt(r.getScene());for(var a=0;a<i.targets.length;a++){var s=n.weights?n.weights[a]:t.weights?t.weights[a]:0,l=o?o[a]:"morphTarget"+a;r.morphTargetManager.addTarget(new wt(l,s,r.getScene()))}}},e.prototype._loadMorphTargetsAsync=function(e,n,t,i){if(!n.targets)return Promise.resolve();for(var r=new Array,o=t.morphTargetManager,a=0;a<o.numTargets;a++){var s=o.getTarget(a);r.push(this._loadMorphTargetVertexDataAsync(e+"/targets/"+a,i,n.targets[a],s))}return Promise.all(r).then((function(){}))},e.prototype._loadMorphTargetVertexDataAsync=function(e,n,t,i){var r=this,o=new Array,a=function(i,a,s){if(null!=t[i]){var l=n.getVertexBuffer(a);if(l){var c=Vt.Get(e+"/"+i,r._gltf.accessors,t[i]);o.push(r._loadFloatAccessorAsync("/accessors/"+c.index,c).then((function(e){s(l,e)})))}}};return a("POSITION",F.PositionKind,(function(e,n){var t=new Float32Array(n.length);e.forEach(n.length,(function(e,i){t[i]=n[i]+e})),i.setPositions(t)})),a("NORMAL",F.NormalKind,(function(e,n){var t=new Float32Array(n.length);e.forEach(t.length,(function(e,i){t[i]=n[i]+e})),i.setNormals(t)})),a("TANGENT",F.TangentKind,(function(e,n){var t=new Float32Array(n.length/3*4),r=0;e.forEach(n.length/3*4,(function(e,i){(i+1)%4!=0&&(t[r]=n[r]+e,r++)})),i.setTangents(t)})),Promise.all(o).then((function(){}))},e._LoadTransform=function(e,n){if(null==e.skin){var t=m.Zero(),i=C.Identity(),r=m.One();if(e.matrix)A.FromArray(e.matrix).decompose(r,i,t);else e.translation&&(t=m.FromArray(e.translation)),e.rotation&&(i=C.FromArray(e.rotation)),e.scale&&(r=m.FromArray(e.scale));n.position=t,n.rotationQuaternion=i,n.scaling=r}},e.prototype._loadSkinAsync=function(e,n,t){var i=this,r=this._extensionsLoadSkinAsync(e,n,t);if(r)return r;var o=function(e){i._forEachPrimitive(n,(function(n){n.skeleton=e}))};if(t._data)return o(t._data.babylonSkeleton),t._data.promise;var a="skeleton"+t.index;this._babylonScene._blockEntityCollection=this._forAssetContainer;var s=new On(t.name||a,a,this._babylonScene);this._babylonScene._blockEntityCollection=!1,s.overrideMesh=this._rootBabylonMesh,this._loadBones(e,t,s),o(s);var l=this._loadSkinInverseBindMatricesDataAsync(e,t).then((function(e){i._updateBoneMatrices(s,e)}));return t._data={babylonSkeleton:s,promise:l},l},e.prototype._loadBones=function(e,n,t){for(var i={},r=0,o=n.joints;r<o.length;r++){var a=o[r],s=Vt.Get(e+"/joints/"+a,this._gltf.nodes,a);this._loadBone(s,n,t,i)}},e.prototype._loadBone=function(e,n,t,i){var r=i[e.index];if(r)return r;var o=null;e.parent&&e.parent._babylonTransformNode!==this._rootBabylonMesh&&(o=this._loadBone(e.parent,n,t,i));var a=n.joints.indexOf(e.index);return r=new Rn(e.name||"joint"+e.index,t,o,this._getNodeMatrix(e),null,null,a),i[e.index]=r,e._babylonBones=e._babylonBones||[],e._babylonBones.push(r),r},e.prototype._loadSkinInverseBindMatricesDataAsync=function(e,n){if(null==n.inverseBindMatrices)return Promise.resolve(null);var t=Vt.Get(e+"/inverseBindMatrices",this._gltf.accessors,n.inverseBindMatrices);return this._loadFloatAccessorAsync("/accessors/"+t.index,t)},e.prototype._updateBoneMatrices=function(e,n){for(var t=0,i=e.bones;t<i.length;t++){var r=i[t],o=A.Identity(),a=r._index;n&&-1!==a&&(A.FromArrayToRef(n,16*a,o),o.invertToRef(o));var s=r.getParent();s&&o.multiplyToRef(s.getInvertedAbsoluteTransform(),o),r.setBindPose(o),r.updateMatrix(o,!1,!1),r._updateDifferenceMatrix(void 0,!1)}},e.prototype._getNodeMatrix=function(e){return e.matrix?A.FromArray(e.matrix):A.Compose(e.scale?m.FromArray(e.scale):m.One(),e.rotation?C.FromArray(e.rotation):C.Identity(),e.translation?m.FromArray(e.translation):m.Zero())},e.prototype.loadCameraAsync=function(n,t,i){void 0===i&&(i=function(){});var r=this._extensionsLoadCameraAsync(n,t,i);if(r)return r;var o=new Array;this.logOpen(n+" "+(t.name||"")),this._babylonScene._blockEntityCollection=this._forAssetContainer;var a=new yn(t.name||"camera"+t.index,m.Zero(),this._babylonScene,!1);switch(this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,a.rotation=new m(0,Math.PI,0),t.type){case"perspective":var s=t.perspective;if(!s)throw new Error(n+": Camera perspective properties are missing");a.fov=s.yfov,a.minZ=s.znear,a.maxZ=s.zfar||Number.MAX_VALUE;break;case"orthographic":if(!t.orthographic)throw new Error(n+": Camera orthographic properties are missing");a.mode=Q.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-t.orthographic.xmag,a.orthoRight=t.orthographic.xmag,a.orthoBottom=-t.orthographic.ymag,a.orthoTop=t.orthographic.ymag,a.minZ=t.orthographic.znear,a.maxZ=t.orthographic.zfar;break;default:throw new Error(n+": Invalid camera type ("+t.type+")")}return e.AddPointerMetadata(a,n),this._parent.onCameraLoadedObservable.notifyObservers(a),i(a),this.logClose(),Promise.all(o).then((function(){return a}))},e.prototype._loadAnimationsAsync=function(){var e=this._gltf.animations;if(!e)return Promise.resolve();for(var n=new Array,t=0;t<e.length;t++){var i=e[t];n.push(this.loadAnimationAsync("/animations/"+i.index,i))}return Promise.all(n).then((function(){}))},e.prototype.loadAnimationAsync=function(e,n){var t=this._extensionsLoadAnimationAsync(e,n);if(t)return t;this._babylonScene._blockEntityCollection=this._forAssetContainer;var i=new At(n.name||"animation"+n.index,this._babylonScene);this._babylonScene._blockEntityCollection=!1,n._babylonAnimationGroup=i;var r=new Array;Vt.Assign(n.channels),Vt.Assign(n.samplers);for(var o=0,a=n.channels;o<a.length;o++){var s=a[o];r.push(this._loadAnimationChannelAsync(e+"/channels/"+s.index,e,n,s,i))}return Promise.all(r).then((function(){return i.normalize(0),i}))},e.prototype._loadAnimationChannelAsync=function(e,n,t,i,r,o){var a=this;if(void 0===o&&(o=null),null==i.target.node)return Promise.resolve();var s=Vt.Get(e+"/target/node",this._gltf.nodes,i.target.node);if("weights"===i.target.path&&!s._numMorphTargets||"weights"!==i.target.path&&!s._babylonTransformNode)return Promise.resolve();var l=Vt.Get(e+"/sampler",t.samplers,i.sampler);return this._loadAnimationSamplerAsync(n+"/samplers/"+i.sampler,l).then((function(n){var t,l;switch(i.target.path){case"translation":t="position",l=N.ANIMATIONTYPE_VECTOR3;break;case"rotation":t="rotationQuaternion",l=N.ANIMATIONTYPE_QUATERNION;break;case"scale":t="scaling",l=N.ANIMATIONTYPE_VECTOR3;break;case"weights":t="influence",l=N.ANIMATIONTYPE_FLOAT;break;default:throw new Error(e+"/target/path: Invalid value ("+i.target.path+")")}var c,f,u=0;switch(t){case"position":c=function(){var e=m.FromArray(n.output,u);return u+=3,e};break;case"rotationQuaternion":c=function(){var e=C.FromArray(n.output,u);return u+=4,e};break;case"scaling":c=function(){var e=m.FromArray(n.output,u);return u+=3,e};break;case"influence":c=function(){for(var e=new Array(s._numMorphTargets),t=0;t<s._numMorphTargets;t++)e[t]=n.output[u++];return e}}switch(n.interpolation){case"STEP":f=function(e){return{frame:n.input[e],value:c(),interpolation:me.STEP}};break;case"LINEAR":f=function(e){return{frame:n.input[e],value:c()}};break;case"CUBICSPLINE":f=function(e){return{frame:n.input[e],inTangent:c(),value:c(),outTangent:c()}}}for(var d=new Array(n.input.length),h=0;h<n.input.length;h++)d[h]=f(h);if("influence"===t)for(var p=function(e){var n=r.name+"_channel"+r.targetedAnimations.length,i=new N(n,t,1,l);i.setKeys(d.map((function(n){return{frame:n.frame,inTangent:n.inTangent?n.inTangent[e]:void 0,value:n.value[e],outTangent:n.outTangent?n.outTangent[e]:void 0}}))),a._forEachPrimitive(s,(function(n){var t=n.morphTargetManager.getTarget(e),o=i.clone();t.animations.push(o),r.addTargetedAnimation(o,t)}))},_=0;_<s._numMorphTargets;_++)p(_);else{var v=r.name+"_channel"+r.targetedAnimations.length,A=new N(v,t,1,l);A.setKeys(d),null!=o&&null!=o.animations?(o.animations.push(A),r.addTargetedAnimation(A,o)):(s._babylonTransformNode.animations.push(A),r.addTargetedAnimation(A,s._babylonTransformNode))}}))},e.prototype._loadAnimationSamplerAsync=function(e,n){if(n._data)return n._data;var t=n.interpolation||"LINEAR";switch(t){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(e+"/interpolation: Invalid value ("+n.interpolation+")")}var i=Vt.Get(e+"/input",this._gltf.accessors,n.input),r=Vt.Get(e+"/output",this._gltf.accessors,n.output);return n._data=Promise.all([this._loadFloatAccessorAsync("/accessors/"+i.index,i),this._loadFloatAccessorAsync("/accessors/"+r.index,r)]).then((function(e){var n=e[0],i=e[1];return{input:n,interpolation:t,output:i}})),n._data},e.prototype._loadBufferAsync=function(e,n,t,i){var r=this._extensionsLoadBufferAsync(e,n,t,i);if(r)return r;if(!n._data)if(n.uri)n._data=this.loadUriAsync(e+"/uri",n,n.uri);else{if(!this._bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");n._data=this._bin.readAsync(0,n.byteLength)}return n._data.then((function(n){try{return new Uint8Array(n.buffer,n.byteOffset+t,i)}catch(r){throw new Error(e+": "+r.message)}}))},e.prototype.loadBufferViewAsync=function(e,n){var t=this._extensionsLoadBufferViewAsync(e,n);if(t)return t;if(n._data)return n._data;var i=Vt.Get(e+"/buffer",this._gltf.buffers,n.buffer);return n._data=this._loadBufferAsync("/buffers/"+i.index,i,n.byteOffset||0,n.byteLength),n._data},e.prototype._loadAccessorAsync=function(n,t,i){var r=this;if(t._data)return t._data;var o=e._GetNumComponents(n,t.type),a=o*F.GetTypeByteLength(t.componentType),s=o*t.count;if(null==t.bufferView)t._data=Promise.resolve(new i(s));else{var l=Vt.Get(n+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+l.index,l).then((function(r){if(5126!==t.componentType||t.normalized||l.byteStride&&l.byteStride!==a){var c=new i(s);return F.ForEach(r,t.byteOffset||0,l.byteStride||a,o,t.componentType,c.length,t.normalized||!1,(function(e,n){c[n]=e})),c}return e._GetTypedArray(n,t.componentType,r,t.byteOffset,s)}))}if(t.sparse){var c=t.sparse;t._data=t._data.then((function(s){var l=s,f=Vt.Get(n+"/sparse/indices/bufferView",r._gltf.bufferViews,c.indices.bufferView),u=Vt.Get(n+"/sparse/values/bufferView",r._gltf.bufferViews,c.values.bufferView);return Promise.all([r.loadBufferViewAsync("/bufferViews/"+f.index,f),r.loadBufferViewAsync("/bufferViews/"+u.index,u)]).then((function(r){var s,f=r[0],u=r[1],d=e._GetTypedArray(n+"/sparse/indices",c.indices.componentType,f,c.indices.byteOffset,c.count),h=o*c.count;if(5126!==t.componentType||t.normalized){var p=e._GetTypedArray(n+"/sparse/values",t.componentType,u,c.values.byteOffset,h);s=new i(h),F.ForEach(p,0,a,o,t.componentType,s.length,t.normalized||!1,(function(e,n){s[n]=e}))}else s=e._GetTypedArray(n+"/sparse/values",t.componentType,u,c.values.byteOffset,h);for(var m=0,_=0;_<d.length;_++)for(var v=d[_]*o,A=0;A<o;A++)l[v++]=s[m++];return l}))}))}return t._data},e.prototype._loadFloatAccessorAsync=function(e,n){return this._loadAccessorAsync(e,n,Float32Array)},e.prototype._loadIndicesAccessorAsync=function(n,t){if("SCALAR"!==t.type)throw new Error(n+"/type: Invalid value "+t.type);if(5121!==t.componentType&&5123!==t.componentType&&5125!==t.componentType)throw new Error(n+"/componentType: Invalid value "+t.componentType);if(t._data)return t._data;if(t.sparse){var i=e._GetTypedArrayConstructor(n+"/componentType",t.componentType);t._data=this._loadAccessorAsync(n,t,i)}else{var r=Vt.Get(n+"/bufferView",this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync("/bufferViews/"+r.index,r).then((function(i){return e._GetTypedArray(n,t.componentType,i,t.byteOffset,t.count)}))}return t._data},e.prototype._loadVertexBufferViewAsync=function(e,n){var t=this;return e._babylonBuffer||(e._babylonBuffer=this.loadBufferViewAsync("/bufferViews/"+e.index,e).then((function(e){return new de(t._babylonScene.getEngine(),e,!1)}))),e._babylonBuffer},e.prototype._loadVertexAccessorAsync=function(t,i,r){var o=this;if(i._babylonVertexBuffer)return i._babylonVertexBuffer;if(i.sparse)i._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+i.index,i).then((function(e){return new F(o._babylonScene.getEngine(),e,r,!1)}));else if(i.byteOffset&&i.byteOffset%F.GetTypeByteLength(i.componentType)!=0)n.Warn("Accessor byte offset is not a multiple of component type byte length"),i._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+i.index,i).then((function(e){return new F(o._babylonScene.getEngine(),e,r,!1)}));else if(r===F.MatricesIndicesKind||r===F.MatricesIndicesExtraKind)i._babylonVertexBuffer=this._loadFloatAccessorAsync("/accessors/"+i.index,i).then((function(e){return new F(o._babylonScene.getEngine(),e,r,!1)}));else{var a=Vt.Get(t+"/bufferView",this._gltf.bufferViews,i.bufferView);i._babylonVertexBuffer=this._loadVertexBufferViewAsync(a,r).then((function(n){var s=e._GetNumComponents(t,i.type);return new F(o._babylonScene.getEngine(),n,r,!1,!1,a.byteStride,!1,i.byteOffset,s,i.componentType,i.normalized,!0,1,!0)}))}return i._babylonVertexBuffer},e.prototype._loadMaterialMetallicRoughnessPropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;return n&&(n.baseColorFactor?(t.albedoColor=w.FromArray(n.baseColorFactor),t.alpha=n.baseColorFactor[3]):t.albedoColor=w.White(),t.metallic=null==n.metallicFactor?1:n.metallicFactor,t.roughness=null==n.roughnessFactor?1:n.roughnessFactor,n.baseColorTexture&&i.push(this.loadTextureInfoAsync(e+"/baseColorTexture",n.baseColorTexture,(function(e){e.name=t.name+" (Base Color)",t.albedoTexture=e}))),n.metallicRoughnessTexture&&(n.metallicRoughnessTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/metallicRoughnessTexture",n.metallicRoughnessTexture,(function(e){e.name=t.name+" (Metallic Roughness)",t.metallicTexture=e}))),t.useMetallnessFromMetallicTextureBlue=!0,t.useRoughnessFromMetallicTextureGreen=!0,t.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(i).then((function(){}))},e.prototype._loadMaterialAsync=function(n,t,i,r,o){void 0===o&&(o=function(){});var a=this._extensionsLoadMaterialAsync(n,t,i,r,o);if(a)return a;t._data=t._data||{};var s=t._data[r];if(!s){this.logOpen(n+" "+(t.name||""));var l=this.createMaterial(n,t,r);s={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(n,t,l)},t._data[r]=s,e.AddPointerMetadata(l,n),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return i&&(s.babylonMeshes.push(i),i.onDisposeObservable.addOnce((function(){var e=s.babylonMeshes.indexOf(i);-1!==e&&s.babylonMeshes.splice(e,1)}))),o(s.babylonMaterial),s.promise.then((function(){return s.babylonMaterial}))},e.prototype._createDefaultMaterial=function(e,n){this._babylonScene._blockEntityCollection=this._forAssetContainer;var t=new Bt(e,this._babylonScene);return this._babylonScene._blockEntityCollection=!1,t.fillMode=n,t.enableSpecularAntiAliasing=!0,t.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,t.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,t.transparencyMode=Bt.PBRMATERIAL_OPAQUE,t.metallic=1,t.roughness=1,t},e.prototype.createMaterial=function(e,n,t){var i=this._extensionsCreateMaterial(e,n,t);if(i)return i;var r=n.name||"material"+n.index;return this._createDefaultMaterial(r,t)},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this._extensionsLoadMaterialPropertiesAsync(e,n,t);if(i)return i;var r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,n,t)),n.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(e+"/pbrMetallicRoughness",n.pbrMetallicRoughness,t)),this.loadMaterialAlphaProperties(e,n,t),Promise.all(r).then((function(){}))},e.prototype.loadMaterialBasePropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;return t.emissiveColor=n.emissiveFactor?w.FromArray(n.emissiveFactor):new w(0,0,0),n.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),n.normalTexture&&(n.normalTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/normalTexture",n.normalTexture,(function(e){e.name=t.name+" (Normal)",t.bumpTexture=e}))),t.invertNormalMapX=!this._babylonScene.useRightHandedSystem,t.invertNormalMapY=this._babylonScene.useRightHandedSystem,null!=n.normalTexture.scale&&(t.bumpTexture.level=n.normalTexture.scale),t.forceIrradianceInFragment=!0),n.occlusionTexture&&(n.occlusionTexture.nonColorData=!0,i.push(this.loadTextureInfoAsync(e+"/occlusionTexture",n.occlusionTexture,(function(e){e.name=t.name+" (Occlusion)",t.ambientTexture=e}))),t.useAmbientInGrayScale=!0,null!=n.occlusionTexture.strength&&(t.ambientTextureStrength=n.occlusionTexture.strength)),n.emissiveTexture&&i.push(this.loadTextureInfoAsync(e+"/emissiveTexture",n.emissiveTexture,(function(e){e.name=t.name+" (Emissive)",t.emissiveTexture=e}))),Promise.all(i).then((function(){}))},e.prototype.loadMaterialAlphaProperties=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");switch(n.alphaMode||"OPAQUE"){case"OPAQUE":t.transparencyMode=Bt.PBRMATERIAL_OPAQUE;break;case"MASK":t.transparencyMode=Bt.PBRMATERIAL_ALPHATEST,t.alphaCutOff=null==n.alphaCutoff?.5:n.alphaCutoff,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0);break;case"BLEND":t.transparencyMode=Bt.PBRMATERIAL_ALPHABLEND,t.albedoTexture&&(t.albedoTexture.hasAlpha=!0,t.useAlphaFromAlbedoTexture=!0);break;default:throw new Error(e+"/alphaMode: Invalid value ("+n.alphaMode+")")}},e.prototype.loadTextureInfoAsync=function(n,t,i){var r=this;void 0===i&&(i=function(){});var o=this._extensionsLoadTextureInfoAsync(n,t,i);if(o)return o;if(this.logOpen(""+n),t.texCoord>=2)throw new Error(n+"/texCoord: Invalid value ("+t.texCoord+")");var a=Vt.Get(n+"/index",this._gltf.textures,t.index);a._textureInfo=t;var s=this._loadTextureAsync("/textures/"+t.index,a,(function(o){o.coordinatesIndex=t.texCoord||0,e.AddPointerMetadata(o,n),r._parent.onTextureLoadedObservable.notifyObservers(o),i(o)}));return this.logClose(),s},e.prototype._loadTextureAsync=function(n,t,i){void 0===i&&(i=function(){});var r=this._extensionsLoadTextureAsync(n,t,i);if(r)return r;this.logOpen(n+" "+(t.name||""));var o=null==t.sampler?e.DefaultSampler:Vt.Get(n+"/sampler",this._gltf.samplers,t.sampler),a=Vt.Get(n+"/source",this._gltf.images,t.source),s=this._createTextureAsync(n,o,a,i);return this.logClose(),s},e.prototype._createTextureAsync=function(e,n,t,i,r){var o=this;void 0===i&&(i=function(){});var a=this._loadSampler("/samplers/"+n.index,n),s=new Array,l=new ct;this._babylonScene._blockEntityCollection=this._forAssetContainer;var c=new ge(null,this._babylonScene,a.noMipMaps,!1,a.samplingMode,(function(){o._disposed||l.resolve()}),(function(n,t){o._disposed||l.reject(new Error(e+": "+(t&&t.message?t.message:n||"Failed to load texture")))}),void 0,void 0,void 0,t.mimeType,r);return this._babylonScene._blockEntityCollection=!1,s.push(l.promise),s.push(this.loadImageAsync("/images/"+t.index,t).then((function(e){var n=t.uri||o._fileName+"#image"+t.index,i="data:"+o._uniqueRootUrl+n;c.updateURL(i,e)}))),c.wrapU=a.wrapU,c.wrapV=a.wrapV,i(c),Promise.all(s).then((function(){return c}))},e.prototype._loadSampler=function(n,t){return t._data||(t._data={noMipMaps:9728===t.minFilter||9729===t.minFilter,samplingMode:e._GetTextureSamplingMode(n,t),wrapU:e._GetTextureWrapMode(n+"/wrapS",t.wrapS),wrapV:e._GetTextureWrapMode(n+"/wrapT",t.wrapT)}),t._data},e.prototype.loadImageAsync=function(e,n){if(!n._data){if(this.logOpen(e+" "+(n.name||"")),n.uri)n._data=this.loadUriAsync(e+"/uri",n,n.uri);else{var t=Vt.Get(e+"/bufferView",this._gltf.bufferViews,n.bufferView);n._data=this.loadBufferViewAsync("/bufferViews/"+t.index,t)}this.logClose()}return n._data},e.prototype.loadUriAsync=function(n,t,i){var o=this,a=this._extensionsLoadUriAsync(n,t,i);if(a)return a;if(!e._ValidateUri(i))throw new Error(n+": '"+i+"' is invalid");if(r.IsBase64(i)){var s=new Uint8Array(r.DecodeBase64(i));return this.log("Decoded "+i.substr(0,64)+"... ("+s.length+" bytes)"),Promise.resolve(s)}return this.log("Loading "+i),this._parent.preprocessUrlAsync(this._rootUrl+i).then((function(e){return new Promise((function(t,r){o._parent._loadFile(e,o._babylonScene,(function(e){o._disposed||(o.log("Loaded "+i+" ("+e.byteLength+" bytes)"),t(new Uint8Array(e)))}),!0,(function(e){r(new he(n+": Failed to load '"+i+"'"+(e?": "+e.status+" "+e.statusText:""),e))}))}))}))},e.AddPointerMetadata=function(e,n){var t=e.metadata=e.metadata||{},i=t.gltf=t.gltf||{};(i.pointers=i.pointers||[]).push(n)},e._GetTextureWrapMode=function(e,t){switch(t=null==t?10497:t){case 33071:return ge.CLAMP_ADDRESSMODE;case 33648:return ge.MIRROR_ADDRESSMODE;case 10497:return ge.WRAP_ADDRESSMODE;default:return n.Warn(e+": Invalid value ("+t+")"),ge.WRAP_ADDRESSMODE}},e._GetTextureSamplingMode=function(e,t){var i=null==t.magFilter?9729:t.magFilter,r=null==t.minFilter?9987:t.minFilter;if(9729===i)switch(r){case 9728:return ge.LINEAR_NEAREST;case 9729:return ge.LINEAR_LINEAR;case 9984:return ge.LINEAR_NEAREST_MIPNEAREST;case 9985:return ge.LINEAR_LINEAR_MIPNEAREST;case 9986:return ge.LINEAR_NEAREST_MIPLINEAR;case 9987:return ge.LINEAR_LINEAR_MIPLINEAR;default:return n.Warn(e+"/minFilter: Invalid value ("+r+")"),ge.LINEAR_LINEAR_MIPLINEAR}else switch(9728!==i&&n.Warn(e+"/magFilter: Invalid value ("+i+")"),r){case 9728:return ge.NEAREST_NEAREST;case 9729:return ge.NEAREST_LINEAR;case 9984:return ge.NEAREST_NEAREST_MIPNEAREST;case 9985:return ge.NEAREST_LINEAR_MIPNEAREST;case 9986:return ge.NEAREST_NEAREST_MIPLINEAR;case 9987:return ge.NEAREST_LINEAR_MIPLINEAR;default:return n.Warn(e+"/minFilter: Invalid value ("+r+")"),ge.NEAREST_NEAREST_MIPNEAREST}},e._GetTypedArrayConstructor=function(e,n){switch(n){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(e+": Invalid component type "+n)}},e._GetTypedArray=function(n,t,i,r,o){var a=i.buffer;r=i.byteOffset+(r||0);var s=e._GetTypedArrayConstructor(n+"/componentType",t);try{return new s(a,r,o)}catch(l){throw new Error(n+": "+l)}},e._GetNumComponents=function(e,n){switch(n){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(e+": Invalid type ("+n+")")},e._ValidateUri=function(e){return r.IsBase64(e)||-1===e.indexOf("..")},e._GetDrawMode=function(e,n){switch(null==n&&(n=4),n){case 0:return H.PointListDrawMode;case 1:return H.LineListDrawMode;case 2:return H.LineLoopDrawMode;case 3:return H.LineStripDrawMode;case 4:return H.TriangleFillMode;case 5:return H.TriangleStripDrawMode;case 6:return H.TriangleFanDrawMode}throw new Error(e+": Invalid mesh primitive mode ("+n+")")},e.prototype._compileMaterialsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile materials");var n=new Array;if(this._gltf.materials)for(var t=0,i=this._gltf.materials;t<i.length;t++){var r=i[t];if(r._data)for(var o in r._data)for(var a=r._data[o],s=0,l=a.babylonMeshes;s<l.length;s++){var c=l[s];c.computeWorldMatrix(!0);var f=a.babylonMaterial;n.push(f.forceCompilationAsync(c)),n.push(f.forceCompilationAsync(c,{useInstances:!0})),this._parent.useClipPlane&&(n.push(f.forceCompilationAsync(c,{clipPlane:!0})),n.push(f.forceCompilationAsync(c,{clipPlane:!0,useInstances:!0})))}}return Promise.all(n).then((function(){e._parent._endPerformanceCounter("Compile materials")}))},e.prototype._compileShadowGeneratorsAsync=function(){var e=this;this._parent._startPerformanceCounter("Compile shadow generators");for(var n=new Array,t=0,i=this._babylonScene.lights;t<i.length;t++){var r=i[t].getShadowGenerator();r&&n.push(r.forceCompilationAsync())}return Promise.all(n).then((function(){e._parent._endPerformanceCounter("Compile shadow generators")}))},e.prototype._forEachExtensions=function(e){for(var n=0,t=this._extensions;n<t.length;n++){var i=t[n];i.enabled&&e(i)}},e.prototype._applyExtensions=function(e,n,t){for(var i=0,r=this._extensions;i<r.length;i++){var o=r[i];if(o.enabled){var a=o.name+"."+n,s=e;s._activeLoaderExtensionFunctions=s._activeLoaderExtensionFunctions||{};var l=s._activeLoaderExtensionFunctions;if(!l[a]){l[a]=!0;try{var c=t(o);if(c)return c}finally{delete l[a]}}}}return null},e.prototype._extensionsOnLoading=function(){this._forEachExtensions((function(e){return e.onLoading&&e.onLoading()}))},e.prototype._extensionsOnReady=function(){this._forEachExtensions((function(e){return e.onReady&&e.onReady()}))},e.prototype._extensionsLoadSceneAsync=function(e,n){return this._applyExtensions(n,"loadScene",(function(t){return t.loadSceneAsync&&t.loadSceneAsync(e,n)}))},e.prototype._extensionsLoadNodeAsync=function(e,n,t){return this._applyExtensions(n,"loadNode",(function(i){return i.loadNodeAsync&&i.loadNodeAsync(e,n,t)}))},e.prototype._extensionsLoadCameraAsync=function(e,n,t){return this._applyExtensions(n,"loadCamera",(function(i){return i.loadCameraAsync&&i.loadCameraAsync(e,n,t)}))},e.prototype._extensionsLoadVertexDataAsync=function(e,n,t){return this._applyExtensions(n,"loadVertexData",(function(i){return i._loadVertexDataAsync&&i._loadVertexDataAsync(e,n,t)}))},e.prototype._extensionsLoadMeshPrimitiveAsync=function(e,n,t,i,r,o){return this._applyExtensions(r,"loadMeshPrimitive",(function(a){return a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,n,t,i,r,o)}))},e.prototype._extensionsLoadMaterialAsync=function(e,n,t,i,r){return this._applyExtensions(n,"loadMaterial",(function(o){return o._loadMaterialAsync&&o._loadMaterialAsync(e,n,t,i,r)}))},e.prototype._extensionsCreateMaterial=function(e,n,t){return this._applyExtensions(n,"createMaterial",(function(i){return i.createMaterial&&i.createMaterial(e,n,t)}))},e.prototype._extensionsLoadMaterialPropertiesAsync=function(e,n,t){return this._applyExtensions(n,"loadMaterialProperties",(function(i){return i.loadMaterialPropertiesAsync&&i.loadMaterialPropertiesAsync(e,n,t)}))},e.prototype._extensionsLoadTextureInfoAsync=function(e,n,t){return this._applyExtensions(n,"loadTextureInfo",(function(i){return i.loadTextureInfoAsync&&i.loadTextureInfoAsync(e,n,t)}))},e.prototype._extensionsLoadTextureAsync=function(e,n,t){return this._applyExtensions(n,"loadTexture",(function(i){return i._loadTextureAsync&&i._loadTextureAsync(e,n,t)}))},e.prototype._extensionsLoadAnimationAsync=function(e,n){return this._applyExtensions(n,"loadAnimation",(function(t){return t.loadAnimationAsync&&t.loadAnimationAsync(e,n)}))},e.prototype._extensionsLoadSkinAsync=function(e,n,t){return this._applyExtensions(t,"loadSkin",(function(i){return i._loadSkinAsync&&i._loadSkinAsync(e,n,t)}))},e.prototype._extensionsLoadUriAsync=function(e,n,t){return this._applyExtensions(n,"loadUri",(function(i){return i._loadUriAsync&&i._loadUriAsync(e,n,t)}))},e.prototype._extensionsLoadBufferViewAsync=function(e,n){return this._applyExtensions(n,"loadBufferView",(function(t){return t.loadBufferViewAsync&&t.loadBufferViewAsync(e,n)}))},e.prototype._extensionsLoadBufferAsync=function(e,n,t,i){return this._applyExtensions(n,"loadBuffer",(function(r){return r.loadBufferAsync&&r.loadBufferAsync(e,n,t,i)}))},e.LoadExtensionAsync=function(e,n,t,i){if(!n.extensions)return null;var r=n.extensions[t];return r?i(e+"/extensions/"+t,r):null},e.LoadExtraAsync=function(e,n,t,i){if(!n.extras)return null;var r=n.extras[t];return r?i(e+"/extras/"+t,r):null},e.prototype.isExtensionUsed=function(e){return!!this._gltf.extensionsUsed&&-1!==this._gltf.extensionsUsed.indexOf(e)},e.prototype.logOpen=function(e){this._parent._logOpen(e)},e.prototype.logClose=function(){this._parent._logClose()},e.prototype.log=function(e){this._parent._log(e)},e.prototype.startPerformanceCounter=function(e){this._parent._startPerformanceCounter(e)},e.prototype.endPerformanceCounter=function(e){this._parent._endPerformanceCounter(e)},e._RegisteredExtensions={},e.DefaultSampler={index:-1},e}();hn._CreateGLTF2Loader=function(e){return new kt(e)};z.ShadersStore.rgbdEncodePixelShader="\nvarying vec2 vUV;\nuniform sampler2D textureSampler;\n#include<helperFunctions>\nvoid main(void)\n{\ngl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);\n}";var Ht=function(){function e(){}return e.GetEnvInfo=function(t){for(var i=new DataView(t.buffer,t.byteOffset,t.byteLength),r=0,o=0;o<e._MagicBytes.length;o++)if(i.getUint8(r++)!==e._MagicBytes[o])return n.Error("Not a babylon environment map"),null;for(var a="",s=0;s=i.getUint8(r++);)a+=String.fromCharCode(s);var l=JSON.parse(a);return l.specular&&(l.specular.specularDataPosition=r,l.specular.lodGenerationScale=l.specular.lodGenerationScale||.8),l},e.CreateEnvTextureAsync=function(n){var t=this,i=n.getInternalTexture();if(!i)return Promise.reject("The cube texture is invalid.");var a=i.getEngine();if(a&&a.premultipliedAlpha)return Promise.reject("Env texture can only be created when the engine is created with the premultipliedAlpha option set to false.");if(0===n.textureType)return Promise.reject("The cube texture should allow HDR (Full Float or Half Float).");var s=a.getRenderingCanvas();if(!s)return Promise.reject("Env texture can only be created when the engine is associated to a canvas.");var l=1;if(!a.getCaps().textureFloatRender&&(l=2,!a.getCaps().textureHalfFloatRender))return Promise.reject("Env texture can only be created when the browser supports half float or full float rendering.");var c=i.width,f=new o(a),u={},d=[],h=re.Log2(i.width);h=Math.round(h);for(var p=function(e){for(var t=Math.pow(2,h-e),i=function(i){var o=n.readPixels(i,e),c=a.createRawTexture(o,t,t,5,!1,!1,1,null,l),h=new Promise((function(n,o){var l=new Ie("rgbdEncode","rgbdEncode",null,null,1,null,1,a,!1,void 0,0,void 0,null,!1);l.getEffect().executeWhenCompiled((function(){l.onApply=function(e){e._bindTexture("textureSampler",c)};var o=a.getRenderWidth(),d=a.getRenderHeight();a.setSize(t,t),f.postProcessManager.directRender([l],null),r.ToBlob(s,(function(t){var r=new FileReader;r.onload=function(t){var r=t.target.result;u[6*e+i]=r,n()},r.readAsArrayBuffer(t)})),a.setSize(o,d)}))}));d.push(h)},o=0;o<6;o++)i(o)},m=0;m<=h;m++)p(m);return Promise.all(d).then((function(){f.dispose();for(var i={version:1,width:c,irradiance:t._CreateEnvTextureIrradiance(n),specular:{mipmaps:[],lodGenerationScale:n.lodGenerationScale}},r=0,o=0;o<=h;o++)for(var a=0;a<6;a++){var s=u[6*o+a].byteLength;i.specular.mipmaps.push({length:s,position:r}),r+=s}for(var l=JSON.stringify(i),d=new ArrayBuffer(l.length+1),p=new Uint8Array(d),m=(o=0,l.length);o<m;o++)p[o]=l.charCodeAt(o);p[l.length]=0;var _=e._MagicBytes.length+r+d.byteLength,v=new ArrayBuffer(_),A=new Uint8Array(v),g=new DataView(v),E=0;for(o=0;o<e._MagicBytes.length;o++)g.setUint8(E++,e._MagicBytes[o]);A.set(new Uint8Array(d),E),E+=d.byteLength;for(o=0;o<=h;o++)for(a=0;a<6;a++){var T=u[6*o+a];A.set(new Uint8Array(T),E),E+=T.byteLength}return v}))},e._CreateEnvTextureIrradiance=function(e){var n=e.sphericalPolynomial;return null==n?null:{x:[n.x.x,n.x.y,n.x.z],y:[n.y.x,n.y.y,n.y.z],z:[n.z.x,n.z.y,n.z.z],xx:[n.xx.x,n.xx.y,n.xx.z],yy:[n.yy.x,n.yy.y,n.yy.z],zz:[n.zz.x,n.zz.y,n.zz.z],yz:[n.yz.x,n.yz.y,n.yz.z],zx:[n.zx.x,n.zx.y,n.zx.z],xy:[n.xy.x,n.xy.y,n.xy.z]}},e.CreateImageDataArrayBufferViews=function(e,n){if(1!==n.version)throw new Error('Unsupported babylon environment map version "'+n.version+'"');var t=n.specular,i=re.Log2(n.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error('Unsupported specular mipmaps number "'+t.mipmaps.length+'"');for(var r=new Array(i),o=0;o<i;o++){r[o]=new Array(6);for(var a=0;a<6;a++){var s=t.mipmaps[6*o+a];r[o][a]=new Uint8Array(e.buffer,e.byteOffset+t.specularDataPosition+s.position,s.length)}}return r},e.UploadEnvLevelsAsync=function(n,t,i){if(1!==i.version)throw new Error('Unsupported babylon environment map version "'+i.version+'"');var r=i.specular;if(!r)return Promise.resolve();n._lodGenerationScale=r.lodGenerationScale;var o=e.CreateImageDataArrayBufferViews(t,i);return e.UploadLevelsAsync(n,o)},e._OnImageReadyAsync=function(e,n,t,i,r,o,a,s,l,c,f){return new Promise((function(u,d){if(t){var h=n.createTexture(null,!0,!0,null,1,null,(function(e){d(e)}),e);i.getEffect().executeWhenCompiled((function(){i.onApply=function(e){e._bindTexture("textureSampler",h),e.setFloat2("scale",1,1)},n.scenes[0].postProcessManager.directRender([i],c,!0,o,a),n.restoreDefaultFramebuffer(),h.dispose(),URL.revokeObjectURL(r),u()}))}else{if(n._uploadImageToTexture(f,e,o,a),s){var p=l[a];p&&n._uploadImageToTexture(p._texture,e,o,0)}u()}}))},e.UploadLevelsAsync=function(e,n){var t=this;if(!r.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");var i=Math.round(re.Log2(e.width))+1,o=e.getEngine(),a=!1,s=!1,l=null,c=null,f=null,u=o.getCaps();if(e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,e),u.textureLOD?o.webGLVersion<2?a=!1:u.textureHalfFloatRender&&u.textureHalfFloatLinearFiltering?(a=!0,e.type=2):u.textureFloatRender&&u.textureFloatLinearFiltering&&(a=!0,e.type=1):(a=!1,s=!0,f={}),a)l=new Ie("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,e.type,void 0,null,!1),e._isRGBD=!1,e.invertY=!1,c=o.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,s)for(var d=e._lodGenerationScale,h=e._lodGenerationOffset,p=0;p<3;p++){var m=(i-1)*d+h,_=h+(m-h)*(1-p/2),v=Math.round(Math.min(Math.max(_,0),m)),A=new M(o,x.Temp);A.isCube=!0,A.invertY=!0,A.generateMipMaps=!1,o.updateTextureSamplingMode(2,A);var g=new Me(null);switch(g.isCube=!0,g._texture=A,f[v]=g,p){case 0:e._lodTextureLow=g;break;case 1:e._lodTextureMid=g;break;case 2:e._lodTextureHigh=g}}var E=[],T=function(i){for(var r=function(r){var u=n[i][r],d=new Blob([u],{type:"image/png"}),h=URL.createObjectURL(d),p=void 0;if("undefined"==typeof Image)p=createImageBitmap(d).then((function(n){return t._OnImageReadyAsync(n,o,a,l,h,r,i,s,f,c,e)}));else{var m=new Image;m.src=h,p=new Promise((function(n,u){m.onload=function(){t._OnImageReadyAsync(m,o,a,l,h,r,i,s,f,c,e).then((function(){return n()})).catch((function(e){u(e)}))},m.onerror=function(e){u(e)}}))}E.push(p)},u=0;u<6;u++)r(u)};for(p=0;p<n.length;p++)T(p);if(n.length<i){var y=void 0,R=Math.pow(2,i-1-n.length),C=R*R*4;switch(e.type){case 0:y=new Uint8Array(C);break;case 2:y=new Uint16Array(C);break;case 1:y=new Float32Array(C)}for(p=n.length;p<i;p++)for(var b=0;b<6;b++)o._uploadArrayBufferViewToTexture(e,y,b,p)}return Promise.all(E).then((function(){c&&(o._releaseFramebufferObjects(c),o._releaseTexture(e),c._swapAndDie(e)),l&&l.dispose(),s&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}))},e.UploadEnvSpherical=function(e,t){1!==t.version&&n.Warn('Unsupported babylon environment map version "'+t.version+'"');var i=t.irradiance;if(i){var r=new Lt;m.FromArrayToRef(i.x,0,r.x),m.FromArrayToRef(i.y,0,r.y),m.FromArrayToRef(i.z,0,r.z),m.FromArrayToRef(i.xx,0,r.xx),m.FromArrayToRef(i.yy,0,r.yy),m.FromArrayToRef(i.zz,0,r.zz),m.FromArrayToRef(i.yz,0,r.yz),m.FromArrayToRef(i.zx,0,r.zx),m.FromArrayToRef(i.xy,0,r.xy),e._sphericalPolynomial=r}},e._UpdateRGBDAsync=function(n,t,i,r,o){return n._source=x.CubeRawRGBD,n._bufferViewArrayArray=t,n._lodGenerationScale=r,n._lodGenerationOffset=o,n._sphericalPolynomial=i,e.UploadLevelsAsync(n,t).then((function(){n.isReady=!0}))},e._MagicBytes=[134,22,135,150,246,214,150,54],e}();M._UpdateRGBDAsync=Ht._UpdateRGBDAsync,O.prototype._createDepthStencilCubeTexture=function(e,t){var i=new M(this,x.Unknown);if(i.isCube=!0,1===this.webGLVersion)return n.Error("Depth cube texture is not supported by WebGL 1."),i;var r=B({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},t),o=this._gl;this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,e,r.generateStencil,r.bilinearFiltering,r.comparisonFunction);for(var a=0;a<6;a++)r.generateStencil?o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,o.DEPTH24_STENCIL8,e,e,0,o.DEPTH_STENCIL,o.UNSIGNED_INT_24_8,null):o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,o.DEPTH_COMPONENT24,e,e,0,o.DEPTH_COMPONENT,o.UNSIGNED_INT,null);return this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,null),i},O.prototype._partialLoadFile=function(e,n,t,i,r){void 0===r&&(r=null);this._loadFile(e,(function(e){t[n]=e,t._internalCount++,6===t._internalCount&&i(t)}),void 0,void 0,!0,(function(e,n){r&&e&&r(e.status+" "+e.statusText,n)}))},O.prototype._cascadeLoadFiles=function(e,n,t,i){void 0===i&&(i=null);var r=[];r._internalCount=0;for(var o=0;o<6;o++)this._partialLoadFile(t[o],o,r,n,i)},O.prototype._cascadeLoadImgs=function(e,n,t,i,r){void 0===i&&(i=null);var o=[];o._internalCount=0;for(var a=0;a<6;a++)this._partialLoadImg(t[a],a,o,e,n,i,r)},O.prototype._partialLoadImg=function(e,n,t,i,r,o,a){var s;void 0===o&&(o=null);s=_e.LoadImage(e,(function(){s&&(t[n]=s,t._internalCount++,i&&i._removePendingData(s)),6===t._internalCount&&r(t)}),(function(e,n){i&&i._removePendingData(s),o&&o(e,n)}),i?i.offlineProvider:null,a),i&&s&&i._addPendingData(s)},O.prototype._setCubeMapTextureParams=function(e,n){var t=this._gl;t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,n?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e.samplingMode=n?3:2,this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)},O.prototype.createCubeTexture=function(e,t,i,r,o,a,s,l,c,f,u,d,h){var p=this;void 0===o&&(o=null),void 0===a&&(a=null),void 0===l&&(l=null),void 0===c&&(c=!1),void 0===f&&(f=0),void 0===u&&(u=0),void 0===d&&(d=null);var m=this._gl,_=d||new M(this,x.Cube);_.isCube=!0,_.url=e,_.generateMipMaps=!r,_._lodGenerationScale=f,_._lodGenerationOffset=u,this._doNotHandleContextLost||(_._extension=l,_._files=i);var v=e;this._transformTextureUrl&&!d&&(e=this._transformTextureUrl(e));for(var A=e.lastIndexOf("."),g=l||(A>-1?e.substring(A).toLowerCase():""),E=null,T=0,y=O._TextureLoaders;T<y.length;T++){var R=y[T];if(R.canLoad(g)){E=R;break}}if(E){var C=function(e){p._bindTextureDirectly(m.TEXTURE_CUBE_MAP,_,!0),E.loadCubeData(e,_,c,o,a)};i&&6===i.length?E.supportCascades?this._cascadeLoadFiles(t,(function(e){return C(e.map((function(e){return new Uint8Array(e)})))}),i,a):a?a("Textures type does not support cascades."):n.Warn("Texture loader does not support cascades."):this._loadFile(e,(function(e){return C(new Uint8Array(e))}),void 0,void 0,!0,(function(d,m){e===v?a&&d&&a(d.status+" "+d.statusText,m):(n.Warn("Failed to load "+e+", falling back to the "+v),p.createCubeTexture(v,t,i,r,o,a,s,l,c,f,u,_,h))}))}else{if(!i)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(t,(function(e){var t=p.needPOTTextures?O.GetExponentOfTwo(e[0].width,p._caps.maxCubemapTextureSize):e[0].width,i=t,a=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];p._bindTextureDirectly(m.TEXTURE_CUBE_MAP,_,!0),p._unpackFlipY(!1);for(var l=s?p._getInternalFormat(s):p._gl.RGBA,c=0;c<a.length;c++)if(e[c].width!==t||e[c].height!==i){if(p._prepareWorkingCanvas(),!p._workingCanvas||!p._workingContext)return void n.Warn("Cannot create canvas to resize texture.");p._workingCanvas.width=t,p._workingCanvas.height=i,p._workingContext.drawImage(e[c],0,0,e[c].width,e[c].height,0,0,t,i),m.texImage2D(a[c],0,l,l,m.UNSIGNED_BYTE,p._workingCanvas)}else m.texImage2D(a[c],0,l,l,m.UNSIGNED_BYTE,e[c]);r||m.generateMipmap(m.TEXTURE_CUBE_MAP),p._setCubeMapTextureParams(_,!r),_.width=t,_.height=i,_.isReady=!0,s&&(_.format=s),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),o&&o()}),i,a)}return this._internalTexturesCache.push(_),_};var Xt=function(e){function n(n,t,i,o,s,l,c,f,u,d,h,p,_,v){var g;void 0===i&&(i=null),void 0===o&&(o=!1),void 0===s&&(s=null),void 0===l&&(l=null),void 0===c&&(c=null),void 0===f&&(f=5),void 0===u&&(u=!1),void 0===d&&(d=null),void 0===h&&(h=!1),void 0===p&&(p=.8),void 0===_&&(_=0);var E=e.call(this,t)||this;if(E.onLoadObservable=new a,E.boundingBoxPosition=m.Zero(),E._rotationY=0,E._files=null,E._forcedExtension=null,E._extensions=null,E.name=n,E.url=n,E._noMipmap=o,E.hasAlpha=!1,E._format=f,E.isCube=!0,E._textureMatrix=A.Identity(),E._createPolynomials=h,E.coordinatesMode=ge.CUBIC_MODE,E._extensions=i,E._files=s,E._forcedExtension=d,E._loaderOptions=v,!n&&!s)return E;var T=n.lastIndexOf("."),y=d||(T>-1?n.substring(T).toLowerCase():""),R=".dds"===y,C=".env"===y;if(C?(E.gammaSpace=!1,E._prefiltered=!1,E.anisotropicFilteringLevel=1):(E._prefiltered=u,u&&(E.gammaSpace=!1,E.anisotropicFilteringLevel=1)),E._texture=E._getFromCache(n,o),!s&&(C||R||i||(i=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),s=[],i))for(var b=0;b<i.length;b++)s.push(n+i[b]);E._files=s;var S=function(){E.onLoadObservable.notifyObservers(E),l&&l()};if(E._texture)E._texture.isReady?r.SetImmediate((function(){return S()})):E._texture.onLoadedObservable.add((function(){return S()}));else{var I=E.getScene();(null==I?void 0:I.useDelayedTextureLoading)?E.delayLoadState=4:(E._texture=u?E._getEngine().createPrefilteredCubeTexture(n,I,p,_,l,c,f,d,E._createPolynomials):E._getEngine().createCubeTexture(n,I,s,o,l,c,E._format,d,!1,p,_,null,v),null===(g=E._texture)||void 0===g||g.onLoadedObservable.add((function(){return E.onLoadObservable.notifyObservers(E)})))}return E}return l(n,e),Object.defineProperty(n.prototype,"boundingBoxSize",{get:function(){return this._boundingBoxSize},set:function(e){if(!this._boundingBoxSize||!this._boundingBoxSize.equals(e)){this._boundingBoxSize=e;var n=this.getScene();n&&n.markAllMaterialsAsDirty(1)}},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"rotationY",{get:function(){return this._rotationY},set:function(e){this._rotationY=e,this.setReflectionTextureMatrix(A.RotationY(this._rotationY))},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"noMipmap",{get:function(){return this._noMipmap},enumerable:!1,configurable:!0}),n.CreateFromImages=function(e,t,i){var r="";return e.forEach((function(e){return r+=e})),new n(r,t,null,i,e)},n.CreateFromPrefilteredData=function(e,t,i,r){void 0===i&&(i=null),void 0===r&&(r=!0);var o=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;var a=new n(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=o,a},n.prototype.getClassName=function(){return"CubeTexture"},n.prototype.updateURL=function(e,n,t,i){var r;void 0===i&&(i=!1),this.url&&(this.releaseInternalTexture(),null===(r=this.getScene())||void 0===r||r.markAllMaterialsAsDirty(1)),this.name&&!u.StartsWith(this.name,"data:")||(this.name=e),this.url=e,this.delayLoadState=4,this._prefiltered=i,this._prefiltered&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1),this._forcedExtension=n||null,t&&(this._delayedOnLoad=t),this.delayLoad(n)},n.prototype.delayLoad=function(e){var n,t=this;if(4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),!this._texture)){var i=this.getScene();this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,.8,0,this._delayedOnLoad,void 0,this._format,e,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,this._delayedOnLoad,null,this._format,e,!1,0,0,null,this._loaderOptions),null===(n=this._texture)||void 0===n||n.onLoadedObservable.add((function(){return t.onLoadObservable.notifyObservers(t)}))}},n.prototype.getReflectionTextureMatrix=function(){return this._textureMatrix},n.prototype.setReflectionTextureMatrix=function(e){var n,t=this;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&(null===(n=this.getScene())||void 0===n||n.markAllMaterialsAsDirty(1,(function(e){return-1!==e.getActiveTextures().indexOf(t)}))),this._textureMatrix=e)},n.Parse=function(e,t,i){var r=U.Parse((function(){var r=!1;return e.prefiltered&&(r=e.prefiltered),new n(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)}),e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=m.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=m.FromArray(e.boundingBoxSize)),e.animations)for(var o=0;o<e.animations.length;o++){var a=e.animations[o],s=X.GetClass("BABYLON.Animation");s&&r.animations.push(s.Parse(a))}return r},n.prototype.clone=function(){var e=this,t=0,i=U.Clone((function(){var i=new n(e.url,e.getScene()||e._getEngine(),e._extensions,e._noMipmap,e._files);return t=i.uniqueId,i}),this);return i.uniqueId=t,i},d([h()],n.prototype,"url",void 0),d([h("rotationY")],n.prototype,"rotationY",null),d([h("files")],n.prototype,"_files",void 0),d([h("forcedExtension")],n.prototype,"_forcedExtension",void 0),d([h("extensions")],n.prototype,"_extensions",void 0),d([ve("textureMatrix")],n.prototype,"_textureMatrix",void 0),n}(Me);ge._CubeTextureParser=Xt.Parse,X.RegisteredTypes["BABYLON.CubeTexture"]=Xt;var Wt=function(e){function n(n,t,i,r,o,a,s,l,c){void 0===r&&(r=5),void 0===o&&(o=0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===l&&(l=3),void 0===c&&(c=null);var f=e.call(this,"",n)||this;return f._texture=n.getEngine().createRawCubeTexture(t,i,r,o,a,s,l,c),f}return l(n,e),n.prototype.update=function(e,n,t,i,r){void 0===r&&(r=null),this._texture.getEngine().updateRawCubeTexture(this._texture,e,n,t,i,r)},n.prototype.updateRGBDAsync=function(e,t,i,r){return void 0===t&&(t=null),void 0===i&&(i=.8),void 0===r&&(r=0),n._UpdateRGBDAsync(this._texture,e,t,i,r)},n.prototype.clone=function(){var e=this;return U.Clone((function(){var t=e.getScene(),i=e._texture,r=new n(t,i._bufferViewArray,i.width,i.format,i.type,i.generateMipMaps,i.invertY,i.samplingMode,i._compression);return i.source===x.CubeRawRGBD&&r.updateRGBDAsync(i._bufferViewArrayArray,i._sphericalPolynomial,i._lodGenerationScale,i._lodGenerationOffset),r}),this)},n._UpdateRGBDAsync=function(e,n,t,i,r){return e._source=x.CubeRawRGBD,e._bufferViewArrayArray=n,e._lodGenerationScale=i,e._lodGenerationOffset=r,e._sphericalPolynomial=t,Ht.UploadLevelsAsync(e,n).then((function(){e.isReady=!0}))},n}(Xt),zt="EXT_lights_image_based",Yt=function(){function e(e){this.name=zt,this._loader=e,this.enabled=this._loader.isExtensionUsed(zt)}return e.prototype.dispose=function(){this._loader=null,delete this._lights},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},e.prototype.loadSceneAsync=function(e,n){var t=this;return kt.LoadExtensionAsync(e,n,this.name,(function(i,r){var o=new Array;o.push(t._loader.loadSceneAsync(e,n)),t._loader.logOpen(""+i);var a=Vt.Get(i+"/light",t._lights,r.light);return o.push(t._loadLightAsync("/extensions/"+t.name+"/lights/"+r.light,a).then((function(e){t._loader.babylonScene.environmentTexture=e}))),t._loader.logClose(),Promise.all(o).then((function(){}))}))},e.prototype._loadLightAsync=function(e,n){var t=this;if(!n._loaded){var i=new Array;this._loader.logOpen(""+e);for(var r=new Array(n.specularImages.length),o=function(t){var o=n.specularImages[t];r[t]=new Array(o.length);for(var s=function(n){var s=e+"/specularImages/"+t+"/"+n;a._loader.logOpen(""+s);var l=o[n],c=Vt.Get(s,a._loader.gltf.images,l);i.push(a._loader.loadImageAsync("/images/"+l,c).then((function(e){r[t][n]=e}))),a._loader.logClose()},l=0;l<o.length;l++)s(l)},a=this,s=0;s<n.specularImages.length;s++)o(s);this._loader.logClose(),n._loaded=Promise.all(i).then((function(){var e=new Wt(t._loader.babylonScene,null,n.specularImageSize);if(e.name=n.name||"environment",n._babylonTexture=e,null!=n.intensity&&(e.level=n.intensity),n.rotation){var i=C.FromArray(n.rotation);t._loader.babylonScene.useRightHandedSystem||(i=C.Inverse(i)),A.FromQuaternionToRef(i,e.getReflectionTextureMatrix())}var o=xt.FromArray(n.irradianceCoefficients);o.scaleInPlace(n.intensity),o.convertIrradianceToLambertianRadiance();var a=Lt.FromHarmonics(o),s=(r.length-1)/re.Log2(n.specularImageSize);return e.updateRGBDAsync(r,a,s)}))}return n._loaded.then((function(){return n._babylonTexture}))},e}();kt.RegisterExtension(zt,(function(e){return new Yt(e)}));var Qt="EXT_mesh_gpu_instancing",jt=function(){function e(e){this.name=Qt,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qt)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadNodeAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(e,r){i._loader._disableInstancedMesh++;var o=i._loader.loadNodeAsync("/nodes/"+n.index,n,t);if(i._loader._disableInstancedMesh--,!n._primitiveBabylonMeshes)return o;var a=new Array,s=0,l=function(n){if(null!=r.attributes[n]){var t=Vt.Get(e+"/attributes/"+n,i._loader.gltf.accessors,r.attributes[n]);if(a.push(i._loader._loadFloatAccessorAsync("/accessors/"+t.bufferView,t)),0===s)s=t.count;else if(s!==t.count)throw new Error(e+"/attributes: Instance buffer accessors do not have the same count.")}else a.push(Promise.resolve(null))};return l("TRANSLATION"),l("ROTATION"),l("SCALE"),o.then((function(e){return Promise.all(a).then((function(t){var i=t[0],r=t[1],o=t[2],a=new Float32Array(16*s);P.Vector3[0].copyFromFloats(0,0,0),P.Quaternion[0].copyFromFloats(0,0,0,1),P.Vector3[1].copyFromFloats(1,1,1);for(var l=0;l<s;++l)i&&m.FromArrayToRef(i,3*l,P.Vector3[0]),r&&C.FromArrayToRef(r,4*l,P.Quaternion[0]),o&&m.FromArrayToRef(o,3*l,P.Vector3[1]),A.ComposeToRef(P.Vector3[1],P.Quaternion[0],P.Vector3[0],P.Matrix[0]),P.Matrix[0].copyToArray(a,16*l);for(var c=0,f=n._primitiveBabylonMeshes;c<f.length;c++){f[c].thinInstanceSetBuffer("matrix",a,16,!0)}return e}))}))}))},e}();kt.RegisterExtension(Qt,(function(e){return new jt(e)}));var Kt="EXT_texture_webp",qt=function(){function e(e){this.name=Kt,this._loader=e,this.enabled=e.isExtensionUsed(Kt)}return e.prototype.dispose=function(){this._loader=null},e.prototype._loadTextureAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=null==n.sampler?kt.DefaultSampler:Vt.Get(e+"/sampler",i._loader.gltf.samplers,n.sampler),s=Vt.Get(r+"/source",i._loader.gltf.images,o.source);return i._loader._createTextureAsync(e,a,s,(function(e){t(e)}))}))},e}();kt.RegisterExtension(Kt,(function(e){return new qt(e)}));var Zt=function(){function e(e){this._pendingActions=new Array,this._workerInfos=e.map((function(e){return{worker:e,active:!1}}))}return e.prototype.dispose=function(){for(var e=0,n=this._workerInfos;e<n.length;e++){n[e].worker.terminate()}this._workerInfos=[],this._pendingActions=[]},e.prototype.push=function(e){for(var n=0,t=this._workerInfos;n<t.length;n++){var i=t[n];if(!i.active)return void this._execute(i,e)}this._pendingActions.push(e)},e.prototype._execute=function(e,n){var t=this;e.active=!0,n(e.worker,(function(){e.active=!1;var n=t._pendingActions.shift();n&&t._execute(e,n)}))},e}();function Jt(e,n,t,i,r){var o=new e.DecoderBuffer;o.Init(n,n.byteLength);var a,s,l=new e.Decoder;try{var c=l.GetEncodedGeometryType(o);switch(c){case e.TRIANGULAR_MESH:a=new e.Mesh,s=l.DecodeBufferToMesh(o,a);break;case e.POINT_CLOUD:a=new e.PointCloud,s=l.DecodeBufferToPointCloud(o,a);break;default:throw new Error("Invalid geometry type "+c)}if(!s.ok()||!a.ptr)throw new Error(s.error_msg());if(c===e.TRIANGULAR_MESH){var f=3*a.num_faces(),u=4*f,d=e._malloc(u);try{l.GetTrianglesUInt32Array(a,u,d);var h=new Uint32Array(f);h.set(new Uint32Array(e.HEAPF32.buffer,d,f)),i(h)}finally{e._free(d)}}var p=function(n,t){var i=t.num_components(),o=a.num_points(),s=o*i,c=s*Float32Array.BYTES_PER_ELEMENT,f=e._malloc(c);try{l.GetAttributeDataArrayForAllPoints(a,t,e.DT_FLOAT32,c,f);var u=new Float32Array(e.HEAPF32.buffer,f,s);if("color"===n&&3===i){for(var d=new Float32Array(4*o),h=0,p=0;h<d.length;h+=4,p+=i)d[h+0]=u[p+0],d[h+1]=u[p+1],d[h+2]=u[p+2],d[h+3]=1;r(n,d)}else{(d=new Float32Array(s)).set(new Float32Array(e.HEAPF32.buffer,f,s)),r(n,d)}}finally{e._free(f)}};if(t)for(var m in t){var _=t[m];p(m,l.GetAttributeByUniqueId(a,_))}else{var v={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"};for(var m in v){if(-1!==(_=l.GetAttributeId(a,e[v[m]])))p(m,l.GetAttribute(a,_))}}}finally{a&&e.destroy(a),e.destroy(l),e.destroy(o)}}function $t(){var e;onmessage=function(n){var t=n.data;switch(t.id){case"init":var i=t.decoder;i.url&&(importScripts(i.url),e=DracoDecoderModule({wasmBinary:i.wasmBinary})),postMessage("done");break;case"decodeMesh":if(!e)throw new Error("Draco decoder module is not available");e.then((function(e){Jt(e,t.dataView,t.attributes,(function(e){postMessage({id:"indices",value:e},[e.buffer])}),(function(e,n){postMessage({id:e,value:n},[n.buffer])})),postMessage("done")}))}}}function ei(e){return"object"!=typeof document||"string"!=typeof e?e:r.GetAbsoluteUrl(e)}var ni=function(){function e(n){void 0===n&&(n=e.DefaultNumWorkers);var t=e.Configuration.decoder,i=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:t.wasmUrl,wasmBinaryPromise:r.LoadFileAsync(ei(t.wasmBinaryUrl))}:{url:t.fallbackUrl,wasmBinaryPromise:Promise.resolve(void 0)};n&&"function"==typeof Worker?this._workerPoolPromise=i.wasmBinaryPromise.then((function(e){for(var t=Jt+"("+$t+")()",r=URL.createObjectURL(new Blob([t],{type:"application/javascript"})),o=new Array(n),a=0;a<o.length;a++)o[a]=new Promise((function(n,t){var o=new Worker(r),a=function(e){o.removeEventListener("error",a),o.removeEventListener("message",s),t(e)},s=function(e){"done"===e.data&&(o.removeEventListener("error",a),o.removeEventListener("message",s),n(o))};o.addEventListener("error",a),o.addEventListener("message",s),o.postMessage({id:"init",decoder:{url:ei(i.url),wasmBinary:e}})}));return Promise.all(o).then((function(e){return new Zt(e)}))})):this._decoderModulePromise=i.wasmBinaryPromise.then((function(e){if(!i.url)throw new Error("Draco decoder module is not available");return r.LoadScriptAsync(i.url).then((function(){return n=e,new Promise((function(e){DracoDecoderModule({wasmBinary:n}).then((function(n){e({module:n})}))}));var n}))}))}return Object.defineProperty(e,"DecoderAvailable",{get:function(){var n=e.Configuration.decoder;return!!(n.wasmUrl&&n.wasmBinaryUrl&&"object"==typeof WebAssembly||n.fallbackUrl)},enumerable:!1,configurable:!0}),e.GetDefaultNumWorkers=function(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1},Object.defineProperty(e,"Default",{get:function(){return e._Default||(e._Default=new e),e._Default},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this._workerPoolPromise&&this._workerPoolPromise.then((function(e){e.dispose()})),delete this._workerPoolPromise,delete this._decoderModulePromise},e.prototype.whenReadyAsync=function(){return this._workerPoolPromise?this._workerPoolPromise.then((function(){})):this._decoderModulePromise?this._decoderModulePromise.then((function(){})):Promise.resolve()},e.prototype.decodeMeshAsync=function(e,n){var t=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this._workerPoolPromise)return this._workerPoolPromise.then((function(e){return new Promise((function(i,r){e.push((function(e,o){var a=new Z,s=function(n){e.removeEventListener("error",s),e.removeEventListener("message",l),r(n),o()},l=function(n){"done"===n.data?(e.removeEventListener("error",s),e.removeEventListener("message",l),i(a),o()):"indices"===n.data.id?a.indices=n.data.value:a.set(n.data.value,n.data.id)};e.addEventListener("error",s),e.addEventListener("message",l);var c=new Uint8Array(t.byteLength);c.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),e.postMessage({id:"decodeMesh",dataView:c,attributes:n},[c.buffer])}))}))}));if(this._decoderModulePromise)return this._decoderModulePromise.then((function(e){var i=new Z;return Jt(e.module,t,n,(function(e){i.indices=e}),(function(e,n){i.set(n,e)})),i}));throw new Error("Draco decoder module is not available")},e.Configuration={decoder:{wasmUrl:"https://preview.babylonjs.com/draco_wasm_wrapper_gltf.js",wasmBinaryUrl:"https://preview.babylonjs.com/draco_decoder_gltf.wasm",fallbackUrl:"https://preview.babylonjs.com/draco_decoder_gltf.js"}},e.DefaultNumWorkers=e.GetDefaultNumWorkers(),e._Default=null,e}(),ti="KHR_draco_mesh_compression",ii=function(){function e(e){this.name=ti,this._loader=e,this.enabled=ni.DecoderAvailable&&this._loader.isExtensionUsed(ti)}return e.prototype.dispose=function(){delete this.dracoCompression,this._loader=null},e.prototype._loadVertexDataAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){if(null!=n.mode){if(5!==n.mode&&4!==n.mode)throw new Error(e+": Unsupported mode "+n.mode);if(5===n.mode)throw new Error(e+": Mode "+n.mode+" is not currently supported")}var a={},s=function(e,n){var i=o.attributes[e];null!=i&&(t._delayInfo=t._delayInfo||[],-1===t._delayInfo.indexOf(n)&&t._delayInfo.push(n),a[n]=i)};s("POSITION",F.PositionKind),s("NORMAL",F.NormalKind),s("TANGENT",F.TangentKind),s("TEXCOORD_0",F.UVKind),s("TEXCOORD_1",F.UV2Kind),s("JOINTS_0",F.MatricesIndicesKind),s("WEIGHTS_0",F.MatricesWeightsKind),s("COLOR_0",F.ColorKind);var l=Vt.Get(r,i._loader.gltf.bufferViews,o.bufferView);return l._dracoBabylonGeometry||(l._dracoBabylonGeometry=i._loader.loadBufferViewAsync("/bufferViews/"+l.index,l).then((function(n){return(i.dracoCompression||ni.Default).decodeMeshAsync(n,a).then((function(e){var n=new K(t.name,i._loader.babylonScene);return e.applyToGeometry(n),n})).catch((function(n){throw new Error(e+": "+n.message)}))}))),l._dracoBabylonGeometry}))},e}();kt.RegisterExtension(ti,(function(e){return new ii(e)}));var ri="KHR_lights_punctual",oi=function(){function e(e){this.name=ri,this._loader=e,this.enabled=this._loader.isExtensionUsed(ri)}return e.prototype.dispose=function(){this._loader=null,delete this._lights},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._lights=n.lights}},e.prototype.loadNodeAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){return i._loader.loadNodeAsync(e,n,(function(e){var n,a=Vt.Get(r,i._lights,o.light),s=a.name||e.name;switch(i._loader.babylonScene._blockEntityCollection=i._loader._forAssetContainer,a.type){case"directional":n=new Ln(s,m.Backward(),i._loader.babylonScene);break;case"point":n=new Dn(s,m.Zero(),i._loader.babylonScene);break;case"spot":var l=new Se(s,m.Zero(),m.Backward(),0,1,i._loader.babylonScene);l.angle=2*(a.spot&&a.spot.outerConeAngle||Math.PI/4),l.innerAngle=2*(a.spot&&a.spot.innerConeAngle||0),n=l;break;default:throw i._loader.babylonScene._blockEntityCollection=!1,new Error(r+": Invalid light type ("+a.type+")")}i._loader.babylonScene._blockEntityCollection=!1,n.falloffType=W.FALLOFF_GLTF,n.diffuse=a.color?w.FromArray(a.color):w.White(),n.intensity=null==a.intensity?1:a.intensity,n.range=null==a.range?Number.MAX_VALUE:a.range,n.parent=e,i._loader._babylonLights.push(n),kt.AddPointerMetadata(n,r),t(e)}))}))},e}();kt.RegisterExtension(ri,(function(e){return new oi(e)}));var ai="KHR_materials_pbrSpecularGlossiness",si=function(){function e(e){this.name=ai,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(ai)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialBasePropertiesAsync(e,n,t)),a.push(i._loadSpecularGlossinessPropertiesAsync(r,n,o,t)),i._loader.loadMaterialAlphaProperties(e,n,t),Promise.all(a).then((function(){}))}))},e.prototype._loadSpecularGlossinessPropertiesAsync=function(e,n,t,i){if(!(i instanceof Bt))throw new Error(e+": Material type not supported");var r=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=w.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=w.White(),i.reflectivityColor=t.specularFactor?w.FromArray(t.specularFactor):w.White(),i.microSurface=null==t.glossinessFactor?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(e+"/diffuseTexture",t.diffuseTexture,(function(e){e.name=i.name+" (Diffuse)",i.albedoTexture=e}))),t.specularGlossinessTexture&&(t.specularGlossinessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(e+"/specularGlossinessTexture",t.specularGlossinessTexture,(function(e){e.name=i.name+" (Specular Glossiness)",i.reflectivityTexture=e}))),i.reflectivityTexture.hasAlpha=!0,i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then((function(){}))},e}();kt.RegisterExtension(ai,(function(e){return new si(e)}));var li="KHR_materials_unlit",ci=function(){function e(e){this.name=li,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(li)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(){return i._loadUnlitPropertiesAsync(e,n,t)}))},e.prototype._loadUnlitPropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;t.unlit=!0;var r=n.pbrMetallicRoughness;return r&&(r.baseColorFactor?(t.albedoColor=w.FromArray(r.baseColorFactor),t.alpha=r.baseColorFactor[3]):t.albedoColor=w.White(),r.baseColorTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/baseColorTexture",r.baseColorTexture,(function(e){e.name=t.name+" (Base Color)",t.albedoTexture=e})))),n.doubleSided&&(t.backFaceCulling=!1,t.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,n,t),Promise.all(i).then((function(){}))},e}();kt.RegisterExtension(li,(function(e){return new ci(e)}));var fi="KHR_materials_clearcoat",ui=function(){function e(e){this.name=fi,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(fi)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadClearCoatPropertiesAsync(r,o,t)),Promise.all(a).then((function(){}))}))},e.prototype._loadClearCoatPropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;return t.clearCoat.isEnabled=!0,t.clearCoat.useRoughnessFromMainTexture=!1,t.clearCoat.remapF0OnInterfaceChange=!1,null!=n.clearcoatFactor?t.clearCoat.intensity=n.clearcoatFactor:t.clearCoat.intensity=0,n.clearcoatTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatTexture",n.clearcoatTexture,(function(e){e.name=t.name+" (ClearCoat Intensity)",t.clearCoat.texture=e}))),null!=n.clearcoatRoughnessFactor?t.clearCoat.roughness=n.clearcoatRoughnessFactor:t.clearCoat.roughness=0,n.clearcoatRoughnessTexture&&(n.clearcoatRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatRoughnessTexture",n.clearcoatRoughnessTexture,(function(e){e.name=t.name+" (ClearCoat Roughness)",t.clearCoat.textureRoughness=e})))),n.clearcoatNormalTexture&&(n.clearcoatNormalTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/clearcoatNormalTexture",n.clearcoatNormalTexture,(function(e){e.name=t.name+" (ClearCoat Normal)",t.clearCoat.bumpTexture=e}))),t.invertNormalMapX=!t.getScene().useRightHandedSystem,t.invertNormalMapY=t.getScene().useRightHandedSystem,null!=n.clearcoatNormalTexture.scale&&(t.clearCoat.bumpTexture.level=n.clearcoatNormalTexture.scale)),Promise.all(i).then((function(){}))},e}();kt.RegisterExtension(fi,(function(e){return new ui(e)}));var di="KHR_materials_sheen",hi=function(){function e(e){this.name=di,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(di)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadSheenPropertiesAsync(r,o,t)),Promise.all(a).then((function(){}))}))},e.prototype._loadSheenPropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;return t.sheen.isEnabled=!0,t.sheen.intensity=1,null!=n.sheenColorFactor?t.sheen.color=w.FromArray(n.sheenColorFactor):t.sheen.color=w.Black(),n.sheenColorTexture&&i.push(this._loader.loadTextureInfoAsync(e+"/sheenColorTexture",n.sheenColorTexture,(function(e){e.name=t.name+" (Sheen Color)",t.sheen.texture=e}))),void 0!==n.sheenRoughnessFactor?t.sheen.roughness=n.sheenRoughnessFactor:t.sheen.roughness=0,n.sheenRoughnessTexture&&(n.sheenRoughnessTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/sheenRoughnessTexture",n.sheenRoughnessTexture,(function(e){e.name=t.name+" (Sheen Roughness)",t.sheen.textureRoughness=e})))),t.sheen.albedoScaling=!0,t.sheen.useRoughnessFromMainTexture=!1,Promise.all(i).then((function(){}))},e}();kt.RegisterExtension(di,(function(e){return new hi(e)}));var pi="KHR_materials_specular",mi=function(){function e(e){this.name=pi,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(pi)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadSpecularPropertiesAsync(r,o,t)),Promise.all(a).then((function(){}))}))},e.prototype._loadSpecularPropertiesAsync=function(e,n,t){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var i=new Array;return void 0!==n.specularFactor&&(t.metallicF0Factor=n.specularFactor),void 0!==n.specularColorFactor&&(t.metallicReflectanceColor=w.FromArray(n.specularColorFactor)),n.specularTexture&&(n.specularTexture.nonColorData=!0,i.push(this._loader.loadTextureInfoAsync(e+"/specularTexture",n.specularTexture,(function(e){e.name=t.name+" (Specular F0 Color)",t.metallicReflectanceTexture=e})))),Promise.all(i).then((function(){}))},e}();kt.RegisterExtension(pi,(function(e){return new mi(e)}));var _i="KHR_materials_ior",vi=function(){function e(e){this.name=_i,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(_i)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadIorPropertiesAsync(r,o,t)),Promise.all(a).then((function(){}))}))},e.prototype._loadIorPropertiesAsync=function(n,t,i){if(!(i instanceof Bt))throw new Error(n+": Material type not supported");return void 0!==t.ior?i.indexOfRefraction=t.ior:i.indexOfRefraction=e._DEFAULT_IOR,Promise.resolve()},e._DEFAULT_IOR=1.5,e}();kt.RegisterExtension(_i,(function(e){return new vi(e)}));var Ai="KHR_materials_variants",gi=function(){function e(e){this.name=Ai,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ai)}return e.prototype.dispose=function(){this._loader=null},e.GetAvailableVariants=function(e){var n=this._GetExtensionMetadata(e);return n?Object.keys(n.variants):[]},e.prototype.getAvailableVariants=function(n){return e.GetAvailableVariants(n)},e.SelectVariant=function(e,n){var t=this._GetExtensionMetadata(e);if(!t)throw new Error("Cannot select variant on a glTF mesh that does not have the "+Ai+" extension");var i=function(e){var n=t.variants[e];if(n)for(var i=0,r=n;i<r.length;i++){var o=r[i];o.mesh.material=o.material}};if(n instanceof Array)for(var r=0,o=n;r<o.length;r++){i(o[r])}else i(n);t.lastSelected=n},e.prototype.selectVariant=function(n,t){return e.SelectVariant(n,t)},e.Reset=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot reset on a glTF mesh that does not have the "+Ai+" extension");for(var t=0,i=n.original;t<i.length;t++){var r=i[t];r.mesh.material=r.material}n.lastSelected=null},e.prototype.reset=function(n){return e.Reset(n)},e.GetLastSelectedVariant=function(e){var n=this._GetExtensionMetadata(e);if(!n)throw new Error("Cannot get the last selected variant on a glTF mesh that does not have the "+Ai+" extension");return n.lastSelected},e.prototype.getLastSelectedVariant=function(n){return e.GetLastSelectedVariant(n)},e._GetExtensionMetadata=function(e){var n,t;return(null===(t=null===(n=null==e?void 0:e.metadata)||void 0===n?void 0:n.gltf)||void 0===t?void 0:t[Ai])||null},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._variants=n.variants}},e.prototype._loadMeshPrimitiveAsync=function(e,n,t,i,r,o){var a=this;return kt.LoadExtensionAsync(e,r,this.name,(function(s,l){var f=new Array;return f.push(a._loader._loadMeshPrimitiveAsync(e,n,t,i,r,(function(n){if(o(n),n instanceof c){var t=kt._GetDrawMode(e,r.mode),i=a._loader.rootBabylonMesh,u=i.metadata=i.metadata||{},d=u.gltf=u.gltf||{},h=d[Ai]=d[Ai]||{lastSelected:null,original:[],variants:{}};h.original.push({mesh:n,material:n.material});for(var p=h.variants,m=0,_=l.mappings;m<_.length;m++)for(var v=_[m],A=function(e){var i=Vt.Get(s+"/mapping/"+e,a._variants,e),r=Vt.Get("#/materials/",a._loader.gltf.materials,v.material);f.push(a._loader._loadMaterialAsync("#/materials/"+v.material,r,n,t,(function(e){p[i.name]=p[i.name]||[],p[i.name].push({mesh:n,material:e})})))},g=0,E=v.variants;g<E.length;g++){A(E[g])}}}))),Promise.all(f).then((function(e){return e[0]}))}))},e}();kt.RegisterExtension(Ai,(function(e){return new gi(e)}));var Ei=function(){function e(n,t){var i=this;this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._options=B(B({},e._getDefaultOptions()),n),this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new a,this._scene.onDisposeObservable.addOnce((function(e){i.dispose()})),this._parseScene(),this._setupRenderTargets()}return e._getDefaultOptions=function(){return{renderSize:512}},e.prototype.updateOptions=function(e){var n=this;if(Object.keys(e).filter((function(t){return n._options[t]!==e[t]})).length){var t=B(B({},this._options),e),i=this._options;this._options=t,t.renderSize!==i.renderSize&&this._setupRenderTargets()}},e.prototype.getOpaqueTarget=function(){return this._opaqueRenderTarget},e.prototype.shouldRenderAsTransmission=function(e){return!!e&&!!(e instanceof Bt&&e.subSurface.isRefractionEnabled)},e.prototype._addMesh=function(e){e instanceof c&&(e.onMaterialChangedObservable.add(this.onMeshMaterialChanged.bind(this)),this.shouldRenderAsTransmission(e.material)?this._transparentMeshesCache.push(e):this._opaqueMeshesCache.push(e))},e.prototype._removeMesh=function(e){if(e instanceof c){e.onMaterialChangedObservable.remove(this.onMeshMaterialChanged.bind(this));var n=this._transparentMeshesCache.indexOf(e);-1!==n&&this._transparentMeshesCache.splice(n,1),-1!==(n=this._opaqueMeshesCache.indexOf(e))&&this._opaqueMeshesCache.splice(n,1)}},e.prototype._parseScene=function(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))},e.prototype.onMeshMaterialChanged=function(e){if(e instanceof c){var n=this._transparentMeshesCache.indexOf(e),t=this._opaqueMeshesCache.indexOf(e);this.shouldRenderAsTransmission(e.material)?(e.material instanceof Bt&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),-1!==t?(this._opaqueMeshesCache.splice(t,1),this._transparentMeshesCache.push(e)):-1===n&&this._transparentMeshesCache.push(e)):-1!==n?(this._transparentMeshesCache.splice(n,1),this._opaqueMeshesCache.push(e)):-1===t&&this._opaqueMeshesCache.push(e)}},e.prototype._setupRenderTargets=function(){var e=this,n=-1;if(this._scene.layers&&this._opaqueRenderTarget)for(var t=0,i=this._scene.layers;t<i.length;t++){var r=(s=i[t]).renderTargetTextures.indexOf(this._opaqueRenderTarget);r>=0&&s.renderTargetTextures.splice(r,1)}if(this._opaqueRenderTarget&&(n=this._scene.customRenderTargets.indexOf(this._opaqueRenderTarget),this._opaqueRenderTarget.dispose()),this._opaqueRenderTarget=new Ne("opaqueSceneTexture",this._options.renderSize,this._scene,!0),this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.gammaSpace=!0,this._opaqueRenderTarget.lodGenerationScale=1,this._opaqueRenderTarget.lodGenerationOffset=-4,n>=0?this._scene.customRenderTargets.splice(n,0,this._opaqueRenderTarget):(n=this._scene.customRenderTargets.length,this._scene.customRenderTargets.push(this._opaqueRenderTarget)),this._scene.layers&&this._opaqueRenderTarget)for(var o=0,a=this._scene.layers;o<a.length;o++){var s;(s=a[o]).renderTargetTextures.push(this._opaqueRenderTarget)}this._transparentMeshesCache.forEach((function(n){e.shouldRenderAsTransmission(n.material)&&n.material instanceof Bt&&(n.material.refractionTexture=e._opaqueRenderTarget)}))},e.prototype.dispose=function(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]},e}(),Ti="KHR_materials_transmission",yi=function(){function e(e){this.name=Ti,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ti),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialBasePropertiesAsync(e,n,t)),a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadTransparentPropertiesAsync(r,n,t,o)),Promise.all(a).then((function(){}))}))},e.prototype._loadTransparentPropertiesAsync=function(e,n,t,i){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var r=t;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,void 0===i.transmissionFactor)return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();r.subSurface.refractionIntensity=i.transmissionFactor;var o=r.getScene();return r.subSurface.refractionIntensity&&!o._transmissionHelper&&new Ei({},r.getScene()),i.transmissionTexture?(i.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(e+"/transmissionTexture",i.transmissionTexture,void 0).then((function(e){r.subSurface.thicknessTexture=e,r.subSurface.useMaskFromThicknessTextureGltf=!0}))):Promise.resolve()},e}();kt.RegisterExtension(Ti,(function(e){return new yi(e)}));var Ri="KHR_materials_translucency",Ci=function(){function e(e){this.name=Ri,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ri),this.enabled&&(e.parent.transparencyAsCoverage=!0)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=new Array;return a.push(i._loader.loadMaterialBasePropertiesAsync(e,n,t)),a.push(i._loader.loadMaterialPropertiesAsync(e,n,t)),a.push(i._loadTranslucentPropertiesAsync(r,n,t,o)),Promise.all(a).then((function(){}))}))},e.prototype._loadTranslucentPropertiesAsync=function(e,n,t,i){if(!(t instanceof Bt))throw new Error(e+": Material type not supported");var r=t;return r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintRefraction=!0,void 0===i.translucencyFactor?(r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve()):(r.subSurface.translucencyIntensity=i.translucencyFactor,i.translucencyTexture?this._loader.loadTextureInfoAsync(e+"/translucencyTexture",i.translucencyTexture).then((function(e){r.subSurface.thicknessTexture=e,r.subSurface.useMaskFromThicknessTextureGltf=!0})):Promise.resolve())},e}();kt.RegisterExtension(Ri,(function(e){return new Ci(e)}));var bi="KHR_mesh_quantization",Si=function(){function e(e){this.name=bi,this.enabled=e.isExtensionUsed(bi)}return e.prototype.dispose=function(){},e}();kt.RegisterExtension(bi,(function(e){return new Si(e)}));var Ii="KHR_texture_basisu",Oi=function(){function e(e){this.name=Ii,this._loader=e,this.enabled=e.isExtensionUsed(Ii)}return e.prototype.dispose=function(){this._loader=null},e.prototype._loadTextureAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){var a=null==n.sampler?kt.DefaultSampler:Vt.Get(e+"/sampler",i._loader.gltf.samplers,n.sampler),s=Vt.Get(r+"/source",i._loader.gltf.images,o.source);return i._loader._createTextureAsync(e,a,s,(function(e){t(e)}),n._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0)}))},e}();kt.RegisterExtension(Ii,(function(e){return new Oi(e)}));var Mi="KHR_texture_transform",xi=function(){function e(e){this.name=Mi,this._loader=e,this.enabled=this._loader.isExtensionUsed(Mi)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadTextureInfoAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(r,o){return i._loader.loadTextureInfoAsync(e,n,(function(e){if(!(e instanceof ge))throw new Error(r+": Texture type not supported");o.offset&&(e.uOffset=o.offset[0],e.vOffset=o.offset[1]),e.uRotationCenter=0,e.vRotationCenter=0,o.rotation&&(e.wAng=-o.rotation),o.scale&&(e.uScale=o.scale[0],e.vScale=o.scale[1]),null!=o.texCoord&&(e.coordinatesIndex=o.texCoord),t(e)}))}))},e}();kt.RegisterExtension(Mi,(function(e){return new xi(e)}));var Li=function(){function e(e,n,t){this.frame=e,this.action=n,this.onlyOnce=t,this.isDone=!1}return e.prototype._clone=function(){return new e(this.frame,this.action,this.onlyOnce)},e}(),Pi=function(){function e(t,o,s,l,c){var f,u,d,h,p=this;if(void 0===l&&(l=null),this.autoplay=!1,this.loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.spatialSound=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new a,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=m.Zero(),this._positionInEmitterSpace=!1,this._localDirection=new m(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,this._scene=s,e._SceneComponentInitialization(s),this._readyToPlayCallback=l,this._customAttenuationFunction=function(e,n,t,i,r){return n<t?e*(1-n/t):0},c&&(this.autoplay=c.autoplay||!1,this.loop=c.loop||!1,void 0!==c.volume&&(this._volume=c.volume),this.spatialSound=null!==(f=c.spatialSound)&&void 0!==f&&f,this.maxDistance=null!==(u=c.maxDistance)&&void 0!==u?u:100,this.useCustomAttenuation=null!==(d=c.useCustomAttenuation)&&void 0!==d&&d,this.rolloffFactor=c.rolloffFactor||1,this.refDistance=c.refDistance||1,this.distanceModel=c.distanceModel||"linear",this._playbackRate=c.playbackRate||1,this._streaming=null!==(h=c.streaming)&&void 0!==h&&h,this._length=c.length,this._offset=c.offset),i.audioEngine.canUseWebAudio&&i.audioEngine.audioContext){this._soundGain=i.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this.spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);var _=!0;if(o)try{"string"==typeof o?this._urlType="String":o instanceof ArrayBuffer?this._urlType="ArrayBuffer":o instanceof MediaStream?this._urlType="MediaStream":Array.isArray(o)&&(this._urlType="Array");var v=[],A=!1;switch(this._urlType){case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=i.audioEngine.audioContext.createMediaStreamSource(o),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":o.byteLength>0&&(A=!0,this._soundLoaded(o));break;case"String":v.push(o);case"Array":0===v.length&&(v=o);for(var g=0;g<v.length;g++){var E=v[g];if(A=c&&c.skipCodecCheck||-1!==E.indexOf(".mp3",E.length-4)&&i.audioEngine.isMP3supported||-1!==E.indexOf(".ogg",E.length-4)&&i.audioEngine.isOGGsupported||-1!==E.indexOf(".wav",E.length-4)||-1!==E.indexOf(".m4a",E.length-4)||-1!==E.indexOf("blob:")){this._streaming?(this._htmlAudioElement=new Audio(E),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,r.SetCorsBehavior(E,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",(function(){p._isReadyToPlay=!0,p.autoplay&&p.play(0,p._offset,p._length),p._readyToPlayCallback&&p._readyToPlayCallback()})),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(E,(function(e){p._soundLoaded(e)}),void 0,!0,!0,(function(e){e&&n.Error("XHR "+e.status+" error on: "+E+"."),n.Error("Sound creation aborted."),p._scene.mainSoundTrack.removeSound(p)}));break}}break;default:_=!1}_?A||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout((function(){p._readyToPlayCallback&&p._readyToPlayCallback()}),1e3)):n.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(T){n.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),i.audioEngine.WarnedWebAudioUnsupported||(n.Error("Web Audio is not supported by your browser."),i.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout((function(){p._readyToPlayCallback&&p._readyToPlayCallback()}),1e3)}return Object.defineProperty(e.prototype,"currentTime",{get:function(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;var e=this._startOffset;return this.isPlaying&&i.audioEngine.audioContext&&(e+=i.audioEngine.audioContext.currentTime-this._startTime),e},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){i.audioEngine.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))},e.prototype.isReady=function(){return this._isReadyToPlay},e.prototype._soundLoaded=function(e){var t=this;i.audioEngine.audioContext&&i.audioEngine.audioContext.decodeAudioData(e,(function(e){t._audioBuffer=e,t._isReadyToPlay=!0,t.autoplay&&t.play(0,t._offset,t._length),t._readyToPlayCallback&&t._readyToPlayCallback()}),(function(e){n.Error("Error while decoding audio data for: "+t.name+" / Error: "+e)}))},e.prototype.setAudioBuffer=function(e){i.audioEngine.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)},e.prototype.updateOptions=function(e){var n,t,i,r,o,a,s,l,c;e&&(this.loop=null!==(n=e.loop)&&void 0!==n?n:this.loop,this.maxDistance=null!==(t=e.maxDistance)&&void 0!==t?t:this.maxDistance,this.useCustomAttenuation=null!==(i=e.useCustomAttenuation)&&void 0!==i?i:this.useCustomAttenuation,this.rolloffFactor=null!==(r=e.rolloffFactor)&&void 0!==r?r:this.rolloffFactor,this.refDistance=null!==(o=e.refDistance)&&void 0!==o?o:this.refDistance,this.distanceModel=null!==(a=e.distanceModel)&&void 0!==a?a:this.distanceModel,this._playbackRate=null!==(s=e.playbackRate)&&void 0!==s?s:this._playbackRate,this._length=null!==(l=e.length)&&void 0!==l?l:void 0,this._offset=null!==(c=e.offset)&&void 0!==c?c:void 0,this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))},e.prototype._createSpatialParameters=function(){i.audioEngine.canUseWebAudio&&i.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=i.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))},e.prototype._updateSpatialParameters=function(){this.spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))},e.prototype.switchPanningModelToHRTF=function(){this._panningModel="HRTF",this._switchPanningModel()},e.prototype.switchPanningModelToEqualPower=function(){this._panningModel="equalpower",this._switchPanningModel()},e.prototype._switchPanningModel=function(){i.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)},e.prototype.connectToSoundTrackAudioNode=function(e){i.audioEngine.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)},e.prototype.setDirectionalCone=function(e,t,i){t<e?n.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length)))},Object.defineProperty(e.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(e){if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e)return void n.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e,i.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(e){if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle)return void n.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e,i.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}},enumerable:!1,configurable:!0}),e.prototype.setPosition=function(e){this._position=e,i.audioEngine.canUseWebAudio&&this.spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z)},e.prototype.setLocalDirectionToMesh=function(e){this._localDirection=e,i.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()},e.prototype._updateDirection=function(){if(this._connectedTransformNode&&this._soundPanner){var e=this._connectedTransformNode.getWorldMatrix(),n=m.TransformNormal(this._localDirection,e);n.normalize(),this._soundPanner.setOrientation(n.x,n.y,n.z)}},e.prototype.updateDistanceFromListener=function(){if(i.audioEngine.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){var e=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}},e.prototype.setAttenuationFunction=function(e){this._customAttenuationFunction=e},e.prototype.play=function(e,t,r){var o=this;if(this._isReadyToPlay&&this._scene.audioEnabled&&i.audioEngine.audioContext)try{this._startOffset<0&&(e=-this._startOffset,this._startOffset=0);var a=e?i.audioEngine.audioContext.currentTime+e:i.audioEngine.audioContext.currentTime;if(this._soundSource&&this._streamingSource||this.spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||this._soundPanner.setPosition(this._position.x,this._position.y,this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=i.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=function(){o._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement)(s=function(){if(i.audioEngine.unlocked){var e=o._htmlAudioElement.play();void 0!==e&&e.catch((function(e){i.audioEngine.lock(),(o.loop||o.autoplay)&&i.audioEngine.onAudioUnlockedObservable.addOnce((function(){s()}))}))}else(o.loop||o.autoplay)&&i.audioEngine.onAudioUnlockedObservable.addOnce((function(){s()}))})()}else{var s=function(){if(i.audioEngine.audioContext){if(r=r||o._length,t=t||o._offset,o._soundSource){var n=o._soundSource;n.onended=function(){n.disconnect()}}if(o._soundSource=i.audioEngine.audioContext.createBufferSource(),o._soundSource&&o._inputAudioNode){o._soundSource.buffer=o._audioBuffer,o._soundSource.connect(o._inputAudioNode),o._soundSource.loop=o.loop,void 0!==t&&(o._soundSource.loopStart=t),void 0!==r&&(o._soundSource.loopEnd=(0|t)+r),o._soundSource.playbackRate.value=o._playbackRate,o._soundSource.onended=function(){o._onended()},a=e?i.audioEngine.audioContext.currentTime+e:i.audioEngine.audioContext.currentTime;var s=o.isPaused?o._startOffset%o._soundSource.buffer.duration:t||0;o._soundSource.start(a,s,o.loop?void 0:r)}}};"suspended"===i.audioEngine.audioContext.state?setTimeout((function(){"suspended"===i.audioEngine.audioContext.state?(i.audioEngine.lock(),(o.loop||o.autoplay)&&i.audioEngine.onAudioUnlockedObservable.addOnce((function(){s()}))):s()}),500):s()}this._startTime=a,this.isPlaying=!0,this.isPaused=!1}catch(l){n.Error("Error while trying to play audio: "+this.name+", "+l.message)}},e.prototype._onended=function(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},e.prototype.stop=function(e){var n=this;if(this.isPlaying)if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(i.audioEngine.audioContext&&this._soundSource){var t=e?i.audioEngine.audioContext.currentTime+e:i.audioEngine.audioContext.currentTime;this._soundSource.stop(t),this._soundSource.onended=function(){n.isPlaying=!1},this.isPaused||(this._startOffset=0)}},e.prototype.pause=function(){this.isPlaying&&(this.isPaused=!0,this._streaming?this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect():i.audioEngine.audioContext&&(this.stop(0),this._startOffset+=i.audioEngine.audioContext.currentTime-this._startTime))},e.prototype.setVolume=function(e,n){i.audioEngine.canUseWebAudio&&this._soundGain&&(n&&i.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(i.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,i.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,i.audioEngine.audioContext.currentTime+n)):this._soundGain.gain.value=e),this._volume=e},e.prototype.setPlaybackRate=function(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))},e.prototype.getVolume=function(){return this._volume},e.prototype.attachToMesh=function(e){var n=this;this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this.spatialSound||(this.spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=function(e){return n._onRegisterAfterWorldMatrixUpdate(e)},this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)},e.prototype.detachFromMesh=function(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)},e.prototype._onRegisterAfterWorldMatrixUpdate=function(e){if(this._positionInEmitterSpace)e.worldMatrixFromCache.invertToRef(P.Matrix[0]),this.setPosition(P.Matrix[0].getTranslation());else if(e.getBoundingInfo){var n=e.getBoundingInfo();this.setPosition(n.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);i.audioEngine.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()},e.prototype.clone=function(){var n=this;if(this._streaming)return null;var t=function(){n._isReadyToPlay?(r._audioBuffer=n.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,n._offset,n._length)):window.setTimeout(t,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new e(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),t(),r},e.prototype.getAudioBuffer=function(){return this._audioBuffer},e.prototype.getSoundSource=function(){return this._soundSource},e.prototype.getSoundGain=function(){return this._soundGain},e.prototype.serialize=function(){var e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e},e.Parse=function(n,t,i,r){var o,a=n.name;o=n.url?i+n.url:i+a;var s,l={autoplay:n.autoplay,loop:n.loop,volume:n.volume,spatialSound:n.spatialSound,maxDistance:n.maxDistance,rolloffFactor:n.rolloffFactor,refDistance:n.refDistance,distanceModel:n.distanceModel,playbackRate:n.playbackRate};if(r){var c=function(){r._isReadyToPlay?(s._audioBuffer=r.getAudioBuffer(),s._isReadyToPlay=!0,s.autoplay&&s.play(0,s._offset,s._length)):window.setTimeout(c,300)};s=new e(a,new ArrayBuffer(0),t,null,l),c()}else s=new e(a,o,t,(function(){t._removePendingData(s)}),l),t._addPendingData(s);if(n.position){var f=m.FromArray(n.position);s.setPosition(f)}if(n.isDirectional&&(s.setDirectionalCone(n.coneInnerAngle||360,n.coneOuterAngle||360,n.coneOuterGain||0),n.localDirectionToMesh)){var u=m.FromArray(n.localDirectionToMesh);s.setLocalDirectionToMesh(u)}if(n.connectedMeshId){var d=t.getMeshByID(n.connectedMeshId);d&&s.attachToMesh(d)}return n.metadata&&(s.metadata=n.metadata),s},e._SceneComponentInitialization=function(e){throw Ae.WarnImport("AudioSceneComponent")},e}(),Ni=function(){function e(e,n,t){var i=this;if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],n.length!==t.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=t;for(var r=0,o=0,a=t;o<a.length;o++){r+=a[o]}for(var s=r>0?1/r:0,l=0;l<this._weights.length;l++)this._weights[l]*=s;this._sounds=n;for(var c=0,f=this._sounds;c<f.length;c++){f[c].onEndedObservable.add((function(){i._onended()}))}}return Object.defineProperty(e.prototype,"directionalConeInnerAngle",{get:function(){return this._coneInnerAngle},set:function(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void n.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(var t=0,i=this._sounds;t<i.length;t++){i[t].directionalConeInnerAngle=e}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"directionalConeOuterAngle",{get:function(){return this._coneOuterAngle},set:function(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void n.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(var t=0,i=this._sounds;t<i.length;t++){i[t].directionalConeOuterAngle=e}}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(e){if(e!==this._volume)for(var n=0,t=this._sounds;n<t.length;n++){t[n].setVolume(e)}},enumerable:!1,configurable:!0}),e.prototype._onended=function(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1},e.prototype.pause=function(){this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause()},e.prototype.stop=function(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()},e.prototype.play=function(e){if(!this.isPaused){this.stop();for(var n=Math.random(),t=0,i=0;i<this._weights.length;i++)if(n<=(t+=this._weights[i])){this._currentIndex=i;break}}var r=this._sounds[this._currentIndex];r.isReady()?r.play(0,this.isPaused?void 0:e):r.autoplay=!0,this.isPlaying=!0,this.isPaused=!1},e}(),Di="MSFT_audio_emitter",Fi=function(){function e(e){this.name=Di,this._loader=e,this.enabled=this._loader.isExtensionUsed(Di)}return e.prototype.dispose=function(){this._loader=null,this._clips=null,this._emitters=null},e.prototype.onLoading=function(){var e=this._loader.gltf.extensions;if(e&&e[this.name]){var n=e[this.name];this._clips=n.clips,this._emitters=n.emitters,Vt.Assign(this._clips),Vt.Assign(this._emitters)}},e.prototype.loadSceneAsync=function(e,n){var t=this;return kt.LoadExtensionAsync(e,n,this.name,(function(i,r){var o=new Array;o.push(t._loader.loadSceneAsync(e,n));for(var a=0,s=r.emitters;a<s.length;a++){var l=s[a],c=Vt.Get(i+"/emitters",t._emitters,l);if(null!=c.refDistance||null!=c.maxDistance||null!=c.rolloffFactor||null!=c.distanceModel||null!=c.innerAngle||null!=c.outerAngle)throw new Error(i+": Direction or Distance properties are not allowed on emitters attached to a scene");o.push(t._loadEmitterAsync(i+"/emitters/"+c.index,c))}return Promise.all(o).then((function(){}))}))},e.prototype.loadNodeAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(e,o){var a=new Array;return i._loader.loadNodeAsync(e,n,(function(n){for(var s=function(t){var o=Vt.Get(e+"/emitters",i._emitters,t);a.push(i._loadEmitterAsync(e+"/emitters/"+o.index,o).then((function(){for(var e=0,t=o._babylonSounds;e<t.length;e++){var i=t[e];i.attachToMesh(n),null==o.innerAngle&&null==o.outerAngle||(i.setLocalDirectionToMesh(m.Forward()),i.setDirectionalCone(2*r.ToDegrees(null==o.innerAngle?Math.PI:o.innerAngle),2*r.ToDegrees(null==o.outerAngle?Math.PI:o.outerAngle),0))}})))},l=0,c=o.emitters;l<c.length;l++){s(c[l])}t(n)})).then((function(e){return Promise.all(a).then((function(){return e}))}))}))},e.prototype.loadAnimationAsync=function(e,n){var t=this;return kt.LoadExtensionAsync(e,n,this.name,(function(i,r){return t._loader.loadAnimationAsync(e,n).then((function(o){var a=new Array;Vt.Assign(r.events);for(var s=0,l=r.events;s<l.length;s++){var c=l[s];a.push(t._loadAnimationEventAsync(i+"/events/"+c.index,e,n,c,o))}return Promise.all(a).then((function(){return o}))}))}))},e.prototype._loadClipAsync=function(e,n){if(n._objectURL)return n._objectURL;var t;if(n.uri)t=this._loader.loadUriAsync(e,n,n.uri);else{var i=Vt.Get(e+"/bufferView",this._loader.gltf.bufferViews,n.bufferView);t=this._loader.loadBufferViewAsync("/bufferViews/"+i.index,i)}return n._objectURL=t.then((function(e){return URL.createObjectURL(new Blob([e],{type:n.mimeType}))})),n._objectURL},e.prototype._loadEmitterAsync=function(e,n){var t=this;if(n._babylonSounds=n._babylonSounds||[],!n._babylonData){for(var i=new Array,o=n.name||"emitter"+n.index,a={loop:!1,autoplay:!1,volume:null==n.volume?1:n.volume},s=function(e){var r="/extensions/"+l.name+"/clips",s=Vt.Get(r,l._clips,n.clips[e].clip);i.push(l._loadClipAsync(r+"/"+n.clips[e].clip,s).then((function(i){var r=n._babylonSounds[e]=new Pi(o,i,t._loader.babylonScene,null,a);r.refDistance=n.refDistance||1,r.maxDistance=n.maxDistance||256,r.rolloffFactor=n.rolloffFactor||1,r.distanceModel=n.distanceModel||"exponential",r._positionInEmitterSpace=!0})))},l=this,c=0;c<n.clips.length;c++)s(c);var f=Promise.all(i).then((function(){var e=n.clips.map((function(e){return e.weight||1})),t=new Ni(n.loop||!1,n._babylonSounds,e);n.innerAngle&&(t.directionalConeInnerAngle=2*r.ToDegrees(n.innerAngle)),n.outerAngle&&(t.directionalConeOuterAngle=2*r.ToDegrees(n.outerAngle)),n.volume&&(t.volume=n.volume),n._babylonData.sound=t}));n._babylonData={loaded:f}}return n._babylonData.loaded},e.prototype._getEventAction=function(e,n,t,i,r){switch(t){case"play":return function(e){var t=(r||0)+(e-i);n.play(t)};case"stop":return function(e){n.stop()};case"pause":return function(e){n.pause()};default:throw new Error(e+": Unsupported action "+t)}},e.prototype._loadAnimationEventAsync=function(e,n,t,i,r){var o=this;if(0==r.targetedAnimations.length)return Promise.resolve();var a=r.targetedAnimations[0],s=i.emitter,l=Vt.Get("/extensions/"+this.name+"/emitters",this._emitters,s);return this._loadEmitterAsync(e,l).then((function(){var n=l._babylonData.sound;if(n){var t=new Li(i.time,o._getEventAction(e,n,i.action,i.time,i.startOffset));a.animation.addEvent(t),r.onAnimationGroupEndObservable.add((function(){n.stop()})),r.onAnimationGroupPauseObservable.add((function(){n.pause()}))}}))},e}();kt.RegisterExtension(Di,(function(e){return new Fi(e)}));var Ui=function(){function e(e){this.name="MSFT_lod",this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new a,this.onMaterialLODsLoadedObservable=new a,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed("MSFT_lod")}return e.prototype.dispose=function(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()},e.prototype.onReady=function(){for(var e=this,n=function(n){var i=Promise.all(t._nodePromiseLODs[n]).then((function(){0!==n&&(e._loader.endPerformanceCounter("Node LOD "+n),e._loader.log("Loaded node LOD "+n)),e.onNodeLODsLoadedObservable.notifyObservers(n),n!==e._nodePromiseLODs.length-1&&(e._loader.startPerformanceCounter("Node LOD "+(n+1)),e._loadBufferLOD(e._nodeBufferLODs,n+1),e._nodeSignalLODs[n]&&e._nodeSignalLODs[n].resolve())}));t._loader._completePromises.push(i)},t=this,i=0;i<this._nodePromiseLODs.length;i++)n(i);var r=function(n){var t=Promise.all(o._materialPromiseLODs[n]).then((function(){0!==n&&(e._loader.endPerformanceCounter("Material LOD "+n),e._loader.log("Loaded material LOD "+n)),e.onMaterialLODsLoadedObservable.notifyObservers(n),n!==e._materialPromiseLODs.length-1&&(e._loader.startPerformanceCounter("Material LOD "+(n+1)),e._loadBufferLOD(e._materialBufferLODs,n+1),e._materialSignalLODs[n]&&e._materialSignalLODs[n].resolve())}));o._loader._completePromises.push(t)},o=this;for(i=0;i<this._materialPromiseLODs.length;i++)r(i)},e.prototype.loadSceneAsync=function(e,n){var t=this._loader.loadSceneAsync(e,n);return this._loadBufferLOD(this._bufferLODs,0),t},e.prototype.loadNodeAsync=function(e,n,t){var i=this;return kt.LoadExtensionAsync(e,n,this.name,(function(e,t){var r,o=i._getLODs(e,n,i._loader.gltf.nodes,t.ids);i._loader.logOpen(""+e);for(var a=function(e){var n=o[e];0!==e&&(i._nodeIndexLOD=e,i._nodeSignalLODs[e]=i._nodeSignalLODs[e]||new ct);var t=i._loader.loadNodeAsync("/nodes/"+n.index,n,(function(e){e.setEnabled(!1)})).then((function(n){if(0!==e){var t=o[e-1];t._babylonTransformNode&&(i._disposeTransformNode(t._babylonTransformNode),delete t._babylonTransformNode)}return n.setEnabled(!0),n}));i._nodePromiseLODs[e]=i._nodePromiseLODs[e]||[],0===e?r=t:(i._nodeIndexLOD=null,i._nodePromiseLODs[e].push(t))},s=0;s<o.length;s++)a(s);return i._loader.logClose(),r}))},e.prototype._loadMaterialAsync=function(e,n,t,i,r){var o=this;return this._nodeIndexLOD?null:kt.LoadExtensionAsync(e,n,this.name,(function(e,a){var s,l=o._getLODs(e,n,o._loader.gltf.materials,a.ids);o._loader.logOpen(""+e);for(var c=function(e){var n=l[e];0!==e&&(o._materialIndexLOD=e);var a=o._loader._loadMaterialAsync("/materials/"+n.index,n,t,i,(function(n){0===e&&r(n)})).then((function(n){if(0!==e){r(n);var t=l[e-1]._data;t[i]&&(o._disposeMaterials([t[i].babylonMaterial]),delete t[i])}return n}));o._materialPromiseLODs[e]=o._materialPromiseLODs[e]||[],0===e?s=a:(o._materialIndexLOD=null,o._materialPromiseLODs[e].push(a))},f=0;f<l.length;f++)c(f);return o._loader.logClose(),s}))},e.prototype._loadUriAsync=function(e,n,t){var i=this;if(null!==this._nodeIndexLOD){this._loader.log("deferred");var r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new ct,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then((function(){return i._loader.loadUriAsync(e,n,t)}))}if(null!==this._materialIndexLOD){this._loader.log("deferred");r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new ct,this._materialSignalLODs[r].promise.then((function(){return i._loader.loadUriAsync(e,n,t)}))}return null},e.prototype.loadBufferAsync=function(e,n,t,i){if(this._loader.parent.useRangeRequests&&!n.uri){if(!this._loader.bin)throw new Error(e+": Uri is missing or the binary glTF is missing its binary chunk");var r=function(e,n){var r=t,o=r+i-1,a=e[n];return a?(a.start=Math.min(a.start,r),a.end=Math.max(a.end,o)):(a={start:r,end:o,loaded:new ct},e[n]=a),a.loaded.promise.then((function(e){return new Uint8Array(e.buffer,e.byteOffset+t-a.start,i)}))};return this._loader.log("deferred"),null!==this._nodeIndexLOD?r(this._nodeBufferLODs,this._nodeIndexLOD):null!==this._materialIndexLOD?r(this._materialBufferLODs,this._materialIndexLOD):r(this._bufferLODs,0)}return null},e.prototype._loadBufferLOD=function(e,n){var t=e[n];t&&(this._loader.log("Loading buffer range ["+t.start+"-"+t.end+"]"),this._loader.bin.readAsync(t.start,t.end-t.start+1).then((function(e){t.loaded.resolve(e)}),(function(e){t.loaded.reject(e)})))},e.prototype._getLODs=function(e,n,t,i){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");for(var r=new Array,o=i.length-1;o>=0;o--)if(r.push(Vt.Get(e+"/ids/"+i[o],t,i[o])),r.length===this.maxLODsToLoad)return r;return r.push(n),r},e.prototype._disposeTransformNode=function(e){var n=this,t=new Array,i=e.material;i&&t.push(i);for(var r=0,o=e.getChildMeshes();r<o.length;r++){var a=o[r];a.material&&t.push(a.material)}e.dispose();var s=t.filter((function(e){return n._loader.babylonScene.meshes.every((function(n){return n.material!=e}))}));this._disposeMaterials(s)},e.prototype._disposeMaterials=function(e){for(var n={},t=0,i=e;t<i.length;t++){for(var r=0,o=(f=i[t]).getActiveTextures();r<o.length;r++){var a=o[r];n[a.uniqueId]=a}f.dispose()}for(var s in n)for(var l=0,c=this._loader.babylonScene.materials;l<c.length;l++){var f;(f=c[l]).hasTexture(n[s])&&delete n[s]}for(var s in n)n[s].dispose()},e}();kt.RegisterExtension("MSFT_lod",(function(e){return new Ui(e)}));var Bi="MSFT_minecraftMesh",wi=function(){function e(e){this.name=Bi,this._loader=e,this.enabled=this._loader.isExtensionUsed(Bi)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtraAsync(e,n,this.name,(function(r,o){if(o){if(!(t instanceof Bt))throw new Error(r+": Material type not supported");var a=i._loader.loadMaterialPropertiesAsync(e,n,t);return t.needAlphaBlending()&&(t.forceDepthWrite=!0,t.separateCullingPass=!0),t.backFaceCulling=t.forceDepthWrite,t.twoSidedLighting=!0,a}return null}))},e}();kt.RegisterExtension(Bi,(function(e){return new wi(e)}));var Gi="MSFT_sRGBFactors",Vi=function(){function e(e){this.name=Gi,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gi)}return e.prototype.dispose=function(){this._loader=null},e.prototype.loadMaterialPropertiesAsync=function(e,n,t){var i=this;return kt.LoadExtraAsync(e,n,this.name,(function(r,o){if(o){if(!(t instanceof Bt))throw new Error(r+": Material type not supported");var a=i._loader.loadMaterialPropertiesAsync(e,n,t);return t.albedoTexture||t.albedoColor.toLinearSpaceToRef(t.albedoColor),t.reflectivityTexture||t.reflectivityColor.toLinearSpaceToRef(t.reflectivityColor),a}return null}))},e}();kt.RegisterExtension(Gi,(function(e){return new Vi(e)}));var ki="ExtrasAsMetadata",Hi=function(){function e(e){this.name=ki,this.enabled=!0,this._loader=e}return e.prototype._assignExtras=function(e,n){if(n.extras&&Object.keys(n.extras).length>0){var t=e.metadata=e.metadata||{};(t.gltf=t.gltf||{}).extras=n.extras}},e.prototype.dispose=function(){this._loader=null},e.prototype.loadNodeAsync=function(e,n,t){var i=this;return this._loader.loadNodeAsync(e,n,(function(e){i._assignExtras(e,n),t(e)}))},e.prototype.loadCameraAsync=function(e,n,t){var i=this;return this._loader.loadCameraAsync(e,n,(function(e){i._assignExtras(e,n),t(e)}))},e.prototype.createMaterial=function(e,n,t){var i=this._loader.createMaterial(e,n,t);return this._assignExtras(i,n),i},e}();kt.RegisterExtension(ki,(function(e){return new Hi(e)}));async function Xi(){const[e,n]=await Promise.all([Ue.ImportMeshAsync("","/npodice/","bowl.gltf"),Ue.ImportMeshAsync("","/npodice/","dice.gltf")]);return{bowl:e,dice:n}}export{Xi as load};
